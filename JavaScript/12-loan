<script>

/**
 * Show loan page - MAIN ENTRY POINT
 */
function showLoanPage() {
  console.log('=== SHOW LOAN PAGE ===');
  
  showLoading('ƒêang t·∫£i d·ªØ li·ªáu kho·∫£n vay...');
  
  // Load loan data
  if (DataManager && DataManager.isInitialized && DataManager.isInitialized()) {
    allLoanData = DataManager.getLoan();
    loanFilteredData = allLoanData.slice();
    hideLoading();
    renderLoanPage();
  } else {
    // Fallback: Load directly
    google.script.run
      .withSuccessHandler(function(response) {
        console.log('Loan data loaded:', response);
        
        if (response.success) {
          allLoanData = response.data || [];
          loanFilteredData = allLoanData.slice();
        } else {
          allLoanData = [];
          loanFilteredData = [];
          showToast('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu kho·∫£n vay', 'error');
        }
        
        hideLoading();
        renderLoanPage();
      })
      .withFailureHandler(function(error) {
        console.error('Load loan error:', error);
        hideLoading();
        showToast('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
        
        // Render empty page
        allLoanData = [];
        loanFilteredData = [];
        renderLoanPage();
      })
      .getRecords('Kho·∫£n vay');
  }
}

/**
 * Render loan page - FIXED VERSION
 */
function renderLoanPage() {
  console.log('=== RENDERING LOAN PAGE ===');
  
  document.getElementById('pageTitle').textContent = 'Kho·∫£n vay';
  
  // Apply filters DIRECTLY without calling applyLoanFilters()
  if (document.getElementById('loanFromDate')) {
    loanFilters.fromDate = document.getElementById('loanFromDate').value;
  }
  if (document.getElementById('loanToDate')) {
    loanFilters.toDate = document.getElementById('loanToDate').value;
  }
  if (document.getElementById('loanNameFilter')) {
    loanFilters.loanName = document.getElementById('loanNameFilter').value.toLowerCase();
  }
  if (document.getElementById('loanStatusFilter')) {
    loanFilters.status = document.getElementById('loanStatusFilter').value;
  }
  
  // Filter data
  loanFilteredData = allLoanData.filter(function(item) {
    var loanDate = item['Ng√†y vay'] || '';
    var loanName = (item['Danh m·ª•c vay'] || '').toLowerCase();
    var status = item['T√¨nh tr·∫°ng'] || 'active';
    
    if (loanFilters.fromDate && loanDate < loanFilters.fromDate) return false;
    if (loanFilters.toDate && loanDate > loanFilters.toDate) return false;
    if (loanFilters.loanName && loanName.indexOf(loanFilters.loanName) === -1) return false;
    if (loanFilters.status && status !== loanFilters.status) return false;
    
    return true;
  });
  
  var totalPages = Math.ceil(loanFilteredData.length / loanItemsPerPage);
  var startIndex = (loanCurrentPage - 1) * loanItemsPerPage;
  var endIndex = Math.min(startIndex + loanItemsPerPage, loanFilteredData.length);
  
  console.log('Total filtered:', loanFilteredData.length);
  console.log('Current page:', loanCurrentPage);
  console.log('Items per page:', loanItemsPerPage);
  console.log('Total pages:', totalPages);
  
  var html = 
    // Filter Section
    '<div class="card">' +
    '<div class="card-header">' +
    '<h3 class="card-title">Qu·∫£n l√Ω Kho·∫£n vay</h3>' +
    '<div style="display: flex; gap: 10px;">' +
    '<button class="btn-primary" onclick="downloadLoanTemplate()">' +
    '<i class="fas fa-download"></i> T·∫£i m·∫´u' +
    '</button>' +
    '<button class="btn-warning" onclick="openLoanImportModal()">' +
    '<i class="fas fa-file-import"></i> Import Excel' +
    '</button>' +
    '<button class="btn-success" onclick="exportLoanToExcel()">' +
    '<i class="fas fa-file-excel"></i> Xu·∫•t Excel' +
    '</button>' +
    '<button class="btn-primary" onclick="openLoanModal(null)">' +
    '<i class="fas fa-plus"></i> Th√™m kho·∫£n vay' +
    '</button>' +
    '</div>' +
    '</div>' +
    
    // Notifications container
    '<div id="loanNotifications"></div>' +
    
    // Filters
    '<div style="padding: 20px; background: #f9fafb; border-radius: 8px; margin-bottom: 20px;">' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">' +
    '<div>' +
    '<label style="display: block; font-size: 13px; font-weight: 500; color: #4a5568; margin-bottom: 5px;">T·ª´ ng√†y vay</label>' +
    '<input type="date" id="loanFromDate" class="form-control" value="' + loanFilters.fromDate + '" onchange="renderLoanPage()">' +
    '</div>' +
    '<div>' +
    '<label style="display: block; font-size: 13px; font-weight: 500; color: #4a5568; margin-bottom: 5px;">ƒê·∫øn ng√†y vay</label>' +
    '<input type="date" id="loanToDate" class="form-control" value="' + loanFilters.toDate + '" onchange="renderLoanPage()">' +
    '</div>' +
    '<div>' +
    '<label style="display: block; font-size: 13px; font-weight: 500; color: #4a5568; margin-bottom: 5px;">T√™n kho·∫£n vay</label>' +
    '<input type="text" id="loanNameFilter" class="form-control" placeholder="T√¨m theo t√™n..." value="' + loanFilters.loanName + '" oninput="renderLoanPage()">' +
    '</div>' +
    '<div>' +
    '<label style="display: block; font-size: 13px; font-weight: 500; color: #4a5568; margin-bottom: 5px;">T√¨nh tr·∫°ng</label>' +
    '<select id="loanStatusFilter" class="form-control" onchange="renderLoanPage()">' +
    '<option value="">T·∫•t c·∫£</option>' +
    '<option value="active"' + (loanFilters.status === 'active' ? ' selected' : '') + '>ƒêang vay</option>' +
    '<option value="completed"' + (loanFilters.status === 'completed' ? ' selected' : '') + '>ƒê√£ tr·∫£ h·∫øt</option>' +
    '<option value="overdue"' + (loanFilters.status === 'overdue' ? ' selected' : '') + '>Qu√° h·∫°n</option>' +
    '</select>' +
    '</div>' +
    '</div>' +
    '<div style="text-align: right;">' +
    '<button class="btn-secondary btn-sm" onclick="clearLoanFilters()">' +
    '<i class="fas fa-times"></i> X√≥a b·ªô l·ªçc' +
    '</button>' +
    '</div>' +
    '</div>' +
    
    // Summary cards
    renderLoanSummary() +
    
    // Table
    '<div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">' +
    '<div style="color: #6b7280; font-size: 14px;">Hi·ªÉn th·ªã ' + 
    (loanFilteredData.length === 0 ? 0 : (startIndex + 1)) + '-' + endIndex + ' trong t·ªïng s·ªë ' + loanFilteredData.length + ' b·∫£n ghi</div>' +
    '<div style="display: flex; align-items: center; gap: 10px;">' +
    '<label style="font-size: 14px; color: #4a5568;">Hi·ªÉn th·ªã:</label>' +
    '<select class="form-control" style="width: 80px; padding: 6px 10px;" onchange="changeLoanItemsPerPage(this.value)">' +
    '<option value="10"' + (loanItemsPerPage === 10 ? ' selected' : '') + '>10</option>' +
    '<option value="20"' + (loanItemsPerPage === 20 ? ' selected' : '') + '>20</option>' +
    '<option value="50"' + (loanItemsPerPage === 50 ? ' selected' : '') + '>50</option>' +
    '<option value="100"' + (loanItemsPerPage === 100 ? ' selected' : '') + '>100</option>' +
    '</select>' +
    '</div>' +
    '</div>' +
    
    '<div style="overflow-x: auto; max-height: calc(100vh - 400px); overflow-y: auto;">' +
    '<table>' +
    '<thead>' +
    '<tr>' +
    '<th class="sticky-column" style="min-width: 180px;">DANH M·ª§C VAY</th>' +
    '<th style="min-width: 120px;">NG√ÄY VAY</th>' +
    '<th style="min-width: 120px;">H·∫†N TR·∫¢</th>' +
    '<th style="min-width: 140px;">GI√Å TR·ªä VAY</th>' +
    '<th style="min-width: 100px;">L√ÉI SU·∫§T</th>' +
    '<th style="min-width: 140px;">G·ªêC/TH√ÅNG</th>' +
    '<th style="min-width: 140px;">L√ÉI/TH√ÅNG</th>' +
    '<th style="min-width: 160px;">G·ªêC ƒê√É TR·∫¢</th>' +
    '<th style="min-width: 140px;">C√íN L·∫†I</th>' +
    '<th style="min-width: 120px;">T√åNH TR·∫†NG</th>' +
    '<th style="min-width: 180px;">H√ÄNH ƒê·ªòNG</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody>' +
    renderLoanTableWithPagination() +
    '</tbody>' +
    '</table>' +
    '</div>' +
    
    // Pagination
    renderLoanPagination(totalPages) +
    
    '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
  
  console.log('‚úÖ Loan page rendered');
  
  // Check and display notifications
  checkLoanNotifications();
}
/**
 * Render loan summary cards
 */
function renderLoanSummary() {
  var totalPrincipal = 0;
  var totalMonthlyPayment = 0;
  var totalInterest = 0;
  var totalPaid = 0;
  var totalRemaining = 0;
  
  for (var i = 0; i < loanFilteredData.length; i++) {
    var principal = parseCurrency(loanFilteredData[i]['Gi√° tr·ªã vay']);
    var monthlyPrincipal = parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng']);
    var monthlyInterest = parseCurrency(loanFilteredData[i]['Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng']);
    var paid = parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']);
    var remaining = parseCurrency(loanFilteredData[i]['Ti·ªÅn vay c√≤n l·∫°i']);
    
    totalPrincipal += principal;
    totalMonthlyPayment += (monthlyPrincipal + monthlyInterest);
    totalInterest += monthlyInterest;
    totalPaid += paid;
    totalRemaining += remaining;
  }
  
  var paymentPercent = totalPrincipal > 0 ? Math.round((totalPaid / totalPrincipal) * 100) : 0;
  
  return '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">' +
    '<div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px; color: white;">' +
    '<i class="fas fa-calculator" style="font-size: 24px; margin-right: 10px;"></i>' +
    '<h3 style="margin: 0; font-size: 18px;">T·ªîNG H·ª¢P KHO·∫¢N VAY</h3>' +
    '</div>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">T·ªïng gi√° tr·ªã vay</div>' +
    '<div style="color: white; font-size: 20px; font-weight: 700;">' + formatCurrency(totalPrincipal) + ' ƒë</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">Tr·∫£/th√°ng</div>' +
    '<div style="color: white; font-size: 20px; font-weight: 700;">' + formatCurrency(totalMonthlyPayment) + ' ƒë</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">L√£i/th√°ng</div>' +
    '<div style="color: white; font-size: 20px; font-weight: 700;">' + formatCurrency(totalInterest) + ' ƒë</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">G·ªëc ƒë√£ tr·∫£</div>' +
    '<div style="color: #4ade80; font-size: 20px; font-weight: 700;">' + formatCurrency(totalPaid) + ' ƒë</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">C√≤n l·∫°i</div>' +
    '<div style="color: #fbbf24; font-size: 20px; font-weight: 700;">' + formatCurrency(totalRemaining) + ' ƒë</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">T·ª∑ l·ªá ho√†n th√†nh</div>' +
    '<div style="color: white; font-size: 20px; font-weight: 700;">' + paymentPercent + '%</div>' +
    '</div>' +
    '</div>' +
    '</div>';
}

/**
 * Apply loan filters
 */
function applyLoanFilters() {
  loanFilters.fromDate = document.getElementById('loanFromDate') ? document.getElementById('loanFromDate').value : '';
  loanFilters.toDate = document.getElementById('loanToDate') ? document.getElementById('loanToDate').value : '';
  loanFilters.loanName = document.getElementById('loanNameFilter') ? document.getElementById('loanNameFilter').value.toLowerCase() : '';
  loanFilters.status = document.getElementById('loanStatusFilter') ? document.getElementById('loanStatusFilter').value : '';
  
  loanFilteredData = allLoanData.filter(function(item) {
    var loanDate = item['Ng√†y vay'] || '';
    var loanName = (item['Danh m·ª•c vay'] || '').toLowerCase();
    var status = item['T√¨nh tr·∫°ng'] || 'active';
    
    if (loanFilters.fromDate && loanDate < loanFilters.fromDate) return false;
    if (loanFilters.toDate && loanDate > loanFilters.toDate) return false;
    if (loanFilters.loanName && loanName.indexOf(loanFilters.loanName) === -1) return false;
    if (loanFilters.status && status !== loanFilters.status) return false;
    
    return true;
  });
  
  loanCurrentPage = 1;
}

/**
 * Clear loan filters
 */
function clearLoanFilters() {
  loanFilters = {
    fromDate: '',
    toDate: '',
    loanName: '',
    status: ''
  };
  
  // Reset input fields if exist
  if (document.getElementById('loanFromDate')) document.getElementById('loanFromDate').value = '';
  if (document.getElementById('loanToDate')) document.getElementById('loanToDate').value = '';
  if (document.getElementById('loanNameFilter')) document.getElementById('loanNameFilter').value = '';
  if (document.getElementById('loanStatusFilter')) document.getElementById('loanStatusFilter').value = '';
  
  loanFilteredData = allLoanData.slice();
  loanCurrentPage = 1;
  
  renderLoanPage();
}

/**
 * Change items per page
 */
function changeLoanItemsPerPage(value) {
  loanItemsPerPage = parseInt(value);
  loanCurrentPage = 1;
  renderLoanPage();
}

/**
 * Go to specific page
 * @param {number} page - Page number
 */
function loanGoToPage(page) {
  loanCurrentPage = page;
  renderLoanPage();
  window.scrollTo(0, 0);
}


/**
 * Render loan table with pagination + TOTALS ROW
 * @return {string} HTML table rows
 */
function renderLoanTableWithPagination() {
  console.log('Rendering loan table, filtered data:', loanFilteredData.length);
  
  if (!loanFilteredData || loanFilteredData.length === 0) {
    return '<tr><td colspan="11" class="text-center" style="padding: 40px; color: #9ca3af;">' +
      '<i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>' +
      '<div>Ch∆∞a c√≥ kho·∫£n vay n√†o</div>' +
      '</td></tr>';
  }
  
  var startIndex = (loanCurrentPage - 1) * loanItemsPerPage;
  var endIndex = Math.min(startIndex + loanItemsPerPage, loanFilteredData.length);
  
  console.log('Rendering from', startIndex, 'to', endIndex);
  
  // Calculate totals for ALL filtered data (not just current page)
  var totalPrincipal = 0;
  var totalMonthlyPrincipal = 0;
  var totalMonthlyInterest = 0;
  var totalPaidPrincipal = 0;
  var totalRemaining = 0;
  
  for (var i = 0; i < loanFilteredData.length; i++) {
    totalPrincipal += parseCurrency(loanFilteredData[i]['Gi√° tr·ªã vay']);
    totalMonthlyPrincipal += parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng']);
    totalMonthlyInterest += parseCurrency(loanFilteredData[i]['Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng']);
    totalPaidPrincipal += parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']);
    totalRemaining += parseCurrency(loanFilteredData[i]['Ti·ªÅn vay c√≤n l·∫°i']);
  }
  
  var html = '';
  
  // Render data rows
  for (var i = startIndex; i < endIndex; i++) {
    var item = loanFilteredData[i];
    var id = item.ID || 'N/A';
    
    console.log('Rendering loan item:', item);
    
    // Parse values
    var loanName = item['Danh m·ª•c vay'] || 'N/A';
    var loanDate = item['Ng√†y vay'] || '';
    var dueDate = item['H·∫°n tr·∫£ vay'] || '';
    var principal = parseCurrency(item['Gi√° tr·ªã vay']);
    var annualRate = parseFloat(item['L√£i su·∫•t vay/nƒÉm']) || 0;
    var monthlyPrincipal = parseCurrency(item['Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng']);
    var monthlyInterest = parseCurrency(item['Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng']);
    var paidPrincipal = parseCurrency(item['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']);
    var remaining = parseCurrency(item['Ti·ªÅn vay c√≤n l·∫°i']);
    var status = item['T√¨nh tr·∫°ng'] || 'active';
    
    // Status badge
    var statusBadge = 'badge-info';
    var statusText = 'ƒêang vay';
    var statusIcon = 'fa-clock';
    
    if (status === 'completed') {
      statusBadge = 'badge-success';
      statusText = 'ƒê√£ tr·∫£ h·∫øt';
      statusIcon = 'fa-check-circle';
    } else if (status === 'overdue') {
      statusBadge = 'badge-danger';
      statusText = 'Qu√° h·∫°n';
      statusIcon = 'fa-exclamation-triangle';
    }
    
    // Progress calculation
    var progress = principal > 0 ? Math.round((paidPrincipal / principal) * 100) : 0;
    var progressColor = progress >= 100 ? '#24c560' : progress >= 75 ? '#3782f4' : progress >= 50 ? '#f59e0b' : '#e94849';
    
    html += '<tr>' +
      // Danh m·ª•c vay (sticky column)
      '<td class="sticky-column" style="font-weight: 600;">' + loanName + '</td>' +
      
      // Ng√†y vay
      '<td>' + formatDate(loanDate) + '</td>' +
      
      // H·∫°n tr·∫£
      '<td>' + formatDate(dueDate) + '</td>' +
      
      // Gi√° tr·ªã vay
      '<td style="color: #e94849; font-weight: 600;">' + formatCurrency(principal) + ' ƒë</td>' +
      
      // L√£i su·∫•t
      '<td>' + annualRate.toFixed(2) + '%/nƒÉm</td>' +
      
      // G·ªëc/th√°ng
      '<td style="color: #3782f4; font-weight: 600;">' + formatCurrency(monthlyPrincipal) + ' ƒë</td>' +
      
      // L√£i/th√°ng
      '<td style="color: #f59e0b; font-weight: 600;">' + formatCurrency(monthlyInterest) + ' ƒë</td>' +
      
      // G·ªëc ƒë√£ tr·∫£ + Progress bar
      '<td>' +
      '<div style="margin-bottom: 5px; font-weight: 600; color: #24c560;">' + formatCurrency(paidPrincipal) + ' ƒë</div>' +
      '<div style="width: 100%; background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden;">' +
      '<div style="background: ' + progressColor + '; width: ' + Math.min(progress, 100) + '%; height: 100%;"></div>' +
      '</div>' +
      '<div style="font-size: 11px; color: #718096; margin-top: 2px;">' + progress + '%</div>' +
      '</td>' +
      
      // C√≤n l·∫°i
      '<td style="color: ' + (remaining > 0 ? '#e94849' : '#24c560') + '; font-weight: 600;">' + 
      formatCurrency(remaining) + ' ƒë</td>' +
      
      // T√¨nh tr·∫°ng
      '<td>' +
      '<span class="badge ' + statusBadge + '">' +
      '<i class="fas ' + statusIcon + '"></i> ' + statusText +
      '</span>' +
      '</td>' +
      
      // H√†nh ƒë·ªông
      '<td class="action-buttons" style="white-space: nowrap;">' +
      '<button class="btn-primary btn-sm" onclick="viewLoanDetails(\'' + id + '\')" title="Xem chi ti·∫øt">' +
      '<i class="fas fa-eye"></i>' +
      '</button>' +
      '<button class="btn-success btn-sm" onclick="markPayment(\'' + id + '\')" title="Thanh to√°n">' +
      '<i class="fas fa-money-bill"></i>' +
      '</button>' +
      '<button class="btn-warning btn-sm" onclick="editLoan(\'' + id + '\')" title="S·ª≠a">' +
      '<i class="fas fa-edit"></i>' +
      '</button>' +
      '<button class="btn-danger btn-sm" onclick="confirmDeleteLoan(\'' + id + '\')" title="X√≥a">' +
      '<i class="fas fa-trash"></i>' +
      '</button>' +
      '</td>' +
      '</tr>';
  }
  
  // TOTALS ROW
  html += '<tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; border-top: 3px solid #667eea;">' +
    '<td class="sticky-column" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700;">' +
    '<i class="fas fa-calculator"></i> T·ªîNG C·ªòNG' +
    '</td>' +
    '<td colspan="2" style="text-align: center;">' + loanFilteredData.length + ' kho·∫£n</td>' +
    '<td style="font-size: 15px;">' + formatCurrency(totalPrincipal) + ' ƒë</td>' +
    '<td></td>' +
    '<td style="font-size: 15px;">' + formatCurrency(totalMonthlyPrincipal) + ' ƒë</td>' +
    '<td style="font-size: 15px;">' + formatCurrency(totalMonthlyInterest) + ' ƒë</td>' +
    '<td style="font-size: 15px;">' + formatCurrency(totalPaidPrincipal) + ' ƒë</td>' +
    '<td style="font-size: 15px;">' + formatCurrency(totalRemaining) + ' ƒë</td>' +
    '<td colspan="2"></td>' +
    '</tr>';
  
  return html;
}

/**
 * Render loan pagination controls
 * @param {number} totalPages - Total number of pages
 * @return {string} HTML pagination
 */
function renderLoanPagination(totalPages) {
  if (totalPages <= 1) return '';
  
  var html = '<div style="display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px;">';
  
  // Previous button
  html += '<button class="btn-secondary btn-sm" onclick="loanGoToPage(' + (loanCurrentPage - 1) + ')" ' + 
    (loanCurrentPage === 1 ? 'disabled' : '') + '>' +
    '<i class="fas fa-chevron-left"></i>' +
    '</button>';
  
  // Page numbers
  var startPage = Math.max(1, loanCurrentPage - 2);
  var endPage = Math.min(totalPages, loanCurrentPage + 2);
  
  if (startPage > 1) {
    html += '<button class="btn-secondary btn-sm" onclick="loanGoToPage(1)">1</button>';
    if (startPage > 2) html += '<span style="padding: 0 10px; color: #718096;">...</span>';
  }
  
  for (var i = startPage; i <= endPage; i++) {
    if (i === loanCurrentPage) {
      html += '<button class="btn-primary btn-sm" disabled>' + i + '</button>';
    } else {
      html += '<button class="btn-secondary btn-sm" onclick="loanGoToPage(' + i + ')">' + i + '</button>';
    }
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span style="padding: 0 10px; color: #718096;">...</span>';
    html += '<button class="btn-secondary btn-sm" onclick="loanGoToPage(' + totalPages + ')">' + totalPages + '</button>';
  }
  
  // Next button
  html += '<button class="btn-secondary btn-sm" onclick="loanGoToPage(' + (loanCurrentPage + 1) + ')" ' + 
    (loanCurrentPage === totalPages ? 'disabled' : '') + '>' +
    '<i class="fas fa-chevron-right"></i>' +
    '</button>';
  
  html += '</div>';
  
  return html;
}

// ========================================
// LOAN MODAL - ADD/EDIT WITH CALCULATOR
// ========================================

/**
 * Open loan modal for add/edit
 * @param {string} id - Loan ID (null for add new)
 */
function openLoanModal(id) {
  console.log('=== OPENING LOAN MODAL ===', id ? 'EDIT' : 'CREATE');
  
  var isEdit = !!id;
  var item = {};
  
  if (isEdit) {
    const loanList = DataManager.isInitialized && DataManager.isInitialized() ? 
      DataManager.getLoan() : allLoanData;
    item = loanList.find(function(i) { return i.ID === id; }) || {};
    
    if (!item.ID) {
      showToast('Kh√¥ng t√¨m th·∫•y kho·∫£n vay', 'error');
      return;
    }
  }
  
  // Parse existing data
  var loanName = item['Danh m·ª•c vay'] || '';
  var loanDate = item['Ng√†y vay'] || new Date().toISOString().split('T')[0];
  var principal = isEdit ? parseCurrency(item['Gi√° tr·ªã vay']) : 0;
  var annualRate = isEdit ? parseFloat(item['L√£i su·∫•t vay/nƒÉm']) : 0;
  var months = 12; // Default
  var interestType = 'declining'; // Default
  
  // Parse details to get months and interest type
  if (isEdit && item['Chi ti·∫øt kho·∫£n vay']) {
    try {
      var details = typeof item['Chi ti·∫øt kho·∫£n vay'] === 'string' ? 
        JSON.parse(item['Chi ti·∫øt kho·∫£n vay']) : item['Chi ti·∫øt kho·∫£n vay'];
      
      if (details) {
        months = details.months || 12;
        interestType = details.interestType || 'declining';
      }
    } catch(e) {
      console.error('Parse details error:', e);
    }
  }
  
  // Build modal HTML
  var body = 
    '<form id="loanForm" onsubmit="handleSaveLoan(event, \'' + (id || '') + '\')">' +
    
    // Basic Info
    '<div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #3782f4;">' +
    '<h4 style="margin: 0 0 10px 0; color: #1e40af;"><i class="fas fa-info-circle"></i> Th√¥ng tin c∆° b·∫£n</h4>' +
    
    '<div class="form-row">' +
    '<div class="form-group">' +
    '<label><i class="fas fa-tag"></i> T√™n kho·∫£n vay <span style="color: red;">*</span></label>' +
    '<input type="text" id="loanName" name="Danh m·ª•c vay" class="form-control" value="' + loanName + '" ' +
    'placeholder="VD: Vay mua nh√†, Vay ti√™u d√πng..." required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-calendar"></i> Ng√†y vay <span style="color: red;">*</span></label>' +
    '<input type="date" id="loanDate" name="Ng√†y vay" class="form-control" value="' + loanDate + '" required>' +
    '</div>' +
    '</div>' +
    
    '</div>' +
    
    // Loan Calculation
    '<div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #f59e0b;">' +
    '<h4 style="margin: 0 0 10px 0; color: #92400e;"><i class="fas fa-calculator"></i> T√≠nh to√°n kho·∫£n vay</h4>' +
    
    '<div class="form-row">' +
    '<div class="form-group">' +
    '<label><i class="fas fa-money-bill-wave"></i> S·ªë ti·ªÅn vay (VNƒê) <span style="color: red;">*</span></label>' +
    '<input type="text" id="loanPrincipal" class="form-control currency-input" value="' + 
    (isEdit ? formatCurrency(principal) : '0') + '" required oninput="calculateLoanPreview()">' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-percentage"></i> L√£i su·∫•t (%/nƒÉm) <span style="color: red;">*</span></label>' +
    '<input type="number" id="loanRate" class="form-control" value="' + annualRate + '" ' +
    'step="0.01" min="0" max="100" required oninput="calculateLoanPreview()">' +
    '</div>' +
    '</div>' +
    
    '<div class="form-row">' +
    '<div class="form-group">' +
    '<label><i class="fas fa-clock"></i> K·ª≥ h·∫°n (th√°ng) <span style="color: red;">*</span></label>' +
    '<input type="number" id="loanMonths" class="form-control" value="' + months + '" ' +
    'min="1" max="360" required oninput="calculateLoanPreview()">' +
    '<small style="color: #78350f;">T·ªëi ƒëa 360 th√°ng (30 nƒÉm)</small>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-chart-line"></i> H√¨nh th·ª©c l√£i su·∫•t <span style="color: red;">*</span></label>' +
    '<select id="loanInterestType" class="form-control" onchange="calculateLoanPreview()">' +
    '<option value="declining"' + (interestType === 'declining' ? ' selected' : '') + '>L√£i gi·∫£m d·∫ßn (Ph·ªï bi·∫øn nh·∫•t)</option>' +
    '<option value="simple"' + (interestType === 'simple' ? ' selected' : '') + '>L√£i ƒë∆°n</option>' +
    '<option value="compound"' + (interestType === 'compound' ? ' selected' : '') + '>L√£i k√©p</option>' +
    '</select>' +
    '<small id="interestTypeDescription" style="color: #78350f; display: block; margin-top: 5px;"></small>' +
    '</div>' +
    '</div>' +
    
    '</div>' +
    
    // Preview Results
    '<div id="loanPreview" style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #24c560; display: none;">' +
    '<h4 style="margin: 0 0 15px 0; color: #166534;"><i class="fas fa-chart-bar"></i> D·ª± t√≠nh tr·∫£ n·ª£</h4>' +
    
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">' +
    '<div style="background: white; padding: 12px; border-radius: 8px;">' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">G·ªëc h√†ng th√°ng</div>' +
    '<div id="previewMonthlyPrincipal" style="font-size: 18px; font-weight: 700; color: #3782f4;">0 ƒë</div>' +
    '</div>' +
    
    '<div style="background: white; padding: 12px; border-radius: 8px;">' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">L√£i h√†ng th√°ng</div>' +
    '<div id="previewMonthlyInterest" style="font-size: 18px; font-weight: 700; color: #f59e0b;">0 ƒë</div>' +
    '</div>' +
    
    '<div style="background: white; padding: 12px; border-radius: 8px;">' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">T·ªïng tr·∫£ h√†ng th√°ng</div>' +
    '<div id="previewMonthlyTotal" style="font-size: 18px; font-weight: 700; color: #24c560;">0 ƒë</div>' +
    '</div>' +
    
    '<div style="background: white; padding: 12px; border-radius: 8px;">' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">T·ªïng l√£i ph·∫£i tr·∫£</div>' +
    '<div id="previewTotalInterest" style="font-size: 18px; font-weight: 700; color: #e94849;">0 ƒë</div>' +
    '</div>' +
    '</div>' +
    
    '</div>' +
    
    // Important Notes
    '<div style="background: #fffbeb; padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b;">' +
    '<strong style="color: #92400e;"><i class="fas fa-lightbulb"></i> L∆∞u √Ω:</strong>' +
    '<ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: #78350f;">' +
    '<li><strong>L√£i gi·∫£m d·∫ßn:</strong> L√£i t√≠nh tr√™n s·ªë d∆∞ n·ª£ c√≤n l·∫°i ‚Üí Ph·ªï bi·∫øn nh·∫•t (ng√¢n h√†ng, mua nh√†)</li>' +
    '<li><strong>L√£i ƒë∆°n:</strong> L√£i t√≠nh c·ªë ƒë·ªãnh tr√™n g·ªëc ban ƒë·∫ßu ‚Üí D·ªÖ t√≠nh, ·ªïn ƒë·ªãnh</li>' +
    '<li><strong>L√£i k√©p:</strong> L√£i t√≠nh tr√™n c·∫£ g·ªëc + l√£i t√≠ch l≈©y ‚Üí Chi ph√≠ cao nh·∫•t</li>' +
    '<li>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o l·ªãch tr·∫£ n·ª£ chi ti·∫øt sau khi l∆∞u</li>' +
    '</ul>' +
    '</div>' +
    
    '</form>';
  
  var footer = 
    '<button type="button" class="btn-secondary" onclick="closeModal()">' +
    '<i class="fas fa-times"></i> H·ªßy' +
    '</button>' +
    '<button type="button" class="btn-primary" onclick="document.getElementById(\'loanForm\').requestSubmit()">' +
    '<i class="fas fa-save"></i> ' + (isEdit ? 'C·∫≠p nh·∫≠t' : 'T·∫°o kho·∫£n vay') +
    '</button>';
  
  openModal(
    isEdit ? '‚úèÔ∏è S·ª≠a kho·∫£n vay' : '‚ûï Th√™m kho·∫£n vay m·ªõi', 
    body, 
    footer
  );
  
  // Initialize after modal opens
  setTimeout(function() {
    console.log('üîß Initializing loan modal...');
    
    // Setup currency input
    setupCurrencyInput(document.getElementById('loanPrincipal'));
    
    // Calculate preview if editing
    if (isEdit) {
      calculateLoanPreview();
    }
    
    // Update interest type description
    updateInterestTypeDescription();
    
    // Focus first input
    document.getElementById('loanName').focus();
    
    console.log('‚úÖ Loan modal initialized');
  }, 100);
}

/**
 * Calculate loan preview in real-time
 */
function calculateLoanPreview() {
  var principal = parseCurrency(document.getElementById('loanPrincipal').value);
  var annualRate = parseFloat(document.getElementById('loanRate').value) || 0;
  var months = parseInt(document.getElementById('loanMonths').value) || 0;
  var interestType = document.getElementById('loanInterestType').value;
  
  if (principal <= 0 || months <= 0) {
    document.getElementById('loanPreview').style.display = 'none';
    return;
  }
  
  // Calculate based on interest type
  var monthlyPrincipal = 0;
  var monthlyInterest = 0;
  var totalInterest = 0;
  
  if (interestType === 'declining') {
    // L√£i gi·∫£m d·∫ßn: PMT formula
    if (annualRate === 0) {
      monthlyPrincipal = Math.round(principal / months);
      monthlyInterest = 0;
      totalInterest = 0;
    } else {
      var monthlyRate = annualRate / 12 / 100;
      var monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                          (Math.pow(1 + monthlyRate, months) - 1);
      
      monthlyPayment = Math.round(monthlyPayment);
      
      // Estimate average interest (first month)
      monthlyInterest = Math.round(principal * monthlyRate);
      monthlyPrincipal = monthlyPayment - monthlyInterest;
      
      // Total interest = total payment - principal
      totalInterest = Math.round(monthlyPayment * months - principal);
    }
    
  } else if (interestType === 'simple') {
    // L√£i ƒë∆°n
    totalInterest = Math.round(principal * (annualRate / 100) * (months / 12));
    var totalPayment = principal + totalInterest;
    var monthlyPayment = Math.round(totalPayment / months);
    monthlyPrincipal = Math.round(principal / months);
    monthlyInterest = Math.round(totalInterest / months);
    
  } else if (interestType === 'compound') {
    // L√£i k√©p
    var monthlyRate = annualRate / 12 / 100;
    var futureValue = principal * Math.pow(1 + monthlyRate, months);
    totalInterest = Math.round(futureValue - principal);
    var monthlyPayment = Math.round(futureValue / months);
    monthlyPrincipal = Math.round(principal / months);
    monthlyInterest = Math.round(totalInterest / months);
  }
  
  // Update UI
  document.getElementById('loanPreview').style.display = 'block';
  document.getElementById('previewMonthlyPrincipal').textContent = formatCurrency(monthlyPrincipal) + ' ƒë';
  document.getElementById('previewMonthlyInterest').textContent = formatCurrency(monthlyInterest) + ' ƒë';
  document.getElementById('previewMonthlyTotal').textContent = formatCurrency(monthlyPrincipal + monthlyInterest) + ' ƒë';
  document.getElementById('previewTotalInterest').textContent = formatCurrency(totalInterest) + ' ƒë';
  
  console.log('Preview calculated:', {
    principal: principal,
    rate: annualRate,
    months: months,
    type: interestType,
    monthlyPrincipal: monthlyPrincipal,
    monthlyInterest: monthlyInterest,
    totalInterest: totalInterest
  });
}

/**
 * Update interest type description
 */
function updateInterestTypeDescription() {
  var interestType = document.getElementById('loanInterestType').value;
  var desc = '';
  
  if (interestType === 'declining') {
    desc = '‚úÖ ƒê∆∞·ª£c khuy√™n d√πng - L√£i gi·∫£m d·∫ßn theo s·ªë n·ª£ c√≤n l·∫°i';
  } else if (interestType === 'simple') {
    desc = 'L√£i t√≠nh c·ªë ƒë·ªãnh tr√™n s·ªë g·ªëc ban ƒë·∫ßu';
  } else if (interestType === 'compound') {
    desc = '‚ö†Ô∏è Chi ph√≠ cao - L√£i t√≠nh tr√™n c·∫£ g·ªëc v√† l√£i t√≠ch l≈©y';
  }
  
  var descEl = document.getElementById('interestTypeDescription');
  if (descEl) {
    descEl.textContent = desc;
  }
  
  // Trigger preview recalculation
  calculateLoanPreview();
}

// ========================================
// SAVE LOAN - CREATE/UPDATE WITH SCHEDULE
// ========================================

/**
 * Handle save loan (create or update)
 * @param {Event} event - Form submit event
 * @param {string} id - Loan ID (empty for create)
 */
async function handleSaveLoan(event, id) {
  event.preventDefault();
  
  console.log('=== SAVING LOAN ===', id ? 'UPDATE' : 'CREATE');
  
  // Collect form data
  var loanName = document.getElementById('loanName').value.trim();
  var loanDate = document.getElementById('loanDate').value;
  var principal = parseCurrency(document.getElementById('loanPrincipal').value);
  var annualRate = parseFloat(document.getElementById('loanRate').value);
  var months = parseInt(document.getElementById('loanMonths').value);
  var interestType = document.getElementById('loanInterestType').value;
  
  // Validate
  if (!loanName || !loanDate || principal <= 0 || annualRate < 0 || months <= 0) {
    showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
    return;
  }
  
  console.log('Loan data:', {
    name: loanName,
    date: loanDate,
    principal: principal,
    rate: annualRate,
    months: months,
    type: interestType
  });
  
  closeModal();
  showLoading('ƒêang t√≠nh to√°n l·ªãch tr·∫£ n·ª£...');
  
  try {
    // Step 1: Calculate loan schedule from backend
    console.log('Step 1: Calling backend to calculate schedule...');
    
    const scheduleResponse = await new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .handleRequest('calculateLoanSchedule', {
          loanData: {
            principal: principal,
            annualRate: annualRate,
            months: months,
            interestType: interestType,
            startDate: loanDate
          }
        });
    });
    
    console.log('Schedule response:', scheduleResponse);
    
    if (!scheduleResponse.success) {
      throw new Error(scheduleResponse.message || 'Kh√¥ng th·ªÉ t√≠nh l·ªãch tr·∫£ n·ª£');
    }
    
    const schedule = scheduleResponse.data;
    console.log('Schedule calculated:', schedule.length, 'periods');
    
    // Calculate monthly amounts from schedule
    var firstPeriod = schedule[0];
    var monthlyPrincipal = firstPeriod.principalPayment || 0;
    var monthlyInterest = firstPeriod.interestPayment || 0;
    
    // Calculate due date (last period)
    var lastPeriod = schedule[schedule.length - 1];
    var dueDate = lastPeriod.dueDate;
    
    console.log('Calculated:', {
      monthlyPrincipal: monthlyPrincipal,
      monthlyInterest: monthlyInterest,
      dueDate: dueDate
    });
    
    // Step 2: Build record data
    var recordData = {
      'ID': id || generateId('KV'),
      'UserID': currentUser.userId,
      'Ng√†y vay': loanDate,
      'H·∫°n tr·∫£ vay': dueDate,
      'Danh m·ª•c vay': loanName,
      'Gi√° tr·ªã vay': principal,
      'L√£i su·∫•t vay/nƒÉm': annualRate,
      'Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng': monthlyPrincipal,
      'Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng': monthlyInterest,
      'Ti·ªÅn g·ªëc ƒë√£ tr·∫£': 0,
      'Ti·ªÅn vay c√≤n l·∫°i': principal,
      'T√¨nh tr·∫°ng': 'active',
      'Chi ti·∫øt kho·∫£n vay': JSON.stringify({
        months: months,
        interestType: interestType,
        schedule: schedule,
        createdAt: new Date().toISOString()
      })
    };
    
    console.log('Record data:', recordData);
    
    // Step 3: Save to backend
    console.log('Step 2: Saving to backend...');
    
    var action = id ? 'updateRecord' : 'createRecord';
    var params = id ? 
      {sheetName: 'Kho·∫£n vay', id: id, data: recordData} : 
      {sheetName: 'Kho·∫£n vay', data: recordData};
    
    const saveResponse = await new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .handleRequest(action, params);
    });
    
    console.log('Save response:', saveResponse);
    
    if (!saveResponse.success) {
      throw new Error(saveResponse.message || 'Kh√¥ng th·ªÉ l∆∞u kho·∫£n vay');
    }
    
    // Step 4: Reload data
    console.log('Step 3: Reloading loan data...');
    await reloadLoanData();
    
    hideLoading();
    showToast('‚úÖ ƒê√£ ' + (id ? 'c·∫≠p nh·∫≠t' : 't·∫°o') + ' kho·∫£n vay th√†nh c√¥ng!', 'success');
    
    console.log('‚úÖ Save loan completed');
    
  } catch (error) {
    console.error('‚ùå Save loan error:', error);
    hideLoading();
    showToast('L·ªói: ' + error.message, 'error');
  }
}

/**
 * Reload loan data from backend
 */
async function reloadLoanData() {
  try {
    console.log('Reloading loan data...');
    
    // Use DataManager if available
    if (DataManager && DataManager.isInitialized && DataManager.isInitialized()) {
      await DataManager.refresh('Kho·∫£n vay');
      allLoanData = DataManager.getLoan();
    } else {
      // Fallback to direct load
      const result = await new Promise(function(resolve, reject) {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getRecords('Kho·∫£n vay');
      });
      
      if (result.success) {
        allLoanData = result.data;
      }
    }
    
    loanFilteredData = allLoanData.slice();
    loanCurrentPage = 1;
    
    console.log('‚úÖ Loan data reloaded:', allLoanData.length, 'records');
    
    renderLoanPage();
    
  } catch (error) {
    console.error('Reload loan data error:', error);
    throw error;
  }
}

/**
 * Open edit loan modal
 * @param {string} id - Loan ID
 */
function editLoan(id) {
  openLoanModal(id);
}

/**
 * Confirm delete loan
 * @param {string} id - Loan ID
 */
function confirmDeleteLoan(id) {
  var loan = null;
  var loanList = DataManager.isInitialized && DataManager.isInitialized() ? 
    DataManager.getLoan() : allLoanData;
  
  for (var i = 0; i < loanList.length; i++) {
    if (loanList[i].ID === id) {
      loan = loanList[i];
      break;
    }
  }
  
  if (!loan) {
    showToast('Kh√¥ng t√¨m th·∫•y kho·∫£n vay', 'error');
    return;
  }
  
  var body = '<div style="padding: 20px; text-align: center;">' +
    '<i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f59e0b; margin-bottom: 15px;"></i>' +
    '<p style="font-size: 16px; color: #1f2937; margin-bottom: 10px;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kho·∫£n vay:</p>' +
    '<p style="font-size: 18px; font-weight: 600; color: #e94849; margin-bottom: 20px;">"' + loan['Danh m·ª•c vay'] + '"?</p>' +
    '<p style="color: #e94849;">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>' +
    '</div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-danger" onclick="executeDeleteLoan(\'' + id + '\')">X√≥a</button>';
  
  openModal('‚ö†Ô∏è X√°c nh·∫≠n x√≥a', body, footer);
}

/**
 * Execute delete loan
 * @param {string} id - Loan ID
 */
function executeDeleteLoan(id) {
  closeModal();
  showLoading('ƒêang x√≥a...');
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        reloadLoanData().then(function() {
          hideLoading();
          showToast('‚úÖ ƒê√£ x√≥a kho·∫£n vay', 'success');
        }).catch(function(error) {
          hideLoading();
          showToast('L·ªói t·∫£i l·∫°i d·ªØ li·ªáu', 'error');
        });
      } else {
        hideLoading();
        showToast(response.message || 'X√≥a th·∫•t b·∫°i', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('deleteRecord', {sheetName: 'Kho·∫£n vay', id: id});
}



// ========================================
// VIEW LOAN DETAILS - PAYMENT SCHEDULE
// ========================================

/**
 * View loan details with payment schedule
 * @param {string} id - Loan ID
 */
function viewLoanDetails(id) {
  console.log('=== VIEW LOAN DETAILS ===', id);
  
  var loanList = DataManager.isInitialized && DataManager.isInitialized() ? 
    DataManager.getLoan() : allLoanData;
  
  var loan = null;
  for (var i = 0; i < loanList.length; i++) {
    if (loanList[i].ID === id) {
      loan = loanList[i];
      break;
    }
  }
  
  if (!loan) {
    showToast('Kh√¥ng t√¨m th·∫•y kho·∫£n vay', 'error');
    return;
  }
  
  // Parse details
  var details = null;
  try {
    details = typeof loan['Chi ti·∫øt kho·∫£n vay'] === 'string' ? 
      JSON.parse(loan['Chi ti·∫øt kho·∫£n vay']) : loan['Chi ti·∫øt kho·∫£n vay'];
  } catch(e) {
    showToast('Kh√¥ng th·ªÉ ƒë·ªçc chi ti·∫øt kho·∫£n vay', 'error');
    return;
  }
  
  if (!details || !details.schedule) {
    showToast('Kh√¥ng c√≥ l·ªãch tr·∫£ n·ª£', 'error');
    return;
  }
  
  var schedule = details.schedule;
  var interestType = details.interestType || 'declining';
  
  // Interest type label
  var interestTypeLabel = interestType === 'declining' ? 'L√£i gi·∫£m d·∫ßn' : 
    interestType === 'simple' ? 'L√£i ƒë∆°n' : 'L√£i k√©p';
  
  // Calculate totals
  var totalPrincipal = 0;
  var totalInterest = 0;
  var totalPayment = 0;
  var paidCount = 0;
  
  for (var i = 0; i < schedule.length; i++) {
    totalPrincipal += schedule[i].principalPayment;
    totalInterest += schedule[i].interestPayment;
    totalPayment += schedule[i].totalPayment;
    if (schedule[i].status === 'paid') paidCount++;
  }
  
  // Build modal HTML
  var body = 
    // Loan Info
    '<div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3782f4;">' +
    '<h4 style="margin: 0 0 15px 0; color: #1e40af; font-size: 18px;">' +
    '<i class="fas fa-info-circle"></i> Th√¥ng tin kho·∫£n vay' +
    '</h4>' +
    
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">' +
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">T√™n kho·∫£n vay</div>' +
    '<div style="font-weight: 600; color: #1f2937; font-size: 15px;">' + loan['Danh m·ª•c vay'] + '</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">Gi√° tr·ªã vay</div>' +
    '<div style="font-weight: 700; color: #e94849; font-size: 16px;">' + formatCurrency(loan['Gi√° tr·ªã vay']) + ' ƒë</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">L√£i su·∫•t</div>' +
    '<div style="font-weight: 600; color: #f59e0b; font-size: 15px;">' + loan['L√£i su·∫•t vay/nƒÉm'] + '%/nƒÉm</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">H√¨nh th·ª©c l√£i</div>' +
    '<div style="font-weight: 600; color: #3782f4; font-size: 15px;">' + interestTypeLabel + '</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">Ng√†y vay</div>' +
    '<div style="font-weight: 600; font-size: 15px;">' + formatDate(loan['Ng√†y vay']) + '</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">H·∫°n tr·∫£</div>' +
    '<div style="font-weight: 600; font-size: 15px;">' + formatDate(loan['H·∫°n tr·∫£ vay']) + '</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">G·ªëc ƒë√£ tr·∫£</div>' +
    '<div style="font-weight: 700; color: #24c560; font-size: 16px;">' + formatCurrency(loan['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']) + ' ƒë</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">C√≤n l·∫°i</div>' +
    '<div style="font-weight: 700; color: #e94849; font-size: 16px;">' + formatCurrency(loan['Ti·ªÅn vay c√≤n l·∫°i']) + ' ƒë</div>' +
    '</div>' +
    '</div>' +
    '</div>' +
    
    // Payment Schedule Table
    '<div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">' +
    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">' +
    '<h4 style="margin: 0; color: #92400e; font-size: 18px;">' +
    '<i class="fas fa-calendar-alt"></i> L·ªãch tr·∫£ n·ª£ (' + schedule.length + ' k·ª≥)' +
    '</h4>' +
    '<div style="font-size: 14px; color: #92400e;">' +
    '<strong>ƒê√£ thanh to√°n: ' + paidCount + '/' + schedule.length + '</strong>' +
    '</div>' +
    '</div>' +
    
    '<div class="loan-schedule-table">' +
    '<table>' +
    '<thead>' +
    '<tr>' +
    '<th class="sticky-period-col" style="text-align: center; width: 50px;">K·ª≥</th>' +
    '<th class="sticky-date-col" style="text-align: left; width: 120px;">H·∫°n tr·∫£</th>' +
    '<th style="text-align: right; min-width: 100px;">G·ªëc</th>' +
    '<th style="text-align: right; min-width: 100px;">L√£i</th>' +
    '<th style="text-align: right; min-width: 120px;">T·ªïng tr·∫£</th>' +
    '<th style="text-align: right; min-width: 100px;">D∆∞ n·ª£</th>' +
    '<th style="text-align: center; min-width: 100px;">Tr·∫°ng th√°i</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody>';
  
  for (var i = 0; i < schedule.length; i++) {
    var period = schedule[i];
    var isPaid = period.status === 'paid';
    var rowClass = isPaid ? 'paid-row' : '';
    
    body += '<tr class="' + rowClass + '">' +
      '<td class="sticky-period-col" style="text-align: center;">' + period.period + '</td>' +
      '<td class="sticky-date-col">' + formatDate(period.dueDate) + '</td>' +
      '<td style="text-align: right; color: #3782f4; font-weight: 600;">' + formatCurrency(period.principalPayment) + '</td>' +
      '<td style="text-align: right; color: #f59e0b; font-weight: 600;">' + formatCurrency(period.interestPayment) + '</td>' +
      '<td style="text-align: right; font-weight: 700;">' + formatCurrency(period.totalPayment) + '</td>' +
      '<td style="text-align: right; color: #e94849; font-weight: 600;">' + formatCurrency(period.remainingPrincipal) + '</td>' +
      '<td style="text-align: center;">' +
      (isPaid ? 
        '<span class="badge badge-success"><i class="fas fa-check"></i> ƒê√£ tr·∫£</span>' :
        '<button class="btn-success btn-sm" onclick="markPaymentInModal(\'' + id + '\', ' + period.period + ')" style="padding: 5px 10px; font-size: 12px;">' +
        '<i class="fas fa-money-bill-wave"></i> Thanh to√°n' +
        '</button>') +
      '</td>' +
      '</tr>';
  }
  
  // Totals row
  body += '<tr style="background: #fff3cd; font-weight: 700; border-top: 3px solid #fbbf24;">' +
    '<td class="sticky-period-col" style="text-align: center;">T·ªïng</td>' +
    '<td class="sticky-date-col"></td>' +
    '<td style="text-align: right; color: #3782f4;">' + formatCurrency(totalPrincipal) + '</td>' +
    '<td style="text-align: right; color: #f59e0b;">' + formatCurrency(totalInterest) + '</td>' +
    '<td style="text-align: right; color: #1f2937;">' + formatCurrency(totalPayment) + '</td>' +
    '<td colspan="2"></td>' +
    '</tr>';
  
  body += '</tbody></table></div></div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()"><i class="fas fa-times"></i> ƒê√≥ng</button>';
  
  // Open modal with LARGE class
  openModal('üìã Chi ti·∫øt kho·∫£n vay', body, footer);
  
  // Add large class to modal after opening
  setTimeout(function() {
    var modalContent = document.querySelector('.modal-content');
    if (modalContent) {
      modalContent.classList.add('modal-large');
    }
  }, 50);
}

/**
 * Mark payment as paid from detail modal
 * @param {string} loanId - Loan ID
 * @param {number} period - Payment period
 */
function markPaymentInModal(loanId, period) {
  console.log('Mark payment in modal:', loanId, period);
  
  // Get loan data
  var loanList = DataManager.isInitialized && DataManager.isInitialized() ? 
    DataManager.getLoan() : allLoanData;
  
  var loan = null;
  for (var i = 0; i < loanList.length; i++) {
    if (loanList[i].ID === loanId) {
      loan = loanList[i];
      break;
    }
  }
  
  if (!loan) {
    showToast('Kh√¥ng t√¨m th·∫•y kho·∫£n vay', 'error');
    return;
  }
  
  // Parse details
  var details = null;
  try {
    details = typeof loan['Chi ti·∫øt kho·∫£n vay'] === 'string' ? 
      JSON.parse(loan['Chi ti·∫øt kho·∫£n vay']) : loan['Chi ti·∫øt kho·∫£n vay'];
  } catch(e) {
    showToast('Kh√¥ng th·ªÉ ƒë·ªçc chi ti·∫øt', 'error');
    return;
  }
  
  // Find payment
  var payment = null;
  for (var i = 0; i < details.schedule.length; i++) {
    if (details.schedule[i].period === period) {
      payment = details.schedule[i];
      break;
    }
  }
  
  if (!payment) {
    showToast('Kh√¥ng t√¨m th·∫•y k·ª≥ thanh to√°n', 'error');
    return;
  }
  
  // Close detail modal first
  closeModal();
  
  // Wait a bit then open payment confirm modal
  setTimeout(function() {
    // Build payment confirm modal
    var body = '<div style="padding: 20px;">' +
      '<div style="text-align: center; margin-bottom: 20px;">' +
      '<i class="fas fa-money-bill-wave" style="font-size: 48px; color: #24c560; margin-bottom: 10px;"></i>' +
      '<h3 style="margin: 10px 0; color: #1f2937;">X√°c nh·∫≠n thanh to√°n k·ª≥ ' + payment.period + '</h3>' +
      '<p style="color: #6b7280;">Kho·∫£n vay: <strong>' + loan['Danh m·ª•c vay'] + '</strong></p>' +
      '</div>' +
      
      '<div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
      '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">' +
      '<div>' +
      '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">H·∫°n tr·∫£</div>' +
      '<div style="font-weight: 600; color: #1f2937;">' + formatDate(payment.dueDate) + '</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Ti·ªÅn g·ªëc</div>' +
      '<div style="font-weight: 600; color: #3782f4;">' + formatCurrency(payment.principalPayment) + ' ƒë</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Ti·ªÅn l√£i</div>' +
      '<div style="font-weight: 600; color: #f59e0b;">' + formatCurrency(payment.interestPayment) + ' ƒë</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">T·ªïng thanh to√°n</div>' +
      '<div style="font-weight: 700; color: #24c560; font-size: 18px;">' + formatCurrency(payment.totalPayment) + ' ƒë</div>' +
      '</div>' +
      '</div>' +
      '</div>' +
      
      '<div style="background: #fffbeb; padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b;">' +
      '<p style="margin: 0; color: #92400e; font-size: 14px;">' +
      '<i class="fas fa-info-circle"></i> Sau khi thanh to√°n, s·ªë d∆∞ n·ª£ c√≤n l·∫°i s·∫Ω l√†: <strong>' + 
      formatCurrency(payment.remainingPrincipal) + ' ƒë</strong>' +
      '</p>' +
      '</div>' +
      '</div>';
    
    var footer = 
      '<button class="btn-secondary" onclick="closeModal(); setTimeout(function() { viewLoanDetails(\'' + loanId + '\'); }, 300);">H·ªßy</button>' +
      '<button class="btn-success" onclick="executeMarkPaymentFromDetail(\'' + loanId + '\', ' + payment.period + ')">' +
      '<i class="fas fa-check"></i> X√°c nh·∫≠n thanh to√°n' +
      '</button>';
    
    openModal('üí∞ Thanh to√°n k·ª≥ ' + payment.period, body, footer);
  }, 300);
}

/**
 * Execute mark payment from detail modal
 * @param {string} loanId - Loan ID
 * @param {number} period - Payment period
 */
function executeMarkPaymentFromDetail(loanId, period) {
  closeModal();
  showLoading('ƒêang c·∫≠p nh·∫≠t thanh to√°n...');
  
  console.log('Execute mark payment from detail:', loanId, period);
  
  google.script.run
    .withSuccessHandler(function(response) {
      console.log('Payment response:', response);
      
      if (!response) {
        hideLoading();
        showToast('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server', 'error');
        return;
      }
      
      if (response.success) {
        reloadLoanData().then(function() {
          hideLoading();
          showToast('‚úÖ ƒê√£ thanh to√°n k·ª≥ ' + period + ' th√†nh c√¥ng!', 'success');
          
          // Re-open detail modal
          setTimeout(function() {
            viewLoanDetails(loanId);
          }, 500);
        }).catch(function(error) {
          console.error('Reload error:', error);
          hideLoading();
          showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng nh∆∞ng kh√¥ng t·∫£i l·∫°i ƒë∆∞·ª£c d·ªØ li·ªáu', 'warning');
          setTimeout(function() { location.reload(); }, 2000);
        });
      } else {
        hideLoading();
        showToast(response.message || 'Thanh to√°n th·∫•t b·∫°i', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Payment error:', error);
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('markLoanPaymentAsPaid', {loanId: loanId, period: period});
}

/**
 * Mark payment from main table (quick payment)
 * @param {string} loanId - Loan ID
 */
function markPayment(loanId) {
  console.log('Quick mark payment for loan:', loanId);
  
  var loanList = DataManager.isInitialized && DataManager.isInitialized() ? 
    DataManager.getLoan() : allLoanData;
  
  var loan = null;
  for (var i = 0; i < loanList.length; i++) {
    if (loanList[i].ID === loanId) {
      loan = loanList[i];
      break;
    }
  }
  
  if (!loan) {
    showToast('Kh√¥ng t√¨m th·∫•y kho·∫£n vay', 'error');
    return;
  }
  
  // Parse details
  var details = null;
  try {
    details = typeof loan['Chi ti·∫øt kho·∫£n vay'] === 'string' ? 
      JSON.parse(loan['Chi ti·∫øt kho·∫£n vay']) : loan['Chi ti·∫øt kho·∫£n vay'];
  } catch(e) {
    showToast('Kh√¥ng th·ªÉ ƒë·ªçc chi ti·∫øt kho·∫£n vay', 'error');
    return;
  }
  
  if (!details || !details.schedule) {
    showToast('Kh√¥ng c√≥ l·ªãch tr·∫£ n·ª£', 'error');
    return;
  }
  
  // Find next unpaid period
  var nextPeriod = null;
  for (var i = 0; i < details.schedule.length; i++) {
    if (details.schedule[i].status !== 'paid') {
      nextPeriod = details.schedule[i];
      break;
    }
  }
  
  if (!nextPeriod) {
    showToast('Kho·∫£n vay ƒë√£ tr·∫£ h·∫øt', 'info');
    return;
  }
  
  // Build payment modal
  var body = '<div style="padding: 20px;">' +
    '<div style="text-align: center; margin-bottom: 20px;">' +
    '<i class="fas fa-money-bill-wave" style="font-size: 48px; color: #24c560; margin-bottom: 10px;"></i>' +
    '<h3 style="margin: 10px 0; color: #1f2937;">Thanh to√°n k·ª≥ ' + nextPeriod.period + '</h3>' +
    '<p style="color: #6b7280;">Kho·∫£n vay: <strong>' + loan['Danh m·ª•c vay'] + '</strong></p>' +
    '</div>' +
    
    '<div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">' +
    '<div>' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">H·∫°n tr·∫£</div>' +
    '<div style="font-weight: 600; color: #1f2937;">' + formatDate(nextPeriod.dueDate) + '</div>' +
    '</div>' +
    '<div>' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Ti·ªÅn g·ªëc</div>' +
    '<div style="font-weight: 600; color: #3782f4;">' + formatCurrency(nextPeriod.principalPayment) + ' ƒë</div>' +
    '</div>' +
    '<div>' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Ti·ªÅn l√£i</div>' +
    '<div style="font-weight: 600; color: #f59e0b;">' + formatCurrency(nextPeriod.interestPayment) + ' ƒë</div>' +
    '</div>' +
    '<div>' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">T·ªïng thanh to√°n</div>' +
    '<div style="font-weight: 700; color: #24c560; font-size: 18px;">' + formatCurrency(nextPeriod.totalPayment) + ' ƒë</div>' +
    '</div>' +
    '</div>' +
    '</div>' +
    
    '<div style="background: #fffbeb; padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b;">' +
    '<p style="margin: 0; color: #92400e; font-size: 14px;">' +
    '<i class="fas fa-info-circle"></i> Sau khi thanh to√°n, s·ªë d∆∞ n·ª£ c√≤n l·∫°i s·∫Ω l√†: <strong>' + 
    formatCurrency(nextPeriod.remainingPrincipal) + ' ƒë</strong>' +
    '</p>' +
    '</div>' +
    '</div>';
  
  var footer = 
    '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-success" onclick="executeMarkPayment(\'' + loanId + '\', ' + nextPeriod.period + ')">' +
    '<i class="fas fa-check"></i> X√°c nh·∫≠n thanh to√°n' +
    '</button>';
  
  openModal('üí∞ Thanh to√°n k·ª≥ ' + nextPeriod.period, body, footer);
}

/**
 * Execute mark payment
 * @param {string} loanId - Loan ID
 * @param {number} period - Payment period
 */
function executeMarkPayment(loanId, period) {
  closeModal();
  showLoading('ƒêang c·∫≠p nh·∫≠t thanh to√°n...');
  
  console.log('=== EXECUTE MARK PAYMENT ===');
  console.log('LoanID:', loanId, 'Period:', period);
  
  google.script.run
    .withSuccessHandler(function(response) {
      console.log('Mark payment response:', response);
      
      // Check response validity
      if (!response) {
        hideLoading();
        showToast('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server', 'error');
        return;
      }
      
      if (response.success) {
        console.log('Payment marked successfully');
        
        reloadLoanData().then(function() {
          hideLoading();
          showToast('‚úÖ ƒê√£ thanh to√°n k·ª≥ ' + period + ' th√†nh c√¥ng!', 'success');
        }).catch(function(error) {
          console.error('Reload error:', error);
          hideLoading();
          showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng nh∆∞ng kh√¥ng t·∫£i l·∫°i ƒë∆∞·ª£c d·ªØ li·ªáu', 'warning');
          
          // Force reload page if data manager fails
          setTimeout(function() {
            location.reload();
          }, 2000);
        });
      } else {
        hideLoading();
        showToast(response.message || 'Thanh to√°n th·∫•t b·∫°i', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Mark payment failure:', error);
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('markLoanPaymentAsPaid', {loanId: loanId, period: period});
}

// ========================================
// LOAN NOTIFICATIONS - DUE DATE ALERTS
// ========================================

/**
 * Check and display loan notifications
 * Called when loan page loads
 */
async function checkLoanNotifications() {
  try {
    console.log('Checking loan notifications...');
    
    // Get alert days from settings (default 7 days)
    var alertDays = parseInt(localStorage.getItem('loanAlertDays') || '7');
    
    const response = await new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .handleRequest('getLoanNotifications', {daysBeforeDue: alertDays});
    });
    
    if (!response.success) {
      console.log('No notifications or error:', response.message);
      return;
    }
    
    var notifications = response.data || [];
    
    console.log('Loan notifications:', notifications.length);
    
    if (notifications.length === 0) {
      // No notifications
      var notifContainer = document.getElementById('loanNotifications');
      if (notifContainer) {
        notifContainer.innerHTML = '';
      }
      return;
    }
    
    // Display notifications
    displayLoanNotifications(notifications);
    
  } catch (error) {
    console.error('Check notifications error:', error);
  }
}

/**
 * Display loan notifications in UI
 * @param {Array} notifications - Array of notifications
 */
function displayLoanNotifications(notifications) {
  var notifContainer = document.getElementById('loanNotifications');
  if (!notifContainer) return;
  
  var html = '<div style="background: #fff7ed; border: 2px solid #fb923c; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(251, 146, 60, 0.15);">' +
    '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">' +
    '<h3 style="margin: 0; color: #c2410c; font-size: 18px;">' +
    '<i class="fas fa-bell" style="margin-right: 8px; animation: ring 2s infinite;"></i>' +
    'Th√¥ng b√°o kho·∫£n vay s·∫Øp ƒë·∫øn h·∫°n (' + notifications.length + ')' +
    '</h3>' +
    '<button class="btn-secondary btn-sm" onclick="openLoanNotificationSettings()" title="C√†i ƒë·∫∑t c·∫£nh b√°o">' +
    '<i class="fas fa-cog"></i>' +
    '</button>' +
    '</div>';
  
  // Sort by urgency (urgent first)
  notifications.sort(function(a, b) {
    if (a.type === 'urgent' && b.type !== 'urgent') return -1;
    if (a.type !== 'urgent' && b.type === 'urgent') return 1;
    return a.daysUntilDue - b.daysUntilDue;
  });
  
  html += '<div style="display: grid; gap: 12px;">';
  
  for (var i = 0; i < notifications.length; i++) {
    var notif = notifications[i];
    var isUrgent = notif.type === 'urgent';
    var bgColor = isUrgent ? '#fef2f2' : '#fffbeb';
    var borderColor = isUrgent ? '#f87171' : '#fbbf24';
    var iconColor = isUrgent ? '#dc2626' : '#f59e0b';
    var icon = isUrgent ? 'fa-exclamation-triangle' : 'fa-clock';
    
    html += '<div style="background: ' + bgColor + '; border-left: 4px solid ' + borderColor + '; padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">' +
      '<div style="flex: 1;">' +
      '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">' +
      '<i class="fas ' + icon + '" style="color: ' + iconColor + '; font-size: 20px;"></i>' +
      '<strong style="color: #1f2937; font-size: 15px;">' + notif.loanName + '</strong>' +
      '</div>' +
      '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 13px; color: #4b5563;">' +
      '<div>K·ª≥: <strong>' + notif.period + '</strong></div>' +
      '<div>H·∫°n tr·∫£: <strong>' + formatDate(notif.dueDate) + '</strong></div>' +
      '<div>S·ªë ti·ªÅn: <strong style="color: ' + iconColor + ';">' + formatCurrency(notif.amount) + ' ƒë</strong></div>' +
      '<div>C√≤n: <strong style="color: ' + (notif.daysUntilDue <= 3 ? '#dc2626' : '#f59e0b') + ';">' + notif.daysUntilDue + ' ng√†y</strong></div>' +
      '</div>' +
      '</div>' +
      '<div style="display: flex; gap: 8px;">' +
      '<button class="btn-primary btn-sm" onclick="viewLoanDetails(\'' + notif.loanId + '\')" title="Xem chi ti·∫øt">' +
      '<i class="fas fa-eye"></i>' +
      '</button>' +
      '<button class="btn-success btn-sm" onclick="markPayment(\'' + notif.loanId + '\')" title="Thanh to√°n">' +
      '<i class="fas fa-money-bill-wave"></i>' +
      '</button>' +
      '</div>' +
      '</div>';
  }
  
  html += '</div></div>';
  
  // Add animation keyframes
  html += '<style>' +
    '@keyframes ring {' +
    '0%, 100% { transform: rotate(0deg); }' +
    '10%, 30% { transform: rotate(-10deg); }' +
    '20%, 40% { transform: rotate(10deg); }' +
    '}' +
    '</style>';
  
  notifContainer.innerHTML = html;
}

/**
 * Open notification settings modal
 */
function openLoanNotificationSettings() {
  var currentDays = parseInt(localStorage.getItem('loanAlertDays') || '7');
  
  var body = '<div style="padding: 20px;">' +
    '<div style="text-align: center; margin-bottom: 20px;">' +
    '<i class="fas fa-bell" style="font-size: 48px; color: #3782f4; margin-bottom: 10px;"></i>' +
    '<p style="color: #6b7280;">C√†i ƒë·∫∑t th·ªùi gian c·∫£nh b√°o tr∆∞·ªõc khi ƒë·∫øn h·∫°n thanh to√°n</p>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-calendar-alt"></i> C·∫£nh b√°o tr∆∞·ªõc (ng√†y)</label>' +
    '<input type="number" id="loanAlertDays" class="form-control" value="' + currentDays + '" min="1" max="30">' +
    '<small style="color: #6b7280;">H·ªá th·ªëng s·∫Ω c·∫£nh b√°o c√°c kho·∫£n vay ƒë·∫øn h·∫°n trong X ng√†y t·ªõi</small>' +
    '</div>' +
    
    '<div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-top: 15px;">' +
    '<p style="margin: 0; color: #1e40af; font-size: 13px;">' +
    '<i class="fas fa-info-circle"></i> G·ª£i √Ω:' +
    '</p>' +
    '<ul style="margin: 8px 0 0 20px; padding: 0; font-size: 13px; color: #1e40af;">' +
    '<li>3-5 ng√†y: C·∫£nh b√°o kh·∫©n c·∫•p</li>' +
    '<li>7 ng√†y: Khuy√™n d√πng (m·∫∑c ƒë·ªãnh)</li>' +
    '<li>14-30 ng√†y: C·∫£nh b√°o s·ªõm</li>' +
    '</ul>' +
    '</div>' +
    '</div>';
  
  var footer = 
    '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-primary" onclick="saveLoanNotificationSettings()">' +
    '<i class="fas fa-save"></i> L∆∞u c√†i ƒë·∫∑t' +
    '</button>';
  
  openModal('‚öôÔ∏è C√†i ƒë·∫∑t c·∫£nh b√°o', body, footer);
}

/**
 * Save notification settings
 */
function saveLoanNotificationSettings() {
  var days = parseInt(document.getElementById('loanAlertDays').value);
  
  if (!days || days < 1 || days > 30) {
    showToast('Vui l√≤ng nh·∫≠p s·ªë ng√†y t·ª´ 1-30', 'error');
    return;
  }
  
  localStorage.setItem('loanAlertDays', days);
  closeModal();
  showToast('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t c·∫£nh b√°o: ' + days + ' ng√†y', 'success');
  
  // Reload notifications with new settings
  checkLoanNotifications();
}

// ========================================
// LOAN IMPORT/EXPORT
// ========================================

// ========================================
// EXPORT LOAN TO EXCEL
// ========================================

/**
 * Export loan data to Excel
 */
function exportLoanToExcel() {
  console.log('Exporting loan to Excel...');
  
  if (!loanFilteredData || loanFilteredData.length === 0) {
    showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'warning');
    return;
  }
  
  showLoading('ƒêang t·∫°o file Excel...');
  
  try {
    // Prepare data
    var headers = [
      'Danh m·ª•c vay',
      'Ng√†y vay',
      'H·∫°n tr·∫£ vay',
      'Gi√° tr·ªã vay',
      'L√£i su·∫•t (%/nƒÉm)',
      'G·ªëc/th√°ng',
      'L√£i/th√°ng',
      'G·ªëc ƒë√£ tr·∫£',
      'C√≤n l·∫°i',
      'T√¨nh tr·∫°ng'
    ];
    
    var data = [];
    
    for (var i = 0; i < loanFilteredData.length; i++) {
      var item = loanFilteredData[i];
      
      var statusText = item['T√¨nh tr·∫°ng'] === 'completed' ? 'ƒê√£ tr·∫£ h·∫øt' : 
                      item['T√¨nh tr·∫°ng'] === 'overdue' ? 'Qu√° h·∫°n' : 'ƒêang vay';
      
      data.push([
        item['Danh m·ª•c vay'] || '',
        formatDate(item['Ng√†y vay']),
        formatDate(item['H·∫°n tr·∫£ vay']),
        parseCurrency(item['Gi√° tr·ªã vay']),
        parseFloat(item['L√£i su·∫•t vay/nƒÉm']) || 0,
        parseCurrency(item['Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng']),
        parseCurrency(item['Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng']),
        parseCurrency(item['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']),
        parseCurrency(item['Ti·ªÅn vay c√≤n l·∫°i']),
        statusText
      ]);
    }
    
    // Calculate totals
    var totalPrincipal = 0;
    var totalMonthlyPrincipal = 0;
    var totalMonthlyInterest = 0;
    var totalPaidPrincipal = 0;
    var totalRemaining = 0;
    
    for (var i = 0; i < loanFilteredData.length; i++) {
      totalPrincipal += parseCurrency(loanFilteredData[i]['Gi√° tr·ªã vay']);
      totalMonthlyPrincipal += parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng']);
      totalMonthlyInterest += parseCurrency(loanFilteredData[i]['Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng']);
      totalPaidPrincipal += parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']);
      totalRemaining += parseCurrency(loanFilteredData[i]['Ti·ªÅn vay c√≤n l·∫°i']);
    }
    
    // Add totals row
    data.push([
      'T·ªîNG C·ªòNG',
      '',
      '',
      totalPrincipal,
      '',
      totalMonthlyPrincipal,
      totalMonthlyInterest,
      totalPaidPrincipal,
      totalRemaining,
      loanFilteredData.length + ' kho·∫£n'
    ]);
    
    // Create workbook
    var ws_data = [headers].concat(data);
    var ws = XLSX.utils.aoa_to_sheet(ws_data);
    
    // Set column widths
    ws['!cols'] = [
      {wch: 25}, // Danh m·ª•c vay
      {wch: 12}, // Ng√†y vay
      {wch: 12}, // H·∫°n tr·∫£
      {wch: 15}, // Gi√° tr·ªã vay
      {wch: 12}, // L√£i su·∫•t
      {wch: 15}, // G·ªëc/th√°ng
      {wch: 15}, // L√£i/th√°ng
      {wch: 15}, // G·ªëc ƒë√£ tr·∫£
      {wch: 15}, // C√≤n l·∫°i
      {wch: 12}  // T√¨nh tr·∫°ng
    ];
    
    // Style header row
    var range = XLSX.utils.decode_range(ws['!ref']);
    for (var C = range.s.c; C <= range.e.c; ++C) {
      var address = XLSX.utils.encode_col(C) + "1";
      if (!ws[address]) continue;
      ws[address].s = {
        font: {bold: true, color: {rgb: "FFFFFF"}},
        fill: {fgColor: {rgb: "667eea"}},
        alignment: {horizontal: "center", vertical: "center"}
      };
    }
    
    // Style totals row
    var lastRow = range.e.r + 1;
    for (var C = range.s.c; C <= range.e.c; ++C) {
      var address = XLSX.utils.encode_col(C) + lastRow;
      if (!ws[address]) continue;
      ws[address].s = {
        font: {bold: true, color: {rgb: "FFFFFF"}},
        fill: {fgColor: {rgb: "764ba2"}},
        alignment: {horizontal: "center"}
      };
    }
    
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Kho·∫£n vay");
    
    // Generate filename
    var filename = 'Khoan_vay_' + formatDate(new Date()).replace(/\//g, '-') + '.xlsx';
    
    // Download
    XLSX.writeFile(wb, filename);
    
    hideLoading();
    showToast('‚úÖ ƒê√£ xu·∫•t ' + loanFilteredData.length + ' kho·∫£n vay ra Excel', 'success');
    
  } catch (error) {
    console.error('Export error:', error);
    hideLoading();
    showToast('L·ªói xu·∫•t Excel: ' + error.message, 'error');
  }
}

/**
 * Download loan template Excel
 */
function downloadLoanTemplate() {
  console.log('Downloading loan template...');
  
  // Create template data
  var headers = [
    'Danh m·ª•c vay',
    'Ng√†y vay',
    'Gi√° tr·ªã vay',
    'L√£i su·∫•t vay/nƒÉm (%)',
    'K·ª≥ h·∫°n (th√°ng)',
    'H√¨nh th·ª©c l√£i'
  ];
  
  var sampleData = [
    ['Vay mua nh√†', '2025-01-01', '500000000', '8.5', '240', 'declining'],
    ['Vay ti√™u d√πng', '2025-01-15', '50000000', '12', '36', 'simple'],
    ['Vay mua xe', '2025-02-01', '200000000', '9', '60', 'declining']
  ];
  
  var instructions = [
    [''],
    ['H∆Ø·ªöNG D·∫™N NH·∫¨P LI·ªÜU:'],
    ['1. Danh m·ª•c vay: T√™n kho·∫£n vay (VD: Vay mua nh√†, Vay ti√™u d√πng)'],
    ['2. Ng√†y vay: ƒê·ªãnh d·∫°ng YYYY-MM-DD (VD: 2025-01-01)'],
    ['3. Gi√° tr·ªã vay: S·ªë ti·ªÅn vay (VD: 100000000 = 100 tri·ªáu)'],
    ['4. L√£i su·∫•t: L√£i su·∫•t nƒÉm (VD: 8.5 nghƒ©a l√† 8.5%/nƒÉm)'],
    ['5. K·ª≥ h·∫°n: S·ªë th√°ng (VD: 12, 24, 36, 60, 240)'],
    ['6. H√¨nh th·ª©c l√£i: declining (l√£i gi·∫£m d·∫ßn), simple (l√£i ƒë∆°n), compound (l√£i k√©p)'],
    [''],
    ['L∆ØU √ù:'],
    ['- Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng c√°c c·ªôt b·∫Øt bu·ªôc'],
    ['- Gi√° tr·ªã vay ph·∫£i > 0'],
    ['- L√£i su·∫•t ph·∫£i t·ª´ 0-100'],
    ['- K·ª≥ h·∫°n ph·∫£i t·ª´ 1-360 th√°ng'],
    ['- H√¨nh th·ª©c l√£i khuy√™n d√πng: declining (ph·ªï bi·∫øn nh·∫•t)']
  ];
  
  // Build workbook
  var ws_data = [headers].concat(sampleData).concat(instructions);
  var ws = XLSX.utils.aoa_to_sheet(ws_data);
  
  // Set column widths
  ws['!cols'] = [
    {wch: 25}, // Danh m·ª•c vay
    {wch: 15}, // Ng√†y vay
    {wch: 15}, // Gi√° tr·ªã vay
    {wch: 20}, // L√£i su·∫•t
    {wch: 15}, // K·ª≥ h·∫°n
    {wch: 20}  // H√¨nh th·ª©c l√£i
  ];
  
  // Style header row
  var range = XLSX.utils.decode_range(ws['!ref']);
  for (var C = range.s.c; C <= range.e.c; ++C) {
    var address = XLSX.utils.encode_col(C) + "1";
    if (!ws[address]) continue;
    ws[address].s = {
      font: {bold: true},
      fill: {fgColor: {rgb: "3782f4"}},
      alignment: {horizontal: "center"}
    };
  }
  
  var wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Kho·∫£n vay");
  
  // Download
  XLSX.writeFile(wb, 'Mau_Khoan_vay_' + formatDate(new Date()) + '.xlsx');
  
  showToast('‚úÖ ƒê√£ t·∫£i xu·ªëng file m·∫´u', 'success');
}

/**
 * Open import loan modal
 */
function openLoanImportModal() {
  var body = '<div style="padding: 20px;">' +
    '<div style="text-align: center; margin-bottom: 20px;">' +
    '<i class="fas fa-file-import" style="font-size: 48px; color: #3782f4; margin-bottom: 10px;"></i>' +
    '<h3 style="margin: 10px 0; color: #1f2937;">Import kho·∫£n vay t·ª´ Excel</h3>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-file-excel"></i> Ch·ªçn file Excel</label>' +
    '<input type="file" id="loanImportFile" class="form-control" accept=".xlsx,.xls" ' +
    'onchange="handleLoanFileSelect(event)">' +
    '<small style="color: #6b7280;">Ch·∫•p nh·∫≠n file .xlsx, .xls</small>' +
    '</div>' +
    
    '<div style="background: #fffbeb; padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b; margin-top: 15px;">' +
    '<p style="margin: 0 0 8px 0; color: #92400e; font-weight: 600;"><i class="fas fa-lightbulb"></i> L∆∞u √Ω:</p>' +
    '<ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f;">' +
    '<li>File ph·∫£i c√≥ ƒë√∫ng c·∫•u tr√∫c template</li>' +
    '<li>D·ªØ li·ªáu b·∫Øt ƒë·∫ßu t·ª´ d√≤ng 2 (d√≤ng 1 l√† header)</li>' +
    '<li>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√≠nh l·ªãch tr·∫£ n·ª£</li>' +
    '<li>C√°c kho·∫£n vay b·ªã l·ªói s·∫Ω b·ªã b·ªè qua</li>' +
    '</ul>' +
    '</div>' +
    
    '<div id="importPreview" style="margin-top: 15px;"></div>' +
    '</div>';
  
  var footer = 
    '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-warning" onclick="downloadLoanTemplate()" style="margin-right: auto;">' +
    '<i class="fas fa-download"></i> T·∫£i file m·∫´u' +
    '</button>' +
    '<button id="btnImportLoan" class="btn-primary" onclick="processLoanImport()" disabled>' +
    '<i class="fas fa-upload"></i> Import' +
    '</button>';
  
  openModal('üì• Import kho·∫£n vay', body, footer);
}

/**
 * Handle file select for import
 * @param {Event} event - File input change event
 */
function handleLoanFileSelect(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  console.log('File selected:', file.name);
  
  var reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, {type: 'array'});
      
      // Get first sheet
      var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      var jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
      
      console.log('Excel data:', jsonData);
      
      // Validate and preview
      var validRecords = validateLoanImportData(jsonData);
      
      if (validRecords.length === 0) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ import', 'error');
        return;
      }
      
      // Store for import
      window.loanImportData = validRecords;
      
      // Show preview
      displayLoanImportPreview(validRecords);
      
      // Enable import button
      document.getElementById('btnImportLoan').disabled = false;
      
    } catch (error) {
      console.error('Read file error:', error);
      showToast('L·ªói ƒë·ªçc file: ' + error.message, 'error');
    }
  };
  
  reader.readAsArrayBuffer(file);
}

/**
 * Validate loan import data
 * @param {Array} data - Raw Excel data
 * @return {Array} Valid records
 */
function validateLoanImportData(data) {
  if (!data || data.length < 2) return [];
  
  var headers = data[0];
  var validRecords = [];
  
  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    
    // Skip empty rows
    if (!row || row.length === 0 || !row[0]) continue;
    
    try {
      var record = {
        'Danh m·ª•c vay': row[0] ? String(row[0]).trim() : '',
        'Ng√†y vay': row[1] ? String(row[1]).trim() : '',
        'Gi√° tr·ªã vay': parseFloat(row[2]) || 0,
        'L√£i su·∫•t vay/nƒÉm': parseFloat(row[3]) || 0,
        'K·ª≥ h·∫°n': parseInt(row[4]) || 0,
        'H√¨nh th·ª©c l√£i': row[5] ? String(row[5]).trim().toLowerCase() : 'declining'
      };
      
      // Validate
      if (!record['Danh m·ª•c vay']) continue;
      if (!record['Ng√†y vay'] || !isValidDate(record['Ng√†y vay'])) continue;
      if (record['Gi√° tr·ªã vay'] <= 0) continue;
      if (record['L√£i su·∫•t vay/nƒÉm'] < 0 || record['L√£i su·∫•t vay/nƒÉm'] > 100) continue;
      if (record['K·ª≥ h·∫°n'] < 1 || record['K·ª≥ h·∫°n'] > 360) continue;
      
      // Validate interest type
      var validTypes = ['declining', 'simple', 'compound'];
      if (validTypes.indexOf(record['H√¨nh th·ª©c l√£i']) === -1) {
        record['H√¨nh th·ª©c l√£i'] = 'declining';
      }
      
      validRecords.push(record);
      
    } catch (e) {
      console.error('Parse row error:', e);
      continue;
    }
  }
  
  return validRecords;
}

/**
 * Display import preview
 * @param {Array} records - Valid records
 */
function displayLoanImportPreview(records) {
  var html = '<div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 3px solid #24c560;">' +
    '<p style="margin: 0; color: #166534; font-weight: 600;">' +
    '<i class="fas fa-check-circle"></i> T√¨m th·∫•y ' + records.length + ' kho·∫£n vay h·ª£p l·ªá' +
    '</p>' +
    '<ul style="margin: 10px 0 0 20px; padding: 0; font-size: 13px; color: #166534;">';
  
  for (var i = 0; i < Math.min(records.length, 5); i++) {
    html += '<li>' + records[i]['Danh m·ª•c vay'] + ' - ' + 
      formatCurrency(records[i]['Gi√° tr·ªã vay']) + ' ƒë - ' +
      records[i]['L√£i su·∫•t vay/nƒÉm'] + '%/nƒÉm - ' +
      records[i]['K·ª≥ h·∫°n'] + ' th√°ng' +
      '</li>';
  }
  
  if (records.length > 5) {
    html += '<li>... v√† ' + (records.length - 5) + ' kho·∫£n vay kh√°c</li>';
  }
  
  html += '</ul></div>';
  
  document.getElementById('importPreview').innerHTML = html;
}

/**
 * Process loan import
 */
async function processLoanImport() {
  if (!window.loanImportData || window.loanImportData.length === 0) {
    showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ import', 'error');
    return;
  }
  
  closeModal();
  showLoading('ƒêang import ' + window.loanImportData.length + ' kho·∫£n vay...');
  
  var successCount = 0;
  var errorCount = 0;
  
  try {
    for (var i = 0; i < window.loanImportData.length; i++) {
      var record = window.loanImportData[i];
      
      try {
        // Calculate schedule
        const scheduleResponse = await new Promise(function(resolve, reject) {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .handleRequest('calculateLoanSchedule', {
              loanData: {
                principal: record['Gi√° tr·ªã vay'],
                annualRate: record['L√£i su·∫•t vay/nƒÉm'],
                months: record['K·ª≥ h·∫°n'],
                interestType: record['H√¨nh th·ª©c l√£i'],
                startDate: record['Ng√†y vay']
              }
            });
        });
        
        if (!scheduleResponse.success) {
          errorCount++;
          continue;
        }
        
        var schedule = scheduleResponse.data;
        var firstPeriod = schedule[0];
        var lastPeriod = schedule[schedule.length - 1];
        
        // Build record
        var loanData = {
          'ID': generateId('KV'),
          'UserID': currentUser.userId,
          'Ng√†y vay': record['Ng√†y vay'],
          'H·∫°n tr·∫£ vay': lastPeriod.dueDate,
          'Danh m·ª•c vay': record['Danh m·ª•c vay'],
          'Gi√° tr·ªã vay': record['Gi√° tr·ªã vay'],
          'L√£i su·∫•t vay/nƒÉm': record['L√£i su·∫•t vay/nƒÉm'],
          'Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng': firstPeriod.principalPayment,
          'Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng': firstPeriod.interestPayment,
          'Ti·ªÅn g·ªëc ƒë√£ tr·∫£': 0,
          'Ti·ªÅn vay c√≤n l·∫°i': record['Gi√° tr·ªã vay'],
          'T√¨nh tr·∫°ng': 'active',
          'Chi ti·∫øt kho·∫£n vay': JSON.stringify({
            months: record['K·ª≥ h·∫°n'],
            interestType: record['H√¨nh th·ª©c l√£i'],
            schedule: schedule,
            createdAt: new Date().toISOString()
          })
        };
        
        // Save
        const saveResponse = await new Promise(function(resolve, reject) {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .handleRequest('createRecord', {sheetName: 'Kho·∫£n vay', data: loanData});
        });
        
        if (saveResponse.success) {
          successCount++;
        } else {
          errorCount++;
        }
        
      } catch (e) {
        console.error('Import record error:', e);
        errorCount++;
      }
    }
    
    // Reload data
    await reloadLoanData();
    
    hideLoading();
    
    var message = 'Import ho√†n t·∫•t: ' + successCount + ' th√†nh c√¥ng';
    if (errorCount > 0) {
      message += ', ' + errorCount + ' th·∫•t b·∫°i';
    }
    
    showToast('‚úÖ ' + message, successCount > 0 ? 'success' : 'warning');
    
    // Clear import data
    window.loanImportData = null;
    
  } catch (error) {
    console.error('Import error:', error);
    hideLoading();
    showToast('L·ªói import: ' + error.message, 'error');
  }
}

</script>
