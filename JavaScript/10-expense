<script>

function showExpensePage() {
  console.log('=== SHOWING EXPENSE PAGE ===');
  
  // Reset v·ªÅ trang 1 khi m·ªü page
  expenseCurrentPage = 1;
  expenseFilteredData = allExpenseData.slice();
  
  renderExpensePage();
}

function renderExpensePage() {
  console.log('=== RENDERING EXPENSE PAGE (CACHED) ===');
  
  // Use cached data
  if (!incomeFilteredData.length) {
    incomeFilteredData = DataManager.getIncome();
  }
  
  // Apply filters
  applyExpenseFilters();
  
  console.log('expenseFilteredData (after filter):', expenseFilteredData.length, 'records');
  
  var totalRecords = expenseFilteredData.length;
  var totalPages = Math.ceil(totalRecords / expenseItemsPerPage);
  
  if (expenseCurrentPage > totalPages && totalPages > 0) {
    expenseCurrentPage = totalPages;
  }
  
  if (expenseCurrentPage < 1) {
    expenseCurrentPage = 1;
  }
  
  var html = '<div class="card">' +
    '<div class="card-header">' +
    '<h2 class="card-title">Danh s√°ch Chi ti√™u</h2>' +
    '<div style="display: flex; gap: 10px;">' +
    '<button class="btn-secondary" onclick="downloadExpenseTemplate()"><i class="fas fa-download"></i> T·∫£i m·∫´u Excel</button>' +
    '<button class="btn-secondary" onclick="openExpenseImportModal()"><i class="fas fa-file-import"></i> Import Excel</button>' +
    '<button class="btn-primary" onclick="openExpenseModal()"><i class="fas fa-plus"></i> Th√™m chi ti√™u</button>' +
    '</div>' +
    '</div>' +
    
    // FILTER PANEL
    '<div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">T·ª´ ng√†y</label>' +
    '<input type="date" id="expenseFilterFromDate" class="form-control" value="' + expenseFilters.fromDate + '" onchange="renderExpensePage()"></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">ƒê·∫øn ng√†y</label>' +
    '<input type="date" id="expenseFilterToDate" class="form-control" value="' + expenseFilters.toDate + '" onchange="renderExpensePage()"></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">Danh m·ª•c</label>' +
    '<select id="expenseFilterCategory" class="form-control" onchange="renderExpensePage()"><option value="">T·∫•t c·∫£</option>' +
    '<option value="food">ƒÇn u·ªëng</option><option value="transport">Di chuy·ªÉn</option>' +
    '<option value="shopping">Mua s·∫Øm</option><option value="education">H·ªçc t·∫≠p</option>' +
    '<option value="health">Y t·∫ø</option><option value="entertainment">Gi·∫£i tr√≠</option><option value="other">Kh√°c</option></select></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">T√†i kho·∫£n</label>' +
    '<select id="expenseFilterAccount" class="form-control" onchange="renderExpensePage()"><option value="">T·∫•t c·∫£</option>' + 
    renderAccountOptionsForFilter() + '</select></div>' +
    '<div style="display: flex; align-items: flex-end;"><button class="btn-secondary" onclick="clearExpenseFilters()" style="width: 100%;">X√≥a b·ªô l·ªçc</button></div>' +
    '</div></div>' +
    
    '<div style="margin-bottom: 10px; color: #718096; display: flex; justify-content: space-between; align-items: center;">' +
    '<span>Hi·ªÉn th·ªã ' + ((expenseCurrentPage - 1) * expenseItemsPerPage + 1) + ' - ' + 
    Math.min(expenseCurrentPage * expenseItemsPerPage, totalRecords) + ' trong t·ªïng s·ªë ' + totalRecords + ' b·∫£n ghi</span>' +
    '<div style="display: flex; gap: 10px; align-items: center;">' +
    '<label style="margin: 0;">Hi·ªÉn th·ªã:</label>' +
    '<select onchange="changeExpenseItemsPerPage(this.value)" class="form-control" style="width: auto; padding: 5px 10px;">' +
    '<option value="5"' + (expenseItemsPerPage === 5 ? ' selected' : '') + '>5</option>' +
    '<option value="10"' + (expenseItemsPerPage === 10 ? ' selected' : '') + '>10</option>' +
    '<option value="20"' + (expenseItemsPerPage === 20 ? ' selected' : '') + '>20</option>' +
    '<option value="50"' + (expenseItemsPerPage === 50 ? ' selected' : '') + '>50</option>' +
    '</select>' +
    '</div></div>' +
    
    '<div style="overflow: auto; max-height: calc(100vh - 400px); position: relative;">' +
    '<table>' +
    '<thead>' +
    '<tr>' +
    '<th class="sticky-column">Ng√†y</th>' +
    '<th>Danh m·ª•c</th>' +
    '<th>S·ªë ti·ªÅn</th>' +
    '<th>M√¥ t·∫£</th>' +
    '<th>T√†i kho·∫£n</th>' +
    '<th>H√†nh ƒë·ªông</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody>' + renderExpenseTableWithPagination() + '</tbody>' +
    '</table></div>' +
    
    // PAGINATION
    renderExpensePagination(totalPages) +
    
    '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
  
  // Restore filter values
  var fromDateEl = document.getElementById('expenseFilterFromDate');
  var toDateEl = document.getElementById('expenseFilterToDate');
  var categoryEl = document.getElementById('expenseFilterCategory');
  var accountEl = document.getElementById('expenseFilterAccount');
  
  if (fromDateEl) fromDateEl.value = expenseFilters.fromDate;
  if (toDateEl) toDateEl.value = expenseFilters.toDate;
  if (categoryEl) categoryEl.value = expenseFilters.category;
  if (accountEl) accountEl.value = expenseFilters.accountId;
}

function applyExpenseFilters() {
  // ƒê·ªçc gi√° tr·ªã filter t·ª´ input
  var fromDateEl = document.getElementById('expenseFilterFromDate');
  var toDateEl = document.getElementById('expenseFilterToDate');
  var categoryEl = document.getElementById('expenseFilterCategory');
  var accountEl = document.getElementById('expenseFilterAccount');
  
  if (fromDateEl) expenseFilters.fromDate = fromDateEl.value;
  if (toDateEl) expenseFilters.toDate = toDateEl.value;
  if (categoryEl) expenseFilters.category = categoryEl.value;
  if (accountEl) expenseFilters.accountId = accountEl.value;
  
  // Filter data
  expenseFilteredData = [];
  
  for (var i = 0; i < allExpenseData.length; i++) {
    var item = allExpenseData[i];
    var itemDate = item['Ng√†y'];
    
    // Filter by date range
    if (expenseFilters.fromDate && itemDate < expenseFilters.fromDate) continue;
    if (expenseFilters.toDate && itemDate > expenseFilters.toDate) continue;
    
    // Filter by category
    if (expenseFilters.category) {
      try {
        var cat = typeof item['Danh m·ª•c chi ti√™u'] === 'string' ? 
          JSON.parse(item['Danh m·ª•c chi ti√™u']) : item['Danh m·ª•c chi ti√™u'];
        if (!cat || !cat[0] || cat[0].id !== expenseFilters.category) continue;
      } catch(e) {
        continue;
      }
    }
    
    // Filter by account
    if (expenseFilters.accountId) {
      try {
        var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
        if (!meta || meta.accountId !== expenseFilters.accountId) continue;
      } catch(e) {
        continue;
      }
    }
    
    expenseFilteredData.push(item);
  }
}

function clearExpenseFilters() {
  console.log('=== CLEARING EXPENSE FILTERS ===');
  
  // Reset filter values
  expenseFilters = { 
    fromDate: '', 
    toDate: '', 
    category: '', 
    accountId: '' 
  };
  
  // Reset to page 1
  expenseCurrentPage = 1;
  
  // Reset filtered data to all data
  expenseFilteredData = allExpenseData.slice();
  
  console.log('Filters cleared, rendering page...');
  
  // Re-render page
  renderExpensePage();
  
  // Force clear input values after render
  setTimeout(function() {
    var fromDateEl = document.getElementById('expenseFilterFromDate');
    var toDateEl = document.getElementById('expenseFilterToDate');
    var categoryEl = document.getElementById('expenseFilterCategory');
    var accountEl = document.getElementById('expenseFilterAccount');
    
    if (fromDateEl) fromDateEl.value = '';
    if (toDateEl) toDateEl.value = '';
    if (categoryEl) categoryEl.value = '';
    if (accountEl) accountEl.value = '';
    
    console.log('Input values cleared');
  }, 100);
}

function changeExpenseItemsPerPage(value) {
  expenseItemsPerPage = parseInt(value);
  expenseCurrentPage = 1;
  renderExpensePage();
}

function saveExpense() {
  // ... existing validation code ...
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        showToast(editingExpenseId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng' : 'Th√™m th√†nh c√¥ng', 'success');
        closeModal();
        
        // Reload expense data
        reloadExpenseData();
        
        // ===== TH√äM ƒêO·∫†N N√ÄY =====
        // Force refresh budget data to show updated "Chi ti√™u" column
        console.log('Refreshing budget data after expense change...');
        setTimeout(function() {
          DataManager.refresh('Ng√¢n s√°ch').then(function() {
            allBudgetData = DataManager.getBudget();
            console.log('‚úì Budget data refreshed');
            
            // If user is on budget page, re-render it
            if (currentPage === 'budget') {
              renderBudgetPage();
            }
          });
        }, 2000); // Wait 2 seconds for backend to finish calculation
        // ===== K·∫æT TH√öC =====
        
      } else {
        hideLoading();
        showToast(response.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest(
      editingExpenseId ? 'updateRecord' : 'createRecord',
      editingExpenseId ? 
        { sheetName: 'Chi ti√™u', id: editingExpenseId, data: expenseData } :
        { sheetName: 'Chi ti√™u', data: expenseData }
    );
}

function renderExpenseTableWithPagination() {
  if (!expenseFilteredData || expenseFilteredData.length === 0) {
    return '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
  }
  
  var startIndex = (expenseCurrentPage - 1) * expenseItemsPerPage;
  var endIndex = Math.min(startIndex + expenseItemsPerPage, expenseFilteredData.length);
  
  var html = '';
  
  for (var i = startIndex; i < endIndex; i++) {
    var item = expenseFilteredData[i];
    var id = item.ID || 'N/A';
    var accountId = '';
    
    try {
      var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
      accountId = meta.accountId || '';
    } catch(e) {}
    
    var categoryDisplay = formatCategoryDisplay(item['Danh m·ª•c chi ti√™u']);
    
    html += '<tr>' +
      '<td class="sticky-column">' + formatDate(item['Ng√†y']) + '</td>' +
      '<td>' + categoryDisplay + '</td>' +
      '<td style="color: #e94849; font-weight: 600;">' + formatCurrency(item['S·ªë ti·ªÅn']) + ' ƒë</td>' +
      '<td>' + (item['M√¥ t·∫£'] || '-') + '</td>' +
      '<td>' + getAccountName(accountId) + '</td>' +
      '<td class="action-buttons">' +
      '<button class="btn-primary btn-sm" onclick="editExpense(\'' + id + '\')"><i class="fas fa-edit"></i></button>' +
      '<button class="btn-danger btn-sm" onclick="confirmDeleteExpense(\'' + id + '\')"><i class="fas fa-trash"></i></button>' +
      '</td></tr>';
  }
  
  return html;
}

function renderExpensePagination(totalPages) {
  if (totalPages <= 1) return '';
  
  var html = '<div style="display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px;">';
  
  // Previous button
  html += '<button class="btn-secondary btn-sm" onclick="expenseGoToPage(' + (expenseCurrentPage - 1) + ')" ' + 
    (expenseCurrentPage === 1 ? 'disabled' : '') + '><i class="fas fa-chevron-left"></i></button>';
  
  // Page numbers
  var startPage = Math.max(1, expenseCurrentPage - 2);
  var endPage = Math.min(totalPages, expenseCurrentPage + 2);
  
  if (startPage > 1) {
    html += '<button class="btn-secondary btn-sm" onclick="expenseGoToPage(1)">1</button>';
    if (startPage > 2) html += '<span>...</span>';
  }
  
  for (var i = startPage; i <= endPage; i++) {
    if (i === expenseCurrentPage) {
      html += '<button class="btn-primary btn-sm" disabled>' + i + '</button>';
    } else {
      html += '<button class="btn-secondary btn-sm" onclick="expenseGoToPage(' + i + ')">' + i + '</button>';
    }
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span>...</span>';
    html += '<button class="btn-secondary btn-sm" onclick="expenseGoToPage(' + totalPages + ')">' + totalPages + '</button>';
  }
  
  // Next button
  html += '<button class="btn-secondary btn-sm" onclick="expenseGoToPage(' + (expenseCurrentPage + 1) + ')" ' + 
    (expenseCurrentPage === totalPages ? 'disabled' : '') + '><i class="fas fa-chevron-right"></i></button>';
  
  html += '</div>';
  
  return html;
}

function expenseGoToPage(page) {
  expenseCurrentPage = page;
  renderExpensePage();
  window.scrollTo(0, 0);
}

// DOWNLOAD EXCEL TEMPLATE
function downloadExpenseTemplate() {
  // T·∫°o workbook m·ªõi
  var wb = XLSX.utils.book_new();
  
  // T·∫°o data v·ªõi format ƒë·∫πp
  var wsData = [
    ['Ng√†y', 'Danh m·ª•c', 'S·ªë ti·ªÅn', 'M√¥ t·∫£', 'T√†i kho·∫£n'],
    ['2025-10-20', 'food', 150000, 'ƒÇn tr∆∞a', 'ACC001'],
    ['2025-10-21', 'transport', 50000, 'XƒÉng xe', 'ACC002']
  ];
  
  // T·∫°o worksheet
  var ws = XLSX.utils.aoa_to_sheet(wsData);
  
  // Set column widths
  ws['!cols'] = [
    { wch: 12 },  // Ng√†y
    { wch: 15 },  // Danh m·ª•c
    { wch: 15 },  // S·ªë ti·ªÅn
    { wch: 30 },  // M√¥ t·∫£
    { wch: 12 }   // T√†i kho·∫£n
  ];
  
  // Add worksheet to workbook
  XLSX.utils.book_append_sheet(wb, ws, 'Expense_Template');
  
  // T·∫°o file Excel
  var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  var blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  
  // Download file
  var link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'Expense_Template.xlsx';
  link.click();
  
  showToast('ƒê√£ t·∫£i xu·ªëng file m·∫´u Excel', 'success');
}

// IMPORT EXCEL MODAL
function openExpenseImportModal() {
  var body = '<div class="form-group">' +
    '<label>Ch·ªçn file Excel/CSV</label>' +
    '<input type="file" id="expenseImportFile" accept=".xlsx,.xls,.csv" class="form-control">' +
    '<small style="color: #718096; margin-top: 5px; display: block;">ƒê·ªãnh d·∫°ng: XLSX, XLS, CSV</small>' +
    '<small style="color: #718096; margin-top: 5px; display: block;">C·∫•u tr√∫c: Ng√†y | Danh m·ª•c | S·ªë ti·ªÅn | M√¥ t·∫£ | T√†i kho·∫£n</small>' +
    '<div style="margin-top: 10px; padding: 10px; background: #fffbeb; border-left: 3px solid #f59e0b; border-radius: 4px;">' +
    '<strong>L∆∞u √Ω:</strong><br>' +
    '<ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">' +
    '<li>Ng√†y: ƒê·ªãnh d·∫°ng YYYY-MM-DD (VD: 2025-10-20)</li>' +
    '<li>Danh m·ª•c: food, transport, shopping, education, health, entertainment, other</li>' +
    '<li>S·ªë ti·ªÅn: S·ªë nguy√™n (VD: 150000)</li>' +
    '<li>T√†i kho·∫£n: M√£ t√†i kho·∫£n (VD: ACC001)</li>' +
    '</ul>' +
    '</div>' +
    '</div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-primary" onclick="processExpenseImport()">Import</button>';
  
  openModal('Import d·ªØ li·ªáu Chi ti√™u', body, footer);
}

// PROCESS IMPORT EXCEL
function processExpenseImport() {
  var fileInput = document.getElementById('expenseImportFile');
  
  if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
    showToast('Vui l√≤ng ch·ªçn file', 'error');
    return;
  }
  
  var file = fileInput.files[0];
  var reader = new FileReader();
  
  closeModal();
  showLoading();
  
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, { type: 'array' });
      var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      var jsonData = XLSX.utils.sheet_to_json(firstSheet);
      
      console.log('Imported expense data:', jsonData);
      
      if (jsonData.length === 0) {
        hideLoading();
        showToast('File kh√¥ng c√≥ d·ªØ li·ªáu', 'error');
        return;
      }
      
      // X·ª≠ l√Ω t·ª´ng d√≤ng tu·∫ßn t·ª±
      var successCount = 0;
      var errorCount = 0;
      
      function processRow(index) {
        if (index >= jsonData.length) {
          // Ho√†n th√†nh
          console.log('=== IMPORT COMPLETED ===');
          console.log('Success:', successCount, 'Error:', errorCount);
          
          hideLoading();
          
          if (successCount > 0) {
            showToast('Import th√†nh c√¥ng ' + successCount + ' / ' + jsonData.length + ' b·∫£n ghi', 'success');
            
            // Reload data with delay ƒë·ªÉ ƒë·∫£m b·∫£o Sheet ƒë√£ update
            console.log('Reloading expense data in 1 second...');
            setTimeout(function() {
              Promise.all([
                loadSheetData('Chi ti√™u'),
                loadSheetData('T√†i kho·∫£n')
              ]).then(function(results) {
                allExpenseData = results[0];
                allAccountsData = results[1];
                expenseFilteredData = allExpenseData.slice(); // Reset filter
                expenseCurrentPage = 1; // Reset v·ªÅ trang 1
                
                console.log('Expense data reloaded:', allExpenseData.length, 'records');
                
                renderExpensePage();
              }).catch(function(error) {
                console.error('Error reloading expense data:', error);
                showToast('L·ªói t·∫£i l·∫°i d·ªØ li·ªáu', 'error');
              });
            }, 1500); // Delay 1.5 gi√¢y
          } else {
            showToast('Kh√¥ng c√≥ b·∫£n ghi n√†o ƒë∆∞·ª£c import', 'error');
          }
          
          if (errorCount > 0) {
            showToast('C√≥ ' + errorCount + ' l·ªói', 'error');
          }
          
          return;
        }
        
        var row = jsonData[index];
        
        console.log('Processing expense row ' + (index + 1) + ':', row);
        
        // Validate
        if (!row['Ng√†y'] || !row['Danh m·ª•c'] || !row['S·ªë ti·ªÅn'] || !row['T√†i kho·∫£n']) {
          console.error('Row ' + (index + 1) + ': Missing required fields');
          errorCount++;
          processRow(index + 1);
          return;
        }
        
        // Parse date
        var dateValue = row['Ng√†y'];
        var formattedDate = '';
        
        if (typeof dateValue === 'number') {
          var excelDate = XLSX.SSF.parse_date_code(dateValue);
          formattedDate = excelDate.y + '-' + 
            String(excelDate.m).padStart(2, '0') + '-' + 
            String(excelDate.d).padStart(2, '0');
        } else if (typeof dateValue === 'string') {
          formattedDate = dateValue;
        } else {
          console.error('Row ' + (index + 1) + ': Invalid date format');
          errorCount++;
          processRow(index + 1);
          return;
        }
        
        var accountId = row['T√†i kho·∫£n'];
        var amount = parseFloat(row['S·ªë ti·ªÅn']);
        
        // Create record
        var recordData = {
          'ID': generateId('CT'),
          'Ng√†y': formattedDate,
          'Danh m·ª•c chi ti√™u': JSON.stringify([{
            id: row['Danh m·ª•c'], 
            name: getCategoryLabel(row['Danh m·ª•c'])
          }]),
          'S·ªë ti·ªÅn': amount,
          'M√¥ t·∫£': row['M√¥ t·∫£'] || '',
          'Ph∆∞∆°ng th·ª©c thanh to√°n': JSON.stringify([{
            id: accountId, 
            name: getAccountName(accountId)
          }]),
          'UserID': currentUser.userId,
          'Metadata': JSON.stringify({accountId: accountId})
        };
        
        console.log('Creating expense record:', recordData);
        
        // Create record in Sheet
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              console.log('Expense row ' + (index + 1) + ' created successfully');
              
              // Update account balance (SUBTRACT)
              google.script.run
                .withSuccessHandler(function(balanceResponse) {
                  console.log('Balance updated for expense row ' + (index + 1));
                  successCount++;
                  processRow(index + 1);
                })
                .withFailureHandler(function(error) {
                  console.error('Balance update failed for expense row ' + (index + 1) + ':', error);
                  successCount++; // V·∫´n t√≠nh l√† th√†nh c√¥ng
                  processRow(index + 1);
                })
                .handleRequest('updateAccountBalance', {
                  accountId: accountId,
                  amount: amount,
                  type: 'subtract'
                });
            } else {
              console.error('Expense row ' + (index + 1) + ' failed:', response.message);
              errorCount++;
              processRow(index + 1);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Expense row ' + (index + 1) + ' error:', error);
            errorCount++;
            processRow(index + 1);
          })
          .handleRequest('createRecord', {
            sheetName: 'Chi ti√™u',
            data: recordData
          });
        
      }
      
      // B·∫Øt ƒë·∫ßu x·ª≠ l√Ω t·ª´ row 0
      processRow(0);
      
    } catch (error) {
      hideLoading();
      showToast('L·ªói ƒë·ªçc file: ' + error.message, 'error');
      console.error('Import error:', error);
    }
  };
  
  reader.onerror = function() {
    hideLoading();
    showToast('L·ªói ƒë·ªçc file', 'error');
  };
  
  reader.readAsArrayBuffer(file);
}

// ========================================
// EXPENSE MODAL - OPTIMIZED VERSION
// ========================================

function openExpenseModal(id) {
  console.log('=== OPENING EXPENSE MODAL ===', id ? 'EDIT' : 'CREATE');
  
  var isEdit = !!id;
  var item = {};
  
  if (isEdit) {
    const expenseList = DataManager.getExpense();
    item = expenseList.find(i => i.ID === id) || {};
    
    if (!item.ID) {
      showToast('Kh√¥ng t√¨m th·∫•y b·∫£n ghi', 'error');
      return;
    }
  }
  
  // Parse existing data
  var accountId = '';
  var categoryId = '';
  var subcategoryId = '';
  
  if (isEdit && item.Metadata) {
    try {
      var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
      accountId = meta.accountId || '';
    } catch(e) {
      console.error('Parse metadata error:', e);
    }
  }
  
  if (isEdit && item['Danh m·ª•c chi ti√™u']) {
    try {
      var cat = typeof item['Danh m·ª•c chi ti√™u'] === 'string' ? 
        JSON.parse(item['Danh m·ª•c chi ti√™u']) : item['Danh m·ª•c chi ti√™u'];
      if (cat && cat[0]) {
        categoryId = cat[0].id || '';
        subcategoryId = cat[0].subcategoryId || '';
      }
    } catch(e) {
      console.error('Parse category error:', e);
    }
  }
  
  // Build modal HTML
  var body = 
    '<form id="expenseForm" onsubmit="handleSaveExpense(event, \'' + (id || '') + '\')">' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-calendar"></i> Ng√†y <span style="color: red;">*</span></label>' +
    '<input type="date" id="expenseDate" name="Ng√†y" class="form-control" value="' + 
    (item['Ng√†y'] || new Date().toISOString().split('T')[0]) + '" required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-tag"></i> Danh m·ª•c ch√≠nh <span style="color: red;">*</span></label>' +
    '<select id="expenseCategory" name="Danh m·ª•c" class="form-control" onchange="loadExpenseSubcategories()" required>' +
    '<option value="">-- Loading categories... --</option>' +
    '</select>' +
    '</div>' +
    
    '<div class="form-group" id="expenseSubcategoryWrapper" style="display: none;">' +
    '<label><i class="fas fa-sitemap"></i> Danh m·ª•c con (T√πy ch·ªçn)</label>' +
    '<select id="expenseSubcategory" class="form-control">' +
    '<option value="">-- Kh√¥ng ch·ªçn --</option>' +
    '</select>' +
    '<small style="color: #718096; display: block; margin-top: 5px;">N·∫øu kh√¥ng ch·ªçn, ch·ªâ l∆∞u danh m·ª•c ch√≠nh</small>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-money-bill-wave"></i> S·ªë ti·ªÅn (VNƒê) <span style="color: red;">*</span></label>' +
    '<input type="text" id="expenseAmount" name="S·ªë ti·ªÅn" class="form-control currency-input" value="' + 
    (isEdit ? formatCurrency(item['S·ªë ti·ªÅn']) : '0') + '" required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-university"></i> T√†i kho·∫£n thanh to√°n <span style="color: red;">*</span></label>' +
    '<select id="expensePayment" name="T√†i kho·∫£n" class="form-control" required>' + 
    renderAccountOptions(accountId) + 
    '</select>' +
    '<small id="accountBalanceHint" style="color: #718096; display: block; margin-top: 5px;"></small>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-comment"></i> M√¥ t·∫£</label>' +
    '<textarea id="expenseDescription" class="form-control" rows="3" placeholder="Ghi ch√∫ v·ªÅ kho·∫£n chi...">' + 
    (item['M√¥ t·∫£'] || '') + '</textarea>' +
    '</div>' +
    
    '</form>';
  
  var footer = 
    '<button type="button" class="btn-secondary" onclick="closeModal()">' +
    '<i class="fas fa-times"></i> H·ªßy' +
    '</button>' +
    '<button type="button" class="btn-primary" onclick="document.getElementById(\'expenseForm\').requestSubmit()">' +
    '<i class="fas fa-save"></i> L∆∞u' +
    '</button>';
  
  openModal(
    isEdit ? '‚úèÔ∏è S·ª≠a chi ti√™u' : '‚ûï Th√™m chi ti√™u', 
    body, 
    footer
  );
  
  // Initialize after modal opens
  setTimeout(function() {
    console.log('üîß Initializing expense modal...');
    
    // 1. Load categories from cache (INSTANT)
    const categories = DataManager.getCategories('expense');
    console.log('‚úÖ Loaded', categories.length, 'expense categories from cache');
    
    var categorySelect = document.getElementById('expenseCategory');
    if (categorySelect) {
      categorySelect.innerHTML = renderCategoryOptions(categories, categoryId);
      
      if (categoryId) {
        loadExpenseSubcategories().then(function() {
          if (subcategoryId) {
            var subcatSelect = document.getElementById('expenseSubcategory');
            if (subcatSelect) {
              subcatSelect.value = subcategoryId;
            }
          }
        });
      }
    }
    
    // 2. Setup currency input
    setupCurrencyInput(document.getElementById('expenseAmount'));
    
    // 3. Enable real-time validation
    const form = document.getElementById('expenseForm');
    if (form) {
      Validator.enableRealTimeValidation(form, 'expense');
    }
    
    // 4. Show account balance hint
    updateAccountBalanceHint();
    
    // 5. Listen to account change
    var accountSelect = document.getElementById('expensePayment');
    if (accountSelect) {
      accountSelect.addEventListener('change', updateAccountBalanceHint);
    }
    
    // 6. Focus first input
    document.getElementById('expenseDate').focus();
    
    console.log('‚úÖ Expense modal initialized');
  }, 100);
}


// ========================================
// LOAD EXPENSE SUBCATEGORIES
// ========================================

function loadExpenseSubcategories() {
  return new Promise(function(resolve, reject) {
    var categorySelect = document.getElementById('expenseCategory');
    var subcategoryWrapper = document.getElementById('expenseSubcategoryWrapper');
    var subcategorySelect = document.getElementById('expenseSubcategory');
    
    if (!categorySelect || !subcategoryWrapper || !subcategorySelect) {
      reject('Elements not found');
      return;
    }
    
    var categoryId = categorySelect.value;
    
    if (!categoryId) {
      subcategoryWrapper.style.display = 'none';
      subcategorySelect.innerHTML = '<option value="">-- Kh√¥ng ch·ªçn --</option>';
      resolve();
      return;
    }
    
    console.log('üì• Loading subcategories for:', categoryId);
    
    subcategorySelect.innerHTML = '<option value="">-- ƒêang t·∫£i... --</option>';
    subcategoryWrapper.style.display = 'block';
    
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success && response.data.length > 0) {
          console.log('‚úÖ Loaded', response.data.length, 'subcategories');
          subcategorySelect.innerHTML = renderSubcategoryOptions(response.data, '');
          subcategoryWrapper.style.display = 'block';
        } else {
          subcategorySelect.innerHTML = '<option value="">-- Kh√¥ng c√≥ danh m·ª•c con --</option>';
          subcategoryWrapper.style.display = 'block';
        }
        resolve();
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Load subcategories error:', error);
        subcategorySelect.innerHTML = '<option value="">-- L·ªói t·∫£i d·ªØ li·ªáu --</option>';
        reject(error);
      })
      .handleRequest('getSubcategories', { 
        parentId: categoryId,
        userId: currentUser.userId 
      });
  });
}

// ========================================
// UPDATE ACCOUNT BALANCE HINT
// ========================================

function updateAccountBalanceHint() {
  var accountSelect = document.getElementById('expensePayment');
  var hint = document.getElementById('accountBalanceHint');
  
  if (!accountSelect || !hint) return;
  
  var accountId = accountSelect.value;
  if (!accountId) {
    hint.textContent = '';
    return;
  }
  
  const accounts = DataManager.getAccounts();
  const account = accounts.find(a => a.AccountID === accountId);
  
  if (account) {
    const balance = parseCurrency(account['S·ªë d∆∞ hi·ªán t·∫°i']);
    hint.innerHTML = '<i class="fas fa-info-circle"></i> S·ªë d∆∞: <strong>' + 
      formatCurrency(balance) + ' ƒë</strong>';
    
    if (balance <= 0) {
      hint.style.color = '#e94849';
    } else {
      hint.style.color = '#718096';
    }
  }
}


// ========================================
// SAVE EXPENSE - WITH VALIDATION & ERROR RECOVERY
// ========================================

async function handleSaveExpense(event, id) {
  event.preventDefault();
  
  console.log('=== SAVING EXPENSE ===', id ? 'UPDATE' : 'CREATE');
  
  Validator.clearErrors();
  
  // Collect form data
  var formData = {
    'Ng√†y': document.getElementById('expenseDate').value,
    'Danh m·ª•c': document.getElementById('expenseCategory').value,
    'S·ªë ti·ªÅn': parseCurrency(document.getElementById('expenseAmount').value),
    'T√†i kho·∫£n': document.getElementById('expensePayment').value
  };
  
  var subcategoryId = document.getElementById('expenseSubcategory') ? 
    document.getElementById('expenseSubcategory').value : '';
  var description = document.getElementById('expenseDescription').value;
  
  // Validate
  const validation = Validator.validate(formData, 'expense');
  
  if (!validation.valid) {
    console.log('‚ùå Validation failed:', validation.errors);
    Validator.showErrors(validation.errors);
    return;
  }
  
  // Check account balance
  const balanceCheck = Validator.rules.accountBalance(formData['S·ªë ti·ªÅn'], formData['T√†i kho·∫£n']);
  if (balanceCheck) {
    Validator.showErrors({ 'S·ªë ti·ªÅn': balanceCheck });
    return;
  }
  
  // Get category details
  var categoryInfo = DataManager.getCategoryById(formData['Danh m·ª•c']);
  var categoryName = categoryInfo ? categoryInfo.name : formData['Danh m·ª•c'];
  
  // Build category data
  var categoryData = {
    id: formData['Danh m·ª•c'],
    name: categoryName
  };
  
  if (subcategoryId) {
    var subcategorySelect = document.getElementById('expenseSubcategory');
    var subcategoryName = '';
    
    if (subcategorySelect) {
      var selectedOption = subcategorySelect.options[subcategorySelect.selectedIndex];
      if (selectedOption) {
        subcategoryName = selectedOption.text.replace('‚îú‚îÄ ', '').trim();
      }
    }
    
    categoryData.subcategory = subcategoryName;
    categoryData.subcategoryId = subcategoryId;
  }
  
  // Build record data
  var recordData = {
    'ID': id || generateId('CT'),
    'Ng√†y': formData['Ng√†y'],
    'Danh m·ª•c chi ti√™u': JSON.stringify([categoryData]),
    'S·ªë ti·ªÅn': formData['S·ªë ti·ªÅn'],
    'M√¥ t·∫£': description,
    'Ph∆∞∆°ng th·ª©c thanh to√°n': JSON.stringify([{
      id: formData['T√†i kho·∫£n'], 
      name: getAccountName(formData['T√†i kho·∫£n'])
    }]),
    'UserID': currentUser.userId,
    'Metadata': JSON.stringify({accountId: formData['T√†i kho·∫£n']})
  };
  
  console.log('üíæ Record data:', recordData);
  
  closeModal();
  showLoading('ƒêang l∆∞u...');
  
  try {
    // Optimistic update
    if (id) {
      DataManager.updateRecord('Chi ti√™u', id, recordData);
    } else {
      DataManager.addRecord('Chi ti√™u', recordData);
    }
    
    // Update UI immediately
    allExpenseData = DataManager.getExpense();
    expenseFilteredData = allExpenseData.slice();
    renderExpensePage();
    
    // Save to server with retry
    var action = id ? 'updateRecord' : 'createRecord';
    var params = id ? 
      {sheetName: 'Chi ti√™u', id: id, data: recordData} : 
      {sheetName: 'Chi ti√™u', data: recordData};
    
    const response = await ErrorHandler.callWithRetry(action, params);
    
    if (response.success) {
      console.log('‚úÖ Server save successful');
      
      // Update account balance
      try {
        await ErrorHandler.callWithRetry('updateAccountBalance', {
          accountId: formData['T√†i kho·∫£n'],
          amount: formData['S·ªë ti·ªÅn'],
          type: 'subtract'
        });
        
        // Refresh accounts
        const accountsData = await DataManager.refresh('T√†i kho·∫£n');
        allAccountsData = accountsData;
        
        console.log('‚úÖ Account balance updated');
      } catch (balanceError) {
        console.error('‚ö†Ô∏è Balance update failed:', balanceError);
      }
      
      hideLoading();
      showToast('‚úÖ ƒê√£ l∆∞u chi ti√™u v√† c·∫≠p nh·∫≠t ng√¢n s√°ch!', 'success');
      
    } else {
      throw new Error(response.message || 'Save failed');
    }
    
  } catch (error) {
    console.error('‚ùå Save error:', error);
    
    // Rollback
    await DataManager.refresh('Chi ti√™u');
    allExpenseData = DataManager.getExpense();
    expenseFilteredData = allExpenseData.slice();
    renderExpensePage();
    
    hideLoading();
  }
}

function editExpense(id) {
  openExpenseModal(id);
}

function confirmDeleteExpense(id) {
  var body = '<p style="text-align: center; font-size: 16px; margin: 20px 0;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?</p>' +
    '<p style="text-align: center; color: #e94849; font-weight: 500;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-danger" onclick="executeDeleteExpense(\'' + id + '\')">X√≥a</button>';
  
  openModal('X√°c nh·∫≠n x√≥a', body, footer);
}

function executeDeleteExpense(id) {
  closeModal();
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        showToast('X√≥a th√†nh c√¥ng', 'success');
        reloadExpenseData();
        
        // ===== TH√äM ƒêO·∫†N N√ÄY =====
        // Force refresh budget
        setTimeout(function() {
          DataManager.refresh('Ng√¢n s√°ch').then(function() {
            allBudgetData = DataManager.getBudget();
            if (currentPage === 'budget') {
              renderBudgetPage();
            }
          });
        }, 2000);
        // ===== K·∫æT TH√öC =====
        
      } else {
        hideLoading();
        showToast(response.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('deleteRecord', {sheetName: 'Chi ti√™u', id: id});
}

function forceUpdateAllBudgets() {
  console.log('Force updating all budgets...');
  
  showLoading('ƒêang c·∫≠p nh·∫≠t ng√¢n s√°ch...');
  
  // Get current month from filter or use current month
  var month = budgetFilters.monthFrom || new Date().toISOString().substring(0, 7);
  
  google.script.run
    .withSuccessHandler(function(response) {
      hideLoading();
      
      if (response.success) {
        showToast('ƒê√£ c·∫≠p nh·∫≠t ' + response.updated + ' ng√¢n s√°ch', 'success');
        
        // Reload budget data
        DataManager.refresh('Ng√¢n s√°ch').then(function() {
          allBudgetData = DataManager.getBudget();
          renderBudgetPage();
        });
      } else {
        showToast('L·ªói: ' + response.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('updateAllBudgets', { month: month });
}

function reloadExpenseData() {
  showLoading();
  
  Promise.all([
    loadSheetData('Chi ti√™u'),
    loadSheetData('T√†i kho·∫£n')
  ]).then(function(results) {
    allExpenseData = results[0];
    allAccountsData = results[1];
    
    hideLoading();
    renderExpensePage();
    showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
  }).catch(function(error) {
    hideLoading();
    console.error('Reload error:', error);
    showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
  });
}

</script>
