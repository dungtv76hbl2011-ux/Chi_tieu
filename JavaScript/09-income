<script>

function showIncomePage() {
  console.log('=== SHOWING INCOME PAGE ===');
  
  // Reset v·ªÅ trang 1 khi m·ªü page
  incomeCurrentPage = 1;
  incomeFilteredData = allIncomeData.slice();
  
  renderIncomePage();
}

function renderIncomePage() {
  console.log('=== RENDERING INCOME PAGE (CACHED) ===');
  
  // Use cached data
  if (!incomeFilteredData.length) {
    incomeFilteredData = DataManager.getIncome();
  }
  // Apply filters
  applyIncomeFilters();
  
  var totalRecords = incomeFilteredData.length;
  var totalPages = Math.ceil(totalRecords / incomeItemsPerPage);
  
  if (incomeCurrentPage > totalPages && totalPages > 0) {
    incomeCurrentPage = totalPages;
  }
  
  if (incomeCurrentPage < 1) {
    incomeCurrentPage = 1;
  }
  
  var html = '<div class="card">' +
    '<div class="card-header">' +
    '<h2 class="card-title">Danh s√°ch Thu nh·∫≠p</h2>' +
    '<div style="display: flex; gap: 10px;">' +
    '<button class="btn-secondary" onclick="downloadIncomeTemplate()"><i class="fas fa-download"></i> T·∫£i m·∫´u Excel</button>' +
    '<button class="btn-secondary" onclick="openIncomeImportModal()"><i class="fas fa-file-import"></i> Import Excel</button>' +
    '<button class="btn-primary" onclick="openIncomeModal()"><i class="fas fa-plus"></i> Th√™m thu nh·∫≠p</button>' +
    '</div>' +
    '</div>' +
    
    // FILTER PANEL
    '<div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">T·ª´ ng√†y</label>' +
    '<input type="date" id="incomeFilterFromDate" class="form-control" value="' + incomeFilters.fromDate + '" onchange="renderIncomePage()"></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">ƒê·∫øn ng√†y</label>' +
    '<input type="date" id="incomeFilterToDate" class="form-control" value="' + incomeFilters.toDate + '" onchange="renderIncomePage()"></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">Danh m·ª•c</label>' +
    '<select id="incomeFilterCategory" class="form-control" onchange="renderIncomePage()"><option value="">T·∫•t c·∫£</option>' +
    '<option value="salary">L∆∞∆°ng</option><option value="bonus">Th∆∞·ªüng</option>' +
    '<option value="investment">ƒê·∫ßu t∆∞</option><option value="freelance">Freelance</option><option value="other">Kh√°c</option></select></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">T√†i kho·∫£n</label>' +
    '<select id="incomeFilterAccount" class="form-control" onchange="renderIncomePage()"><option value="">T·∫•t c·∫£</option>' + 
    renderAccountOptionsForFilter() + '</select></div>' +
    '<div style="display: flex; align-items: flex-end;"><button class="btn-secondary" onclick="clearIncomeFilters()" style="width: 100%;">X√≥a b·ªô l·ªçc</button></div>' +
    '</div></div>' +
        
    '<div style="margin-bottom: 10px; color: #718096; display: flex; justify-content: space-between; align-items: center;">' +
    '<span>Hi·ªÉn th·ªã ' + ((incomeCurrentPage - 1) * incomeItemsPerPage + 1) + ' - ' + 
    Math.min(incomeCurrentPage * incomeItemsPerPage, totalRecords) + ' trong t·ªïng s·ªë ' + totalRecords + ' b·∫£n ghi</span>' +
    '<div style="display: flex; gap: 10px; align-items: center;">' +
    '<label style="margin: 0;">Hi·ªÉn th·ªã:</label>' +
    '<select onchange="changeIncomeItemsPerPage(this.value)" class="form-control" style="width: auto; padding: 5px 10px;">' +
    '<option value="5"' + (incomeItemsPerPage === 5 ? ' selected' : '') + '>5</option>' +
    '<option value="10"' + (incomeItemsPerPage === 10 ? ' selected' : '') + '>10</option>' +
    '<option value="20"' + (incomeItemsPerPage === 20 ? ' selected' : '') + '>20</option>' +
    '<option value="50"' + (incomeItemsPerPage === 50 ? ' selected' : '') + '>50</option>' +
    '</select>' +
    '</div></div>' +
    
    '<div style="overflow: auto; max-height: calc(100vh - 400px); position: relative;">' +
    '<table>' +
    '<thead>' +
    '<tr>' +
    '<th class="sticky-column">Ng√†y</th>' +
    '<th>Danh m·ª•c</th>' +
    '<th>S·ªë ti·ªÅn</th>' +
    '<th>M√¥ t·∫£</th>' +
    '<th>T√†i kho·∫£n</th>' +
    '<th>H√†nh ƒë·ªông</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody>' + renderIncomeTableWithPagination() + '</tbody>' +
    '</table></div>' +
    
    // PAGINATION
    renderIncomePagination(totalPages) +
    
    '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
  
  // Restore filter values
  var fromDateEl = document.getElementById('incomeFilterFromDate');
  var toDateEl = document.getElementById('incomeFilterToDate');
  var categoryEl = document.getElementById('incomeFilterCategory');
  var accountEl = document.getElementById('incomeFilterAccount');
  
  if (fromDateEl) fromDateEl.value = incomeFilters.fromDate;
  if (toDateEl) toDateEl.value = incomeFilters.toDate;
  if (categoryEl) categoryEl.value = incomeFilters.category;
  if (accountEl) accountEl.value = incomeFilters.accountId;
}

function applyIncomeFilters() {
  // ƒê·ªçc gi√° tr·ªã filter t·ª´ input
  var fromDateEl = document.getElementById('incomeFilterFromDate');
  var toDateEl = document.getElementById('incomeFilterToDate');
  var categoryEl = document.getElementById('incomeFilterCategory');
  var accountEl = document.getElementById('incomeFilterAccount');
  
  if (fromDateEl) incomeFilters.fromDate = fromDateEl.value;
  if (toDateEl) incomeFilters.toDate = toDateEl.value;
  if (categoryEl) incomeFilters.category = categoryEl.value;
  if (accountEl) incomeFilters.accountId = accountEl.value;
  
  // Filter data
  incomeFilteredData = [];
  
  for (var i = 0; i < allIncomeData.length; i++) {
    var item = allIncomeData[i];
    var itemDate = item['Ng√†y'];
    
    // Filter by date range
    if (incomeFilters.fromDate && itemDate < incomeFilters.fromDate) continue;
    if (incomeFilters.toDate && itemDate > incomeFilters.toDate) continue;
    
    // Filter by category
    if (incomeFilters.category) {
      try {
        var cat = typeof item['Danh m·ª•c thu nh·∫≠p'] === 'string' ? 
          JSON.parse(item['Danh m·ª•c thu nh·∫≠p']) : item['Danh m·ª•c thu nh·∫≠p'];
        if (!cat || !cat[0] || cat[0].id !== incomeFilters.category) continue;
      } catch(e) {
        continue;
      }
    }
    
    // Filter by account
    if (incomeFilters.accountId) {
      try {
        var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
        if (!meta || meta.accountId !== incomeFilters.accountId) continue;
      } catch(e) {
        continue;
      }
    }
    
    incomeFilteredData.push(item);
  }
}

function clearIncomeFilters() {
  console.log('=== CLEARING INCOME FILTERS ===');
  
  // Reset filter values
  incomeFilters = { 
    fromDate: '', 
    toDate: '', 
    category: '', 
    accountId: '' 
  };
  
  // Reset to page 1
  incomeCurrentPage = 1;
  
  // Reset filtered data to all data
  incomeFilteredData = allIncomeData.slice();
  
  console.log('Filters cleared, rendering page...');
  
  // Re-render page
  renderIncomePage();
  
  // Force clear input values after render
  setTimeout(function() {
    var fromDateEl = document.getElementById('incomeFilterFromDate');
    var toDateEl = document.getElementById('incomeFilterToDate');
    var categoryEl = document.getElementById('incomeFilterCategory');
    var accountEl = document.getElementById('incomeFilterAccount');
    
    if (fromDateEl) fromDateEl.value = '';
    if (toDateEl) toDateEl.value = '';
    if (categoryEl) categoryEl.value = '';
    if (accountEl) accountEl.value = '';
    
    console.log('Input values cleared');
  }, 100);
}

function changeIncomeItemsPerPage(value) {
  incomeItemsPerPage = parseInt(value);
  incomeCurrentPage = 1;
  renderIncomePage();
}

function renderIncomeTableWithPagination() {
  if (!incomeFilteredData || incomeFilteredData.length === 0) {
    return '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
  }
  
  var startIndex = (incomeCurrentPage - 1) * incomeItemsPerPage;
  var endIndex = Math.min(startIndex + incomeItemsPerPage, incomeFilteredData.length);
  
  var html = '';
  
  for (var i = startIndex; i < endIndex; i++) {
    var item = incomeFilteredData[i];
    var id = item.ID || 'N/A';
    var accountId = '';
    
    try {
      var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
      accountId = meta.accountId || '';
    } catch(e) {}
    
    var categoryName = getCategoryName(item['Danh m·ª•c thu nh·∫≠p']);
    
    html += '<tr>' +
      '<td class="sticky-column">' + formatDate(item['Ng√†y']) + '</td>' +
      '<td>' + categoryName + '</td>' +
      '<td style="color: #24c560; font-weight: 600;">' + formatCurrency(item['S·ªë ti·ªÅn']) + ' ƒë</td>' +
      '<td>' + (item['M√¥ t·∫£'] || '-') + '</td>' +
      '<td>' + getAccountName(accountId) + '</td>' +
      '<td class="action-buttons">' +
      '<button class="btn-primary btn-sm" onclick="editIncome(\'' + id + '\')"><i class="fas fa-edit"></i></button>' +
      '<button class="btn-danger btn-sm" onclick="confirmDeleteIncome(\'' + id + '\')"><i class="fas fa-trash"></i></button>' +
      '</td></tr>';
  }
  
  return html;
}

function renderIncomePagination(totalPages) {
  if (totalPages <= 1) return '';
  
  var html = '<div style="display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px;">';
  
  // Previous button
  html += '<button class="btn-secondary btn-sm" onclick="incomeGoToPage(' + (incomeCurrentPage - 1) + ')" ' + 
    (incomeCurrentPage === 1 ? 'disabled' : '') + '><i class="fas fa-chevron-left"></i></button>';
  
  // Page numbers
  var startPage = Math.max(1, incomeCurrentPage - 2);
  var endPage = Math.min(totalPages, incomeCurrentPage + 2);
  
  if (startPage > 1) {
    html += '<button class="btn-secondary btn-sm" onclick="incomeGoToPage(1)">1</button>';
    if (startPage > 2) html += '<span>...</span>';
  }
  
  for (var i = startPage; i <= endPage; i++) {
    if (i === incomeCurrentPage) {
      html += '<button class="btn-primary btn-sm" disabled>' + i + '</button>';
    } else {
      html += '<button class="btn-secondary btn-sm" onclick="incomeGoToPage(' + i + ')">' + i + '</button>';
    }
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span>...</span>';
    html += '<button class="btn-secondary btn-sm" onclick="incomeGoToPage(' + totalPages + ')">' + totalPages + '</button>';
  }
  
  // Next button
  html += '<button class="btn-secondary btn-sm" onclick="incomeGoToPage(' + (incomeCurrentPage + 1) + ')" ' + 
    (incomeCurrentPage === totalPages ? 'disabled' : '') + '><i class="fas fa-chevron-right"></i></button>';
  
  html += '</div>';
  
  return html;
}

function incomeGoToPage(page) {
  incomeCurrentPage = page;
  renderIncomePage();
  window.scrollTo(0, 0);
}

function renderAccountOptionsForFilter() {
  var html = '';
  
  if (!allAccountsData || allAccountsData.length === 0) {
    return html;
  }
  
  for (var i = 0; i < allAccountsData.length; i++) {
    var acc = allAccountsData[i];
    html += '<option value="' + acc.AccountID + '">' + acc['T√™n t√†i kho·∫£n'] + '</option>';
  }
  
  return html;
}

// DELETE WITH MODAL CONFIRMATION
function confirmDeleteIncome(id) {
  var body = '<p style="text-align: center; font-size: 16px; margin: 20px 0;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?</p>' +
    '<p style="text-align: center; color: #e94849; font-weight: 500;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-danger" onclick="executeDeleteIncome(\'' + id + '\')">X√≥a</button>';
  
  openModal('X√°c nh·∫≠n x√≥a', body, footer);
}

function executeDeleteIncome(id) {
  closeModal();
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        reloadIncomeData();
      } else {
        hideLoading();
        showToast(response.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('deleteRecord', {sheetName: 'Thu nh·∫≠p', id: id});
}

// DOWNLOAD EXCEL TEMPLATE
function downloadIncomeTemplate() {
  // T·∫°o workbook m·ªõi
  var wb = XLSX.utils.book_new();
  
  // T·∫°o data v·ªõi format ƒë·∫πp
  var wsData = [
    ['Ng√†y', 'Danh m·ª•c', 'S·ªë ti·ªÅn', 'M√¥ t·∫£', 'T√†i kho·∫£n'],
    ['2025-10-20', 'salary', 15000000, 'L∆∞∆°ng th√°ng 10', 'ACC001'],
    ['2025-10-21', 'bonus', 5000000, 'Th∆∞·ªüng d·ª± √°n', 'ACC002']
  ];
  
  // T·∫°o worksheet
  var ws = XLSX.utils.aoa_to_sheet(wsData);
  
  // Set column widths
  ws['!cols'] = [
    { wch: 12 },  // Ng√†y
    { wch: 15 },  // Danh m·ª•c
    { wch: 15 },  // S·ªë ti·ªÅn
    { wch: 30 },  // M√¥ t·∫£
    { wch: 12 }   // T√†i kho·∫£n
  ];
  
  // Add worksheet to workbook
  XLSX.utils.book_append_sheet(wb, ws, 'Income_Template');
  
  // T·∫°o file Excel
  var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  var blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  
  // Download file
  var link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'Income_Template.xlsx';
  link.click();
  
  showToast('ƒê√£ t·∫£i xu·ªëng file m·∫´u Excel', 'success');
}

function openIncomeImportModal() {
  var body = '<div class="form-group">' +
    '<label>Ch·ªçn file Excel/CSV</label>' +
    '<input type="file" id="incomeImportFile" accept=".xlsx,.xls,.csv" class="form-control">' +
    '<small style="color: #718096; margin-top: 5px; display: block;">ƒê·ªãnh d·∫°ng: XLSX, XLS, CSV</small>' +
    '<small style="color: #718096; margin-top: 5px; display: block;">C·∫•u tr√∫c: Ng√†y | Danh m·ª•c | S·ªë ti·ªÅn | M√¥ t·∫£ | T√†i kho·∫£n</small>' +
    '<div style="margin-top: 10px; padding: 10px; background: #fffbeb; border-left: 3px solid #f59e0b; border-radius: 4px;">' +
    '<strong>L∆∞u √Ω:</strong><br>' +
    '<ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">' +
    '<li>Ng√†y: ƒê·ªãnh d·∫°ng YYYY-MM-DD (VD: 2025-10-20)</li>' +
    '<li>Danh m·ª•c: salary, bonus, investment, freelance, other</li>' +
    '<li>S·ªë ti·ªÅn: S·ªë nguy√™n (VD: 15000000)</li>' +
    '<li>T√†i kho·∫£n: M√£ t√†i kho·∫£n (VD: ACC001)</li>' +
    '</ul>' +
    '</div>' +
    '</div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-primary" onclick="processIncomeImport()">Import</button>';
  
  openModal('Import d·ªØ li·ªáu Thu nh·∫≠p', body, footer);
}

// PROCESS IMPORT EXCEL
function processIncomeImport() {
  var fileInput = document.getElementById('incomeImportFile');
  
  if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
    showToast('Vui l√≤ng ch·ªçn file', 'error');
    return;
  }
  
  var file = fileInput.files[0];
  var reader = new FileReader();
  
  closeModal();
  showLoading();
  
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, { type: 'array' });
      var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      var jsonData = XLSX.utils.sheet_to_json(firstSheet);
      
      console.log('Imported income data:', jsonData);
      
      if (jsonData.length === 0) {
        hideLoading();
        showToast('File kh√¥ng c√≥ d·ªØ li·ªáu', 'error');
        return;
      }
      
      // X·ª≠ l√Ω t·ª´ng d√≤ng tu·∫ßn t·ª±
      var successCount = 0;
      var errorCount = 0;
      
      function processRow(index) {
        if (index >= jsonData.length) {
          // Ho√†n th√†nh
          console.log('=== IMPORT COMPLETED ===');
          console.log('Success:', successCount, 'Error:', errorCount);
          
          hideLoading();
          
          if (successCount > 0) {
            showToast('Import th√†nh c√¥ng ' + successCount + ' / ' + jsonData.length + ' b·∫£n ghi', 'success');
            
            // Reload data with delay
            console.log('Reloading income data in 1 second...');
            setTimeout(function() {
              Promise.all([
                loadSheetData('Thu nh·∫≠p'),
                loadSheetData('T√†i kho·∫£n')
              ]).then(function(results) {
                allIncomeData = results[0];
                allAccountsData = results[1];
                incomeFilteredData = allIncomeData.slice(); // Reset filter
                incomeCurrentPage = 1; // Reset v·ªÅ trang 1
                
                console.log('Income data reloaded:', allIncomeData.length, 'records');
                
                renderIncomePage();
              }).catch(function(error) {
                console.error('Error reloading income data:', error);
                showToast('L·ªói t·∫£i l·∫°i d·ªØ li·ªáu', 'error');
              });
            }, 1500); // Delay 1.5 gi√¢y
          } else {
            showToast('Kh√¥ng c√≥ b·∫£n ghi n√†o ƒë∆∞·ª£c import', 'error');
          }
          
          if (errorCount > 0) {
            showToast('C√≥ ' + errorCount + ' l·ªói', 'error');
          }
          
          return;
        }
        
        var row = jsonData[index];
        
        console.log('Processing income row ' + (index + 1) + ':', row);
        
        // Validate
        if (!row['Ng√†y'] || !row['Danh m·ª•c'] || !row['S·ªë ti·ªÅn'] || !row['T√†i kho·∫£n']) {
          console.error('Row ' + (index + 1) + ': Missing required fields');
          errorCount++;
          processRow(index + 1);
          return;
        }
        
        // Parse date
        var dateValue = row['Ng√†y'];
        var formattedDate = '';
        
        if (typeof dateValue === 'number') {
          var excelDate = XLSX.SSF.parse_date_code(dateValue);
          formattedDate = excelDate.y + '-' + 
            String(excelDate.m).padStart(2, '0') + '-' + 
            String(excelDate.d).padStart(2, '0');
        } else if (typeof dateValue === 'string') {
          formattedDate = dateValue;
        } else {
          console.error('Row ' + (index + 1) + ': Invalid date format');
          errorCount++;
          processRow(index + 1);
          return;
        }
        
        var accountId = row['T√†i kho·∫£n'];
        var amount = parseFloat(row['S·ªë ti·ªÅn']);
        
        // Create record
        var recordData = {
          'ID': generateId('TN'),
          'Ng√†y': formattedDate,
          'Danh m·ª•c thu nh·∫≠p': JSON.stringify([{
            id: row['Danh m·ª•c'], 
            name: getCategoryLabel(row['Danh m·ª•c'])
          }]),
          'S·ªë ti·ªÅn': amount,
          'M√¥ t·∫£': row['M√¥ t·∫£'] || '',
          'Ph∆∞∆°ng th·ª©c thanh to√°n': JSON.stringify([{
            id: accountId, 
            name: getAccountName(accountId)
          }]),
          'UserID': currentUser.userId,
          'Metadata': JSON.stringify({accountId: accountId})
        };
        
        console.log('Creating income record:', recordData);
        
        // Create record in Sheet
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              console.log('Income row ' + (index + 1) + ' created successfully');
              
              // Update account balance (ADD)
              google.script.run
                .withSuccessHandler(function(balanceResponse) {
                  console.log('Balance updated for income row ' + (index + 1));
                  successCount++;
                  processRow(index + 1);
                })
                .withFailureHandler(function(error) {
                  console.error('Balance update failed for income row ' + (index + 1) + ':', error);
                  successCount++; // V·∫´n t√≠nh l√† th√†nh c√¥ng
                  processRow(index + 1);
                })
                .handleRequest('updateAccountBalance', {
                  accountId: accountId,
                  amount: amount,
                  type: 'add'
                });
            } else {
              console.error('Income row ' + (index + 1) + ' failed:', response.message);
              errorCount++;
              processRow(index + 1);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Income row ' + (index + 1) + ' error:', error);
            errorCount++;
            processRow(index + 1);
          })
          .handleRequest('createRecord', {
            sheetName: 'Thu nh·∫≠p',
            data: recordData
          });
        
      }
      
      // B·∫Øt ƒë·∫ßu x·ª≠ l√Ω t·ª´ row 0
      processRow(0);
      
    } catch (error) {
      hideLoading();
      showToast('L·ªói ƒë·ªçc file: ' + error.message, 'error');
      console.error('Import error:', error);
    }
  };
  
  reader.onerror = function() {
    hideLoading();
    showToast('L·ªói ƒë·ªçc file', 'error');
  };
  
  reader.readAsArrayBuffer(file);
}

// ========================================
// INCOME MODAL - OPTIMIZED VERSION
// ========================================

function openIncomeModal(id) {
  console.log('=== OPENING INCOME MODAL ===', id ? 'EDIT' : 'CREATE');
  
  var isEdit = !!id;
  var item = {};
  
  if (isEdit) {
    // Use DataManager for instant lookup
    const incomeList = DataManager.getIncome();
    item = incomeList.find(i => i.ID === id) || {};
    
    if (!item.ID) {
      showToast('Kh√¥ng t√¨m th·∫•y b·∫£n ghi', 'error');
      return;
    }
  }
  
  // Parse existing data
  var accountId = '';
  var categoryId = '';
  var subcategoryId = '';
  
  if (isEdit && item.Metadata) {
    try {
      var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
      accountId = meta.accountId || '';
    } catch(e) {
      console.error('Parse metadata error:', e);
    }
  }
  
  if (isEdit && item['Danh m·ª•c thu nh·∫≠p']) {
    try {
      var cat = typeof item['Danh m·ª•c thu nh·∫≠p'] === 'string' ? 
        JSON.parse(item['Danh m·ª•c thu nh·∫≠p']) : item['Danh m·ª•c thu nh·∫≠p'];
      if (cat && cat[0]) {
        categoryId = cat[0].id || '';
        subcategoryId = cat[0].subcategoryId || '';
      }
    } catch(e) {
      console.error('Parse category error:', e);
    }
  }
  
  // Build modal HTML
  var body = 
    '<form id="incomeForm" onsubmit="handleSaveIncome(event, \'' + (id || '') + '\')">' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-calendar"></i> Ng√†y <span style="color: red;">*</span></label>' +
    '<input type="date" id="incomeDate" name="Ng√†y" class="form-control" value="' + 
    (item['Ng√†y'] || new Date().toISOString().split('T')[0]) + '" required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-tag"></i> Danh m·ª•c ch√≠nh <span style="color: red;">*</span></label>' +
    '<select id="incomeCategory" name="Danh m·ª•c" class="form-control" onchange="loadIncomeSubcategories()" required>' +
    '<option value="">-- Loading categories... --</option>' +
    '</select>' +
    '</div>' +
    
    '<div class="form-group" id="incomeSubcategoryWrapper" style="display: none;">' +
    '<label><i class="fas fa-sitemap"></i> Danh m·ª•c con (T√πy ch·ªçn)</label>' +
    '<select id="incomeSubcategory" class="form-control">' +
    '<option value="">-- Kh√¥ng ch·ªçn --</option>' +
    '</select>' +
    '<small style="color: #718096; display: block; margin-top: 5px;">N·∫øu kh√¥ng ch·ªçn, ch·ªâ l∆∞u danh m·ª•c ch√≠nh</small>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-money-bill-wave"></i> S·ªë ti·ªÅn (VNƒê) <span style="color: red;">*</span></label>' +
    '<input type="text" id="incomeAmount" name="S·ªë ti·ªÅn" class="form-control currency-input" value="' + 
    (isEdit ? formatCurrency(item['S·ªë ti·ªÅn']) : '0') + '" required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-university"></i> T√†i kho·∫£n nh·∫≠n <span style="color: red;">*</span></label>' +
    '<select id="incomePayment" name="T√†i kho·∫£n" class="form-control" required>' + 
    renderAccountOptions(accountId) + 
    '</select>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-comment"></i> M√¥ t·∫£</label>' +
    '<textarea id="incomeDescription" class="form-control" rows="3" placeholder="Ghi ch√∫ v·ªÅ kho·∫£n thu nh·∫≠p...">' + 
    (item['M√¥ t·∫£'] || '') + '</textarea>' +
    '</div>' +
    
    '</form>';
  
  var footer = 
    '<button type="button" class="btn-secondary" onclick="closeModal()">' +
    '<i class="fas fa-times"></i> H·ªßy' +
    '</button>' +
    '<button type="button" class="btn-primary" onclick="document.getElementById(\'incomeForm\').requestSubmit()">' +
    '<i class="fas fa-save"></i> L∆∞u' +
    '</button>';
  
  openModal(
    isEdit ? '‚úèÔ∏è S·ª≠a thu nh·∫≠p' : '‚ûï Th√™m thu nh·∫≠p', 
    body, 
    footer
  );
  
  // Initialize after modal opens
  setTimeout(function() {
    console.log('üîß Initializing income modal...');
    
    // 1. Load categories from cache (INSTANT)
    const categories = DataManager.getCategories('income');
    console.log('‚úÖ Loaded', categories.length, 'income categories from cache');
    
    var categorySelect = document.getElementById('incomeCategory');
    if (categorySelect) {
      categorySelect.innerHTML = renderCategoryOptions(categories, categoryId);
      
      // If editing and has category, load subcategories
      if (categoryId) {
        loadIncomeSubcategories().then(function() {
          if (subcategoryId) {
            var subcatSelect = document.getElementById('incomeSubcategory');
            if (subcatSelect) {
              subcatSelect.value = subcategoryId;
            }
          }
        });
      }
    }
    
    // 2. Setup currency input
    setupCurrencyInput(document.getElementById('incomeAmount'));
    
    // 3. Enable real-time validation
    const form = document.getElementById('incomeForm');
    if (form) {
      Validator.enableRealTimeValidation(form, 'income');
    }
    
    // 4. Focus first input
    document.getElementById('incomeDate').focus();
    
    console.log('‚úÖ Income modal initialized');
  }, 100);
}

// ========================================
// LOAD INCOME SUBCATEGORIES
// ========================================

function loadIncomeSubcategories() {
  return new Promise(function(resolve, reject) {
    var categorySelect = document.getElementById('incomeCategory');
    var subcategoryWrapper = document.getElementById('incomeSubcategoryWrapper');
    var subcategorySelect = document.getElementById('incomeSubcategory');
    
    if (!categorySelect || !subcategoryWrapper || !subcategorySelect) {
      reject('Elements not found');
      return;
    }
    
    var categoryId = categorySelect.value;
    
    if (!categoryId) {
      subcategoryWrapper.style.display = 'none';
      subcategorySelect.innerHTML = '<option value="">-- Kh√¥ng ch·ªçn --</option>';
      resolve();
      return;
    }
    
    console.log('üì• Loading subcategories for:', categoryId);
    
    subcategorySelect.innerHTML = '<option value="">-- ƒêang t·∫£i... --</option>';
    subcategoryWrapper.style.display = 'block';
    
    // Call backend to get subcategories
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success && response.data.length > 0) {
          console.log('‚úÖ Loaded', response.data.length, 'subcategories');
          subcategorySelect.innerHTML = renderSubcategoryOptions(response.data, '');
          subcategoryWrapper.style.display = 'block';
        } else {
          subcategorySelect.innerHTML = '<option value="">-- Kh√¥ng c√≥ danh m·ª•c con --</option>';
          subcategoryWrapper.style.display = 'block';
        }
        resolve();
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Load subcategories error:', error);
        subcategorySelect.innerHTML = '<option value="">-- L·ªói t·∫£i d·ªØ li·ªáu --</option>';
        reject(error);
      })
      .handleRequest('getSubcategories', { 
        parentId: categoryId,
        userId: currentUser.userId 
      });
  });
}

// ========================================
// SAVE INCOME - WITH VALIDATION & ERROR RECOVERY
// ========================================

async function handleSaveIncome(event, id) {
  event.preventDefault();
  
  console.log('=== SAVING INCOME ===', id ? 'UPDATE' : 'CREATE');
  
  // Clear previous errors
  Validator.clearErrors();
  
  // Collect form data
  var formData = {
    'Ng√†y': document.getElementById('incomeDate').value,
    'Danh m·ª•c': document.getElementById('incomeCategory').value,
    'S·ªë ti·ªÅn': parseCurrency(document.getElementById('incomeAmount').value),
    'T√†i kho·∫£n': document.getElementById('incomePayment').value
  };
  
  var subcategoryId = document.getElementById('incomeSubcategory') ? 
    document.getElementById('incomeSubcategory').value : '';
  var description = document.getElementById('incomeDescription').value;
  
  // Validate
  const validation = Validator.validate(formData, 'income');
  
  if (!validation.valid) {
    console.log('‚ùå Validation failed:', validation.errors);
    Validator.showErrors(validation.errors);
    return;
  }
  
  // Get category details
  var categoryInfo = DataManager.getCategoryById(formData['Danh m·ª•c']);
  var categoryName = categoryInfo ? categoryInfo.name : formData['Danh m·ª•c'];
  
  // Build category data
  var categoryData = {
    id: formData['Danh m·ª•c'],
    name: categoryName
  };
  
  // Add subcategory if selected
  if (subcategoryId) {
    var subcategorySelect = document.getElementById('incomeSubcategory');
    var subcategoryName = '';
    
    if (subcategorySelect) {
      var selectedOption = subcategorySelect.options[subcategorySelect.selectedIndex];
      if (selectedOption) {
        subcategoryName = selectedOption.text.replace('‚îú‚îÄ ', '').trim();
      }
    }
    
    categoryData.subcategory = subcategoryName;
    categoryData.subcategoryId = subcategoryId;
  }
  
  // Build record data
  var recordData = {
    'ID': id || generateId('TN'),
    'Ng√†y': formData['Ng√†y'],
    'Danh m·ª•c thu nh·∫≠p': JSON.stringify([categoryData]),
    'S·ªë ti·ªÅn': formData['S·ªë ti·ªÅn'],
    'M√¥ t·∫£': description,
    'Ph∆∞∆°ng th·ª©c thanh to√°n': JSON.stringify([{
      id: formData['T√†i kho·∫£n'], 
      name: getAccountName(formData['T√†i kho·∫£n'])
    }]),
    'UserID': currentUser.userId,
    'Metadata': JSON.stringify({accountId: formData['T√†i kho·∫£n']})
  };
  
  console.log('üíæ Record data:', recordData);
  
  closeModal();
  showLoading('ƒêang l∆∞u...');
  
  try {
    // Optimistic update
    if (id) {
      DataManager.updateRecord('Thu nh·∫≠p', id, recordData);
    } else {
      DataManager.addRecord('Thu nh·∫≠p', recordData);
    }
    
    // Update UI immediately
    allIncomeData = DataManager.getIncome();
    incomeFilteredData = allIncomeData.slice();
    renderIncomePage();
    
    // Save to server with retry
    var action = id ? 'updateRecord' : 'createRecord';
    var params = id ? 
      {sheetName: 'Thu nh·∫≠p', id: id, data: recordData} : 
      {sheetName: 'Thu nh·∫≠p', data: recordData};
    
    const response = await ErrorHandler.callWithRetry(action, params);
    
    if (response.success) {
      console.log('‚úÖ Server save successful');
      
      // Update account balance
      try {
        await ErrorHandler.callWithRetry('updateAccountBalance', {
          accountId: formData['T√†i kho·∫£n'],
          amount: formData['S·ªë ti·ªÅn'],
          type: 'add'
        });
        
        // Refresh accounts
        const accountsData = await DataManager.refresh('T√†i kho·∫£n');
        allAccountsData = accountsData;
        
        console.log('‚úÖ Account balance updated');
      } catch (balanceError) {
        console.error('‚ö†Ô∏è Balance update failed:', balanceError);
        showToast('L∆∞u th√†nh c√¥ng nh∆∞ng ch∆∞a c·∫≠p nh·∫≠t s·ªë d∆∞', 'warning');
      }
      
      hideLoading();
      showToast('‚úÖ ƒê√£ l∆∞u thu nh·∫≠p!', 'success');
      
    } else {
      throw new Error(response.message || 'Save failed');
    }
    
  } catch (error) {
    console.error('‚ùå Save error:', error);
    
    // Rollback optimistic update
    await DataManager.refresh('Thu nh·∫≠p');
    allIncomeData = DataManager.getIncome();
    incomeFilteredData = allIncomeData.slice();
    renderIncomePage();
    
    hideLoading();
    // Error toast already shown by ErrorHandler
  }
}

function editIncome(id) {
  openIncomeModal(id);
}

function confirmDeleteIncome(id) {
  var body = '<p style="text-align: center; font-size: 16px; margin: 20px 0;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?</p>' +
    '<p style="text-align: center; color: #e94849; font-weight: 500;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-danger" onclick="executeDeleteIncome(\'' + id + '\')">X√≥a</button>';
  
  openModal('X√°c nh·∫≠n x√≥a', body, footer);
}

function executeDeleteIncome(id) {
  closeModal();
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        reloadIncomeData();
      } else {
        hideLoading();
        showToast(response.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('deleteRecord', {sheetName: 'Thu nh·∫≠p', id: id});
}

function reloadIncomeData() {
  showLoading();
  
  Promise.all([
    loadSheetData('Thu nh·∫≠p'),
    loadSheetData('T√†i kho·∫£n')
  ]).then(function(results) {
    allIncomeData = results[0];
    allAccountsData = results[1];
    
    hideLoading();
    renderIncomePage();
    showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
  }).catch(function(error) {
    hideLoading();
    console.error('Reload error:', error);
    showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
  });
}

// Helper function to render account options for select
function renderAccountOptions() {
  var html = '<option value="">-- Ch·ªçn t√†i kho·∫£n --</option>';
  
  if (!allAccountsData || allAccountsData.length === 0) {
    return html;
  }
  
  for (var i = 0; i < allAccountsData.length; i++) {
    var acc = allAccountsData[i];
    html += '<option value="' + acc.AccountID + '">' + 
      acc['T√™n t√†i kho·∫£n'] + ' (' + formatCurrency(acc['S·ªë d∆∞ hi·ªán t·∫°i']) + ' ƒë)</option>';
  }
  
  return html;
}

function reloadIncomeData() {
  showLoading();
  
  Promise.all([
    loadSheetData('Thu nh·∫≠p'),
    loadSheetData('T√†i kho·∫£n')
  ]).then(function(results) {
    allIncomeData = results[0];
    allAccountsData = results[1];
    
    hideLoading();
    renderIncomePage();
    showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi', 'success');
  }).catch(function(error) {
    hideLoading();
    console.error('Reload error:', error);
    showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
  });
}

// Test Income Page
(async function testIncomePage() {
  console.log('=== Testing Income Page ===');
  
  if (!DataManager.isInitialized()) {
    await DataManager.initialize();
    syncLegacyVariables();
  }
  
  // Test 1: Show income page
  showIncomePage();
  
  setTimeout(() => {
    // Test 2: Check pagination
    console.assert(incomeCurrentPage === 1, 'Should start at page 1');
    console.assert(incomeItemsPerPage === 10, 'Should show 10 items per page');
    
    // Test 3: Check filter inputs exist
    var fromDateEl = document.getElementById('incomeFilterFromDate');
    var categoryEl = document.getElementById('incomeFilterCategory');
    console.assert(fromDateEl !== null, 'Filter inputs should exist');
    console.assert(categoryEl !== null, 'Category filter should exist');
    
    // Test 4: Test pagination
    if (allIncomeData.length > 10) {
      incomeGoToPage(2);
      console.assert(incomeCurrentPage === 2, 'Should go to page 2');
    }
    
    console.log('‚úÖ Income page tests passed');
  }, 500);
})();

</script>
