<script>

// ========== DASHBOARD WITH CHARTS ==========
function showDashboard() {
  console.log('=== SHOWING DASHBOARD WITH CHARTS ===');
  
  // Calculate summary statistics
  var totalIncome = 0;
  var totalExpense = 0;
  var incomeCount = 0;
  var expenseCount = 0;
  
  for (var i = 0; i < allIncomeData.length; i++) {
    totalIncome += parseCurrency(allIncomeData[i]['Số tiền']);
    incomeCount++;
  }
  
  for (var i = 0; i < allExpenseData.length; i++) {
    totalExpense += parseCurrency(allExpenseData[i]['Số tiền']);
    expenseCount++;
  }
  
  var balance = totalIncome - totalExpense;
  var accountCount = allAccountsData.length;
  
  // Calculate account balances
  var totalAccountBalance = 0;
  var cashAccountBalance = 0;
  
  for (var i = 0; i < allAccountsData.length; i++) {
    var accountBalance = parseCurrency(allAccountsData[i]['Số dư hiện tại']);
    totalAccountBalance += accountBalance;
    
    if (allAccountsData[i]['Loại'] === 'Tiền mặt') {
      cashAccountBalance = accountBalance;
    }
  }
  
  // BUILD HTML
  var html = '';
  
  // SUMMARY CARDS
  html += '<div class="card" style="margin-bottom: 30px;">';
  html += '<div class="card-header"><h2 class="card-title">Tổng quan tài chính</h2></div>';
  html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 20px;">';
  
  // Card 1: Income
  html += '<div style="background: linear-gradient(135deg, #24c560 0%, #1ea750 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(36, 197, 96, 0.3);">';
  html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">';
  html += '<div><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Tổng thu nhập</div>';
  html += '<div style="font-size: 28px; font-weight: 700;">' + formatCurrency(totalIncome) + ' đ</div></div>';
  html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><i class="fas fa-arrow-down" style="font-size: 24px;"></i></div>';
  html += '</div><div style="font-size: 13px; opacity: 0.85;">' + incomeCount + ' giao dịch</div></div>';
  
  // Card 2: Expense
  html += '<div style="background: linear-gradient(135deg, #e94849 0%, #d03838 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(233, 72, 73, 0.3);">';
  html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">';
  html += '<div><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Tổng chi tiêu</div>';
  html += '<div style="font-size: 28px; font-weight: 700;">' + formatCurrency(totalExpense) + ' đ</div></div>';
  html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><i class="fas fa-arrow-up" style="font-size: 24px;"></i></div>';
  html += '</div><div style="font-size: 13px; opacity: 0.85;">' + expenseCount + ' giao dịch</div></div>';
  
  // Card 3: Balance
  html += '<div style="background: linear-gradient(135deg, #3782f4 0%, #2563d4 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(55, 130, 244, 0.3);">';
  html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">';
  html += '<div><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Chênh lệch thu chi</div>';
  html += '<div style="font-size: 28px; font-weight: 700;">' + formatCurrency(balance) + ' đ</div></div>';
  html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><i class="fas fa-wallet" style="font-size: 24px;"></i></div>';
  html += '</div><div style="font-size: 13px; opacity: 0.85;">';
  html += (balance >= 0 ? 'Thu > Chi' : 'Chi > Thu') + ' (' + formatCurrency(totalIncome) + ' đ - ' + formatCurrency(totalExpense) + ' đ)</div></div>';
  
  // Card 4: Accounts
  html += '<div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">';
  html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">';
  html += '<div><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Tài khoản</div>';
  html += '<div style="font-size: 28px; font-weight: 700;">' + accountCount + '</div></div>';
  html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><i class="fas fa-building-columns" style="font-size: 24px;"></i></div>';
  html += '</div><div style="font-size: 13px; opacity: 0.85;">Số dư hiện tại: Tiền mặt: ' + formatCurrency(cashAccountBalance) + ' đ / Tổng: ' + formatCurrency(totalAccountBalance) + ' đ</div></div>';
  
  html += '</div></div>';
  
  // CHARTS SECTION
  html += '<div class="charts-container">';
  
  // Chart 1
  html += '<div class="chart-card chart-full-width">';
  html += '<h3><i class="fas fa-chart-line"></i> Xu hướng Thu nhập & Chi tiêu</h3>';
  html += '<div class="chart-wrapper"><canvas id="trendChart"></canvas></div>';
  html += '</div>';
  
  // Chart 2
  html += '<div class="chart-card">';
  html += '<h3><i class="fas fa-chart-pie"></i> Phân bổ Chi tiêu</h3>';
  html += '<div class="chart-wrapper"><canvas id="expenseCategoryChart"></canvas></div>';
  html += '</div>';
  
  // Chart 3
  html += '<div class="chart-card">';
  html += '<h3><i class="fas fa-chart-bar"></i> Thu nhập theo Danh mục</h3>';
  html += '<div class="chart-wrapper"><canvas id="incomeCategoryChart"></canvas></div>';
  html += '</div>';
  
  // Chart 4
  html += '<div class="chart-card">';
  html += '<h3><i class="fas fa-ranking-star"></i> Top 5 khoản chi tiêu lớn nhất</h3>';
  html += '<div class="chart-wrapper"><canvas id="topExpensesChart"></canvas></div>';
  html += '</div>';
  
  // Chart 5
  html += '<div class="chart-card chart-full-width">';
  html += '<h3><i class="fas fa-chart-column"></i> So sánh Thu Chi 6 tháng gần nhất</h3>';
  html += '<div class="chart-wrapper"><canvas id="monthlyComparisonChart"></canvas></div>';
  html += '</div>';
  
  html += '</div>';
  
  // SET HTML
  document.getElementById('contentWrapper').innerHTML = html;
  
  console.log('✅ HTML rendered');
  
  // Render charts với delay dài hơn
  setTimeout(function() {
    try {
      console.log('=== RENDERING CHARTS ===');
      
      // Check Chart.js
      if (typeof Chart === 'undefined') {
        console.error('❌ Chart.js NOT LOADED!');
        return;
      }
      console.log('✅ Chart.js loaded:', Chart.version);
      
      // Check canvases
      var canvases = ['trendChart', 'expenseCategoryChart', 'incomeCategoryChart', 'topExpensesChart', 'monthlyComparisonChart'];
      var allFound = true;
      
      for (var i = 0; i < canvases.length; i++) {
        var canvas = document.getElementById(canvases[i]);
        if (!canvas) {
          console.error('❌ Canvas not found:', canvases[i]);
          allFound = false;
        } else {
          console.log('✅ Canvas found:', canvases[i]);
        }
      }
      
      if (!allFound) {
        console.error('❌ Some canvases not found - aborting');
        return;
      }
      
      // Render all charts
      console.log('--- Rendering Trend Chart ---');
      renderTrendChart();
      
      console.log('--- Rendering Expense Category Chart ---');
      renderExpenseCategoryChart();
      
      console.log('--- Rendering Income Category Chart ---');
      renderIncomeCategoryChart();
      
      console.log('--- Rendering Top Expenses Chart ---');
      renderTopExpensesChart();
      
      console.log('--- Rendering Monthly Comparison Chart ---');
      renderMonthlyComparisonChart();
      
      console.log('✅ All charts rendered successfully');
      
    } catch (error) {
      console.error('❌ Error rendering charts:', error);
      console.error('Error stack:', error.stack);
    }
  }, 1000);
}

// ========== CHART RENDERING FUNCTIONS ==========

// Chart 1: Income vs Expense Trend (Line Chart)
function renderTrendChart() {
  console.log('>>> renderTrendChart called');
  
  var ctx = document.getElementById('trendChart');
  if (!ctx) {
    console.error('❌ trendChart canvas not found');
    return;
  }
  
  console.log('✅ trendChart canvas found');
  
  // Kiểm tra context
  var context = ctx.getContext('2d');
  if (!context) {
    console.error('❌ Cannot get 2d context');
    return;
  }
  
  console.log('✅ 2d context OK');
  
  var monthlyData = {};
  
  for (var i = 0; i < allIncomeData.length; i++) {
    var item = allIncomeData[i];
    var date = new Date(item['Ngày']);
    var monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
    
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = { income: 0, expense: 0 };
    }
    
    monthlyData[monthKey].income += parseCurrency(item['Số tiền']);
  }
  
  for (var i = 0; i < allExpenseData.length; i++) {
    var item = allExpenseData[i];
    var date = new Date(item['Ngày']);
    var monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
    
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = { income: 0, expense: 0 };
    }
    
    monthlyData[monthKey].expense += parseCurrency(item['Số tiền']);
  }
  
  var sortedMonths = Object.keys(monthlyData).sort();
  var last6Months = sortedMonths.slice(-6);
  
  var labels = [];
  var incomeData = [];
  var expenseData = [];
  
  for (var i = 0; i < last6Months.length; i++) {
    var monthKey = last6Months[i];
    var parts = monthKey.split('-');
    labels.push('Tháng ' + parts[1] + '/' + parts[0]);
    incomeData.push(monthlyData[monthKey].income);
    expenseData.push(monthlyData[monthKey].expense);
  }
  
  if (labels.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-chart-line"></i><div>Chưa có dữ liệu</div></div>';
    return;
  }
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Thu nhập',
          data: incomeData,
          borderColor: '#24c560',
          backgroundColor: 'rgba(36, 197, 96, 0.1)',
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7
        },
        {
          label: 'Chi tiêu',
          data: expenseData,
          borderColor: '#e94849',
          backgroundColor: 'rgba(233, 72, 73, 0.1)',
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + formatCurrency(context.parsed.y) + ' đ';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value) + ' đ';
            }
          }
        }
      }
    }
  });
}

// Chart 2: Expense by Category (Doughnut Chart)
function renderExpenseCategoryChart() {
  var ctx = document.getElementById('expenseCategoryChart');
  if (!ctx) return;
  
  var categoryData = {};
  
  for (var i = 0; i < allExpenseData.length; i++) {
    var item = allExpenseData[i];
    try {
      var cat = typeof item['Danh mục chi tiêu'] === 'string' ? 
        JSON.parse(item['Danh mục chi tiêu']) : item['Danh mục chi tiêu'];
      
      if (cat && cat[0]) {
        var categoryName = cat[0].name || 'Khác';
        if (!categoryData[categoryName]) {
          categoryData[categoryName] = 0;
        }
        categoryData[categoryName] += parseCurrency(item['Số tiền']);
      }
    } catch(e) {}
  }
  
  var labels = Object.keys(categoryData);
  var data = Object.values(categoryData);
  
  if (labels.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-chart-pie"></i><div>Chưa có dữ liệu</div></div>';
    return;
  }
  
  var colors = ['#e94849', '#f59e0b', '#3782f4', '#24c560', '#9333ea', '#ec4899', '#14b8a6', '#f97316'];
  var total = data.reduce(function(a, b) { return a + b; }, 0);
  
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors,
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'right'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              var percentage = ((context.parsed / total) * 100).toFixed(1);
              return context.label + ': ' + formatCurrency(context.parsed) + ' đ (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

// Chart 3: Income by Category (Bar Chart)
function renderIncomeCategoryChart() {
  var ctx = document.getElementById('incomeCategoryChart');
  if (!ctx) return;
  
  var categoryData = {};
  
  for (var i = 0; i < allIncomeData.length; i++) {
    var item = allIncomeData[i];
    try {
      var cat = typeof item['Danh mục thu nhập'] === 'string' ? 
        JSON.parse(item['Danh mục thu nhập']) : item['Danh mục thu nhập'];
      
      if (cat && cat[0]) {
        var categoryName = cat[0].name || 'Khác';
        if (!categoryData[categoryName]) {
          categoryData[categoryName] = 0;
        }
        categoryData[categoryName] += parseCurrency(item['Số tiền']);
      }
    } catch(e) {}
  }
  
  var labels = Object.keys(categoryData);
  var data = Object.values(categoryData);
  
  if (labels.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-chart-bar"></i><div>Chưa có dữ liệu</div></div>';
    return;
  }
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Thu nhập',
        data: data,
        backgroundColor: '#24c560',
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Thu nhập: ' + formatCurrency(context.parsed.y) + ' đ';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value) + ' đ';
            }
          }
        }
      }
    }
  });
}


// Chart 4: Top 5 Expenses (Horizontal Bar Chart)
function renderTopExpensesChart() {
  var ctx = document.getElementById('topExpensesChart');
  if (!ctx) return;
  
  if (!allExpenseData || allExpenseData.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-ranking-star"></i><div>Chưa có dữ liệu</div></div>';
    return;
  }
  
  var expensesArray = [];
  
  for (var i = 0; i < allExpenseData.length; i++) {
    var item = allExpenseData[i];
    var amount = parseCurrency(item['Số tiền']);
    var description = item['Mô tả'] || 'Không có mô tả';
    var date = item['Ngày'] || '';
    
    var categoryName = 'Khác';
    try {
      var cat = typeof item['Danh mục chi tiêu'] === 'string' ? 
        JSON.parse(item['Danh mục chi tiêu']) : item['Danh mục chi tiêu'];
      if (cat && cat[0]) {
        categoryName = cat[0].name || 'Khác';
      }
    } catch(e) {}
    
    expensesArray.push({
      amount: amount,
      description: description,
      date: date,
      category: categoryName
    });
  }
  
  expensesArray.sort(function(a, b) {
    return b.amount - a.amount;
  });
  
  var top5 = expensesArray.slice(0, 5);
  
  if (top5.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-ranking-star"></i><div>Chưa có dữ liệu</div></div>';
    return;
  }
  
  var labels = [];
  var data = [];
  var backgroundColors = [];
  
  var colors = ['#e94849', '#f97316', '#f59e0b', '#eab308', '#84cc16'];
  
  for (var i = 0; i < top5.length; i++) {
    var expense = top5[i];
    var label = expense.description;
    if (label.length > 25) {
      label = label.substring(0, 22) + '...';
    }
    
    labels.push(label);
    data.push(expense.amount);
    backgroundColors.push(colors[i]);
  }
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Số tiền',
        data: data,
        backgroundColor: backgroundColors,
        borderRadius: 8,
        barThickness: 40
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            title: function(context) {
              var index = context[0].dataIndex;
              return top5[index].description;
            },
            label: function(context) {
              return 'Số tiền: ' + formatCurrency(context.parsed.x) + ' đ';
            },
            afterLabel: function(context) {
              var index = context.dataIndex;
              return [
                'Danh mục: ' + top5[index].category,
                'Ngày: ' + formatDate(top5[index].date)
              ];
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value) + ' đ';
            }
          }
        },
        y: {
          ticks: {
            autoSkip: false,
            font: {
              size: 11
            }
          }
        }
      }
    }
  });
}
// Chart 5: Monthly Comparison (Bar Chart)
function renderMonthlyComparisonChart() {
  var ctx = document.getElementById('monthlyComparisonChart');
  if (!ctx) return;
  
  var monthlyData = {};
  
  for (var i = 0; i < allIncomeData.length; i++) {
    var item = allIncomeData[i];
    var date = new Date(item['Ngày']);
    var monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
    
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = { income: 0, expense: 0 };
    }
    
    monthlyData[monthKey].income += parseCurrency(item['Số tiền']);
  }
  
  for (var i = 0; i < allExpenseData.length; i++) {
    var item = allExpenseData[i];
    var date = new Date(item['Ngày']);
    var monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
    
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = { income: 0, expense: 0 };
    }
    
    monthlyData[monthKey].expense += parseCurrency(item['Số tiền']);
  }
  
  var sortedMonths = Object.keys(monthlyData).sort();
  var last6Months = sortedMonths.slice(-6);
  
  var labels = [];
  var incomeData = [];
  var expenseData = [];
  
  for (var i = 0; i < last6Months.length; i++) {
    var monthKey = last6Months[i];
    var parts = monthKey.split('-');
    labels.push('Tháng ' + parts[1] + '/' + parts[0]);
    incomeData.push(monthlyData[monthKey].income);
    expenseData.push(monthlyData[monthKey].expense);
  }
  
  if (labels.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-chart-column"></i><div>Chưa có dữ liệu</div></div>';
    return;
  }
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Thu nhập',
          data: incomeData,
          backgroundColor: '#24c560',
          borderRadius: 8
        },
        {
          label: 'Chi tiêu',
          data: expenseData,
          backgroundColor: '#e94849',
          borderRadius: 8
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + formatCurrency(context.parsed.y) + ' đ';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value) + ' đ';
            }
          }
        }
      }
    }
  });
}

// Test Dashboard
(async function testDashboard() {
  console.log('=== Testing Dashboard ===');
  
  // Ensure data loaded
  if (!DataManager.isInitialized()) {
    await DataManager.initialize();
    syncLegacyVariables();
  }
  
  // Test 1: Show dashboard
  showDashboard();
  
  // Test 2: Wait for charts to render
  setTimeout(() => {
    var trendChart = document.getElementById('trendChart');
    var expenseChart = document.getElementById('expenseCategoryChart');
    
    console.assert(trendChart !== null, 'Trend chart should exist');
    console.assert(expenseChart !== null, 'Expense chart should exist');
    
    // Check if Chart.js rendered
    var canvas = trendChart.getContext('2d');
    console.assert(canvas !== null, 'Chart context should exist');
    
    console.log('✅ Dashboard tests passed');
  }, 2000);
})();
</script>
