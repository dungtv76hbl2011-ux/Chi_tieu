<script>

// SETTINGS PAGE - CATEGORY MANAGEMENT
// ========================================

function showSettingsPage() {
  console.log('=== SHOWING SETTINGS PAGE ===');
  
  currentSettingsTab = 'expense'; // Default tab
  
  var html = '<div class="card">';
  html += '<div class="card-header">';
  html += '<h2 class="card-title">Quáº£n lÃ½ Danh má»¥c</h2>';
  html += '</div>';
  
  // Tab navigation
  html += '<div style="display: flex; gap: 10px; padding: 20px; border-bottom: 1px solid #e5e7eb;">';
  html += '<button class="btn-primary" id="tabExpense" onclick="switchSettingsTab(\'expense\')">Chi tiÃªu</button>';
  html += '<button class="btn-secondary" id="tabIncome" onclick="switchSettingsTab(\'income\')">Thu nháº­p</button>';
  html += '<button class="btn-secondary" id="tabBudget" onclick="switchSettingsTab(\'budget\')">NgÃ¢n sÃ¡ch</button>';
  html += '</div>';
  
  // Category list container
  html += '<div id="categoryListContainer" style="padding: 20px;">';
  html += '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #3782f4;"></i></div>';
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
  
  // Load categories for default tab
  loadCategoriesForTab('expense');
}

function loadCategoriesForTab(type) {
  console.log('=== LOADING CATEGORIES FOR TAB: ' + type + ' ===');
  
  showLoading();
  
  // Load ALL categories (main + sub) for this type
  google.script.run
    .withSuccessHandler(function(response) {
      console.log('Categories response:', response);
      
      if (response && response.success) {
        var allCats = response.data || [];
        
        // PhÃ¢n loáº¡i main vÃ  sub
        var mainCategories = [];
        var subCategoriesMap = {}; // { parentId: [subcategories] }
        
        for (var i = 0; i < allCats.length; i++) {
          var cat = allCats[i];
          
          if (!cat.parentId || cat.parentId === 'null' || cat.parentId === '') {
            // Main category
            mainCategories.push(cat);
            subCategoriesMap[cat.id] = []; // Initialize empty array
          } else {
            // Subcategory
            if (!subCategoriesMap[cat.parentId]) {
              subCategoriesMap[cat.parentId] = [];
            }
            subCategoriesMap[cat.parentId].push(cat);
          }
        }
        
        console.log('Main categories:', mainCategories.length);
        console.log('Subcategories map:', subCategoriesMap);
        
        // Render
        renderCategoryTree(mainCategories, subCategoriesMap);
        
        hideLoading();
      } else {
        console.error('Failed to load categories:', response?.message);
        hideLoading();
        showToast('Lá»—i táº£i danh má»¥c', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error loading categories:', error);
      hideLoading();
      showToast('Lá»—i káº¿t ná»‘i', 'error');
    })
    .handleRequest('getAllCategoriesByType', { 
      type: type,
      userId: getCurrentUserId()
    });
}

function loadAllCategories() {
  showLoading('Äang táº£i danh má»¥c...');
  
  // Refresh categories from server
  Promise.all([
    DataManager.refreshCategories('expense'),
    DataManager.refreshCategories('income'),
    DataManager.refreshCategories('budget')
  ])
  .then(results => {
    allCategories = [...results[0], ...results[1], ...results[2]];
    
    console.log('âœ… Categories loaded:', allCategories.length);
    
    hideLoading();
    renderSettingsPage();
  })
  .catch(error => {
    console.error('âŒ Load categories error:', error);
    hideLoading();
    showToast('Lá»—i táº£i danh má»¥c', 'error');
  });
}

function renderSettingsPage() {
  console.log('=== RENDERING SETTINGS PAGE ===');
  console.log('Current tab:', currentSettingsTab);
  console.log('Categories:', allCategories.length);
  
  var html = '<div class="card">' +
    '<div class="card-header">' +
    '<h2 class="card-title">CÃ i Ä‘áº·t - Quáº£n lÃ½ Danh má»¥c</h2>' +
    '</div>' +
    
    // TABS
    '<div style="background: #f7fafc; padding: 15px; border-bottom: 2px solid #e2e8f0;">' +
    '<div style="display: flex; gap: 10px; flex-wrap: wrap;">' +
    
    '<button class="' + (currentSettingsTab === 'expense' ? 'btn-primary' : 'btn-secondary') + '" ' +
    'onclick="switchSettingsTab(\'expense\')" style="padding: 8px 20px;">' +
    '<i class="fas fa-shopping-cart"></i> Chi tiÃªu' +
    '</button>' +
    
    '<button class="' + (currentSettingsTab === 'income' ? 'btn-primary' : 'btn-secondary') + '" ' +
    'onclick="switchSettingsTab(\'income\')" style="padding: 8px 20px;">' +
    '<i class="fas fa-money-bill-wave"></i> Thu nháº­p' +
    '</button>' +
    
    '<button class="' + (currentSettingsTab === 'budget' ? 'btn-primary' : 'btn-secondary') + '" ' +
    'onclick="switchSettingsTab(\'budget\')" style="padding: 8px 20px;">' +
    '<i class="fas fa-chart-pie"></i> NgÃ¢n sÃ¡ch' +
    '</button>' +
    
    '</div>' +
    '</div>' +
    
    // CATEGORY TREE
    '<div style="padding: 20px;">' +
    
    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
    '<h3 style="margin: 0; color: #1f2937;">Danh sÃ¡ch danh má»¥c</h3>' +
    '<button class="btn-primary" onclick="openAddCategoryModal(null)">' +
    '<i class="fas fa-plus"></i> ThÃªm danh má»¥c chÃ­nh' +
    '</button>' +
    '</div>' +
    
    '<div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">' +
    renderCategoryTree() +
    '</div>' +
    
    '</div>' +
    
    '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
}

function renderCategoryTree(mainCategories, subCategoriesMap) {
  console.log('=== RENDERING CATEGORY TREE ===');
  
  var html = '';
  
  // Add new category button
  html += '<div style="margin-bottom: 20px;">';
  html += '<button class="btn-primary" onclick="openAddCategoryModal()">';
  html += '<i class="fas fa-plus"></i> ThÃªm danh má»¥c chÃ­nh';
  html += '</button>';
  html += '</div>';
  
  if (!mainCategories || mainCategories.length === 0) {
    html += '<div style="text-align: center; padding: 40px; color: #718096;">';
    html += '<i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 10px;"></i>';
    html += '<p>ChÆ°a cÃ³ danh má»¥c nÃ o</p>';
    html += '</div>';
    
    document.getElementById('categoryListContainer').innerHTML = html;
    return;
  }
  
  // Render category tree
  html += '<div class="category-tree">';
  
  for (var i = 0; i < mainCategories.length; i++) {
    var mainCat = mainCategories[i];
    var subcategories = subCategoriesMap[mainCat.id] || [];
    
    html += '<div class="category-item main-category" data-category-id="' + mainCat.id + '">';
    
    // Main category row
    html += '<div class="category-row">';
    html += '<div class="category-info">';
    html += '<div class="category-icon" style="background: ' + (mainCat.color || '#6b7280') + ';">';
    html += mainCat.icon || 'ğŸ“';
    html += '</div>';
    html += '<span class="category-name">' + mainCat.name + '</span>';
    
    if (subcategories.length > 0) {
      html += '<span class="badge-count">' + subcategories.length + '</span>';
    }
    
    html += '</div>';
    
    // Action buttons
    html += '<div class="category-actions">';
    html += '<button class="btn-icon-small" onclick="openAddSubcategoryModal(\'' + mainCat.id + '\', \'' + mainCat.name + '\')" title="ThÃªm danh má»¥c con">';
    html += '<i class="fas fa-plus"></i>';
    html += '</button>';
    html += '<button class="btn-icon-small" onclick="editCategory(\'' + mainCat.id + '\')" title="Sá»­a">';
    html += '<i class="fas fa-edit"></i>';
    html += '</button>';
    html += '<button class="btn-icon-small btn-danger-outline" onclick="deleteCategory(\'' + mainCat.id + '\')" title="XÃ³a">';
    html += '<i class="fas fa-trash"></i>';
    html += '</button>';
    html += '</div>';
    
    html += '</div>'; // End category-row
    
    // Render subcategories
    if (subcategories.length > 0) {
      html += '<div class="subcategories">';
      
      for (var j = 0; j < subcategories.length; j++) {
        var subCat = subcategories[j];
        
        html += '<div class="category-item sub-category">';
        html += '<div class="category-row">';
        html += '<div class="category-info">';
        html += '<span class="category-name">â”œâ”€ ' + subCat.name + '</span>';
        html += '</div>';
        
        html += '<div class="category-actions">';
        html += '<button class="btn-icon-small" onclick="editCategory(\'' + subCat.id + '\')" title="Sá»­a">';
        html += '<i class="fas fa-edit"></i>';
        html += '</button>';
        html += '<button class="btn-icon-small btn-danger-outline" onclick="deleteCategory(\'' + subCat.id + '\')" title="XÃ³a">';
        html += '<i class="fas fa-trash"></i>';
        html += '</button>';
        html += '</div>';
        
        html += '</div>'; // End category-row
        html += '</div>'; // End sub-category
      }
      
      html += '</div>'; // End subcategories
    }
    
    html += '</div>'; // End main-category
  }
  
  html += '</div>'; // End category-tree
  
  document.getElementById('categoryListContainer').innerHTML = html;
  
  console.log('âœ… Category tree rendered');
}

function renderSubcategories(parentId) {
  console.log('=== RENDERING SUBCATEGORIES for parent:', parentId);
  
  // Filter danh má»¥c con dá»±a trÃªn parentId
  var subcategories = allCategories.filter(function(cat) {
    return cat.parentId === parentId;
  });
  
  console.log('Found', subcategories.length, 'subcategories');
  
  if (subcategories.length === 0) {
    return '<div style="padding: 10px; color: #9ca3af; font-size: 13px;">ChÆ°a cÃ³ danh má»¥c con</div>';
  }
  
  var html = '';
  
  for (var i = 0; i < subcategories.length; i++) {
    var cat = subcategories[i];
    
    console.log('- Subcategory:', cat.name);
    
    html += '<div class="category-item sub-category">' +
      '<div class="category-row">' +
      
      '<div class="category-info">' +
      '<span class="category-name">â”œâ”€ ' + cat.name + '</span>' +
      '</div>' +
      
      '<div class="category-actions">' +
      '<button class="btn-icon-small" onclick="openEditCategoryModal(\'' + cat.id + '\')" title="Sá»­a">' +
      '<i class="fas fa-edit"></i>' +
      '</button>' +
      '<button class="btn-icon-small btn-danger-outline" onclick="confirmDeleteCategory(\'' + cat.id + '\')" title="XÃ³a">' +
      '<i class="fas fa-trash"></i>' +
      '</button>' +
      '</div>' +
      
      '</div>' +
      '</div>';
  }
  
  return html;
}

function getSubcategoriesCount(parentId) {
  return allCategories.filter(function(cat) {
    return cat.parentId === parentId;
  }).length;
}

function toggleSubcategories(categoryId) {
  var subDiv = document.getElementById('sub-' + categoryId);
  var icon = document.getElementById('toggle-' + categoryId);
  
  if (subDiv.style.display === 'none') {
    subDiv.style.display = 'block';
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-up');
  } else {
    subDiv.style.display = 'none';
    icon.classList.remove('fa-chevron-up');
    icon.classList.add('fa-chevron-down');
  }
}

function switchSettingsTab(tab) {
  console.log('Switching to tab:', tab);
  
  currentSettingsTab = tab;
  
  // Update button styles
  document.getElementById('tabExpense').className = tab === 'expense' ? 'btn-primary' : 'btn-secondary';
  document.getElementById('tabIncome').className = tab === 'income' ? 'btn-primary' : 'btn-secondary';
  document.getElementById('tabBudget').className = tab === 'budget' ? 'btn-primary' : 'btn-secondary';
  
  // Load categories for selected tab
  loadCategoriesForTab(tab);
}

function getCurrentUserId() {
  return currentUser ? currentUser.id : 'USR001';
}


function saveSubcategory() {
  var parentId = document.getElementById('subcategoryParentId').value;
  var name = document.getElementById('subcategoryName').value.trim();
  var sortOrder = parseInt(document.getElementById('subcategorySortOrder').value) || 999;
  
  if (!name) {
    showToast('Vui lÃ²ng nháº­p tÃªn danh má»¥c con', 'error');
    return;
  }
  
  if (!parentId) {
    showToast('Lá»—i: KhÃ´ng tÃ¬m tháº¥y danh má»¥c cha', 'error');
    return;
  }
  
  showLoading();
  closeModal();
  
  var data = {
    type: currentSettingsTab,
    parentId: parentId,
    name: name,
    icon: '',
    color: '',
    userId: getCurrentUserId(),
    sortOrder: sortOrder
  };
  
  console.log('Saving subcategory:', data);
  
  google.script.run
    .withSuccessHandler(function(response) {
      hideLoading();
      
      if (response.success) {
        console.log('âœ… Subcategory saved successfully');
        showToast('ThÃªm danh má»¥c con thÃ nh cÃ´ng', 'success');
        
        // Clear cache
        CategoryManager.clearCache(parentId);
        
        // Reload categories for current tab
        loadCategoriesForTab(currentSettingsTab);
        
        // Refresh main categories cache
        DataManager.refreshCategories(currentSettingsTab).then(function() {
          console.log('Categories cache refreshed');
        });
        
      } else {
        showToast(response.message || 'Lá»—i khi thÃªm danh má»¥c con', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      console.error('Error:', error);
      showToast('Lá»—i káº¿t ná»‘i', 'error');
    })
    .handleRequest('saveCategory', data);
}

function openAddSubcategoryModal(parentId, parentName) {
  var body = '<div class="form-group">' +
    '<label>Danh má»¥c cha</label>' +
    '<input type="text" class="form-control" value="' + parentName + '" disabled>' +
    '<input type="hidden" id="subcategoryParentId" value="' + parentId + '">' +
    '</div>' +
    '<div class="form-group">' +
    '<label>TÃªn danh má»¥c con <span style="color: red;">*</span></label>' +
    '<input type="text" id="subcategoryName" class="form-control" placeholder="Nháº­p tÃªn danh má»¥c con">' +
    '</div>' +
    '<div class="form-group">' +
    '<label>Thá»© tá»± hiá»ƒn thá»‹</label>' +
    '<input type="number" id="subcategorySortOrder" class="form-control" value="999" min="1">' +
    '</div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">Há»§y</button>' +
    '<button class="btn-primary" onclick="saveSubcategory()">LÆ°u</button>';
  
  openModal('ThÃªm danh má»¥c con', body, footer);
  
  // Focus to name input
  setTimeout(function() {
    document.getElementById('subcategoryName').focus();
  }, 100);
}
// ========================================
// CATEGORY MODALS - ADD / EDIT / DELETE
// ========================================

/**
 * Open modal to add new category
 * @param {string} parentId - Parent category ID (null for main category)
 */
function openAddCategoryModal(parentId) {
  editingCategoryId = null;
  
  var title = parentId ? 'ThÃªm danh má»¥c con' : 'ThÃªm danh má»¥c chÃ­nh';
  var parentName = '';
  
  if (parentId) {
    var parent = allCategories.find(function(cat) {
      return cat.id === parentId;
    });
    parentName = parent ? parent.name : '';
  }
  
  var modalBody = '<form id="categoryForm" onsubmit="handleSaveCategory(event)">' +
    
    (parentId ? 
      '<div class="form-group">' +
      '<label>Danh má»¥c cha</label>' +
      '<input type="text" class="form-control" value="' + parentName + '" disabled>' +
      '<input type="hidden" id="categoryParentId" value="' + parentId + '">' +
      '</div>' : 
      '<input type="hidden" id="categoryParentId" value="">') +
    
    '<div class="form-group">' +
    '<label>TÃªn danh má»¥c <span style="color: red;">*</span></label>' +
    '<input type="text" id="categoryName" class="form-control" placeholder="Nháº­p tÃªn danh má»¥c" required autofocus>' +
    '</div>' +
    
    // ===== Sá»¬A PHáº¦N NÃ€Y - THÃŠM EMOJI PICKER =====
    (parentId ? '' : 
      '<div class="form-group">' +
      '<label>Icon (Emoji)</label>' +
      '<div style="display: flex; gap: 10px; margin-bottom: 10px;">' +
      '<input type="text" id="categoryIcon" class="form-control" placeholder="ğŸ”" maxlength="2" style="flex: 1;">' +
      '<button type="button" class="btn-secondary" onclick="toggleEmojiPicker()" style="padding: 8px 16px;">ğŸ“ Chá»n</button>' +
      '</div>' +
      '<div id="emojiPicker" style="display: none; padding: 15px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 200px; overflow-y: auto;">' +
      renderEmojiPicker() +
      '</div>' +
      '</div>' +
      
      '<div class="form-group">' +
      '<label>MÃ u sáº¯c</label>' +
      '<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">' +
      renderColorPicker() +
      '</div>' +
      '<input type="hidden" id="categoryColor" value="#e94849">' +
      '</div>') +
    // ===== Káº¾T THÃšC PHáº¦N Sá»¬A =====
    
    '<div class="form-group">' +
    '<label>Thá»© tá»± hiá»ƒn thá»‹</label>' +
    '<input type="number" id="categorySortOrder" class="form-control" value="999" min="1">' +
    '</div>' +
    
    '</form>';
  
  var modalFooter = '<button class="btn-secondary" onclick="closeModal()">Há»§y</button>' +
    '<button class="btn-primary" onclick="document.getElementById(\'categoryForm\').requestSubmit()">LÆ°u</button>';
  
  openModal(title, modalBody, modalFooter);
}

/**
 * Open modal to edit existing category
 * @param {string} categoryId - Category ID to edit
 */
function openEditCategoryModal(categoryId) {
  editingCategoryId = categoryId;
  
  var category = allCategories.find(function(cat) {
    return cat.id === categoryId;
  });
  
  if (!category) {
    showToast('KhÃ´ng tÃ¬m tháº¥y danh má»¥c', 'error');
    return;
  }
  
  var title = 'Sá»­a danh má»¥c: ' + category.name;
  var isMainCategory = !category.parentId;
  
  var modalBody = '<form id="categoryForm" onsubmit="handleSaveCategory(event)">' +
    
    '<div class="form-group">' +
    '<label>TÃªn danh má»¥c <span style="color: red;">*</span></label>' +
    '<input type="text" id="categoryName" class="form-control" value="' + category.name + '" required autofocus>' +
    '</div>' +
    
    // ===== Sá»¬A PHáº¦N NÃ€Y - THÃŠM EMOJI PICKER =====
    (isMainCategory ? 
      '<div class="form-group">' +
      '<label>Icon (Emoji)</label>' +
      '<div style="display: flex; gap: 10px; margin-bottom: 10px;">' +
      '<input type="text" id="categoryIcon" class="form-control" value="' + (category.icon || '') + '" maxlength="2" style="flex: 1;">' +
      '<button type="button" class="btn-secondary" onclick="toggleEmojiPicker()" style="padding: 8px 16px;">ğŸ“ Chá»n</button>' +
      '</div>' +
      '<div id="emojiPicker" style="display: none; padding: 15px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 200px; overflow-y: auto;">' +
      renderEmojiPicker() +
      '</div>' +
      '</div>' +
      
      '<div class="form-group">' +
      '<label>MÃ u sáº¯c</label>' +
      '<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">' +
      renderColorPicker(category.color) +
      '</div>' +
      '<input type="hidden" id="categoryColor" value="' + (category.color || '#e94849') + '">' +
      '</div>' : '') +
    // ===== Káº¾T THÃšC PHáº¦N Sá»¬A =====
    
    '<div class="form-group">' +
    '<label>Thá»© tá»± hiá»ƒn thá»‹</label>' +
    '<input type="number" id="categorySortOrder" class="form-control" value="' + (category.sortOrder || 999) + '" min="1">' +
    '</div>' +
    
    '</form>';
  
  var modalFooter = '<button class="btn-secondary" onclick="closeModal()">Há»§y</button>' +
    '<button class="btn-primary" onclick="document.getElementById(\'categoryForm\').requestSubmit()">Cáº­p nháº­t</button>';
  
  openModal(title, modalBody, modalFooter);
}

/**
 * Render color picker
 */
function renderColorPicker(selectedColor) {
  var colors = [
    '#e94849', // Red
    '#f59e0b', // Orange
    '#f59e0b', // Yellow
    '#24c560', // Green
    '#10b981', // Teal
    '#3782f4', // Blue
    '#8b5cf6', // Purple
    '#ec4899', // Pink
    '#6b7280'  // Gray
  ];
  
  var html = '';
  
  for (var i = 0; i < colors.length; i++) {
    var color = colors[i];
    var isSelected = selectedColor === color || (!selectedColor && i === 0);
    
    html += '<div class="color-option' + (isSelected ? ' selected' : '') + '" ' +
      'style="background: ' + color + ';" ' +
      'onclick="selectColor(\'' + color + '\')" ' +
      'data-color="' + color + '">' +
      (isSelected ? '<i class="fas fa-check"></i>' : '') +
      '</div>';
  }
  
  return html;
}

/**
 * Render emoji picker
 */
function renderEmojiPicker() {
  var emojiGroups = {
    'Phá»• biáº¿n': ['ğŸ”', 'ğŸš—', 'ğŸ›’', 'ğŸ“š', 'âš•ï¸', 'ğŸ®', 'ğŸ’°', 'ğŸ“ˆ', 'ğŸ', 'ğŸ“¦', 'ğŸ ', 'âš¡', 'ğŸ’¡', 'ğŸ”§'],
    'Ä‚n uá»‘ng': ['ğŸ•', 'ğŸœ', 'â˜•', 'ğŸº', 'ğŸ¥—', 'ğŸ£', 'ğŸ¥˜', 'ğŸ°', 'ğŸ', 'ğŸ¥', 'ğŸ±', 'ğŸ¥¤'],
    'Di chuyá»ƒn': ['ğŸš™', 'ğŸš•', 'ğŸšŒ', 'âœˆï¸', 'ğŸš‚', 'ğŸš´', 'ğŸ›µ', 'â›½', 'ğŸš¦'],
    'Mua sáº¯m': ['ğŸ‘•', 'ğŸ‘—', 'ğŸ‘”', 'ğŸ‘ ', 'ğŸ’„', 'ğŸ“±', 'ğŸ’»', 'ğŸ“·', 'ğŸ§', 'âŒš'],
    'Há»c táº­p': ['ğŸ“–', 'âœï¸', 'ğŸ“', 'ğŸ“', 'ğŸ«', 'ğŸ’¼', 'ğŸ“Š', 'ğŸ–Šï¸'],
    'Y táº¿': ['ğŸ’Š', 'ğŸ¥', 'ğŸ©º', 'ğŸ’‰', 'ğŸ§˜', 'ğŸƒ', 'âš•ï¸'],
    'Giáº£i trÃ­': ['ğŸ¬', 'ğŸµ', 'ğŸ¸', 'ğŸ®', 'ğŸ¯', 'ğŸª', 'ğŸ¨', 'ğŸ“º', 'ğŸ­'],
    'TÃ i chÃ­nh': ['ğŸ’µ', 'ğŸ’³', 'ğŸ’', 'ğŸ¦', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ’¸', 'ğŸª™'],
    'KhÃ¡c': ['â­', 'â¤ï¸', 'ğŸ‰', 'ğŸ””', 'ğŸ“Œ', 'ğŸ†', 'ğŸ¯', 'âœ…', 'âŒ', 'âš ï¸']
  };
  
  var html = '';
  
  for (var group in emojiGroups) {
    html += '<div style="margin-bottom: 15px;">' +
      '<div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 8px; text-transform: uppercase;">' + group + '</div>' +
      '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 5px;">';
    
    var emojis = emojiGroups[group];
    for (var i = 0; i < emojis.length; i++) {
      html += '<button type="button" class="emoji-btn" onclick="selectEmoji(\'' + emojis[i] + '\')">' + 
        emojis[i] + 
        '</button>';
    }
    
    html += '</div></div>';
  }
  
  return html;
}

/**
 * Toggle emoji picker visibility
 */
function toggleEmojiPicker() {
  var picker = document.getElementById('emojiPicker');
  if (picker) {
    picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
  }
}

/**
 * Select emoji from picker
 */
function selectEmoji(emoji) {
  var input = document.getElementById('categoryIcon');
  if (input) {
    input.value = emoji;
    toggleEmojiPicker(); // Close picker
  }
}

/**
 * Select color
 */
function selectColor(color) {
  // Remove selected class from all
  var options = document.querySelectorAll('.color-option');
  options.forEach(function(opt) {
    opt.classList.remove('selected');
    opt.innerHTML = '';
  });
  
  // Add selected class to clicked
  var selected = document.querySelector('.color-option[data-color="' + color + '"]');
  if (selected) {
    selected.classList.add('selected');
    selected.innerHTML = '<i class="fas fa-check"></i>';
  }
  
  // Update hidden input
  document.getElementById('categoryColor').value = color;
}

/**
 * Handle save category (add or edit)
 */
function handleSaveCategory(event) {
  event.preventDefault();
  
  var name = document.getElementById('categoryName').value.trim();
  var icon = document.getElementById('categoryIcon') ? document.getElementById('categoryIcon').value.trim() : '';
  var color = document.getElementById('categoryColor') ? document.getElementById('categoryColor').value : '';
  var sortOrder = parseInt(document.getElementById('categorySortOrder').value) || 999;
  var parentId = document.getElementById('categoryParentId') ? document.getElementById('categoryParentId').value : '';
  
  if (!name) {
    showToast('Vui lÃ²ng nháº­p tÃªn danh má»¥c', 'error');
    return;
  }
  
  var data = {
    type: currentSettingsTab,
    name: name,
    icon: icon,
    color: color,
    sortOrder: sortOrder,
    parentId: parentId || null,
    userId: getCurrentUserId()
  };
  
  closeModal();
  
  if (editingCategoryId) {
    // Update existing
    updateCategoryBackend(editingCategoryId, data);
  } else {
    // Add new
    saveCategoryBackend(data);
  }
}

/**
 * Save new category to backend
 */
function saveCategoryBackend(data) {
  showLoading('Äang lÆ°u danh má»¥c...');
  
  var parentIdToExpand = data.parentId; // LÆ°u parentId Ä‘á»ƒ expand sau
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        showToast('ThÃªm danh má»¥c thÃ nh cÃ´ng', 'success');
        
        // Reload vÃ  tá»± Ä‘á»™ng má»Ÿ danh má»¥c cha náº¿u thÃªm danh má»¥c con
        loadAllCategoriesAndExpand(parentIdToExpand);
      } else {
        showToast(result.message || 'Lá»—i thÃªm danh má»¥c', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('Lá»—i: ' + error.message, 'error');
    })
    .saveCategory(data);
}

/**
 * Update existing category
 */
function updateCategoryBackend(categoryId, data) {
  showLoading('Äang cáº­p nháº­t...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        showToast('Cáº­p nháº­t danh má»¥c thÃ nh cÃ´ng', 'success');
        loadAllCategories(); // Reload
      } else {
        showToast(result.message || 'Lá»—i cáº­p nháº­t', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('Lá»—i: ' + error.message, 'error');
    })
    .updateCategory(categoryId, data);
}

/**
 * Confirm delete category
 */
function confirmDeleteCategory(categoryId) {
  var category = allCategories.find(function(cat) {
    return cat.id === categoryId;
  });
  
  if (!category) {
    showToast('KhÃ´ng tÃ¬m tháº¥y danh má»¥c', 'error');
    return;
  }
  
  var message = 'Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a danh má»¥c "<strong>' + category.name + '</strong>"?';
  
  if (category.hasChildren) {
    message += '<br><br><span style="color: #e94849;">âš ï¸ Danh má»¥c nÃ y cÃ³ ' + getSubcategoriesCount(category.id) + ' danh má»¥c con. Táº¥t cáº£ danh má»¥c con cÅ©ng sáº½ bá»‹ xÃ³a.</span>';
  }
  
  var modalBody = '<div style="padding: 20px; text-align: center;">' +
    '<i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f59e0b; margin-bottom: 15px;"></i>' +
    '<p style="font-size: 16px; color: #1f2937;">' + message + '</p>' +
    '</div>';
  
  var modalFooter = '<button class="btn-secondary" onclick="closeModal()">Há»§y</button>' +
    '<button class="btn-danger" onclick="deleteCategoryBackend(\'' + categoryId + '\')">XÃ³a</button>';
  
  openModal('XÃ¡c nháº­n xÃ³a', modalBody, modalFooter);
}

/**
 * Delete category from backend
 */
function deleteCategoryBackend(categoryId) {
  closeModal();
  showLoading('Äang xÃ³a...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        showToast('XÃ³a danh má»¥c thÃ nh cÃ´ng', 'success');
        loadAllCategories(); // Reload
      } else {
        showToast(result.message || 'Lá»—i xÃ³a danh má»¥c', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('Lá»—i: ' + error.message, 'error');
    })
    .deleteCategory(categoryId);
}

// Test Settings Page
(async function testSettingsPage() {
  console.log('=== Testing Settings Page ===');
  
  if (!DataManager.isInitialized()) {
    await DataManager.initialize();
    syncLegacyVariables();
  }
  
  showSettingsPage();
  
  setTimeout(() => {
    var tabs = document.querySelectorAll('.settings-tab');
    console.assert(tabs.length > 0, 'Should have setting tabs');
    
    console.log('âœ… Settings page tests passed');
  }, 500);
})();

</script>
