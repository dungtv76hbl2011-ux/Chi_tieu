<script>
// ========================================
// JAVASCRIPT.HTML - FRONTEND LOGIC v2.0
// OPTIMIZED WITH MODULES & CACHING
// ========================================

// ========================================
// DATA MANAGER - CENTRALIZED CACHE SYSTEM
// ========================================

const DataManager = (function() {
  'use strict';
  
  // Private state
  const cache = {
    income: [],
    expense: [],
    budget: [],
    loan: [],
    investment: [],
    thirdParty: [],
    accounts: [],
    settings: [],
    categories: {
      expense: [],
      income: [],
      budget: []
    },
    categoryMap: {}, // Fast lookup by ID
    lastUpdated: {}
  };
  
  const loadingState = {
    isInitialized: false,
    isLoading: false,
    failedSheets: []
  };
  
  const listeners = {}; // Event listeners for data changes
  
  // ========== INITIALIZATION ==========
  
  async function initialize() {
    if (loadingState.isLoading) {
      console.log('‚è≥ Already loading...');
      return;
    }
    
    if (loadingState.isInitialized) {
      console.log('‚úÖ Already initialized');
      return cache;
    }
    
    loadingState.isLoading = true;
    showLoading('ƒêang t·∫£i d·ªØ li·ªáu...');
    
    try {
      console.log('=== INITIALIZING DATA MANAGER ===');
      
      // Load all data in parallel
      const [
        incomeData,
        expenseData,
        budgetData,
        loanData,
        investmentData,
        thirdPartyData,
        accountsData,
        settingsData,
        expenseCategories,
        incomeCategories,
        budgetCategories
      ] = await Promise.all([
        loadSheet('Thu nh·∫≠p'),
        loadSheet('Chi ti√™u'),
        loadSheet('Ng√¢n s√°ch'),
        loadSheet('Kho·∫£n vay'),
        loadSheet('ƒê·∫ßu t∆∞'),
        loadSheet('Thu chi h·ªô'),
        loadSheet('T√†i kho·∫£n'),
        loadSheet('C√†i ƒë·∫∑t'),
        loadCategories('expense'),
        loadCategories('income'),
        loadCategories('budget')
      ]);
      
      // Store in cache
      cache.income = incomeData || [];
      cache.expense = expenseData || [];
      cache.budget = budgetData || [];
      cache.loan = loanData || [];
      cache.investment = investmentData || [];
      cache.thirdParty = thirdPartyData || [];
      cache.accounts = accountsData || [];
      cache.settings = settingsData || [];
      
      cache.categories.expense = expenseCategories || [];
      cache.categories.income = incomeCategories || [];
      cache.categories.budget = budgetCategories || [];
      
      // Build category map for O(1) lookup
      buildCategoryMap();
      
      // Update timestamps
      const now = Date.now();
      Object.keys(cache).forEach(key => {
        if (key !== 'categoryMap' && key !== 'lastUpdated') {
          cache.lastUpdated[key] = now;
        }
      });
      
      loadingState.isInitialized = true;
      loadingState.isLoading = false;
      
      console.log('‚úÖ Data Manager Initialized');
      console.log('Cache:', {
        income: cache.income.length,
        expense: cache.expense.length,
        budget: cache.budget.length,
        accounts: cache.accounts.length,
        expenseCategories: cache.categories.expense.length,
        incomeCategories: cache.categories.income.length
      });
      
      hideLoading();
      
      // Trigger initialized event
      emit('initialized', cache);
      
      return cache;
      
    } catch (error) {
      loadingState.isLoading = false;
      console.error('‚ùå Initialization failed:', error);
      hideLoading();
      showToast('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
      throw error;
    }
  }
  
  // ========== CATEGORY MAP ==========
  
  function buildCategoryMap() {
    cache.categoryMap = {};
    
    ['expense', 'income', 'budget'].forEach(type => {
      const categories = cache.categories[type] || [];
      categories.forEach(cat => {
        cache.categoryMap[cat.id] = cat;
      });
    });
    
    console.log('‚úÖ Category map built:', Object.keys(cache.categoryMap).length, 'categories');
  }
  
  // ========== LOAD HELPERS ==========
  
  function loadSheet(sheetName) {
    return new Promise((resolve, reject) => {
      console.log('üì• Loading:', sheetName);
      
      google.script.run
        .withSuccessHandler(response => {
          if (response && response.success) {
            console.log('‚úÖ', sheetName, ':', response.data.length, 'records');
            resolve(response.data || []);
          } else {
            console.warn('‚ö†Ô∏è', sheetName, 'failed:', response?.message);
            loadingState.failedSheets.push(sheetName);
            resolve([]);
          }
        })
        .withFailureHandler(error => {
          console.error('‚ùå', sheetName, 'error:', error);
          loadingState.failedSheets.push(sheetName);
          resolve([]);
        })
        .getRecords(sheetName);
    });
  }
  
  function loadCategories(type) {
    return new Promise((resolve, reject) => {
      console.log('üì• Loading categories:', type);
      
      google.script.run
        .withSuccessHandler(response => {
          if (response && response.success) {
            console.log('‚úÖ', type, 'categories:', response.data.length);
            resolve(response.data || []);
          } else {
            console.warn('‚ö†Ô∏è', type, 'categories failed');
            resolve([]);
          }
        })
        .withFailureHandler(error => {
          console.error('‚ùå', type, 'categories error:', error);
          resolve([]);
        })
        .handleRequest('getMainCategories', { type: type });
    });
  }
  
  // ========== GETTERS ==========
  
  function getIncome() {
    return [...cache.income];
  }
  
  function getExpense() {
    return [...cache.expense];
  }
  
  function getBudget() {
    return [...cache.budget];
  }
  
  function getLoan() {
    return [...cache.loan];
  }
  
  function getInvestment() {
    return [...cache.investment];
  }
  
  function getThirdParty() {
    return [...cache.thirdParty];
  }
  
  function getAccounts() {
    return [...cache.accounts];
  }
  
  function getSettings() {
    return [...cache.settings];
  }
  
  function getCategories(type) {
    return [...(cache.categories[type] || [])];
  }
  
  function getCategoryById(id) {
    return cache.categoryMap[id] || null;
  }
  
  function getAllCategories() {
    return { ...cache.categories };
  }
  
  // ========== OPTIMISTIC UPDATES ==========
  
  function addRecord(sheetName, record) {
    const key = getKeyFromSheetName(sheetName);
    if (!key) return;
    
    cache[key].push(record);
    emit('recordAdded', { sheetName, record });
  }
  
  function updateRecord(sheetName, id, updates) {
    const key = getKeyFromSheetName(sheetName);
    if (!key) return;
    
    const index = cache[key].findIndex(r => r.ID === id || r.AccountID === id);
    if (index >= 0) {
      cache[key][index] = { ...cache[key][index], ...updates };
      emit('recordUpdated', { sheetName, id, updates });
    }
  }
  
  function deleteRecord(sheetName, id) {
    const key = getKeyFromSheetName(sheetName);
    if (!key) return;
    
    cache[key] = cache[key].filter(r => r.ID !== id && r.AccountID !== id);
    emit('recordDeleted', { sheetName, id });
  }
  
  // ========== REFRESH ==========
  
  async function refresh(sheetName) {
    const key = getKeyFromSheetName(sheetName);
    if (!key) return;
    
    console.log('üîÑ Refreshing:', sheetName);
    
    try {
      const data = await loadSheet(sheetName);
      cache[key] = data;
      cache.lastUpdated[key] = Date.now();
      
      emit('refreshed', { sheetName, count: data.length });
      
      return data;
    } catch (error) {
      console.error('Refresh error:', error);
      throw error;
    }
  }
  
  async function refreshCategories(type) {
    console.log('üîÑ Refreshing categories:', type);
    
    try {
      const data = await loadCategories(type);
      cache.categories[type] = data;
      buildCategoryMap();
      
      emit('categoriesRefreshed', { type, count: data.length });
      
      return data;
    } catch (error) {
      console.error('Refresh categories error:', error);
      throw error;
    }
  }
  
  // ========== EVENT SYSTEM ==========
  
  function on(event, callback) {
    if (!listeners[event]) {
      listeners[event] = [];
    }
    listeners[event].push(callback);
  }
  
  function off(event, callback) {
    if (!listeners[event]) return;
    listeners[event] = listeners[event].filter(cb => cb !== callback);
  }
  
  function emit(event, data) {
    if (!listeners[event]) return;
    listeners[event].forEach(callback => {
      try {
        callback(data);
      } catch (error) {
        console.error('Event listener error:', error);
      }
    });
  }
  
  // ========== HELPERS ==========
  
  function getKeyFromSheetName(sheetName) {
    const map = {
      'Thu nh·∫≠p': 'income',
      'Chi ti√™u': 'expense',
      'Ng√¢n s√°ch': 'budget',
      'Kho·∫£n vay': 'loan',
      'ƒê·∫ßu t∆∞': 'investment',
      'Thu chi h·ªô': 'thirdParty',
      'T√†i kho·∫£n': 'accounts',
      'C√†i ƒë·∫∑t': 'settings'
    };
    return map[sheetName];
  }
  
  function isInitialized() {
    return loadingState.isInitialized;
  }
  
  function getFailedSheets() {
    return [...loadingState.failedSheets];
  }
  
  // ========== PUBLIC API ==========
  
  return {
    initialize,
    
    // Getters
    getIncome,
    getExpense,
    getBudget,
    getLoan,
    getInvestment,
    getThirdParty,
    getAccounts,
    getSettings,
    getCategories,
    getCategoryById,
    getAllCategories,
    
    // Optimistic updates
    addRecord,
    updateRecord,
    deleteRecord,
    
    // Refresh
    refresh,
    refreshCategories,
    
    // Events
    on,
    off,
    
    // Utils
    isInitialized,
    getFailedSheets
  };
})();

// ========================================
// ERROR HANDLER - CENTRALIZED ERROR RECOVERY
// ========================================

const ErrorHandler = (function() {
  'use strict';
  
  const MAX_RETRIES = 3;
  const RETRY_DELAY = 1000; // 1 second
  
  const errorLog = [];
  const retryQueue = [];
  
  // ========== API CALL WITH RETRY ==========
  
  async function callWithRetry(action, params, retries = MAX_RETRIES) {
    for (let attempt = 1; attempt <= retries; attempt++) {
      try {
        console.log(`üîÑ Attempt ${attempt}/${retries}: ${action}`);
        
        const result = await callAPI(action, params);
        
        if (result && result.success) {
          console.log(`‚úÖ Success: ${action}`);
          return result;
        } else {
          throw new Error(result?.message || 'Unknown error');
        }
        
      } catch (error) {
        console.error(`‚ùå Attempt ${attempt} failed:`, error);
        
        logError(action, params, error, attempt);
        
        if (attempt === retries) {
          // Final attempt failed
          handleFinalFailure(action, params, error);
          throw error;
        }
        
        // Wait before retry
        await sleep(RETRY_DELAY * attempt);
      }
    }
  }
  
  function callAPI(action, params) {
    return new Promise((resolve, reject) => {
      const timeout = setTimeout(() => {
        reject(new Error('Request timeout'));
      }, 30000); // 30 seconds
      
      google.script.run
        .withSuccessHandler(response => {
          clearTimeout(timeout);
          resolve(response);
        })
        .withFailureHandler(error => {
          clearTimeout(timeout);
          reject(error);
        })
        .handleRequest(action, params);
    });
  }
  
  // ========== ERROR LOGGING ==========
  
  function logError(action, params, error, attempt) {
    const errorEntry = {
      timestamp: new Date().toISOString(),
      action,
      params,
      error: error.message,
      attempt,
      stack: error.stack
    };
    
    errorLog.push(errorEntry);
    
    // Keep only last 100 errors
    if (errorLog.length > 100) {
      errorLog.shift();
    }
    
    console.error('üìù Error logged:', errorEntry);
  }
  
  function handleFinalFailure(action, params, error) {
    // Add to retry queue for manual retry
    retryQueue.push({
      action,
      params,
      error: error.message,
      timestamp: Date.now()
    });
    
    // Show user-friendly error
    showToast(
      `L·ªói: ${getFriendlyErrorMessage(action, error)}`,
      'error'
    );
    
    // Offer manual retry
    if (retryQueue.length > 0) {
      showRetryNotification();
    }
  }
  
  // ========== USER-FRIENDLY MESSAGES ==========
  
  function getFriendlyErrorMessage(action, error) {
    const errorMessages = {
      'createRecord': 'Kh√¥ng th·ªÉ t·∫°o b·∫£n ghi. Vui l√≤ng th·ª≠ l·∫°i.',
      'updateRecord': 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t. Vui l√≤ng th·ª≠ l·∫°i.',
      'deleteRecord': 'Kh√¥ng th·ªÉ x√≥a. Vui l√≤ng th·ª≠ l·∫°i.',
      'getAllData': 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng l√†m m·ªõi trang.',
      'updateAccountBalance': 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë d∆∞ t√†i kho·∫£n.',
      'calculateBudgetSpent': 'Kh√¥ng th·ªÉ t√≠nh to√°n ng√¢n s√°ch.',
      'login': 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra t√†i kho·∫£n.'
    };
    
    if (error.message && error.message.includes('timeout')) {
      return 'K·∫øt n·ªëi b·ªã gi√°n ƒëo·∫°n. Vui l√≤ng ki·ªÉm tra m·∫°ng.';
    }
    
    if (error.message && error.message.includes('Session')) {
      return 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
    }
    
    return errorMessages[action] || 'ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.';
  }
  
  // ========== RETRY NOTIFICATION ==========
  
  function showRetryNotification() {
    const notification = document.createElement('div');
    notification.id = 'retryNotification';
    notification.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #fff;
      border: 2px solid #f59e0b;
      border-radius: 8px;
      padding: 15px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10001;
      max-width: 300px;
    `;
    
    notification.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 20px;"></i>
        <strong>C√≥ ${retryQueue.length} thao t√°c th·∫•t b·∫°i</strong>
      </div>
      <button onclick="ErrorHandler.retryAll()" class="btn-warning" style="width: 100%; padding: 8px;">
        <i class="fas fa-redo"></i> Th·ª≠ l·∫°i t·∫•t c·∫£
      </button>
      <button onclick="ErrorHandler.clearQueue()" class="btn-secondary" style="width: 100%; padding: 8px; margin-top: 5px;">
        <i class="fas fa-times"></i> B·ªè qua
      </button>
    `;
    
    // Remove old notification if exists
    const oldNotification = document.getElementById('retryNotification');
    if (oldNotification) {
      oldNotification.remove();
    }
    
    document.body.appendChild(notification);
  }
  
  // ========== RETRY QUEUE ==========
  
  async function retryAll() {
    const queue = [...retryQueue];
    retryQueue.length = 0; // Clear queue
    
    const notification = document.getElementById('retryNotification');
    if (notification) {
      notification.remove();
    }
    
    showLoading(`ƒêang th·ª≠ l·∫°i ${queue.length} thao t√°c...`);
    
    let successCount = 0;
    let failedCount = 0;
    
    for (const item of queue) {
      try {
        await callWithRetry(item.action, item.params, 2);
        successCount++;
      } catch (error) {
        failedCount++;
        retryQueue.push(item); // Re-add failed items
      }
    }
    
    hideLoading();
    
    if (successCount > 0) {
      showToast(`Th√†nh c√¥ng: ${successCount} thao t√°c`, 'success');
    }
    
    if (failedCount > 0) {
      showToast(`Th·∫•t b·∫°i: ${failedCount} thao t√°c`, 'error');
      showRetryNotification();
    }
  }
  
  function clearQueue() {
    retryQueue.length = 0;
    
    const notification = document.getElementById('retryNotification');
    if (notification) {
      notification.remove();
    }
    
    showToast('ƒê√£ x√≥a h√†ng ƒë·ª£i', 'info');
  }
  
  // ========== HELPERS ==========
  
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  
  function getErrorLog() {
    return [...errorLog];
  }
  
  function getRetryQueue() {
    return [...retryQueue];
  }
  
  // ========== PUBLIC API ==========
  
  return {
    callWithRetry,
    retryAll,
    clearQueue,
    getErrorLog,
    getRetryQueue
  };
})();

// ========================================
// VALIDATOR - CENTRALIZED INPUT VALIDATION
// ========================================

const Validator = (function() {
  'use strict';
  
  // ========== VALIDATION RULES ==========
  
  const rules = {
    required: (value, fieldName) => {
      if (!value || (typeof value === 'string' && value.trim() === '')) {
        return `${fieldName} kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng`;
      }
      return null;
    },
    
    number: (value, fieldName) => {
      if (isNaN(value) || value === '') {
        return `${fieldName} ph·∫£i l√† s·ªë`;
      }
      return null;
    },
    
    positive: (value, fieldName) => {
      if (parseFloat(value) <= 0) {
        return `${fieldName} ph·∫£i l·ªõn h∆°n 0`;
      }
      return null;
    },
    
    date: (value, fieldName) => {
      if (!/^\d{4}-\d{2}-\d{2}$/.test(value)) {
        return `${fieldName} kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (YYYY-MM-DD)`;
      }
      const date = new Date(value);
      if (isNaN(date.getTime())) {
        return `${fieldName} kh√¥ng h·ª£p l·ªá`;
      }
      return null;
    },
    
    month: (value, fieldName) => {
      if (!/^\d{4}-\d{2}$/.test(value)) {
        return `${fieldName} kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (YYYY-MM)`;
      }
      return null;
    },
    
    email: (value, fieldName) => {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) {
        return `${fieldName} kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng`;
      }
      return null;
    },
    
    minLength: (value, fieldName, min) => {
      if (value.length < min) {
        return `${fieldName} ph·∫£i c√≥ √≠t nh·∫•t ${min} k√Ω t·ª±`;
      }
      return null;
    },
    
    maxLength: (value, fieldName, max) => {
      if (value.length > max) {
        return `${fieldName} kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${max} k√Ω t·ª±`;
      }
      return null;
    },
    
    accountBalance: (amount, accountId) => {
      const accounts = DataManager.getAccounts();
      const account = accounts.find(a => a.AccountID === accountId);
      
      if (!account) {
        return 'Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n';
      }
      
      const currentBalance = parseCurrency(account['S·ªë d∆∞ hi·ªán t·∫°i']);
      if (amount > currentBalance) {
        return `S·ªë d∆∞ kh√¥ng ƒë·ªß (C√≤n: ${formatCurrency(currentBalance)} ƒë)`;
      }
      
      return null;
    },
    
    uniqueId: (id, sheetName, excludeId = null) => {
      const key = DataManager.getKeyFromSheetName(sheetName);
      if (!key) return null;
      
      const data = DataManager[`get${key.charAt(0).toUpperCase() + key.slice(1)}`]();
      const exists = data.some(item => {
        const itemId = item.ID || item.AccountID;
        return itemId === id && itemId !== excludeId;
      });
      
      if (exists) {
        return 'ID ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng';
      }
      
      return null;
    }
  };
  
  // ========== VALIDATION SCHEMAS ==========
  
  const schemas = {
    income: {
      'Ng√†y': ['required', 'date'],
      'S·ªë ti·ªÅn': ['required', 'number', 'positive'],
      'Danh m·ª•c': ['required'],
      'T√†i kho·∫£n': ['required']
    },
    
    expense: {
      'Ng√†y': ['required', 'date'],
      'S·ªë ti·ªÅn': ['required', 'number', 'positive'],
      'Danh m·ª•c': ['required'],
      'T√†i kho·∫£n': ['required']
    },
    
    budget: {
      'Th√°ng': ['required', 'month'],
      'K·∫ø ho·∫°ch': ['required', 'number', 'positive'],
      'Danh m·ª•c': ['required']
    },
    
    account: {
      'T√™n t√†i kho·∫£n': ['required', ['minLength', 2], ['maxLength', 100]],
      'S·ªë d∆∞ ƒë·∫ßu k·ª≥': ['required', 'number']
    },
    
    login: {
      'T√™n ƒëƒÉng nh·∫≠p': ['required', ['minLength', 3]],
      'M·∫≠t kh·∫©u': ['required', ['minLength', 6]]
    }
  };
  
  // ========== VALIDATE FUNCTION ==========
  
  function validate(data, schemaName) {
    const schema = schemas[schemaName];
    if (!schema) {
      console.error('Unknown schema:', schemaName);
      return { valid: true, errors: {} };
    }
    
    const errors = {};
    let valid = true;
    
    for (const [field, validations] of Object.entries(schema)) {
      const value = data[field];
      
      for (const validation of validations) {
        let ruleName, ruleParams;
        
        if (Array.isArray(validation)) {
          [ruleName, ...ruleParams] = validation;
        } else {
          ruleName = validation;
          ruleParams = [];
        }
        
        const rule = rules[ruleName];
        if (!rule) {
          console.error('Unknown rule:', ruleName);
          continue;
        }
        
        const error = rule(value, field, ...ruleParams);
        
        if (error) {
          errors[field] = error;
          valid = false;
          break; // Stop at first error for this field
        }
      }
    }
    
    return { valid, errors };
  }
  
  // ========== SHOW ERRORS IN UI ==========
  
  function showErrors(errors) {
    // Remove old error messages
    document.querySelectorAll('.field-error').forEach(el => el.remove());
    
    for (const [field, message] of Object.entries(errors)) {
      // Find input by label text
      const labels = document.querySelectorAll('.form-group label');
      let inputElement = null;
      
      for (const label of labels) {
        if (label.textContent.includes(field)) {
          const formGroup = label.closest('.form-group');
          inputElement = formGroup.querySelector('input, select, textarea');
          break;
        }
      }
      
      if (inputElement) {
        // Add error styling
        inputElement.style.borderColor = '#e94849';
        
        // Add error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        errorDiv.style.cssText = 'color: #e94849; font-size: 12px; margin-top: 5px;';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        
        inputElement.parentElement.appendChild(errorDiv);
      }
    }
    
    // Show summary toast
    const errorCount = Object.keys(errors).length;
    showToast(`Vui l√≤ng ki·ªÉm tra ${errorCount} tr∆∞·ªùng b·ªã l·ªói`, 'error');
  }
  
  // ========== CLEAR ERRORS ==========
  
  function clearErrors() {
    document.querySelectorAll('.field-error').forEach(el => el.remove());
    document.querySelectorAll('input, select, textarea').forEach(el => {
      el.style.borderColor = '';
    });
  }
  
  // ========== REAL-TIME VALIDATION ==========
  
  function enableRealTimeValidation(formElement, schemaName) {
    const inputs = formElement.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
      input.addEventListener('blur', function() {
        const label = this.closest('.form-group')?.querySelector('label')?.textContent.trim();
        if (!label) return;
        
        const schema = schemas[schemaName];
        if (!schema || !schema[label]) return;
        
        // Validate this field only
        const validations = schema[label];
        let error = null;
        
        for (const validation of validations) {
          let ruleName, ruleParams;
          
          if (Array.isArray(validation)) {
            [ruleName, ...ruleParams] = validation;
          } else {
            ruleName = validation;
            ruleParams = [];
          }
          
          const rule = rules[ruleName];
          if (!rule) continue;
          
          error = rule(this.value, label, ...ruleParams);
          if (error) break;
        }
        
        // Remove old error for this field
        const oldError = this.parentElement.querySelector('.field-error');
        if (oldError) oldError.remove();
        
        if (error) {
          // Show error
          this.style.borderColor = '#e94849';
          
          const errorDiv = document.createElement('div');
          errorDiv.className = 'field-error';
          errorDiv.style.cssText = 'color: #e94849; font-size: 12px; margin-top: 5px;';
          errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error}`;
          
          this.parentElement.appendChild(errorDiv);
        } else {
          // Clear error
          this.style.borderColor = '';
        }
      });
    });
  }
  
  // ========== PUBLIC API ==========
  
  return {
    validate,
    showErrors,
    clearErrors,
    enableRealTimeValidation,
    rules // Expose for custom validations
  };
})();

// ========================================
// CATEGORY MANAGER - INSTANT CATEGORY OPERATIONS
// ========================================

const CategoryManager = (function() {
  'use strict';
  
  // ========== LOAD SUBCATEGORIES (WITH CACHE) ==========
  
  const subcategoryCache = {}; // { parentId: [subcategories] }
  
  async function loadSubcategories(parentId, forceRefresh = false) {
    console.log('üì• Loading subcategories for:', parentId);
    
    // Check cache first
    if (!forceRefresh && subcategoryCache[parentId]) {
      console.log('‚úÖ Found in cache:', subcategoryCache[parentId].length, 'items');
      return subcategoryCache[parentId];
    }
    
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            const subcats = response.data || [];
            subcategoryCache[parentId] = subcats;
            console.log('‚úÖ Loaded and cached:', subcats.length, 'subcategories');
            resolve(subcats);
          } else {
            console.error('‚ùå Load subcategories failed:', response.message);
            resolve([]);
          }
        })
        .withFailureHandler(error => {
          console.error('‚ùå Error:', error);
          reject(error);
        })
        .handleRequest('getSubcategories', { 
          parentId: parentId,
          userId: getCurrentUserId() 
        });
    });
  }
  
  // ========== CLEAR CACHE ==========
  
  function clearCache(parentId = null) {
    if (parentId) {
      delete subcategoryCache[parentId];
      console.log('üóëÔ∏è Cleared cache for:', parentId);
    } else {
      Object.keys(subcategoryCache).forEach(key => {
        delete subcategoryCache[key];
      });
      console.log('üóëÔ∏è Cleared all subcategory cache');
    }
  }
  
  // ========== FORMAT CATEGORY FOR DISPLAY ==========
  
function formatCategoryDisplay(categoryData) {
  return CategoryManager.formatCategoryDisplay(categoryData);
}

function renderCategoryOptions(categories, selectedId) {
  return CategoryManager.renderCategoryOptions(categories, selectedId);
}

function renderSubcategoryOptions(subcategories, selectedId) {
  return CategoryManager.renderSubcategoryOptions(subcategories, selectedId);
}
  
  // ========== RENDER OPTIONS ==========
  
  function renderCategoryOptions(categories, selectedId) {
    var html = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
    
    for (var i = 0; i < categories.length; i++) {
      var cat = categories[i];
      var selected = cat.id === selectedId ? ' selected' : '';
      var icon = cat.icon ? cat.icon + ' ' : '';
      
      html += '<option value="' + cat.id + '"' + selected + '>' + 
              icon + cat.name + 
              '</option>';
    }
    
    return html;
  }
  
  function renderSubcategoryOptions(subcategories, selectedId) {
    var html = '<option value="">-- Kh√¥ng ch·ªçn danh m·ª•c con --</option>';
    
    for (var i = 0; i < subcategories.length; i++) {
      var subcat = subcategories[i];
      var selected = subcat.id === selectedId ? ' selected' : '';
      
      html += '<option value="' + subcat.id + '"' + selected + '>‚îú‚îÄ ' + 
              subcat.name + 
              '</option>';
    }
    
    return html;
  }
  
  // ========== GET CATEGORY ICON & COLOR ==========
  
  function getCategoryIcon(categoryId) {
    const cat = DataManager.getCategoryById(categoryId);
    return cat ? cat.icon : '';
  }
  
  function getCategoryColor(categoryId) {
    const cat = DataManager.getCategoryById(categoryId);
    return cat ? cat.color : '#6b7280';
  }
  
  function getCategoryName(categoryId) {
    const cat = DataManager.getCategoryById(categoryId);
    return cat ? cat.name : categoryId;
  }
  
  // ========== PUBLIC API ==========
  
  return {
    loadSubcategories,
    clearCache,
    formatCategoryDisplay,
    renderCategoryOptions,
    renderSubcategoryOptions,
    getCategoryIcon,
    getCategoryColor,
    getCategoryName
  };
})();

// ========== GLOBAL VARIABLES ==========
var currentUser = null;
var allIncomeData = [];
var allExpenseData = [];
var allBudgetData = [];
var allLoanData = [];
var allInvestmentData = [];
var allThirdPartyData = [];
var allAccountsData = [];
var allSettingsData = [];
var currentPage = 'dashboard';
// Category cache
var mainExpenseCategories = [];
var mainIncomeCategories = [];
var mainBudgetCategories = [];
var categoryCache = {}; // { categoryId: {id, name, icon, color, parentId} }

// ===== TH√äM D∆Ø·ªöI ƒê√ÇY =====
// Budget page state
var budgetCurrentPage = 1;
var budgetItemsPerPage = 10;
var budgetFilteredData = [];
var budgetFilters = {
  monthFrom: '',
  monthTo: '',
  category: ''
};

// ===== TH√äM D√íNG N√ÄY NGAY B√äN D∆Ø·ªöI =====
// Budget subcategories mapping
var budgetSubcategories = {
  'food': ['ƒÇn s√°ng', 'ƒÇn tr∆∞a', 'ƒÇn t·ªëi', 'ƒÇn v·∫∑t', 'Nh√† h√†ng', 'Kh√°c'],
  'transport': ['XƒÉng xe', 'Taxi/Grab', 'Xe bus', 'B·∫£o d∆∞·ª°ng xe', 'V√© m√°y bay', 'Kh√°c'],
  'shopping': ['Qu·∫ßn √°o', 'M·ªπ ph·∫©m', 'ƒêi·ªán t·ª≠', 'N·ªôi th·∫•t', 'ƒê·ªì d√πng c√° nh√¢n', 'Kh√°c'],
  'education': ['H·ªçc ph√≠', 'S√°ch v·ªü', 'Kh√≥a h·ªçc online', 'ƒê√†o t·∫°o', 'H·ªçc th√™m', 'Kh√°c'],
  'health': ['Kh√°m b·ªánh', 'Thu·ªëc men', 'B·∫£o hi·ªÉm y t·∫ø', 'Gym/Yoga', 'Vitamin', 'Kh√°c'],
  'entertainment': ['Phim ·∫£nh', 'Du l·ªãch', 'Cafe', 'Game/S√°ch', 'S·ªü th√≠ch', 'Kh√°c'],
  'other': ['Qu√† t·∫∑ng', 'T·ª´ thi·ªán', 'Chi ph√≠ kh√°c']
};

// ========== SETTINGS PAGE STATE ==========
var allCategories = []; // Cache all categories
var currentSettingsTab = 'expense'; // Current tab: expense, income, budget, etc.
var editingCategoryId = null; // ID of category being edited

// ===== TH√äM PH·∫¶N N√ÄY =====
// Loan page state
var loanCurrentPage = 1;
var loanItemsPerPage = 10;
var loanFilteredData = [];
var loanFilters = {
  fromDate: '',
  toDate: '',
  loanName: '',
  status: '',
  dueFrom: '',
  dueTo: '',
  remainingMin: '',
  remainingMax: ''
};
// ===== K·∫æT TH√öC PH·∫¶N TH√äM =====

// ========== UTILITY FUNCTIONS ==========
function formatCurrency(amount) {
  if (!amount && amount !== 0) return '0';
  return parseFloat(amount).toLocaleString('vi-VN');
}

function parseCurrency(value) {
  if (typeof value === 'number') return value;
  return parseFloat(value.toString().replace(/[,.]/g, '')) || 0;
}

function setupCurrencyInput(inputElement) {
  if (!inputElement) return;
  
  inputElement.addEventListener('input', function(e) {
    var value = e.target.value.replace(/[^\d]/g, '');
    if (value) {
      e.target.value = formatCurrency(value);
    }
  });
  
  inputElement.addEventListener('focus', function(e) {
    var value = parseCurrency(e.target.value);
    if (value > 0) {
      e.target.value = value;
    }
  });
  
  inputElement.addEventListener('blur', function(e) {
    var value = parseCurrency(e.target.value);
    e.target.value = formatCurrency(value);
  });
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  var date = new Date(dateStr);
  var day = ('0' + date.getDate()).slice(-2);
  var month = ('0' + (date.getMonth() + 1)).slice(-2);
  var year = date.getFullYear();
  return day + '/' + month + '/' + year;
}

function generateId(prefix) {
  var timestamp = new Date().getTime();
  var random = Math.floor(Math.random() * 1000);
  return prefix + timestamp + random;
}

function showToast(message, type) {
  var toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show ' + (type || 'success');
  
  setTimeout(function() {
    toast.className = 'toast';
  }, 3000);
}

// ========== MODAL FUNCTIONS ==========

function openModal(title, body, footer) {
  document.getElementById('modalTitle').innerText = title;
  document.getElementById('modalBody').innerHTML = body;
  document.getElementById('modalFooter').innerHTML = footer;
  document.getElementById('modal').style.display = 'flex';
  
  // Focus first input
  setTimeout(function() {
    var firstInput = document.querySelector('#modalBody input:not([type=hidden])');
    if (firstInput) firstInput.focus();
  }, 100);
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
  document.getElementById('modalBody').innerHTML = '';
  document.getElementById('modalFooter').innerHTML = '';
  editingCategoryId = null;
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
  var modal = document.getElementById('modal');
  if (event.target === modal) {
    closeModal();
  }
});

function showLoading() {
  document.getElementById('loadingSpinner').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingSpinner').style.display = 'none';
}

// ========== MODAL FUNCTIONS ==========
function openModal(title, bodyContent, footerButtons) {
  var modal = document.getElementById('modal');
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyContent;
  
  var footer = document.getElementById('modalFooter');
  footer.innerHTML = footerButtons || '';
  
  modal.classList.add('show');
}

function closeModal() {
  document.getElementById('modal').classList.remove('show');
}

// ========== AUTHENTICATION ==========
function togglePassword() {
  var input = document.getElementById('loginPassword');
  var icon = document.querySelector('.toggle-password i');
  
  if (!input || !icon) return;
  
  if (input.type === 'password') {
    input.type = 'text';
    icon.className = 'fas fa-eye-slash';
  } else {
    input.type = 'password';
    icon.className = 'fas fa-eye';
  }
}

function handleLogin() {
  var username = document.getElementById('loginUsername').value;
  var password = document.getElementById('loginPassword').value;
  
  if (!username || !password) {
    showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
    return;
  }
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      hideLoading();
      
      if (!response || typeof response !== 'object') {
        showToast('L·ªói: Ph·∫£n h·ªìi kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng', 'error');
        return;
      }
      
      if (response.success) {
        currentUser = response.data;
        console.log('Logged in user:', currentUser);
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        
        document.getElementById('userName').textContent = currentUser.fullName;
        document.getElementById('userRole').textContent = currentUser.role === 'Admin' ? 'Qu·∫£n tr·ªã vi√™n' : 'Ng∆∞·ªùi d√πng';
        
        loadAllData();
      } else {
        showToast(response.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói k·∫øt n·ªëi: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'), 'error');
    })
    .handleRequest('login', { username: username, password: password });
}

function handleLogout() {
  if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) return;
  
  google.script.run
    .withSuccessHandler(function() {
      location.reload();
    })
    .withFailureHandler(function() {
      location.reload();
    })
    .handleRequest('logout', {});
}

// ========== DATA LOADING ==========
async function loadAllData() {
  try {
    console.log('=== LOADING ALL DATA (v2.0 - OPTIMIZED) ===');
    
    showLoading('ƒêang t·∫£i d·ªØ li·ªáu...');
    
    // Initialize DataManager (parallel loading)
    await DataManager.initialize();
    
    // Sync to legacy global variables (backward compatibility)
    syncLegacyVariables();
    
    console.log('‚úÖ All data loaded successfully');
    
    hideLoading();
    showDashboard();
    showToast('T·∫£i d·ªØ li·ªáu th√†nh c√¥ng', 'success');
    
  } catch (error) {
    console.error('‚ùå Load data error:', error);
    hideLoading();
    showToast('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
  }
}

// Helper function to sync with legacy variables
function syncLegacyVariables() {
  allIncomeData = DataManager.getIncome();
  allExpenseData = DataManager.getExpense();
  allBudgetData = DataManager.getBudget();
  allLoanData = DataManager.getLoan();
  allInvestmentData = DataManager.getInvestment();
  allThirdPartyData = DataManager.getThirdParty();
  allAccountsData = DataManager.getAccounts();
  allSettingsData = DataManager.getSettings();
  
  mainExpenseCategories = DataManager.getCategories('expense');
  mainIncomeCategories = DataManager.getCategories('income');
  mainBudgetCategories = DataManager.getCategories('budget');
  
  // Build category cache
  categoryCache = {};
  const allCats = DataManager.getAllCategories();
  Object.values(allCats).forEach(catArray => {
    catArray.forEach(cat => {
      categoryCache[cat.id] = cat;
    });
  });
  
  console.log('‚úÖ Legacy variables synced');
}

function loadSheetData(sheetName) {
  return new Promise(function(resolve, reject) {
    console.log('üì• Loading sheet:', sheetName);
    
    google.script.run
      .withSuccessHandler(function(response) {
        console.log('üì¶ Response for', sheetName, ':', response);
        
        if (!response) {
          console.error('‚ùå Null response for', sheetName);
          resolve([]);
          return;
        }
        
        if (!response.success) {
          console.error('‚ùå Error response:', response.message);
          resolve([]);
          return;
        }
        
        if (!response.data) {
          console.error('‚ùå No data field in response');
          resolve([]);
          return;
        }
        
        console.log('‚úÖ', sheetName, 'loaded:', response.data.length, 'records');
        
        // Sample first record
        if (response.data.length > 0) {
          console.log('Sample record:', response.data[0]);
        }
        
        resolve(response.data);
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Load error for', sheetName, ':', error);
        reject(error);
      })
      .getRecords(sheetName);
  });
}

// ========== CATEGORY LOADING ==========

/**
 * Load main categories from Settings sheet
 * @param {string} type - Category type (expense, income, budget)
 * @return {Promise} Promise with categories
 */
function loadMainCategories(type) {
  return new Promise(function(resolve, reject) {
    console.log('üì• Loading main categories for type: ' + type);
    
    google.script.run
      .withSuccessHandler(function(response) {
        console.log('üì¶ Main categories response:', response);
        
        if (response.success) {
          var categories = response.data || [];
          
          // Cache categories
          if (type === 'expense') {
            mainExpenseCategories = categories;
          } else if (type === 'income') {
            mainIncomeCategories = categories;
          } else if (type === 'budget') {
            mainBudgetCategories = categories;
          }
          
          // Update category cache with details
          for (var i = 0; i < categories.length; i++) {
            var cat = categories[i];
            categoryCache[cat.id] = cat;
          }
          
          console.log('‚úÖ Cached ' + categories.length + ' ' + type + ' categories');
          resolve(categories);
        } else {
          console.error('‚ùå Error loading categories:', response.message);
          resolve([]);
        }
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed to load categories:', error);
        reject(error);
      })
      .handleRequest('getMainCategories', { type: type });
  });
}

/**
 * Load subcategories for a parent category
 * @param {string} parentId - Parent category ID
 * @return {Promise} Promise with subcategories
 */
function loadSubcategories(parentId) {
  return new Promise(function(resolve, reject) {
    console.log('üì• Loading subcategories for parent: ' + parentId);
    
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          console.log('‚úÖ Loaded ' + response.data.length + ' subcategories');
          resolve(response.data || []);
        } else {
          console.error('‚ùå Error:', response.message);
          resolve([]);
        }
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed:', error);
        reject(error);
      })
      .handleRequest('getSubcategories', { parentId: parentId });
  });
}

/**
 * Get category details from cache or server
 * @param {string} categoryId - Category ID
 * @return {Promise} Promise with category details
 */
function getCategoryFromCache(categoryId) {
  return new Promise(function(resolve, reject) {
    // Check cache first
    if (categoryCache[categoryId]) {
      resolve(categoryCache[categoryId]);
      return;
    }
    
    // Load from server
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success && response.data) {
          categoryCache[categoryId] = response.data;
          resolve(response.data);
        } else {
          resolve(null);
        }
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed to get category:', error);
        reject(error);
      })
      .handleRequest('getCategoryDetails', { categoryId: categoryId });
  });
}

/**
 * Render category dropdown with icons
 * @param {Array} categories - Array of categories
 * @param {string} selectedId - Selected category ID
 * @return {string} HTML options
 */
function renderCategoryOptions(categories, selectedId) {
  var html = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
  
  for (var i = 0; i < categories.length; i++) {
    var cat = categories[i];
    var selected = cat.id === selectedId ? ' selected' : '';
    var icon = cat.icon ? cat.icon + ' ' : '';
    
    html += '<option value="' + cat.id + '"' + selected + '>' + 
            icon + cat.name + 
            '</option>';
  }
  
  return html;
}

/**
 * Render subcategory dropdown
 * @param {Array} subcategories - Array of subcategories
 * @param {string} selectedId - Selected subcategory ID
 * @return {string} HTML options
 */
function renderSubcategoryOptions(subcategories, selectedId) {
  var html = '<option value="">-- Kh√¥ng ch·ªçn danh m·ª•c con --</option>';
  
  for (var i = 0; i < subcategories.length; i++) {
    var subcat = subcategories[i];
    var selected = subcat.id === selectedId ? ' selected' : '';
    
    html += '<option value="' + subcat.id + '"' + selected + '>‚îú‚îÄ ' + 
            subcat.name + 
            '</option>';
  }
  
  return html;
}

/**
 * Format category for display (with icon)
 * @param {Object} categoryData - Category JSON data
 * @return {string} Formatted category name
 */
function formatCategoryDisplay(categoryData) {
  if (!categoryData) return 'N/A';
  
  try {
    var cat = typeof categoryData === 'string' ? JSON.parse(categoryData) : categoryData;
    
    if (Array.isArray(cat) && cat.length > 0) {
      var mainCat = cat[0];
      var categoryId = mainCat.id;
      
      // Get from cache
      var categoryInfo = categoryCache[categoryId];
      var icon = categoryInfo && categoryInfo.icon ? categoryInfo.icon + ' ' : '';
      var name = mainCat.name || 'N/A';
      
      // Add subcategory if exists
      if (mainCat.subcategory) {
        name += ' - ' + mainCat.subcategory;
      }
      
      return icon + name;
    }
    
    return 'N/A';
  } catch(e) {
    console.error('Error formatting category:', e);
    return 'N/A';
  }
}

// ========== NAVIGATION ==========
function initNavigation() {
  var navItems = document.querySelectorAll('.nav-item');
  for (var i = 0; i < navItems.length; i++) {
    navItems[i].addEventListener('click', function(e) {
      e.preventDefault();
      var page = this.getAttribute('data-page');
      navigateToPage(page);
    });
  }
}

function navigateToPage(page) {
  currentPage = page;
  
  var navItems = document.querySelectorAll('.nav-item');
  for (var i = 0; i < navItems.length; i++) {
    navItems[i].classList.remove('active');
    if (navItems[i].getAttribute('data-page') === page) {
      navItems[i].classList.add('active');
    }
  }
  
  var titles = {
    'dashboard': 'Trang ch·ªß',
    'income': 'Thu nh·∫≠p',
    'expense': 'Chi ti√™u',
    'budget': 'Ng√¢n s√°ch',
    'loan': 'Kho·∫£n vay',
    'investment': 'ƒê·∫ßu t∆∞',
    'thirdparty': 'Thu chi h·ªô',
    'accounts': 'T√†i kho·∫£n',
    'reports': 'B√°o c√°o',
    'settings': 'C√†i ƒë·∫∑t'
  };
  
  document.getElementById('pageTitle').textContent = titles[page] || page;
  
  switch(page) {
    case 'dashboard':
      showDashboard();
      break;
    case 'income':
      showIncomePage();
      break;
    case 'expense':
      showExpensePage();
      break;
    case 'budget':  // ‚Üê TH√äM CASE N√ÄY
      showBudgetPage();
      break;  
    case 'loan':  // ‚Üê TH√äM CASE N√ÄY
      showLoanPage();
      break;
    case 'accounts':
      showAccountsPage();
      break;
    case 'settings':  // ‚Üê TH√äM CASE N√ÄY
      showSettingsPage();
      break;  
    default:
      showPlaceholderPage(titles[page]);
  }
  
  if (window.innerWidth <= 768) {
    document.getElementById('sidebar').classList.remove('active');
  }
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('active');
}

function showPlaceholderPage(title) {
  document.getElementById('contentWrapper').innerHTML = 
    '<div class="card"><h2>' + title + '</h2><p>T√≠nh nƒÉng ƒëang ƒë∆∞·ª£c ho√†n thi·ªán...</p></div>';
}

// ========== DASHBOARD WITH CHARTS ==========
function showDashboard() {
  console.log('=== SHOWING DASHBOARD WITH CHARTS ===');
  
  // Calculate summary statistics
  var totalIncome = 0;
  var totalExpense = 0;
  var incomeCount = 0;
  var expenseCount = 0;
  
  for (var i = 0; i < allIncomeData.length; i++) {
    totalIncome += parseCurrency(allIncomeData[i]['S·ªë ti·ªÅn']);
    incomeCount++;
  }
  
  for (var i = 0; i < allExpenseData.length; i++) {
    totalExpense += parseCurrency(allExpenseData[i]['S·ªë ti·ªÅn']);
    expenseCount++;
  }
  
  var balance = totalIncome - totalExpense;
  var accountCount = allAccountsData.length;
  
  // Calculate account balances
  var totalAccountBalance = 0;
  var cashAccountBalance = 0;
  
  for (var i = 0; i < allAccountsData.length; i++) {
    var accountBalance = parseCurrency(allAccountsData[i]['S·ªë d∆∞ hi·ªán t·∫°i']);
    totalAccountBalance += accountBalance;
    
    if (allAccountsData[i]['Lo·∫°i'] === 'Ti·ªÅn m·∫∑t') {
      cashAccountBalance = accountBalance;
    }
  }
  
  // BUILD HTML
  var html = '';
  
  // SUMMARY CARDS
  html += '<div class="card" style="margin-bottom: 30px;">';
  html += '<div class="card-header"><h2 class="card-title">T·ªïng quan t√†i ch√≠nh</h2></div>';
  html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 20px;">';
  
  // Card 1: Income
  html += '<div style="background: linear-gradient(135deg, #24c560 0%, #1ea750 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(36, 197, 96, 0.3);">';
  html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">';
  html += '<div><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">T·ªïng thu nh·∫≠p</div>';
  html += '<div style="font-size: 28px; font-weight: 700;">' + formatCurrency(totalIncome) + ' ƒë</div></div>';
  html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><i class="fas fa-arrow-down" style="font-size: 24px;"></i></div>';
  html += '</div><div style="font-size: 13px; opacity: 0.85;">' + incomeCount + ' giao d·ªãch</div></div>';
  
  // Card 2: Expense
  html += '<div style="background: linear-gradient(135deg, #e94849 0%, #d03838 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(233, 72, 73, 0.3);">';
  html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">';
  html += '<div><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">T·ªïng chi ti√™u</div>';
  html += '<div style="font-size: 28px; font-weight: 700;">' + formatCurrency(totalExpense) + ' ƒë</div></div>';
  html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><i class="fas fa-arrow-up" style="font-size: 24px;"></i></div>';
  html += '</div><div style="font-size: 13px; opacity: 0.85;">' + expenseCount + ' giao d·ªãch</div></div>';
  
  // Card 3: Balance
  html += '<div style="background: linear-gradient(135deg, #3782f4 0%, #2563d4 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(55, 130, 244, 0.3);">';
  html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">';
  html += '<div><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Ch√™nh l·ªách thu chi</div>';
  html += '<div style="font-size: 28px; font-weight: 700;">' + formatCurrency(balance) + ' ƒë</div></div>';
  html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><i class="fas fa-wallet" style="font-size: 24px;"></i></div>';
  html += '</div><div style="font-size: 13px; opacity: 0.85;">';
  html += (balance >= 0 ? 'Thu > Chi' : 'Chi > Thu') + ' (' + formatCurrency(totalIncome) + ' ƒë - ' + formatCurrency(totalExpense) + ' ƒë)</div></div>';
  
  // Card 4: Accounts
  html += '<div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">';
  html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">';
  html += '<div><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">T√†i kho·∫£n</div>';
  html += '<div style="font-size: 28px; font-weight: 700;">' + accountCount + '</div></div>';
  html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><i class="fas fa-building-columns" style="font-size: 24px;"></i></div>';
  html += '</div><div style="font-size: 13px; opacity: 0.85;">S·ªë d∆∞ hi·ªán t·∫°i: Ti·ªÅn m·∫∑t: ' + formatCurrency(cashAccountBalance) + ' ƒë / T·ªïng: ' + formatCurrency(totalAccountBalance) + ' ƒë</div></div>';
  
  html += '</div></div>';
  
  // CHARTS SECTION
  html += '<div class="charts-container">';
  
  // Chart 1
  html += '<div class="chart-card chart-full-width">';
  html += '<h3><i class="fas fa-chart-line"></i> Xu h∆∞·ªõng Thu nh·∫≠p & Chi ti√™u</h3>';
  html += '<div class="chart-wrapper"><canvas id="trendChart"></canvas></div>';
  html += '</div>';
  
  // Chart 2
  html += '<div class="chart-card">';
  html += '<h3><i class="fas fa-chart-pie"></i> Ph√¢n b·ªï Chi ti√™u</h3>';
  html += '<div class="chart-wrapper"><canvas id="expenseCategoryChart"></canvas></div>';
  html += '</div>';
  
  // Chart 3
  html += '<div class="chart-card">';
  html += '<h3><i class="fas fa-chart-bar"></i> Thu nh·∫≠p theo Danh m·ª•c</h3>';
  html += '<div class="chart-wrapper"><canvas id="incomeCategoryChart"></canvas></div>';
  html += '</div>';
  
  // Chart 4
  html += '<div class="chart-card">';
  html += '<h3><i class="fas fa-ranking-star"></i> Top 5 kho·∫£n chi ti√™u l·ªõn nh·∫•t</h3>';
  html += '<div class="chart-wrapper"><canvas id="topExpensesChart"></canvas></div>';
  html += '</div>';
  
  // Chart 5
  html += '<div class="chart-card chart-full-width">';
  html += '<h3><i class="fas fa-chart-column"></i> So s√°nh Thu Chi 6 th√°ng g·∫ßn nh·∫•t</h3>';
  html += '<div class="chart-wrapper"><canvas id="monthlyComparisonChart"></canvas></div>';
  html += '</div>';
  
  html += '</div>';
  
  // SET HTML
  document.getElementById('contentWrapper').innerHTML = html;
  
  console.log('‚úÖ HTML rendered');
  
  // Render charts v·ªõi delay d√†i h∆°n
  setTimeout(function() {
    try {
      console.log('=== RENDERING CHARTS ===');
      
      // Check Chart.js
      if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js NOT LOADED!');
        return;
      }
      console.log('‚úÖ Chart.js loaded:', Chart.version);
      
      // Check canvases
      var canvases = ['trendChart', 'expenseCategoryChart', 'incomeCategoryChart', 'topExpensesChart', 'monthlyComparisonChart'];
      var allFound = true;
      
      for (var i = 0; i < canvases.length; i++) {
        var canvas = document.getElementById(canvases[i]);
        if (!canvas) {
          console.error('‚ùå Canvas not found:', canvases[i]);
          allFound = false;
        } else {
          console.log('‚úÖ Canvas found:', canvases[i]);
        }
      }
      
      if (!allFound) {
        console.error('‚ùå Some canvases not found - aborting');
        return;
      }
      
      // Render all charts
      console.log('--- Rendering Trend Chart ---');
      renderTrendChart();
      
      console.log('--- Rendering Expense Category Chart ---');
      renderExpenseCategoryChart();
      
      console.log('--- Rendering Income Category Chart ---');
      renderIncomeCategoryChart();
      
      console.log('--- Rendering Top Expenses Chart ---');
      renderTopExpensesChart();
      
      console.log('--- Rendering Monthly Comparison Chart ---');
      renderMonthlyComparisonChart();
      
      console.log('‚úÖ All charts rendered successfully');
      
    } catch (error) {
      console.error('‚ùå Error rendering charts:', error);
      console.error('Error stack:', error.stack);
    }
  }, 1000);
}

// ========== CHART RENDERING FUNCTIONS ==========

// Chart 1: Income vs Expense Trend (Line Chart)
function renderTrendChart() {
  console.log('>>> renderTrendChart called');
  
  var ctx = document.getElementById('trendChart');
  if (!ctx) {
    console.error('‚ùå trendChart canvas not found');
    return;
  }
  
  console.log('‚úÖ trendChart canvas found');
  
  // Ki·ªÉm tra context
  var context = ctx.getContext('2d');
  if (!context) {
    console.error('‚ùå Cannot get 2d context');
    return;
  }
  
  console.log('‚úÖ 2d context OK');
  
  var monthlyData = {};
  
  for (var i = 0; i < allIncomeData.length; i++) {
    var item = allIncomeData[i];
    var date = new Date(item['Ng√†y']);
    var monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
    
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = { income: 0, expense: 0 };
    }
    
    monthlyData[monthKey].income += parseCurrency(item['S·ªë ti·ªÅn']);
  }
  
  for (var i = 0; i < allExpenseData.length; i++) {
    var item = allExpenseData[i];
    var date = new Date(item['Ng√†y']);
    var monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
    
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = { income: 0, expense: 0 };
    }
    
    monthlyData[monthKey].expense += parseCurrency(item['S·ªë ti·ªÅn']);
  }
  
  var sortedMonths = Object.keys(monthlyData).sort();
  var last6Months = sortedMonths.slice(-6);
  
  var labels = [];
  var incomeData = [];
  var expenseData = [];
  
  for (var i = 0; i < last6Months.length; i++) {
    var monthKey = last6Months[i];
    var parts = monthKey.split('-');
    labels.push('Th√°ng ' + parts[1] + '/' + parts[0]);
    incomeData.push(monthlyData[monthKey].income);
    expenseData.push(monthlyData[monthKey].expense);
  }
  
  if (labels.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-chart-line"></i><div>Ch∆∞a c√≥ d·ªØ li·ªáu</div></div>';
    return;
  }
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Thu nh·∫≠p',
          data: incomeData,
          borderColor: '#24c560',
          backgroundColor: 'rgba(36, 197, 96, 0.1)',
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7
        },
        {
          label: 'Chi ti√™u',
          data: expenseData,
          borderColor: '#e94849',
          backgroundColor: 'rgba(233, 72, 73, 0.1)',
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + formatCurrency(context.parsed.y) + ' ƒë';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value) + ' ƒë';
            }
          }
        }
      }
    }
  });
}

// Chart 2: Expense by Category (Doughnut Chart)
function renderExpenseCategoryChart() {
  var ctx = document.getElementById('expenseCategoryChart');
  if (!ctx) return;
  
  var categoryData = {};
  
  for (var i = 0; i < allExpenseData.length; i++) {
    var item = allExpenseData[i];
    try {
      var cat = typeof item['Danh m·ª•c chi ti√™u'] === 'string' ? 
        JSON.parse(item['Danh m·ª•c chi ti√™u']) : item['Danh m·ª•c chi ti√™u'];
      
      if (cat && cat[0]) {
        var categoryName = cat[0].name || 'Kh√°c';
        if (!categoryData[categoryName]) {
          categoryData[categoryName] = 0;
        }
        categoryData[categoryName] += parseCurrency(item['S·ªë ti·ªÅn']);
      }
    } catch(e) {}
  }
  
  var labels = Object.keys(categoryData);
  var data = Object.values(categoryData);
  
  if (labels.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-chart-pie"></i><div>Ch∆∞a c√≥ d·ªØ li·ªáu</div></div>';
    return;
  }
  
  var colors = ['#e94849', '#f59e0b', '#3782f4', '#24c560', '#9333ea', '#ec4899', '#14b8a6', '#f97316'];
  var total = data.reduce(function(a, b) { return a + b; }, 0);
  
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors,
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'right'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              var percentage = ((context.parsed / total) * 100).toFixed(1);
              return context.label + ': ' + formatCurrency(context.parsed) + ' ƒë (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

// Chart 3: Income by Category (Bar Chart)
function renderIncomeCategoryChart() {
  var ctx = document.getElementById('incomeCategoryChart');
  if (!ctx) return;
  
  var categoryData = {};
  
  for (var i = 0; i < allIncomeData.length; i++) {
    var item = allIncomeData[i];
    try {
      var cat = typeof item['Danh m·ª•c thu nh·∫≠p'] === 'string' ? 
        JSON.parse(item['Danh m·ª•c thu nh·∫≠p']) : item['Danh m·ª•c thu nh·∫≠p'];
      
      if (cat && cat[0]) {
        var categoryName = cat[0].name || 'Kh√°c';
        if (!categoryData[categoryName]) {
          categoryData[categoryName] = 0;
        }
        categoryData[categoryName] += parseCurrency(item['S·ªë ti·ªÅn']);
      }
    } catch(e) {}
  }
  
  var labels = Object.keys(categoryData);
  var data = Object.values(categoryData);
  
  if (labels.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-chart-bar"></i><div>Ch∆∞a c√≥ d·ªØ li·ªáu</div></div>';
    return;
  }
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Thu nh·∫≠p',
        data: data,
        backgroundColor: '#24c560',
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Thu nh·∫≠p: ' + formatCurrency(context.parsed.y) + ' ƒë';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value) + ' ƒë';
            }
          }
        }
      }
    }
  });
}


// Chart 4: Top 5 Expenses (Horizontal Bar Chart)
function renderTopExpensesChart() {
  var ctx = document.getElementById('topExpensesChart');
  if (!ctx) return;
  
  if (!allExpenseData || allExpenseData.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-ranking-star"></i><div>Ch∆∞a c√≥ d·ªØ li·ªáu</div></div>';
    return;
  }
  
  var expensesArray = [];
  
  for (var i = 0; i < allExpenseData.length; i++) {
    var item = allExpenseData[i];
    var amount = parseCurrency(item['S·ªë ti·ªÅn']);
    var description = item['M√¥ t·∫£'] || 'Kh√¥ng c√≥ m√¥ t·∫£';
    var date = item['Ng√†y'] || '';
    
    var categoryName = 'Kh√°c';
    try {
      var cat = typeof item['Danh m·ª•c chi ti√™u'] === 'string' ? 
        JSON.parse(item['Danh m·ª•c chi ti√™u']) : item['Danh m·ª•c chi ti√™u'];
      if (cat && cat[0]) {
        categoryName = cat[0].name || 'Kh√°c';
      }
    } catch(e) {}
    
    expensesArray.push({
      amount: amount,
      description: description,
      date: date,
      category: categoryName
    });
  }
  
  expensesArray.sort(function(a, b) {
    return b.amount - a.amount;
  });
  
  var top5 = expensesArray.slice(0, 5);
  
  if (top5.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-ranking-star"></i><div>Ch∆∞a c√≥ d·ªØ li·ªáu</div></div>';
    return;
  }
  
  var labels = [];
  var data = [];
  var backgroundColors = [];
  
  var colors = ['#e94849', '#f97316', '#f59e0b', '#eab308', '#84cc16'];
  
  for (var i = 0; i < top5.length; i++) {
    var expense = top5[i];
    var label = expense.description;
    if (label.length > 25) {
      label = label.substring(0, 22) + '...';
    }
    
    labels.push(label);
    data.push(expense.amount);
    backgroundColors.push(colors[i]);
  }
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'S·ªë ti·ªÅn',
        data: data,
        backgroundColor: backgroundColors,
        borderRadius: 8,
        barThickness: 40
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            title: function(context) {
              var index = context[0].dataIndex;
              return top5[index].description;
            },
            label: function(context) {
              return 'S·ªë ti·ªÅn: ' + formatCurrency(context.parsed.x) + ' ƒë';
            },
            afterLabel: function(context) {
              var index = context.dataIndex;
              return [
                'Danh m·ª•c: ' + top5[index].category,
                'Ng√†y: ' + formatDate(top5[index].date)
              ];
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value) + ' ƒë';
            }
          }
        },
        y: {
          ticks: {
            autoSkip: false,
            font: {
              size: 11
            }
          }
        }
      }
    }
  });
}
// Chart 5: Monthly Comparison (Bar Chart)
function renderMonthlyComparisonChart() {
  var ctx = document.getElementById('monthlyComparisonChart');
  if (!ctx) return;
  
  var monthlyData = {};
  
  for (var i = 0; i < allIncomeData.length; i++) {
    var item = allIncomeData[i];
    var date = new Date(item['Ng√†y']);
    var monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
    
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = { income: 0, expense: 0 };
    }
    
    monthlyData[monthKey].income += parseCurrency(item['S·ªë ti·ªÅn']);
  }
  
  for (var i = 0; i < allExpenseData.length; i++) {
    var item = allExpenseData[i];
    var date = new Date(item['Ng√†y']);
    var monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
    
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = { income: 0, expense: 0 };
    }
    
    monthlyData[monthKey].expense += parseCurrency(item['S·ªë ti·ªÅn']);
  }
  
  var sortedMonths = Object.keys(monthlyData).sort();
  var last6Months = sortedMonths.slice(-6);
  
  var labels = [];
  var incomeData = [];
  var expenseData = [];
  
  for (var i = 0; i < last6Months.length; i++) {
    var monthKey = last6Months[i];
    var parts = monthKey.split('-');
    labels.push('Th√°ng ' + parts[1] + '/' + parts[0]);
    incomeData.push(monthlyData[monthKey].income);
    expenseData.push(monthlyData[monthKey].expense);
  }
  
  if (labels.length === 0) {
    ctx.parentElement.innerHTML = '<div class="no-data-message"><i class="fas fa-chart-column"></i><div>Ch∆∞a c√≥ d·ªØ li·ªáu</div></div>';
    return;
  }
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Thu nh·∫≠p',
          data: incomeData,
          backgroundColor: '#24c560',
          borderRadius: 8
        },
        {
          label: 'Chi ti√™u',
          data: expenseData,
          backgroundColor: '#e94849',
          borderRadius: 8
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + formatCurrency(context.parsed.y) + ' ƒë';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value) + ' ƒë';
            }
          }
        }
      }
    }
  });
}
// ========== INCOME PAGE WITH FILTERS & PAGINATION ==========
var incomeCurrentPage = 1;
var incomeItemsPerPage = 10;
var incomeFilteredData = [];
var incomeFilters = {
  fromDate: '',
  toDate: '',
  category: '',
  accountId: ''
};

function showIncomePage() {
  console.log('=== SHOWING INCOME PAGE ===');
  
  // Reset v·ªÅ trang 1 khi m·ªü page
  incomeCurrentPage = 1;
  incomeFilteredData = allIncomeData.slice();
  
  renderIncomePage();
}

function renderIncomePage() {
  console.log('=== RENDERING INCOME PAGE (CACHED) ===');
  
  // Use cached data
  if (!incomeFilteredData.length) {
    incomeFilteredData = DataManager.getIncome();
  }
  // Apply filters
  applyIncomeFilters();
  
  var totalRecords = incomeFilteredData.length;
  var totalPages = Math.ceil(totalRecords / incomeItemsPerPage);
  
  if (incomeCurrentPage > totalPages && totalPages > 0) {
    incomeCurrentPage = totalPages;
  }
  
  if (incomeCurrentPage < 1) {
    incomeCurrentPage = 1;
  }
  
  var html = '<div class="card">' +
    '<div class="card-header">' +
    '<h2 class="card-title">Danh s√°ch Thu nh·∫≠p</h2>' +
    '<div style="display: flex; gap: 10px;">' +
    '<button class="btn-secondary" onclick="downloadIncomeTemplate()"><i class="fas fa-download"></i> T·∫£i m·∫´u Excel</button>' +
    '<button class="btn-secondary" onclick="openIncomeImportModal()"><i class="fas fa-file-import"></i> Import Excel</button>' +
    '<button class="btn-primary" onclick="openIncomeModal()"><i class="fas fa-plus"></i> Th√™m thu nh·∫≠p</button>' +
    '</div>' +
    '</div>' +
    
    // FILTER PANEL
    '<div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">T·ª´ ng√†y</label>' +
    '<input type="date" id="incomeFilterFromDate" class="form-control" value="' + incomeFilters.fromDate + '" onchange="renderIncomePage()"></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">ƒê·∫øn ng√†y</label>' +
    '<input type="date" id="incomeFilterToDate" class="form-control" value="' + incomeFilters.toDate + '" onchange="renderIncomePage()"></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">Danh m·ª•c</label>' +
    '<select id="incomeFilterCategory" class="form-control" onchange="renderIncomePage()"><option value="">T·∫•t c·∫£</option>' +
    '<option value="salary">L∆∞∆°ng</option><option value="bonus">Th∆∞·ªüng</option>' +
    '<option value="investment">ƒê·∫ßu t∆∞</option><option value="freelance">Freelance</option><option value="other">Kh√°c</option></select></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">T√†i kho·∫£n</label>' +
    '<select id="incomeFilterAccount" class="form-control" onchange="renderIncomePage()"><option value="">T·∫•t c·∫£</option>' + 
    renderAccountOptionsForFilter() + '</select></div>' +
    '<div style="display: flex; align-items: flex-end;"><button class="btn-secondary" onclick="clearIncomeFilters()" style="width: 100%;">X√≥a b·ªô l·ªçc</button></div>' +
    '</div></div>' +
        
    '<div style="margin-bottom: 10px; color: #718096; display: flex; justify-content: space-between; align-items: center;">' +
    '<span>Hi·ªÉn th·ªã ' + ((incomeCurrentPage - 1) * incomeItemsPerPage + 1) + ' - ' + 
    Math.min(incomeCurrentPage * incomeItemsPerPage, totalRecords) + ' trong t·ªïng s·ªë ' + totalRecords + ' b·∫£n ghi</span>' +
    '<div style="display: flex; gap: 10px; align-items: center;">' +
    '<label style="margin: 0;">Hi·ªÉn th·ªã:</label>' +
    '<select onchange="changeIncomeItemsPerPage(this.value)" class="form-control" style="width: auto; padding: 5px 10px;">' +
    '<option value="5"' + (incomeItemsPerPage === 5 ? ' selected' : '') + '>5</option>' +
    '<option value="10"' + (incomeItemsPerPage === 10 ? ' selected' : '') + '>10</option>' +
    '<option value="20"' + (incomeItemsPerPage === 20 ? ' selected' : '') + '>20</option>' +
    '<option value="50"' + (incomeItemsPerPage === 50 ? ' selected' : '') + '>50</option>' +
    '</select>' +
    '</div></div>' +
    
    '<div style="overflow: auto; max-height: calc(100vh - 400px); position: relative;">' +
    '<table>' +
    '<thead>' +
    '<tr>' +
    '<th class="sticky-column">Ng√†y</th>' +
    '<th>Danh m·ª•c</th>' +
    '<th>S·ªë ti·ªÅn</th>' +
    '<th>M√¥ t·∫£</th>' +
    '<th>T√†i kho·∫£n</th>' +
    '<th>H√†nh ƒë·ªông</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody>' + renderIncomeTableWithPagination() + '</tbody>' +
    '</table></div>' +
    
    // PAGINATION
    renderIncomePagination(totalPages) +
    
    '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
  
  // Restore filter values
  var fromDateEl = document.getElementById('incomeFilterFromDate');
  var toDateEl = document.getElementById('incomeFilterToDate');
  var categoryEl = document.getElementById('incomeFilterCategory');
  var accountEl = document.getElementById('incomeFilterAccount');
  
  if (fromDateEl) fromDateEl.value = incomeFilters.fromDate;
  if (toDateEl) toDateEl.value = incomeFilters.toDate;
  if (categoryEl) categoryEl.value = incomeFilters.category;
  if (accountEl) accountEl.value = incomeFilters.accountId;
}

function applyIncomeFilters() {
  // ƒê·ªçc gi√° tr·ªã filter t·ª´ input
  var fromDateEl = document.getElementById('incomeFilterFromDate');
  var toDateEl = document.getElementById('incomeFilterToDate');
  var categoryEl = document.getElementById('incomeFilterCategory');
  var accountEl = document.getElementById('incomeFilterAccount');
  
  if (fromDateEl) incomeFilters.fromDate = fromDateEl.value;
  if (toDateEl) incomeFilters.toDate = toDateEl.value;
  if (categoryEl) incomeFilters.category = categoryEl.value;
  if (accountEl) incomeFilters.accountId = accountEl.value;
  
  // Filter data
  incomeFilteredData = [];
  
  for (var i = 0; i < allIncomeData.length; i++) {
    var item = allIncomeData[i];
    var itemDate = item['Ng√†y'];
    
    // Filter by date range
    if (incomeFilters.fromDate && itemDate < incomeFilters.fromDate) continue;
    if (incomeFilters.toDate && itemDate > incomeFilters.toDate) continue;
    
    // Filter by category
    if (incomeFilters.category) {
      try {
        var cat = typeof item['Danh m·ª•c thu nh·∫≠p'] === 'string' ? 
          JSON.parse(item['Danh m·ª•c thu nh·∫≠p']) : item['Danh m·ª•c thu nh·∫≠p'];
        if (!cat || !cat[0] || cat[0].id !== incomeFilters.category) continue;
      } catch(e) {
        continue;
      }
    }
    
    // Filter by account
    if (incomeFilters.accountId) {
      try {
        var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
        if (!meta || meta.accountId !== incomeFilters.accountId) continue;
      } catch(e) {
        continue;
      }
    }
    
    incomeFilteredData.push(item);
  }
}

function clearIncomeFilters() {
  console.log('=== CLEARING INCOME FILTERS ===');
  
  // Reset filter values
  incomeFilters = { 
    fromDate: '', 
    toDate: '', 
    category: '', 
    accountId: '' 
  };
  
  // Reset to page 1
  incomeCurrentPage = 1;
  
  // Reset filtered data to all data
  incomeFilteredData = allIncomeData.slice();
  
  console.log('Filters cleared, rendering page...');
  
  // Re-render page
  renderIncomePage();
  
  // Force clear input values after render
  setTimeout(function() {
    var fromDateEl = document.getElementById('incomeFilterFromDate');
    var toDateEl = document.getElementById('incomeFilterToDate');
    var categoryEl = document.getElementById('incomeFilterCategory');
    var accountEl = document.getElementById('incomeFilterAccount');
    
    if (fromDateEl) fromDateEl.value = '';
    if (toDateEl) toDateEl.value = '';
    if (categoryEl) categoryEl.value = '';
    if (accountEl) accountEl.value = '';
    
    console.log('Input values cleared');
  }, 100);
}

function changeIncomeItemsPerPage(value) {
  incomeItemsPerPage = parseInt(value);
  incomeCurrentPage = 1;
  renderIncomePage();
}

function renderIncomeTableWithPagination() {
  if (!incomeFilteredData || incomeFilteredData.length === 0) {
    return '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
  }
  
  var startIndex = (incomeCurrentPage - 1) * incomeItemsPerPage;
  var endIndex = Math.min(startIndex + incomeItemsPerPage, incomeFilteredData.length);
  
  var html = '';
  
  for (var i = startIndex; i < endIndex; i++) {
    var item = incomeFilteredData[i];
    var id = item.ID || 'N/A';
    var accountId = '';
    
    try {
      var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
      accountId = meta.accountId || '';
    } catch(e) {}
    
    var categoryName = getCategoryName(item['Danh m·ª•c thu nh·∫≠p']);
    
    html += '<tr>' +
      '<td class="sticky-column">' + formatDate(item['Ng√†y']) + '</td>' +
      '<td>' + categoryName + '</td>' +
      '<td style="color: #24c560; font-weight: 600;">' + formatCurrency(item['S·ªë ti·ªÅn']) + ' ƒë</td>' +
      '<td>' + (item['M√¥ t·∫£'] || '-') + '</td>' +
      '<td>' + getAccountName(accountId) + '</td>' +
      '<td class="action-buttons">' +
      '<button class="btn-primary btn-sm" onclick="editIncome(\'' + id + '\')"><i class="fas fa-edit"></i></button>' +
      '<button class="btn-danger btn-sm" onclick="confirmDeleteIncome(\'' + id + '\')"><i class="fas fa-trash"></i></button>' +
      '</td></tr>';
  }
  
  return html;
}

function renderIncomePagination(totalPages) {
  if (totalPages <= 1) return '';
  
  var html = '<div style="display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px;">';
  
  // Previous button
  html += '<button class="btn-secondary btn-sm" onclick="incomeGoToPage(' + (incomeCurrentPage - 1) + ')" ' + 
    (incomeCurrentPage === 1 ? 'disabled' : '') + '><i class="fas fa-chevron-left"></i></button>';
  
  // Page numbers
  var startPage = Math.max(1, incomeCurrentPage - 2);
  var endPage = Math.min(totalPages, incomeCurrentPage + 2);
  
  if (startPage > 1) {
    html += '<button class="btn-secondary btn-sm" onclick="incomeGoToPage(1)">1</button>';
    if (startPage > 2) html += '<span>...</span>';
  }
  
  for (var i = startPage; i <= endPage; i++) {
    if (i === incomeCurrentPage) {
      html += '<button class="btn-primary btn-sm" disabled>' + i + '</button>';
    } else {
      html += '<button class="btn-secondary btn-sm" onclick="incomeGoToPage(' + i + ')">' + i + '</button>';
    }
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span>...</span>';
    html += '<button class="btn-secondary btn-sm" onclick="incomeGoToPage(' + totalPages + ')">' + totalPages + '</button>';
  }
  
  // Next button
  html += '<button class="btn-secondary btn-sm" onclick="incomeGoToPage(' + (incomeCurrentPage + 1) + ')" ' + 
    (incomeCurrentPage === totalPages ? 'disabled' : '') + '><i class="fas fa-chevron-right"></i></button>';
  
  html += '</div>';
  
  return html;
}

function incomeGoToPage(page) {
  incomeCurrentPage = page;
  renderIncomePage();
  window.scrollTo(0, 0);
}

function renderAccountOptionsForFilter() {
  var html = '';
  
  if (!allAccountsData || allAccountsData.length === 0) {
    return html;
  }
  
  for (var i = 0; i < allAccountsData.length; i++) {
    var acc = allAccountsData[i];
    html += '<option value="' + acc.AccountID + '">' + acc['T√™n t√†i kho·∫£n'] + '</option>';
  }
  
  return html;
}

// DELETE WITH MODAL CONFIRMATION
function confirmDeleteIncome(id) {
  var body = '<p style="text-align: center; font-size: 16px; margin: 20px 0;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?</p>' +
    '<p style="text-align: center; color: #e94849; font-weight: 500;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-danger" onclick="executeDeleteIncome(\'' + id + '\')">X√≥a</button>';
  
  openModal('X√°c nh·∫≠n x√≥a', body, footer);
}

function executeDeleteIncome(id) {
  closeModal();
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        reloadIncomeData();
      } else {
        hideLoading();
        showToast(response.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('deleteRecord', {sheetName: 'Thu nh·∫≠p', id: id});
}

// DOWNLOAD EXCEL TEMPLATE
function downloadIncomeTemplate() {
  // T·∫°o workbook m·ªõi
  var wb = XLSX.utils.book_new();
  
  // T·∫°o data v·ªõi format ƒë·∫πp
  var wsData = [
    ['Ng√†y', 'Danh m·ª•c', 'S·ªë ti·ªÅn', 'M√¥ t·∫£', 'T√†i kho·∫£n'],
    ['2025-10-20', 'salary', 15000000, 'L∆∞∆°ng th√°ng 10', 'ACC001'],
    ['2025-10-21', 'bonus', 5000000, 'Th∆∞·ªüng d·ª± √°n', 'ACC002']
  ];
  
  // T·∫°o worksheet
  var ws = XLSX.utils.aoa_to_sheet(wsData);
  
  // Set column widths
  ws['!cols'] = [
    { wch: 12 },  // Ng√†y
    { wch: 15 },  // Danh m·ª•c
    { wch: 15 },  // S·ªë ti·ªÅn
    { wch: 30 },  // M√¥ t·∫£
    { wch: 12 }   // T√†i kho·∫£n
  ];
  
  // Add worksheet to workbook
  XLSX.utils.book_append_sheet(wb, ws, 'Income_Template');
  
  // T·∫°o file Excel
  var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  var blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  
  // Download file
  var link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'Income_Template.xlsx';
  link.click();
  
  showToast('ƒê√£ t·∫£i xu·ªëng file m·∫´u Excel', 'success');
}

function openIncomeImportModal() {
  var body = '<div class="form-group">' +
    '<label>Ch·ªçn file Excel/CSV</label>' +
    '<input type="file" id="incomeImportFile" accept=".xlsx,.xls,.csv" class="form-control">' +
    '<small style="color: #718096; margin-top: 5px; display: block;">ƒê·ªãnh d·∫°ng: XLSX, XLS, CSV</small>' +
    '<small style="color: #718096; margin-top: 5px; display: block;">C·∫•u tr√∫c: Ng√†y | Danh m·ª•c | S·ªë ti·ªÅn | M√¥ t·∫£ | T√†i kho·∫£n</small>' +
    '<div style="margin-top: 10px; padding: 10px; background: #fffbeb; border-left: 3px solid #f59e0b; border-radius: 4px;">' +
    '<strong>L∆∞u √Ω:</strong><br>' +
    '<ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">' +
    '<li>Ng√†y: ƒê·ªãnh d·∫°ng YYYY-MM-DD (VD: 2025-10-20)</li>' +
    '<li>Danh m·ª•c: salary, bonus, investment, freelance, other</li>' +
    '<li>S·ªë ti·ªÅn: S·ªë nguy√™n (VD: 15000000)</li>' +
    '<li>T√†i kho·∫£n: M√£ t√†i kho·∫£n (VD: ACC001)</li>' +
    '</ul>' +
    '</div>' +
    '</div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-primary" onclick="processIncomeImport()">Import</button>';
  
  openModal('Import d·ªØ li·ªáu Thu nh·∫≠p', body, footer);
}

// PROCESS IMPORT EXCEL
function processIncomeImport() {
  var fileInput = document.getElementById('incomeImportFile');
  
  if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
    showToast('Vui l√≤ng ch·ªçn file', 'error');
    return;
  }
  
  var file = fileInput.files[0];
  var reader = new FileReader();
  
  closeModal();
  showLoading();
  
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, { type: 'array' });
      var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      var jsonData = XLSX.utils.sheet_to_json(firstSheet);
      
      console.log('Imported income data:', jsonData);
      
      if (jsonData.length === 0) {
        hideLoading();
        showToast('File kh√¥ng c√≥ d·ªØ li·ªáu', 'error');
        return;
      }
      
      // X·ª≠ l√Ω t·ª´ng d√≤ng tu·∫ßn t·ª±
      var successCount = 0;
      var errorCount = 0;
      
      function processRow(index) {
        if (index >= jsonData.length) {
          // Ho√†n th√†nh
          console.log('=== IMPORT COMPLETED ===');
          console.log('Success:', successCount, 'Error:', errorCount);
          
          hideLoading();
          
          if (successCount > 0) {
            showToast('Import th√†nh c√¥ng ' + successCount + ' / ' + jsonData.length + ' b·∫£n ghi', 'success');
            
            // Reload data with delay
            console.log('Reloading income data in 1 second...');
            setTimeout(function() {
              Promise.all([
                loadSheetData('Thu nh·∫≠p'),
                loadSheetData('T√†i kho·∫£n')
              ]).then(function(results) {
                allIncomeData = results[0];
                allAccountsData = results[1];
                incomeFilteredData = allIncomeData.slice(); // Reset filter
                incomeCurrentPage = 1; // Reset v·ªÅ trang 1
                
                console.log('Income data reloaded:', allIncomeData.length, 'records');
                
                renderIncomePage();
              }).catch(function(error) {
                console.error('Error reloading income data:', error);
                showToast('L·ªói t·∫£i l·∫°i d·ªØ li·ªáu', 'error');
              });
            }, 1500); // Delay 1.5 gi√¢y
          } else {
            showToast('Kh√¥ng c√≥ b·∫£n ghi n√†o ƒë∆∞·ª£c import', 'error');
          }
          
          if (errorCount > 0) {
            showToast('C√≥ ' + errorCount + ' l·ªói', 'error');
          }
          
          return;
        }
        
        var row = jsonData[index];
        
        console.log('Processing income row ' + (index + 1) + ':', row);
        
        // Validate
        if (!row['Ng√†y'] || !row['Danh m·ª•c'] || !row['S·ªë ti·ªÅn'] || !row['T√†i kho·∫£n']) {
          console.error('Row ' + (index + 1) + ': Missing required fields');
          errorCount++;
          processRow(index + 1);
          return;
        }
        
        // Parse date
        var dateValue = row['Ng√†y'];
        var formattedDate = '';
        
        if (typeof dateValue === 'number') {
          var excelDate = XLSX.SSF.parse_date_code(dateValue);
          formattedDate = excelDate.y + '-' + 
            String(excelDate.m).padStart(2, '0') + '-' + 
            String(excelDate.d).padStart(2, '0');
        } else if (typeof dateValue === 'string') {
          formattedDate = dateValue;
        } else {
          console.error('Row ' + (index + 1) + ': Invalid date format');
          errorCount++;
          processRow(index + 1);
          return;
        }
        
        var accountId = row['T√†i kho·∫£n'];
        var amount = parseFloat(row['S·ªë ti·ªÅn']);
        
        // Create record
        var recordData = {
          'ID': generateId('TN'),
          'Ng√†y': formattedDate,
          'Danh m·ª•c thu nh·∫≠p': JSON.stringify([{
            id: row['Danh m·ª•c'], 
            name: getCategoryLabel(row['Danh m·ª•c'])
          }]),
          'S·ªë ti·ªÅn': amount,
          'M√¥ t·∫£': row['M√¥ t·∫£'] || '',
          'Ph∆∞∆°ng th·ª©c thanh to√°n': JSON.stringify([{
            id: accountId, 
            name: getAccountName(accountId)
          }]),
          'UserID': currentUser.userId,
          'Metadata': JSON.stringify({accountId: accountId})
        };
        
        console.log('Creating income record:', recordData);
        
        // Create record in Sheet
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              console.log('Income row ' + (index + 1) + ' created successfully');
              
              // Update account balance (ADD)
              google.script.run
                .withSuccessHandler(function(balanceResponse) {
                  console.log('Balance updated for income row ' + (index + 1));
                  successCount++;
                  processRow(index + 1);
                })
                .withFailureHandler(function(error) {
                  console.error('Balance update failed for income row ' + (index + 1) + ':', error);
                  successCount++; // V·∫´n t√≠nh l√† th√†nh c√¥ng
                  processRow(index + 1);
                })
                .handleRequest('updateAccountBalance', {
                  accountId: accountId,
                  amount: amount,
                  type: 'add'
                });
            } else {
              console.error('Income row ' + (index + 1) + ' failed:', response.message);
              errorCount++;
              processRow(index + 1);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Income row ' + (index + 1) + ' error:', error);
            errorCount++;
            processRow(index + 1);
          })
          .handleRequest('createRecord', {
            sheetName: 'Thu nh·∫≠p',
            data: recordData
          });
        
      }
      
      // B·∫Øt ƒë·∫ßu x·ª≠ l√Ω t·ª´ row 0
      processRow(0);
      
    } catch (error) {
      hideLoading();
      showToast('L·ªói ƒë·ªçc file: ' + error.message, 'error');
      console.error('Import error:', error);
    }
  };
  
  reader.onerror = function() {
    hideLoading();
    showToast('L·ªói ƒë·ªçc file', 'error');
  };
  
  reader.readAsArrayBuffer(file);
}

// ========================================
// INCOME MODAL - OPTIMIZED VERSION
// ========================================

function openIncomeModal(id) {
  console.log('=== OPENING INCOME MODAL ===', id ? 'EDIT' : 'CREATE');
  
  var isEdit = !!id;
  var item = {};
  
  if (isEdit) {
    // Use DataManager for instant lookup
    const incomeList = DataManager.getIncome();
    item = incomeList.find(i => i.ID === id) || {};
    
    if (!item.ID) {
      showToast('Kh√¥ng t√¨m th·∫•y b·∫£n ghi', 'error');
      return;
    }
  }
  
  // Parse existing data
  var accountId = '';
  var categoryId = '';
  var subcategoryId = '';
  
  if (isEdit && item.Metadata) {
    try {
      var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
      accountId = meta.accountId || '';
    } catch(e) {
      console.error('Parse metadata error:', e);
    }
  }
  
  if (isEdit && item['Danh m·ª•c thu nh·∫≠p']) {
    try {
      var cat = typeof item['Danh m·ª•c thu nh·∫≠p'] === 'string' ? 
        JSON.parse(item['Danh m·ª•c thu nh·∫≠p']) : item['Danh m·ª•c thu nh·∫≠p'];
      if (cat && cat[0]) {
        categoryId = cat[0].id || '';
        subcategoryId = cat[0].subcategoryId || '';
      }
    } catch(e) {
      console.error('Parse category error:', e);
    }
  }
  
  // Build modal HTML
  var body = 
    '<form id="incomeForm" onsubmit="handleSaveIncome(event, \'' + (id || '') + '\')">' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-calendar"></i> Ng√†y <span style="color: red;">*</span></label>' +
    '<input type="date" id="incomeDate" name="Ng√†y" class="form-control" value="' + 
    (item['Ng√†y'] || new Date().toISOString().split('T')[0]) + '" required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-tag"></i> Danh m·ª•c ch√≠nh <span style="color: red;">*</span></label>' +
    '<select id="incomeCategory" name="Danh m·ª•c" class="form-control" onchange="loadIncomeSubcategories()" required>' +
    '<option value="">-- Loading categories... --</option>' +
    '</select>' +
    '</div>' +
    
    '<div class="form-group" id="incomeSubcategoryWrapper" style="display: none;">' +
    '<label><i class="fas fa-sitemap"></i> Danh m·ª•c con (T√πy ch·ªçn)</label>' +
    '<select id="incomeSubcategory" class="form-control">' +
    '<option value="">-- Kh√¥ng ch·ªçn --</option>' +
    '</select>' +
    '<small style="color: #718096; display: block; margin-top: 5px;">N·∫øu kh√¥ng ch·ªçn, ch·ªâ l∆∞u danh m·ª•c ch√≠nh</small>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-money-bill-wave"></i> S·ªë ti·ªÅn (VNƒê) <span style="color: red;">*</span></label>' +
    '<input type="text" id="incomeAmount" name="S·ªë ti·ªÅn" class="form-control currency-input" value="' + 
    (isEdit ? formatCurrency(item['S·ªë ti·ªÅn']) : '0') + '" required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-university"></i> T√†i kho·∫£n nh·∫≠n <span style="color: red;">*</span></label>' +
    '<select id="incomePayment" name="T√†i kho·∫£n" class="form-control" required>' + 
    renderAccountOptions(accountId) + 
    '</select>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-comment"></i> M√¥ t·∫£</label>' +
    '<textarea id="incomeDescription" class="form-control" rows="3" placeholder="Ghi ch√∫ v·ªÅ kho·∫£n thu nh·∫≠p...">' + 
    (item['M√¥ t·∫£'] || '') + '</textarea>' +
    '</div>' +
    
    '</form>';
  
  var footer = 
    '<button type="button" class="btn-secondary" onclick="closeModal()">' +
    '<i class="fas fa-times"></i> H·ªßy' +
    '</button>' +
    '<button type="button" class="btn-primary" onclick="document.getElementById(\'incomeForm\').requestSubmit()">' +
    '<i class="fas fa-save"></i> L∆∞u' +
    '</button>';
  
  openModal(
    isEdit ? '‚úèÔ∏è S·ª≠a thu nh·∫≠p' : '‚ûï Th√™m thu nh·∫≠p', 
    body, 
    footer
  );
  
  // Initialize after modal opens
  setTimeout(function() {
    console.log('üîß Initializing income modal...');
    
    // 1. Load categories from cache (INSTANT)
    const categories = DataManager.getCategories('income');
    console.log('‚úÖ Loaded', categories.length, 'income categories from cache');
    
    var categorySelect = document.getElementById('incomeCategory');
    if (categorySelect) {
      categorySelect.innerHTML = renderCategoryOptions(categories, categoryId);
      
      // If editing and has category, load subcategories
      if (categoryId) {
        loadIncomeSubcategories().then(function() {
          if (subcategoryId) {
            var subcatSelect = document.getElementById('incomeSubcategory');
            if (subcatSelect) {
              subcatSelect.value = subcategoryId;
            }
          }
        });
      }
    }
    
    // 2. Setup currency input
    setupCurrencyInput(document.getElementById('incomeAmount'));
    
    // 3. Enable real-time validation
    const form = document.getElementById('incomeForm');
    if (form) {
      Validator.enableRealTimeValidation(form, 'income');
    }
    
    // 4. Focus first input
    document.getElementById('incomeDate').focus();
    
    console.log('‚úÖ Income modal initialized');
  }, 100);
}

// ========================================
// LOAD INCOME SUBCATEGORIES
// ========================================

function loadIncomeSubcategories() {
  return new Promise(function(resolve, reject) {
    var categorySelect = document.getElementById('incomeCategory');
    var subcategoryWrapper = document.getElementById('incomeSubcategoryWrapper');
    var subcategorySelect = document.getElementById('incomeSubcategory');
    
    if (!categorySelect || !subcategoryWrapper || !subcategorySelect) {
      reject('Elements not found');
      return;
    }
    
    var categoryId = categorySelect.value;
    
    if (!categoryId) {
      subcategoryWrapper.style.display = 'none';
      subcategorySelect.innerHTML = '<option value="">-- Kh√¥ng ch·ªçn --</option>';
      resolve();
      return;
    }
    
    console.log('üì• Loading subcategories for:', categoryId);
    
    subcategorySelect.innerHTML = '<option value="">-- ƒêang t·∫£i... --</option>';
    subcategoryWrapper.style.display = 'block';
    
    // Call backend to get subcategories
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success && response.data.length > 0) {
          console.log('‚úÖ Loaded', response.data.length, 'subcategories');
          subcategorySelect.innerHTML = renderSubcategoryOptions(response.data, '');
          subcategoryWrapper.style.display = 'block';
        } else {
          subcategorySelect.innerHTML = '<option value="">-- Kh√¥ng c√≥ danh m·ª•c con --</option>';
          subcategoryWrapper.style.display = 'block';
        }
        resolve();
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Load subcategories error:', error);
        subcategorySelect.innerHTML = '<option value="">-- L·ªói t·∫£i d·ªØ li·ªáu --</option>';
        reject(error);
      })
      .handleRequest('getSubcategories', { 
        parentId: categoryId,
        userId: currentUser.userId 
      });
  });
}

// ========================================
// SAVE INCOME - WITH VALIDATION & ERROR RECOVERY
// ========================================

async function handleSaveIncome(event, id) {
  event.preventDefault();
  
  console.log('=== SAVING INCOME ===', id ? 'UPDATE' : 'CREATE');
  
  // Clear previous errors
  Validator.clearErrors();
  
  // Collect form data
  var formData = {
    'Ng√†y': document.getElementById('incomeDate').value,
    'Danh m·ª•c': document.getElementById('incomeCategory').value,
    'S·ªë ti·ªÅn': parseCurrency(document.getElementById('incomeAmount').value),
    'T√†i kho·∫£n': document.getElementById('incomePayment').value
  };
  
  var subcategoryId = document.getElementById('incomeSubcategory') ? 
    document.getElementById('incomeSubcategory').value : '';
  var description = document.getElementById('incomeDescription').value;
  
  // Validate
  const validation = Validator.validate(formData, 'income');
  
  if (!validation.valid) {
    console.log('‚ùå Validation failed:', validation.errors);
    Validator.showErrors(validation.errors);
    return;
  }
  
  // Get category details
  var categoryInfo = DataManager.getCategoryById(formData['Danh m·ª•c']);
  var categoryName = categoryInfo ? categoryInfo.name : formData['Danh m·ª•c'];
  
  // Build category data
  var categoryData = {
    id: formData['Danh m·ª•c'],
    name: categoryName
  };
  
  // Add subcategory if selected
  if (subcategoryId) {
    var subcategorySelect = document.getElementById('incomeSubcategory');
    var subcategoryName = '';
    
    if (subcategorySelect) {
      var selectedOption = subcategorySelect.options[subcategorySelect.selectedIndex];
      if (selectedOption) {
        subcategoryName = selectedOption.text.replace('‚îú‚îÄ ', '').trim();
      }
    }
    
    categoryData.subcategory = subcategoryName;
    categoryData.subcategoryId = subcategoryId;
  }
  
  // Build record data
  var recordData = {
    'ID': id || generateId('TN'),
    'Ng√†y': formData['Ng√†y'],
    'Danh m·ª•c thu nh·∫≠p': JSON.stringify([categoryData]),
    'S·ªë ti·ªÅn': formData['S·ªë ti·ªÅn'],
    'M√¥ t·∫£': description,
    'Ph∆∞∆°ng th·ª©c thanh to√°n': JSON.stringify([{
      id: formData['T√†i kho·∫£n'], 
      name: getAccountName(formData['T√†i kho·∫£n'])
    }]),
    'UserID': currentUser.userId,
    'Metadata': JSON.stringify({accountId: formData['T√†i kho·∫£n']})
  };
  
  console.log('üíæ Record data:', recordData);
  
  closeModal();
  showLoading('ƒêang l∆∞u...');
  
  try {
    // Optimistic update
    if (id) {
      DataManager.updateRecord('Thu nh·∫≠p', id, recordData);
    } else {
      DataManager.addRecord('Thu nh·∫≠p', recordData);
    }
    
    // Update UI immediately
    allIncomeData = DataManager.getIncome();
    incomeFilteredData = allIncomeData.slice();
    renderIncomePage();
    
    // Save to server with retry
    var action = id ? 'updateRecord' : 'createRecord';
    var params = id ? 
      {sheetName: 'Thu nh·∫≠p', id: id, data: recordData} : 
      {sheetName: 'Thu nh·∫≠p', data: recordData};
    
    const response = await ErrorHandler.callWithRetry(action, params);
    
    if (response.success) {
      console.log('‚úÖ Server save successful');
      
      // Update account balance
      try {
        await ErrorHandler.callWithRetry('updateAccountBalance', {
          accountId: formData['T√†i kho·∫£n'],
          amount: formData['S·ªë ti·ªÅn'],
          type: 'add'
        });
        
        // Refresh accounts
        const accountsData = await DataManager.refresh('T√†i kho·∫£n');
        allAccountsData = accountsData;
        
        console.log('‚úÖ Account balance updated');
      } catch (balanceError) {
        console.error('‚ö†Ô∏è Balance update failed:', balanceError);
        showToast('L∆∞u th√†nh c√¥ng nh∆∞ng ch∆∞a c·∫≠p nh·∫≠t s·ªë d∆∞', 'warning');
      }
      
      hideLoading();
      showToast('‚úÖ ƒê√£ l∆∞u thu nh·∫≠p!', 'success');
      
    } else {
      throw new Error(response.message || 'Save failed');
    }
    
  } catch (error) {
    console.error('‚ùå Save error:', error);
    
    // Rollback optimistic update
    await DataManager.refresh('Thu nh·∫≠p');
    allIncomeData = DataManager.getIncome();
    incomeFilteredData = allIncomeData.slice();
    renderIncomePage();
    
    hideLoading();
    // Error toast already shown by ErrorHandler
  }
}

function editIncome(id) {
  openIncomeModal(id);
}

function confirmDeleteIncome(id) {
  var body = '<p style="text-align: center; font-size: 16px; margin: 20px 0;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?</p>' +
    '<p style="text-align: center; color: #e94849; font-weight: 500;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-danger" onclick="executeDeleteIncome(\'' + id + '\')">X√≥a</button>';
  
  openModal('X√°c nh·∫≠n x√≥a', body, footer);
}

function executeDeleteIncome(id) {
  closeModal();
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        reloadIncomeData();
      } else {
        hideLoading();
        showToast(response.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('deleteRecord', {sheetName: 'Thu nh·∫≠p', id: id});
}

function reloadIncomeData() {
  showLoading();
  
  Promise.all([
    loadSheetData('Thu nh·∫≠p'),
    loadSheetData('T√†i kho·∫£n')
  ]).then(function(results) {
    allIncomeData = results[0];
    allAccountsData = results[1];
    
    hideLoading();
    renderIncomePage();
    showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
  }).catch(function(error) {
    hideLoading();
    console.error('Reload error:', error);
    showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
  });
}

// Helper function to render account options for select
function renderAccountOptions() {
  var html = '<option value="">-- Ch·ªçn t√†i kho·∫£n --</option>';
  
  if (!allAccountsData || allAccountsData.length === 0) {
    return html;
  }
  
  for (var i = 0; i < allAccountsData.length; i++) {
    var acc = allAccountsData[i];
    html += '<option value="' + acc.AccountID + '">' + 
      acc['T√™n t√†i kho·∫£n'] + ' (' + formatCurrency(acc['S·ªë d∆∞ hi·ªán t·∫°i']) + ' ƒë)</option>';
  }
  
  return html;
}

function reloadIncomeData() {
  showLoading();
  
  Promise.all([
    loadSheetData('Thu nh·∫≠p'),
    loadSheetData('T√†i kho·∫£n')
  ]).then(function(results) {
    allIncomeData = results[0];
    allAccountsData = results[1];
    
    hideLoading();
    renderIncomePage();
    showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi', 'success');
  }).catch(function(error) {
    hideLoading();
    console.error('Reload error:', error);
    showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
  });
}

// ========== EXPENSE PAGE WITH FILTERS & PAGINATION ==========
var expenseCurrentPage = 1;
var expenseItemsPerPage = 10;
var expenseFilteredData = [];
var expenseFilters = {
  fromDate: '',
  toDate: '',
  category: '',
  accountId: ''
};

function showExpensePage() {
  console.log('=== SHOWING EXPENSE PAGE ===');
  
  // Reset v·ªÅ trang 1 khi m·ªü page
  expenseCurrentPage = 1;
  expenseFilteredData = allExpenseData.slice();
  
  renderExpensePage();
}

function renderExpensePage() {
  console.log('=== RENDERING EXPENSE PAGE (CACHED) ===');
  
  // Use cached data
  if (!incomeFilteredData.length) {
    incomeFilteredData = DataManager.getIncome();
  }
  
  // Apply filters
  applyExpenseFilters();
  
  console.log('expenseFilteredData (after filter):', expenseFilteredData.length, 'records');
  
  var totalRecords = expenseFilteredData.length;
  var totalPages = Math.ceil(totalRecords / expenseItemsPerPage);
  
  if (expenseCurrentPage > totalPages && totalPages > 0) {
    expenseCurrentPage = totalPages;
  }
  
  if (expenseCurrentPage < 1) {
    expenseCurrentPage = 1;
  }
  
  var html = '<div class="card">' +
    '<div class="card-header">' +
    '<h2 class="card-title">Danh s√°ch Chi ti√™u</h2>' +
    '<div style="display: flex; gap: 10px;">' +
    '<button class="btn-secondary" onclick="downloadExpenseTemplate()"><i class="fas fa-download"></i> T·∫£i m·∫´u Excel</button>' +
    '<button class="btn-secondary" onclick="openExpenseImportModal()"><i class="fas fa-file-import"></i> Import Excel</button>' +
    '<button class="btn-primary" onclick="openExpenseModal()"><i class="fas fa-plus"></i> Th√™m chi ti√™u</button>' +
    '</div>' +
    '</div>' +
    
    // FILTER PANEL
    '<div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">T·ª´ ng√†y</label>' +
    '<input type="date" id="expenseFilterFromDate" class="form-control" value="' + expenseFilters.fromDate + '" onchange="renderExpensePage()"></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">ƒê·∫øn ng√†y</label>' +
    '<input type="date" id="expenseFilterToDate" class="form-control" value="' + expenseFilters.toDate + '" onchange="renderExpensePage()"></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">Danh m·ª•c</label>' +
    '<select id="expenseFilterCategory" class="form-control" onchange="renderExpensePage()"><option value="">T·∫•t c·∫£</option>' +
    '<option value="food">ƒÇn u·ªëng</option><option value="transport">Di chuy·ªÉn</option>' +
    '<option value="shopping">Mua s·∫Øm</option><option value="education">H·ªçc t·∫≠p</option>' +
    '<option value="health">Y t·∫ø</option><option value="entertainment">Gi·∫£i tr√≠</option><option value="other">Kh√°c</option></select></div>' +
    '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">T√†i kho·∫£n</label>' +
    '<select id="expenseFilterAccount" class="form-control" onchange="renderExpensePage()"><option value="">T·∫•t c·∫£</option>' + 
    renderAccountOptionsForFilter() + '</select></div>' +
    '<div style="display: flex; align-items: flex-end;"><button class="btn-secondary" onclick="clearExpenseFilters()" style="width: 100%;">X√≥a b·ªô l·ªçc</button></div>' +
    '</div></div>' +
    
    '<div style="margin-bottom: 10px; color: #718096; display: flex; justify-content: space-between; align-items: center;">' +
    '<span>Hi·ªÉn th·ªã ' + ((expenseCurrentPage - 1) * expenseItemsPerPage + 1) + ' - ' + 
    Math.min(expenseCurrentPage * expenseItemsPerPage, totalRecords) + ' trong t·ªïng s·ªë ' + totalRecords + ' b·∫£n ghi</span>' +
    '<div style="display: flex; gap: 10px; align-items: center;">' +
    '<label style="margin: 0;">Hi·ªÉn th·ªã:</label>' +
    '<select onchange="changeExpenseItemsPerPage(this.value)" class="form-control" style="width: auto; padding: 5px 10px;">' +
    '<option value="5"' + (expenseItemsPerPage === 5 ? ' selected' : '') + '>5</option>' +
    '<option value="10"' + (expenseItemsPerPage === 10 ? ' selected' : '') + '>10</option>' +
    '<option value="20"' + (expenseItemsPerPage === 20 ? ' selected' : '') + '>20</option>' +
    '<option value="50"' + (expenseItemsPerPage === 50 ? ' selected' : '') + '>50</option>' +
    '</select>' +
    '</div></div>' +
    
    '<div style="overflow: auto; max-height: calc(100vh - 400px); position: relative;">' +
    '<table>' +
    '<thead>' +
    '<tr>' +
    '<th class="sticky-column">Ng√†y</th>' +
    '<th>Danh m·ª•c</th>' +
    '<th>S·ªë ti·ªÅn</th>' +
    '<th>M√¥ t·∫£</th>' +
    '<th>T√†i kho·∫£n</th>' +
    '<th>H√†nh ƒë·ªông</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody>' + renderExpenseTableWithPagination() + '</tbody>' +
    '</table></div>' +
    
    // PAGINATION
    renderExpensePagination(totalPages) +
    
    '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
  
  // Restore filter values
  var fromDateEl = document.getElementById('expenseFilterFromDate');
  var toDateEl = document.getElementById('expenseFilterToDate');
  var categoryEl = document.getElementById('expenseFilterCategory');
  var accountEl = document.getElementById('expenseFilterAccount');
  
  if (fromDateEl) fromDateEl.value = expenseFilters.fromDate;
  if (toDateEl) toDateEl.value = expenseFilters.toDate;
  if (categoryEl) categoryEl.value = expenseFilters.category;
  if (accountEl) accountEl.value = expenseFilters.accountId;
}

function applyExpenseFilters() {
  // ƒê·ªçc gi√° tr·ªã filter t·ª´ input
  var fromDateEl = document.getElementById('expenseFilterFromDate');
  var toDateEl = document.getElementById('expenseFilterToDate');
  var categoryEl = document.getElementById('expenseFilterCategory');
  var accountEl = document.getElementById('expenseFilterAccount');
  
  if (fromDateEl) expenseFilters.fromDate = fromDateEl.value;
  if (toDateEl) expenseFilters.toDate = toDateEl.value;
  if (categoryEl) expenseFilters.category = categoryEl.value;
  if (accountEl) expenseFilters.accountId = accountEl.value;
  
  // Filter data
  expenseFilteredData = [];
  
  for (var i = 0; i < allExpenseData.length; i++) {
    var item = allExpenseData[i];
    var itemDate = item['Ng√†y'];
    
    // Filter by date range
    if (expenseFilters.fromDate && itemDate < expenseFilters.fromDate) continue;
    if (expenseFilters.toDate && itemDate > expenseFilters.toDate) continue;
    
    // Filter by category
    if (expenseFilters.category) {
      try {
        var cat = typeof item['Danh m·ª•c chi ti√™u'] === 'string' ? 
          JSON.parse(item['Danh m·ª•c chi ti√™u']) : item['Danh m·ª•c chi ti√™u'];
        if (!cat || !cat[0] || cat[0].id !== expenseFilters.category) continue;
      } catch(e) {
        continue;
      }
    }
    
    // Filter by account
    if (expenseFilters.accountId) {
      try {
        var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
        if (!meta || meta.accountId !== expenseFilters.accountId) continue;
      } catch(e) {
        continue;
      }
    }
    
    expenseFilteredData.push(item);
  }
}

function clearExpenseFilters() {
  console.log('=== CLEARING EXPENSE FILTERS ===');
  
  // Reset filter values
  expenseFilters = { 
    fromDate: '', 
    toDate: '', 
    category: '', 
    accountId: '' 
  };
  
  // Reset to page 1
  expenseCurrentPage = 1;
  
  // Reset filtered data to all data
  expenseFilteredData = allExpenseData.slice();
  
  console.log('Filters cleared, rendering page...');
  
  // Re-render page
  renderExpensePage();
  
  // Force clear input values after render
  setTimeout(function() {
    var fromDateEl = document.getElementById('expenseFilterFromDate');
    var toDateEl = document.getElementById('expenseFilterToDate');
    var categoryEl = document.getElementById('expenseFilterCategory');
    var accountEl = document.getElementById('expenseFilterAccount');
    
    if (fromDateEl) fromDateEl.value = '';
    if (toDateEl) toDateEl.value = '';
    if (categoryEl) categoryEl.value = '';
    if (accountEl) accountEl.value = '';
    
    console.log('Input values cleared');
  }, 100);
}

function changeExpenseItemsPerPage(value) {
  expenseItemsPerPage = parseInt(value);
  expenseCurrentPage = 1;
  renderExpensePage();
}

function saveExpense() {
  var id = document.getElementById('expenseId').value;
  var date = document.getElementById('expenseDate').value;
  var mainCategoryEl = document.getElementById('expenseMainCategory');
  var subcategoryEl = document.getElementById('expenseSubcategory');
  var amount = parseCurrency(document.getElementById('expenseAmount').value);
  var description = document.getElementById('expenseDescription').value;
  var accountId = document.getElementById('expenseAccount').value;
  
  // Validation
  if (!date || !mainCategoryEl.value || !amount || !accountId) {
    showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'error');
    return;
  }
  
  if (amount <= 0) {
    showToast('S·ªë ti·ªÅn ph·∫£i l·ªõn h∆°n 0', 'error');
    return;
  }
  
  showLoading();
  closeModal();
  
  // Get category info
  var mainCategoryId = mainCategoryEl.value;
  var mainCategoryName = mainCategoryEl.options[mainCategoryEl.selectedIndex].text.replace(/[^\w\s]/gi, '').trim();
  
  var subcategoryName = '';
  if (subcategoryEl && subcategoryEl.value) {
    subcategoryName = subcategoryEl.options[subcategoryEl.selectedIndex].text.replace('‚îú‚îÄ ', '').trim();
  }
  
  var categoryData = [{
    id: mainCategoryId,
    name: mainCategoryName,
    subcategory: subcategoryName
  }];
  
  // Get account name
  var accountName = '';
  for (var i = 0; i < allAccountsData.length; i++) {
    if (allAccountsData[i].AccountID === accountId) {
      accountName = allAccountsData[i]['T√™n t√†i kho·∫£n'];
      break;
    }
  }
  
  var recordData = {
    'ID': id || generateId('CT'),
    'Ng√†y': date,
    'Danh m·ª•c chi ti√™u': JSON.stringify(categoryData),
    'S·ªë ti·ªÅn': amount,
    'M√¥ t·∫£': description,
    'Ph∆∞∆°ng th·ª©c thanh to√°n': JSON.stringify([{
      id: accountId,
      name: accountName
    }]),
    'UserID': currentUser.userId,
    'Metadata': JSON.stringify({
      accountId: accountId,
      mainCategoryId: mainCategoryId,
      subcategoryId: subcategoryEl ? subcategoryEl.value : ''
    })
  };
  
  var action = id ? 'updateRecord' : 'createRecord';
  var params = id ? 
    {sheetName: 'Chi ti√™u', id: id, data: recordData} : 
    {sheetName: 'Chi ti√™u', data: recordData};
  
  console.log('Saving expense:', action, params);
  
  google.script.run
    .withSuccessHandler(function(response) {
      hideLoading();
      
      if (response.success) {
        showToast(id ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng' : 'Th√™m chi ti√™u th√†nh c√¥ng', 'success');
        
        // Update budget for this month
        var month = date.substring(0, 7);
        console.log('Triggering budget update for month:', month);
        
        // Silent budget update
        google.script.run
          .withSuccessHandler(function(budgetResponse) {
            console.log('Budget updated:', budgetResponse);
          })
          .withFailureHandler(function(error) {
            console.error('Budget update error:', error);
          })
          .handleRequest('updateAllBudgets', { month: month });
        
        // Update account balance if new expense
        if (!id) {
          google.script.run
            .withSuccessHandler(function() {
              console.log('Account balance updated');
            })
            .handleRequest('updateAccountBalance', {
              accountId: accountId,
              amount: amount,
              type: 'subtract'
            });
        }
        
        // Reload data
        reloadExpenseData();
        
      } else {
        showToast(response.message || 'L·ªói khi l∆∞u', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      console.error('Save error:', error);
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest(action, params);
}

function renderExpenseTableWithPagination() {
  if (!expenseFilteredData || expenseFilteredData.length === 0) {
    return '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
  }
  
  var startIndex = (expenseCurrentPage - 1) * expenseItemsPerPage;
  var endIndex = Math.min(startIndex + expenseItemsPerPage, expenseFilteredData.length);
  
  var html = '';
  
  for (var i = startIndex; i < endIndex; i++) {
    var item = expenseFilteredData[i];
    var id = item.ID || 'N/A';
    var accountId = '';
    
    try {
      var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
      accountId = meta.accountId || '';
    } catch(e) {}
    
    var categoryDisplay = formatCategoryDisplay(item['Danh m·ª•c chi ti√™u']);
    
    html += '<tr>' +
      '<td class="sticky-column">' + formatDate(item['Ng√†y']) + '</td>' +
      '<td>' + categoryDisplay + '</td>' +
      '<td style="color: #e94849; font-weight: 600;">' + formatCurrency(item['S·ªë ti·ªÅn']) + ' ƒë</td>' +
      '<td>' + (item['M√¥ t·∫£'] || '-') + '</td>' +
      '<td>' + getAccountName(accountId) + '</td>' +
      '<td class="action-buttons">' +
      '<button class="btn-primary btn-sm" onclick="editExpense(\'' + id + '\')"><i class="fas fa-edit"></i></button>' +
      '<button class="btn-danger btn-sm" onclick="confirmDeleteExpense(\'' + id + '\')"><i class="fas fa-trash"></i></button>' +
      '</td></tr>';
  }
  
  return html;
}

function renderExpensePagination(totalPages) {
  if (totalPages <= 1) return '';
  
  var html = '<div style="display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px;">';
  
  // Previous button
  html += '<button class="btn-secondary btn-sm" onclick="expenseGoToPage(' + (expenseCurrentPage - 1) + ')" ' + 
    (expenseCurrentPage === 1 ? 'disabled' : '') + '><i class="fas fa-chevron-left"></i></button>';
  
  // Page numbers
  var startPage = Math.max(1, expenseCurrentPage - 2);
  var endPage = Math.min(totalPages, expenseCurrentPage + 2);
  
  if (startPage > 1) {
    html += '<button class="btn-secondary btn-sm" onclick="expenseGoToPage(1)">1</button>';
    if (startPage > 2) html += '<span>...</span>';
  }
  
  for (var i = startPage; i <= endPage; i++) {
    if (i === expenseCurrentPage) {
      html += '<button class="btn-primary btn-sm" disabled>' + i + '</button>';
    } else {
      html += '<button class="btn-secondary btn-sm" onclick="expenseGoToPage(' + i + ')">' + i + '</button>';
    }
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span>...</span>';
    html += '<button class="btn-secondary btn-sm" onclick="expenseGoToPage(' + totalPages + ')">' + totalPages + '</button>';
  }
  
  // Next button
  html += '<button class="btn-secondary btn-sm" onclick="expenseGoToPage(' + (expenseCurrentPage + 1) + ')" ' + 
    (expenseCurrentPage === totalPages ? 'disabled' : '') + '><i class="fas fa-chevron-right"></i></button>';
  
  html += '</div>';
  
  return html;
}

function expenseGoToPage(page) {
  expenseCurrentPage = page;
  renderExpensePage();
  window.scrollTo(0, 0);
}

// DOWNLOAD EXCEL TEMPLATE
function downloadExpenseTemplate() {
  // T·∫°o workbook m·ªõi
  var wb = XLSX.utils.book_new();
  
  // T·∫°o data v·ªõi format ƒë·∫πp
  var wsData = [
    ['Ng√†y', 'Danh m·ª•c', 'S·ªë ti·ªÅn', 'M√¥ t·∫£', 'T√†i kho·∫£n'],
    ['2025-10-20', 'food', 150000, 'ƒÇn tr∆∞a', 'ACC001'],
    ['2025-10-21', 'transport', 50000, 'XƒÉng xe', 'ACC002']
  ];
  
  // T·∫°o worksheet
  var ws = XLSX.utils.aoa_to_sheet(wsData);
  
  // Set column widths
  ws['!cols'] = [
    { wch: 12 },  // Ng√†y
    { wch: 15 },  // Danh m·ª•c
    { wch: 15 },  // S·ªë ti·ªÅn
    { wch: 30 },  // M√¥ t·∫£
    { wch: 12 }   // T√†i kho·∫£n
  ];
  
  // Add worksheet to workbook
  XLSX.utils.book_append_sheet(wb, ws, 'Expense_Template');
  
  // T·∫°o file Excel
  var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  var blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  
  // Download file
  var link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'Expense_Template.xlsx';
  link.click();
  
  showToast('ƒê√£ t·∫£i xu·ªëng file m·∫´u Excel', 'success');
}

// IMPORT EXCEL MODAL
function openExpenseImportModal() {
  var body = '<div class="form-group">' +
    '<label>Ch·ªçn file Excel/CSV</label>' +
    '<input type="file" id="expenseImportFile" accept=".xlsx,.xls,.csv" class="form-control">' +
    '<small style="color: #718096; margin-top: 5px; display: block;">ƒê·ªãnh d·∫°ng: XLSX, XLS, CSV</small>' +
    '<small style="color: #718096; margin-top: 5px; display: block;">C·∫•u tr√∫c: Ng√†y | Danh m·ª•c | S·ªë ti·ªÅn | M√¥ t·∫£ | T√†i kho·∫£n</small>' +
    '<div style="margin-top: 10px; padding: 10px; background: #fffbeb; border-left: 3px solid #f59e0b; border-radius: 4px;">' +
    '<strong>L∆∞u √Ω:</strong><br>' +
    '<ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">' +
    '<li>Ng√†y: ƒê·ªãnh d·∫°ng YYYY-MM-DD (VD: 2025-10-20)</li>' +
    '<li>Danh m·ª•c: food, transport, shopping, education, health, entertainment, other</li>' +
    '<li>S·ªë ti·ªÅn: S·ªë nguy√™n (VD: 150000)</li>' +
    '<li>T√†i kho·∫£n: M√£ t√†i kho·∫£n (VD: ACC001)</li>' +
    '</ul>' +
    '</div>' +
    '</div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-primary" onclick="processExpenseImport()">Import</button>';
  
  openModal('Import d·ªØ li·ªáu Chi ti√™u', body, footer);
}

// PROCESS IMPORT EXCEL
function processExpenseImport() {
  var fileInput = document.getElementById('expenseImportFile');
  
  if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
    showToast('Vui l√≤ng ch·ªçn file', 'error');
    return;
  }
  
  var file = fileInput.files[0];
  var reader = new FileReader();
  
  closeModal();
  showLoading();
  
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, { type: 'array' });
      var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      var jsonData = XLSX.utils.sheet_to_json(firstSheet);
      
      console.log('Imported expense data:', jsonData);
      
      if (jsonData.length === 0) {
        hideLoading();
        showToast('File kh√¥ng c√≥ d·ªØ li·ªáu', 'error');
        return;
      }
      
      // X·ª≠ l√Ω t·ª´ng d√≤ng tu·∫ßn t·ª±
      var successCount = 0;
      var errorCount = 0;
      
      function processRow(index) {
        if (index >= jsonData.length) {
          // Ho√†n th√†nh
          console.log('=== IMPORT COMPLETED ===');
          console.log('Success:', successCount, 'Error:', errorCount);
          
          hideLoading();
          
          if (successCount > 0) {
            showToast('Import th√†nh c√¥ng ' + successCount + ' / ' + jsonData.length + ' b·∫£n ghi', 'success');
            
            // Reload data with delay ƒë·ªÉ ƒë·∫£m b·∫£o Sheet ƒë√£ update
            console.log('Reloading expense data in 1 second...');
            setTimeout(function() {
              Promise.all([
                loadSheetData('Chi ti√™u'),
                loadSheetData('T√†i kho·∫£n')
              ]).then(function(results) {
                allExpenseData = results[0];
                allAccountsData = results[1];
                expenseFilteredData = allExpenseData.slice(); // Reset filter
                expenseCurrentPage = 1; // Reset v·ªÅ trang 1
                
                console.log('Expense data reloaded:', allExpenseData.length, 'records');
                
                renderExpensePage();
              }).catch(function(error) {
                console.error('Error reloading expense data:', error);
                showToast('L·ªói t·∫£i l·∫°i d·ªØ li·ªáu', 'error');
              });
            }, 1500); // Delay 1.5 gi√¢y
          } else {
            showToast('Kh√¥ng c√≥ b·∫£n ghi n√†o ƒë∆∞·ª£c import', 'error');
          }
          
          if (errorCount > 0) {
            showToast('C√≥ ' + errorCount + ' l·ªói', 'error');
          }
          
          return;
        }
        
        var row = jsonData[index];
        
        console.log('Processing expense row ' + (index + 1) + ':', row);
        
        // Validate
        if (!row['Ng√†y'] || !row['Danh m·ª•c'] || !row['S·ªë ti·ªÅn'] || !row['T√†i kho·∫£n']) {
          console.error('Row ' + (index + 1) + ': Missing required fields');
          errorCount++;
          processRow(index + 1);
          return;
        }
        
        // Parse date
        var dateValue = row['Ng√†y'];
        var formattedDate = '';
        
        if (typeof dateValue === 'number') {
          var excelDate = XLSX.SSF.parse_date_code(dateValue);
          formattedDate = excelDate.y + '-' + 
            String(excelDate.m).padStart(2, '0') + '-' + 
            String(excelDate.d).padStart(2, '0');
        } else if (typeof dateValue === 'string') {
          formattedDate = dateValue;
        } else {
          console.error('Row ' + (index + 1) + ': Invalid date format');
          errorCount++;
          processRow(index + 1);
          return;
        }
        
        var accountId = row['T√†i kho·∫£n'];
        var amount = parseFloat(row['S·ªë ti·ªÅn']);
        
        // Create record
        var recordData = {
          'ID': generateId('CT'),
          'Ng√†y': formattedDate,
          'Danh m·ª•c chi ti√™u': JSON.stringify([{
            id: row['Danh m·ª•c'], 
            name: getCategoryLabel(row['Danh m·ª•c'])
          }]),
          'S·ªë ti·ªÅn': amount,
          'M√¥ t·∫£': row['M√¥ t·∫£'] || '',
          'Ph∆∞∆°ng th·ª©c thanh to√°n': JSON.stringify([{
            id: accountId, 
            name: getAccountName(accountId)
          }]),
          'UserID': currentUser.userId,
          'Metadata': JSON.stringify({accountId: accountId})
        };
        
        console.log('Creating expense record:', recordData);
        
        // Create record in Sheet
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              console.log('Expense row ' + (index + 1) + ' created successfully');
              
              // Update account balance (SUBTRACT)
              google.script.run
                .withSuccessHandler(function(balanceResponse) {
                  console.log('Balance updated for expense row ' + (index + 1));
                  successCount++;
                  processRow(index + 1);
                })
                .withFailureHandler(function(error) {
                  console.error('Balance update failed for expense row ' + (index + 1) + ':', error);
                  successCount++; // V·∫´n t√≠nh l√† th√†nh c√¥ng
                  processRow(index + 1);
                })
                .handleRequest('updateAccountBalance', {
                  accountId: accountId,
                  amount: amount,
                  type: 'subtract'
                });
            } else {
              console.error('Expense row ' + (index + 1) + ' failed:', response.message);
              errorCount++;
              processRow(index + 1);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Expense row ' + (index + 1) + ' error:', error);
            errorCount++;
            processRow(index + 1);
          })
          .handleRequest('createRecord', {
            sheetName: 'Chi ti√™u',
            data: recordData
          });
        
      }
      
      // B·∫Øt ƒë·∫ßu x·ª≠ l√Ω t·ª´ row 0
      processRow(0);
      
    } catch (error) {
      hideLoading();
      showToast('L·ªói ƒë·ªçc file: ' + error.message, 'error');
      console.error('Import error:', error);
    }
  };
  
  reader.onerror = function() {
    hideLoading();
    showToast('L·ªói ƒë·ªçc file', 'error');
  };
  
  reader.readAsArrayBuffer(file);
}

// ========================================
// EXPENSE MODAL - OPTIMIZED VERSION
// ========================================

function openExpenseModal(id) {
  console.log('=== OPENING EXPENSE MODAL ===', id ? 'EDIT' : 'CREATE');
  
  var isEdit = !!id;
  var item = {};
  
  if (isEdit) {
    const expenseList = DataManager.getExpense();
    item = expenseList.find(i => i.ID === id) || {};
    
    if (!item.ID) {
      showToast('Kh√¥ng t√¨m th·∫•y b·∫£n ghi', 'error');
      return;
    }
  }
  
  // Parse existing data
  var accountId = '';
  var categoryId = '';
  var subcategoryId = '';
  
  if (isEdit && item.Metadata) {
    try {
      var meta = typeof item.Metadata === 'string' ? JSON.parse(item.Metadata) : item.Metadata;
      accountId = meta.accountId || '';
    } catch(e) {
      console.error('Parse metadata error:', e);
    }
  }
  
  if (isEdit && item['Danh m·ª•c chi ti√™u']) {
    try {
      var cat = typeof item['Danh m·ª•c chi ti√™u'] === 'string' ? 
        JSON.parse(item['Danh m·ª•c chi ti√™u']) : item['Danh m·ª•c chi ti√™u'];
      if (cat && cat[0]) {
        categoryId = cat[0].id || '';
        subcategoryId = cat[0].subcategoryId || '';
      }
    } catch(e) {
      console.error('Parse category error:', e);
    }
  }
  
  // Build modal HTML
  var body = 
    '<form id="expenseForm" onsubmit="handleSaveExpense(event, \'' + (id || '') + '\')">' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-calendar"></i> Ng√†y <span style="color: red;">*</span></label>' +
    '<input type="date" id="expenseDate" name="Ng√†y" class="form-control" value="' + 
    (item['Ng√†y'] || new Date().toISOString().split('T')[0]) + '" required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-tag"></i> Danh m·ª•c ch√≠nh <span style="color: red;">*</span></label>' +
    '<select id="expenseCategory" name="Danh m·ª•c" class="form-control" onchange="loadExpenseSubcategories()" required>' +
    '<option value="">-- Loading categories... --</option>' +
    '</select>' +
    '</div>' +
    
    '<div class="form-group" id="expenseSubcategoryWrapper" style="display: none;">' +
    '<label><i class="fas fa-sitemap"></i> Danh m·ª•c con (T√πy ch·ªçn)</label>' +
    '<select id="expenseSubcategory" class="form-control">' +
    '<option value="">-- Kh√¥ng ch·ªçn --</option>' +
    '</select>' +
    '<small style="color: #718096; display: block; margin-top: 5px;">N·∫øu kh√¥ng ch·ªçn, ch·ªâ l∆∞u danh m·ª•c ch√≠nh</small>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-money-bill-wave"></i> S·ªë ti·ªÅn (VNƒê) <span style="color: red;">*</span></label>' +
    '<input type="text" id="expenseAmount" name="S·ªë ti·ªÅn" class="form-control currency-input" value="' + 
    (isEdit ? formatCurrency(item['S·ªë ti·ªÅn']) : '0') + '" required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-university"></i> T√†i kho·∫£n thanh to√°n <span style="color: red;">*</span></label>' +
    '<select id="expensePayment" name="T√†i kho·∫£n" class="form-control" required>' + 
    renderAccountOptions(accountId) + 
    '</select>' +
    '<small id="accountBalanceHint" style="color: #718096; display: block; margin-top: 5px;"></small>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-comment"></i> M√¥ t·∫£</label>' +
    '<textarea id="expenseDescription" class="form-control" rows="3" placeholder="Ghi ch√∫ v·ªÅ kho·∫£n chi...">' + 
    (item['M√¥ t·∫£'] || '') + '</textarea>' +
    '</div>' +
    
    '</form>';
  
  var footer = 
    '<button type="button" class="btn-secondary" onclick="closeModal()">' +
    '<i class="fas fa-times"></i> H·ªßy' +
    '</button>' +
    '<button type="button" class="btn-primary" onclick="document.getElementById(\'expenseForm\').requestSubmit()">' +
    '<i class="fas fa-save"></i> L∆∞u' +
    '</button>';
  
  openModal(
    isEdit ? '‚úèÔ∏è S·ª≠a chi ti√™u' : '‚ûï Th√™m chi ti√™u', 
    body, 
    footer
  );
  
  // Initialize after modal opens
  setTimeout(function() {
    console.log('üîß Initializing expense modal...');
    
    // 1. Load categories from cache (INSTANT)
    const categories = DataManager.getCategories('expense');
    console.log('‚úÖ Loaded', categories.length, 'expense categories from cache');
    
    var categorySelect = document.getElementById('expenseCategory');
    if (categorySelect) {
      categorySelect.innerHTML = renderCategoryOptions(categories, categoryId);
      
      if (categoryId) {
        loadExpenseSubcategories().then(function() {
          if (subcategoryId) {
            var subcatSelect = document.getElementById('expenseSubcategory');
            if (subcatSelect) {
              subcatSelect.value = subcategoryId;
            }
          }
        });
      }
    }
    
    // 2. Setup currency input
    setupCurrencyInput(document.getElementById('expenseAmount'));
    
    // 3. Enable real-time validation
    const form = document.getElementById('expenseForm');
    if (form) {
      Validator.enableRealTimeValidation(form, 'expense');
    }
    
    // 4. Show account balance hint
    updateAccountBalanceHint();
    
    // 5. Listen to account change
    var accountSelect = document.getElementById('expensePayment');
    if (accountSelect) {
      accountSelect.addEventListener('change', updateAccountBalanceHint);
    }
    
    // 6. Focus first input
    document.getElementById('expenseDate').focus();
    
    console.log('‚úÖ Expense modal initialized');
  }, 100);
}


// ========================================
// LOAD EXPENSE SUBCATEGORIES
// ========================================

function loadExpenseSubcategories() {
  return new Promise(function(resolve, reject) {
    var categorySelect = document.getElementById('expenseCategory');
    var subcategoryWrapper = document.getElementById('expenseSubcategoryWrapper');
    var subcategorySelect = document.getElementById('expenseSubcategory');
    
    if (!categorySelect || !subcategoryWrapper || !subcategorySelect) {
      reject('Elements not found');
      return;
    }
    
    var categoryId = categorySelect.value;
    
    if (!categoryId) {
      subcategoryWrapper.style.display = 'none';
      subcategorySelect.innerHTML = '<option value="">-- Kh√¥ng ch·ªçn --</option>';
      resolve();
      return;
    }
    
    console.log('üì• Loading subcategories for:', categoryId);
    
    subcategorySelect.innerHTML = '<option value="">-- ƒêang t·∫£i... --</option>';
    subcategoryWrapper.style.display = 'block';
    
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success && response.data.length > 0) {
          console.log('‚úÖ Loaded', response.data.length, 'subcategories');
          subcategorySelect.innerHTML = renderSubcategoryOptions(response.data, '');
          subcategoryWrapper.style.display = 'block';
        } else {
          subcategorySelect.innerHTML = '<option value="">-- Kh√¥ng c√≥ danh m·ª•c con --</option>';
          subcategoryWrapper.style.display = 'block';
        }
        resolve();
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Load subcategories error:', error);
        subcategorySelect.innerHTML = '<option value="">-- L·ªói t·∫£i d·ªØ li·ªáu --</option>';
        reject(error);
      })
      .handleRequest('getSubcategories', { 
        parentId: categoryId,
        userId: currentUser.userId 
      });
  });
}

// ========================================
// UPDATE ACCOUNT BALANCE HINT
// ========================================

function updateAccountBalanceHint() {
  var accountSelect = document.getElementById('expensePayment');
  var hint = document.getElementById('accountBalanceHint');
  
  if (!accountSelect || !hint) return;
  
  var accountId = accountSelect.value;
  if (!accountId) {
    hint.textContent = '';
    return;
  }
  
  const accounts = DataManager.getAccounts();
  const account = accounts.find(a => a.AccountID === accountId);
  
  if (account) {
    const balance = parseCurrency(account['S·ªë d∆∞ hi·ªán t·∫°i']);
    hint.innerHTML = '<i class="fas fa-info-circle"></i> S·ªë d∆∞: <strong>' + 
      formatCurrency(balance) + ' ƒë</strong>';
    
    if (balance <= 0) {
      hint.style.color = '#e94849';
    } else {
      hint.style.color = '#718096';
    }
  }
}


// ========================================
// SAVE EXPENSE - WITH VALIDATION & ERROR RECOVERY
// ========================================

async function handleSaveExpense(event, id) {
  event.preventDefault();
  
  console.log('=== SAVING EXPENSE ===', id ? 'UPDATE' : 'CREATE');
  
  Validator.clearErrors();
  
  // Collect form data
  var formData = {
    'Ng√†y': document.getElementById('expenseDate').value,
    'Danh m·ª•c': document.getElementById('expenseCategory').value,
    'S·ªë ti·ªÅn': parseCurrency(document.getElementById('expenseAmount').value),
    'T√†i kho·∫£n': document.getElementById('expensePayment').value
  };
  
  var subcategoryId = document.getElementById('expenseSubcategory') ? 
    document.getElementById('expenseSubcategory').value : '';
  var description = document.getElementById('expenseDescription').value;
  
  // Validate
  const validation = Validator.validate(formData, 'expense');
  
  if (!validation.valid) {
    console.log('‚ùå Validation failed:', validation.errors);
    Validator.showErrors(validation.errors);
    return;
  }
  
  // Check account balance
  const balanceCheck = Validator.rules.accountBalance(formData['S·ªë ti·ªÅn'], formData['T√†i kho·∫£n']);
  if (balanceCheck) {
    Validator.showErrors({ 'S·ªë ti·ªÅn': balanceCheck });
    return;
  }
  
  // Get category details
  var categoryInfo = DataManager.getCategoryById(formData['Danh m·ª•c']);
  var categoryName = categoryInfo ? categoryInfo.name : formData['Danh m·ª•c'];
  
  // Build category data
  var categoryData = {
    id: formData['Danh m·ª•c'],
    name: categoryName
  };
  
  if (subcategoryId) {
    var subcategorySelect = document.getElementById('expenseSubcategory');
    var subcategoryName = '';
    
    if (subcategorySelect) {
      var selectedOption = subcategorySelect.options[subcategorySelect.selectedIndex];
      if (selectedOption) {
        subcategoryName = selectedOption.text.replace('‚îú‚îÄ ', '').trim();
      }
    }
    
    categoryData.subcategory = subcategoryName;
    categoryData.subcategoryId = subcategoryId;
  }
  
  // Build record data
  var recordData = {
    'ID': id || generateId('CT'),
    'Ng√†y': formData['Ng√†y'],
    'Danh m·ª•c chi ti√™u': JSON.stringify([categoryData]),
    'S·ªë ti·ªÅn': formData['S·ªë ti·ªÅn'],
    'M√¥ t·∫£': description,
    'Ph∆∞∆°ng th·ª©c thanh to√°n': JSON.stringify([{
      id: formData['T√†i kho·∫£n'], 
      name: getAccountName(formData['T√†i kho·∫£n'])
    }]),
    'UserID': currentUser.userId,
    'Metadata': JSON.stringify({accountId: formData['T√†i kho·∫£n']})
  };
  
  console.log('üíæ Record data:', recordData);
  
  closeModal();
  showLoading('ƒêang l∆∞u...');
  
  try {
    // Optimistic update
    if (id) {
      DataManager.updateRecord('Chi ti√™u', id, recordData);
    } else {
      DataManager.addRecord('Chi ti√™u', recordData);
    }
    
    // Update UI immediately
    allExpenseData = DataManager.getExpense();
    expenseFilteredData = allExpenseData.slice();
    renderExpensePage();
    
    // Save to server with retry
    var action = id ? 'updateRecord' : 'createRecord';
    var params = id ? 
      {sheetName: 'Chi ti√™u', id: id, data: recordData} : 
      {sheetName: 'Chi ti√™u', data: recordData};
    
    const response = await ErrorHandler.callWithRetry(action, params);
    
    if (response.success) {
      console.log('‚úÖ Server save successful');
      
      // Update account balance
      try {
        await ErrorHandler.callWithRetry('updateAccountBalance', {
          accountId: formData['T√†i kho·∫£n'],
          amount: formData['S·ªë ti·ªÅn'],
          type: 'subtract'
        });
        
        // Refresh accounts
        const accountsData = await DataManager.refresh('T√†i kho·∫£n');
        allAccountsData = accountsData;
        
        console.log('‚úÖ Account balance updated');
      } catch (balanceError) {
        console.error('‚ö†Ô∏è Balance update failed:', balanceError);
      }
      
      hideLoading();
      showToast('‚úÖ ƒê√£ l∆∞u chi ti√™u v√† c·∫≠p nh·∫≠t ng√¢n s√°ch!', 'success');
      
    } else {
      throw new Error(response.message || 'Save failed');
    }
    
  } catch (error) {
    console.error('‚ùå Save error:', error);
    
    // Rollback
    await DataManager.refresh('Chi ti√™u');
    allExpenseData = DataManager.getExpense();
    expenseFilteredData = allExpenseData.slice();
    renderExpensePage();
    
    hideLoading();
  }
}

function editExpense(id) {
  openExpenseModal(id);
}

function confirmDeleteExpense(id) {
  var body = '<p style="text-align: center; font-size: 16px; margin: 20px 0;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?</p>' +
    '<p style="text-align: center; color: #e94849; font-weight: 500;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-danger" onclick="executeDeleteExpense(\'' + id + '\')">X√≥a</button>';
  
  openModal('X√°c nh·∫≠n x√≥a', body, footer);
}

function executeDeleteExpense(id) {
  closeModal();
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        reloadExpenseData();
      } else {
        hideLoading();
        showToast(response.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('deleteRecord', {sheetName: 'Chi ti√™u', id: id});
}

function reloadExpenseData() {
  showLoading();
  
  Promise.all([
    loadSheetData('Chi ti√™u'),
    loadSheetData('T√†i kho·∫£n')
  ]).then(function(results) {
    allExpenseData = results[0];
    allAccountsData = results[1];
    
    hideLoading();
    renderExpensePage();
    showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
  }).catch(function(error) {
    hideLoading();
    console.error('Reload error:', error);
    showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
  });
}

// ========== ACCOUNTS PAGE ==========
function showAccountsPage() {
  var html = '<div class="card">' +
    '<div class="card-header">' +
    '<h2 class="card-title">Danh s√°ch T√†i kho·∫£n</h2>' +
    '<div style="display: flex; gap: 10px;">' +
    '<button class="btn-warning" onclick="openTransferModal()">' +
    '<i class="fas fa-exchange-alt"></i> Chuy·ªÉn ti·ªÅn' +
    '</button>' +
    '<button class="btn-primary" onclick="openAccountModal()">' +
    '<i class="fas fa-plus"></i> Th√™m t√†i kho·∫£n' +
    '</button>' +
    '</div>' +
    '</div>' +
    '<table>' +
    '<thead>' +
    '<tr>' +
    '<th>ID</th>' +
    '<th>Lo·∫°i</th>' +
    '<th>T√™n</th>' +
    '<th>S·ªë d∆∞ ƒë·∫ßu k·ª≥</th>' +
    '<th>S·ªë d∆∞ hi·ªán t·∫°i</th>' +
    '<th>H√†nh ƒë·ªông</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody>' + renderAccountsTable() + '</tbody>' +
    '</table>' +
    '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
}

function renderAccountsTable() {
  if (!allAccountsData || allAccountsData.length === 0) {
    return '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
  }
  
  var html = '';
  
  for (var i = 0; i < allAccountsData.length; i++) {
    var item = allAccountsData[i];
    html += '<tr>' +
      '<td>' + item.AccountID + '</td>' +
      '<td>' + item['Lo·∫°i'] + '</td>' +
      '<td>' + item['T√™n t√†i kho·∫£n'] + '</td>' +
      '<td>' + formatCurrency(item['S·ªë d∆∞ ƒë·∫ßu k·ª≥']) + ' ƒë</td>' +
      '<td style="font-weight: 600; color: #3782f4;">' + formatCurrency(item['S·ªë d∆∞ hi·ªán t·∫°i']) + ' ƒë</td>' +
      '<td class="action-buttons">' +
      '<button class="btn-primary btn-sm" onclick="editAccount(\'' + item.AccountID + '\')"><i class="fas fa-edit"></i></button>' +
      '<button class="btn-danger btn-sm" onclick="deleteAccount(\'' + item.AccountID + '\')"><i class="fas fa-trash"></i></button>' +
      '</td></tr>';
  }
  
  return html;
}

function openAccountModal(id) {
  var isEdit = !!id;
  var item = {};
  
  if (isEdit) {
    for (var i = 0; i < allAccountsData.length; i++) {
      if (allAccountsData[i].AccountID === id) {
        item = allAccountsData[i];
        break;
      }
    }
  }
  
  var body = '<div class="form-group"><label>Lo·∫°i t√†i kho·∫£n</label><select id="accountType" class="form-control">' +
    '<option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option><option value="Ng√¢n h√†ng">Ng√¢n h√†ng</option><option value="V√≠ ƒëi·ªán t·ª≠">V√≠ ƒëi·ªán t·ª≠</option></select></div>' +
    '<div class="form-group"><label>T√™n t√†i kho·∫£n</label><input type="text" id="accountName" class="form-control" value="' + (item['T√™n t√†i kho·∫£n'] || '') + '"></div>' +
    '<div class="form-group"><label>S·ªë d∆∞ ƒë·∫ßu k·ª≥ (VNƒê)</label><input type="text" id="accountInitialBalance" class="form-control currency-input" value="' + (isEdit ? formatCurrency(item['S·ªë d∆∞ ƒë·∫ßu k·ª≥']) : '0') + '"></div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button><button class="btn-primary" onclick="saveAccount(\'' + (id || '') + '\')">L∆∞u</button>';
  
  openModal(isEdit ? 'S·ª≠a t√†i kho·∫£n' : 'Th√™m t√†i kho·∫£n', body, footer);
  
  setTimeout(function() { 
    setupCurrencyInput(document.getElementById('accountInitialBalance')); 
  }, 100);
}

function saveAccount(id) {
  var type = document.getElementById('accountType').value;
  var name = document.getElementById('accountName').value;
  var initialBalance = parseCurrency(document.getElementById('accountInitialBalance').value);
  
  if (!name) {
    showToast('Vui l√≤ng nh·∫≠p t√™n t√†i kho·∫£n', 'error');
    return;
  }
  
  var data = {
    'AccountID': id || generateId('ACC'),
    'UserID': currentUser.userId,
    'Lo·∫°i': type,
    'T√™n t√†i kho·∫£n': name,
    'S·ªë d∆∞ ƒë·∫ßu k·ª≥': initialBalance,
    'S·ªë d∆∞ hi·ªán t·∫°i': initialBalance,
    'Metadata': JSON.stringify({})
  };
  
  showLoading();
  
  var action = id ? 'updateRecord' : 'createRecord';
  var params = id ? {sheetName: 'T√†i kho·∫£n', id: id, data: data} : {sheetName: 'T√†i kho·∫£n', data: data};
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        loadSheetData('T√†i kho·∫£n').then(function(data) {
          allAccountsData = data;
          hideLoading();
          closeModal();
          showAccountsPage();
          showToast('Th√†nh c√¥ng', 'success');
        });
      } else {
        hideLoading();
        showToast(response.message, 'error');
      }
    })
    .handleRequest(action, params);
}

function editAccount(id) { 
  openAccountModal(id); 
}

function deleteAccount(id) {
  if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?')) return;
  showLoading();
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        loadSheetData('T√†i kho·∫£n').then(function(data) {
          allAccountsData = data;
          hideLoading();
          showAccountsPage();
          showToast('X√≥a th√†nh c√¥ng', 'success');
        });
      } else {
        hideLoading();
        showToast(response.message, 'error');
      }
    })
    .handleRequest('deleteRecord', {sheetName: 'T√†i kho·∫£n', id: id});
}

// ========== HELPER FUNCTIONS ==========
function renderAccountOptions() {
  var html = '<option value="">-- Ch·ªçn t√†i kho·∫£n --</option>';
  
  if (!allAccountsData || allAccountsData.length === 0) {
    return html;
  }
  
  for (var i = 0; i < allAccountsData.length; i++) {
    var acc = allAccountsData[i];
    html += '<option value="' + acc.AccountID + '">' + acc['T√™n t√†i kho·∫£n'] + ' (' + formatCurrency(acc['S·ªë d∆∞ hi·ªán t·∫°i']) + ' ƒë)</option>';
  }
  
  return html;
}

function getAccountName(accountId) {
  if (!accountId) return 'N/A';
  if (!allAccountsData || allAccountsData.length === 0) return 'N/A';
  
  for (var i = 0; i < allAccountsData.length; i++) {
    if (allAccountsData[i].AccountID === accountId) {
      return allAccountsData[i]['T√™n t√†i kho·∫£n'] || 'N/A';
    }
  }
  
  return 'N/A';
}

function getCategoryName(categoryJson) {
  if (!categoryJson) return 'N/A';
  
  try {
    var cat = typeof categoryJson === 'string' ? JSON.parse(categoryJson) : categoryJson;
    if (Array.isArray(cat) && cat.length > 0 && cat[0].name) {
      return cat[0].name;
    }
    return 'N/A';
  } catch(e) {
    return 'N/A';
  }
}

function getCategoryLabel(categoryId) {
  var labels = {
    // Income categories
    'salary': 'L∆∞∆°ng',
    'bonus': 'Th∆∞·ªüng',
    'investment': 'ƒê·∫ßu t∆∞',
    'freelance': 'Freelance',
    // Expense categories
    'food': 'ƒÇn u·ªëng',
    'transport': 'Di chuy·ªÉn',
    'shopping': 'Mua s·∫Øm',
    'education': 'H·ªçc t·∫≠p',
    'health': 'Y t·∫ø',
    'entertainment': 'Gi·∫£i tr√≠',
    'other': 'Kh√°c'
  };
  
  return labels[categoryId] || categoryId;
}

// ========================================
// BUDGET PAGE - FULL FUNCTIONS
// ========================================

// ========== MAIN BUDGET PAGE ==========
function showBudgetPage() {
  console.log('=== SHOWING BUDGET PAGE ===');
  
  // Reset filters and page
  budgetCurrentPage = 1;
  budgetFilteredData = allBudgetData.slice();
  
  renderBudgetPage();
}

function applyBudgetFilters() {
  // Get filter values
  var fromMonth = document.getElementById('budgetFilterFromMonth')?.value || '';
  var toMonth = document.getElementById('budgetFilterToMonth')?.value || '';
  var category = document.getElementById('budgetFilterCategory')?.value || '';
  
  budgetFilters.monthFrom = fromMonth;
  budgetFilters.monthTo = toMonth;
  budgetFilters.category = category;
  
  // Filter data
  budgetFilteredData = [];
  
  for (var i = 0; i < allBudgetData.length; i++) {
    var item = allBudgetData[i];
    
    // Filter by month range
    if (fromMonth && item['Th√°ng'] < fromMonth) continue;
    if (toMonth && item['Th√°ng'] > toMonth) continue;
    
    // Filter by category
    if (category) {
      try {
        var cat = JSON.parse(item['Danh m·ª•c ID']);
        if (!cat || !cat[0] || cat[0].id !== category) continue;
      } catch(e) {
        continue;
      }
    }
    
    budgetFilteredData.push(item);
  }
}

function clearBudgetFilters() {
  budgetFilters = {
    monthFrom: '',
    monthTo: '',
    category: ''
  };
  
  budgetCurrentPage = 1;
  budgetFilteredData = allBudgetData.slice();
  
  renderBudgetPage();
}

function changeBudgetItemsPerPage(value) {
  budgetItemsPerPage = parseInt(value);
  budgetCurrentPage = 1;
  renderBudgetPage();
}

function renderBudgetTable() {
  if (!budgetFilteredData || budgetFilteredData.length === 0) {
    return '<tr><td colspan="8" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
  }
  
  var startIndex = (budgetCurrentPage - 1) * budgetItemsPerPage;
  var endIndex = Math.min(startIndex + budgetItemsPerPage, budgetFilteredData.length);
  
  var html = '';
  
  for (var i = startIndex; i < endIndex; i++) {
    var item = budgetFilteredData[i];
    var planned = parseCurrency(item['K·∫ø ho·∫°ch']);
    var spent = parseCurrency(item['Chi ti√™u']);
    var remaining = planned - spent;
    var percentage = planned > 0 ? Math.round((spent / planned) * 100) : 0;
    
    var status = 'B√¨nh th∆∞·ªùng';
    var statusColor = '#24c560';
    
    if (percentage >= 100) {
      status = 'V∆∞·ª£t ng√¢n s√°ch';
      statusColor = '#e94849';
    } else if (percentage >= 90) {
      status = 'S·∫Øp v∆∞·ª£t';
      statusColor = '#f59e0b';
    }
    
    var categoryDisplay = formatCategoryDisplay(item['Danh m·ª•c ID']);
    
    html += '<tr>';
    html += '<td>' + (item['Th√°ng'] || 'N/A') + '</td>';
    html += '<td>' + categoryDisplay + '</td>';
    html += '<td style="font-weight: 600;">' + formatCurrency(planned) + ' ƒë</td>';
    html += '<td style="color: #e94849;">' + formatCurrency(spent) + ' ƒë</td>';
    html += '<td style="color: ' + (remaining >= 0 ? '#24c560' : '#e94849') + ';">' + formatCurrency(Math.abs(remaining)) + ' ƒë</td>';
    html += '<td><span class="badge" style="background: ' + statusColor + '20; color: ' + statusColor + ';">' + percentage + '%</span></td>';
    html += '<td><span style="color: ' + statusColor + ';">' + status + '</span></td>';
    html += '<td class="action-buttons">';
    html += '<button class="btn-primary btn-sm" onclick="editBudget(\'' + item.ID + '\')"><i class="fas fa-edit"></i></button>';
    html += '<button class="btn-danger btn-sm" onclick="confirmDeleteBudget(\'' + item.ID + '\')"><i class="fas fa-trash"></i></button>';
    html += '</td></tr>';
  }
  
  return html;
}

function renderBudgetPagination(totalPages) {
  if (totalPages <= 1) return '';
  
  var html = '<div style="display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px;">';
  
  html += '<button class="btn-secondary btn-sm" onclick="budgetGoToPage(' + (budgetCurrentPage - 1) + ')" ' + 
    (budgetCurrentPage === 1 ? 'disabled' : '') + '><i class="fas fa-chevron-left"></i></button>';
  
  for (var i = 1; i <= Math.min(totalPages, 5); i++) {
    if (i === budgetCurrentPage) {
      html += '<button class="btn-primary btn-sm" disabled>' + i + '</button>';
    } else {
      html += '<button class="btn-secondary btn-sm" onclick="budgetGoToPage(' + i + ')">' + i + '</button>';
    }
  }
  
  html += '<button class="btn-secondary btn-sm" onclick="budgetGoToPage(' + (budgetCurrentPage + 1) + ')" ' + 
    (budgetCurrentPage === totalPages ? 'disabled' : '') + '><i class="fas fa-chevron-right"></i></button>';
  
  html += '</div>';
  
  return html;
}

function budgetGoToPage(page) {
  budgetCurrentPage = page;
  renderBudgetPage();
}

function reloadBudgetData() {
  loadSheetData('Ng√¢n s√°ch').then(function(data) {
    allBudgetData = data;
    budgetFilteredData = data.slice();
    renderBudgetPage();
  });
}

function reloadExpenseData() {
  loadSheetData('Chi ti√™u').then(function(data) {
    allExpenseData = data;
    if (currentPage === 'expense') {
      showExpensePage();
    }
  });
}

// ========== RENDER BUDGET PAGE - COMPLETE VERSION ==========
function renderBudgetPage() {
  console.log('=== RENDERING BUDGET PAGE ===');
  console.log('Budget data:', allBudgetData.length, 'records');
  
  // Apply filters
  applyBudgetFilters();
  
  var totalRecords = budgetFilteredData.length;
  var totalPages = Math.ceil(totalRecords / budgetItemsPerPage);
  
  if (budgetCurrentPage > totalPages && totalPages > 0) {
    budgetCurrentPage = totalPages;
  }
  
  // Calculate totals
  var totalPlanned = 0;
  var totalSpent = 0;
  
  for (var i = 0; i < budgetFilteredData.length; i++) {
    totalPlanned += parseCurrency(budgetFilteredData[i]['K·∫ø ho·∫°ch']);
    totalSpent += parseCurrency(budgetFilteredData[i]['Chi ti√™u']);
  }
  
  var totalRemaining = totalPlanned - totalSpent;
  var overallPercentage = totalPlanned > 0 ? Math.round((totalSpent / totalPlanned) * 100) : 0;
  
  var html = '<div class="card">';
  html += '<div class="card-header">';
  html += '<h2 class="card-title">Qu·∫£n l√Ω Ng√¢n s√°ch</h2>';
  html += '<div style="display: flex; gap: 10px;">';
  html += '<button class="btn-secondary" onclick="downloadBudgetTemplate()"><i class="fas fa-download"></i> T·∫£i m·∫´u Excel</button>';
  html += '<button class="btn-secondary" onclick="openBudgetImportModal()"><i class="fas fa-file-import"></i> Import Excel</button>';
  html += '<button class="btn-warning" onclick="updateAllBudgetsManually()"><i class="fas fa-sync-alt"></i> C·∫≠p nh·∫≠t chi ti√™u</button>';
  html += '<button class="btn-primary" onclick="openBudgetModal()"><i class="fas fa-plus"></i> Th√™m ng√¢n s√°ch</button>';
  html += '</div></div>';
  
  // FILTER SECTION
  html += '<div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
  html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
  
  html += '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">T·ª´ th√°ng</label>';
  html += '<input type="month" id="budgetFilterFromMonth" class="form-control" onchange="renderBudgetPage()"></div>';
  
  html += '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">ƒê·∫øn th√°ng</label>';
  html += '<input type="month" id="budgetFilterToMonth" class="form-control" onchange="renderBudgetPage()"></div>';
  
  html += '<div><label style="display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568;">Danh m·ª•c</label>';
  html += '<select id="budgetFilterCategory" class="form-control" onchange="renderBudgetPage()">';
  html += '<option value="">T·∫•t c·∫£</option>';
  html += renderBudgetCategoryOptions();
  html += '</select></div>';
  
  html += '<div style="display: flex; align-items: flex-end;">';
  html += '<button class="btn-secondary" onclick="clearBudgetFilters()" style="width: 100%;">X√≥a b·ªô l·ªçc</button>';
  html += '</div></div></div>';
  
  // SUMMARY CARDS
  html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">';
  html += '<div style="text-align: center; font-size: 14px; opacity: 0.9; margin-bottom: 15px;">üí∞ T·ªîNG H·ª¢P NG√ÇN S√ÅCH</div>';
  html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">';
  
  html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">';
  html += '<div style="font-size: 13px; opacity: 0.8;">T·ªïng k·∫ø ho·∫°ch</div>';
  html += '<div style="font-size: 24px; font-weight: 600; margin-top: 5px;">' + formatCurrency(totalPlanned) + ' ƒë</div></div>';
  
  html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">';
  html += '<div style="font-size: 13px; opacity: 0.8;">T·ªïng chi ti√™u</div>';
  html += '<div style="font-size: 24px; font-weight: 600; margin-top: 5px;">' + formatCurrency(totalSpent) + ' ƒë</div></div>';
  
  html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">';
  html += '<div style="font-size: 13px; opacity: 0.8;">C√≤n l·∫°i</div>';
  html += '<div style="font-size: 24px; font-weight: 600; margin-top: 5px; color: ' + (totalRemaining >= 0 ? '#24c560' : '#e94849') + ';">' + formatCurrency(totalRemaining) + ' ƒë</div></div>';
  
  html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">';
  html += '<div style="font-size: 13px; opacity: 0.8;">T·ª∑ l·ªá th·ª±c hi·ªán</div>';
  html += '<div style="font-size: 24px; font-weight: 600; margin-top: 5px;">' + overallPercentage + '%</div></div>';
  
  html += '</div></div>';
  
  // PAGINATION INFO
  html += '<div style="margin-bottom: 10px; color: #718096; display: flex; justify-content: space-between; align-items: center;">';
  html += '<span>Hi·ªÉn th·ªã ' + ((budgetCurrentPage - 1) * budgetItemsPerPage + 1) + ' - ';
  html += Math.min(budgetCurrentPage * budgetItemsPerPage, totalRecords) + ' trong t·ªïng s·ªë ' + totalRecords + ' b·∫£n ghi</span>';
  html += '<select onchange="changeBudgetItemsPerPage(this.value)" class="form-control" style="width: auto; padding: 5px 10px;">';
  html += '<option value="10"' + (budgetItemsPerPage === 10 ? ' selected' : '') + '>10</option>';
  html += '<option value="20"' + (budgetItemsPerPage === 20 ? ' selected' : '') + '>20</option>';
  html += '<option value="50"' + (budgetItemsPerPage === 50 ? ' selected' : '') + '>50</option>';
  html += '</select></div>';
  
  // TABLE
  html += '<div style="overflow: auto; max-height: calc(100vh - 500px);">';
  html += '<table><thead><tr>';
  html += '<th>TH√ÅNG</th>';
  html += '<th>DANH M·ª§C</th>';
  html += '<th>K·∫æ HO·∫†CH</th>';
  html += '<th>CHI TI√äU</th>';
  html += '<th>C√íN L·∫†I</th>';
  html += '<th>%</th>';
  html += '<th>TR·∫†NG TH√ÅI</th>';
  html += '<th>H√ÄNH ƒê·ªòNG</th>';
  html += '</tr></thead>';
  html += '<tbody>' + renderBudgetTable() + '</tbody>';
  html += '</table></div>';
  
  // PAGINATION
  html += renderBudgetPagination(totalPages);
  
  html += '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
  
  // Restore filter values
  restoreBudgetFilters();
}

function updateAllBudgetsManually() {
  console.log('=== MANUAL UPDATE ALL BUDGETS ===');
  
  if (!confirm('C·∫≠p nh·∫≠t l·∫°i to√†n b·ªô chi ti√™u t·ª´ b·∫£ng Chi ti√™u?')) {
    return;
  }
  
  showLoading('ƒêang c·∫≠p nh·∫≠t ng√¢n s√°ch...');
  
  // Get unique months from current budget data
  var months = [];
  for (var i = 0; i < allBudgetData.length; i++) {
    var month = allBudgetData[i]['Th√°ng'];
    if (month && months.indexOf(month) === -1) {
      months.push(month);
    }
  }
  
  console.log('Months to update:', months);
  
  if (months.length === 0) {
    hideLoading();
    showToast('Kh√¥ng c√≥ ng√¢n s√°ch n√†o ƒë·ªÉ c·∫≠p nh·∫≠t', 'warning');
    return;
  }
  
  var updatedCount = 0;
  var totalMonths = months.length;
  
  // Update each month sequentially
  function updateNextMonth(index) {
    if (index >= totalMonths) {
      // All done
      hideLoading();
      showToast('ƒê√£ c·∫≠p nh·∫≠t ' + updatedCount + ' th√°ng', 'success');
      
      // Reload budget data
      reloadBudgetData();
      return;
    }
    
    var month = months[index];
    console.log('Updating month:', month);
    
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          updatedCount++;
          console.log('‚úÖ Month ' + month + ' updated:', response.updated, 'budgets');
        }
        
        // Update next month
        updateNextMonth(index + 1);
      })
      .withFailureHandler(function(error) {
        console.error('Error updating month ' + month + ':', error);
        updateNextMonth(index + 1);
      })
      .handleRequest('updateAllBudgets', { month: month });
  }
  
  // Start updating
  updateNextMonth(0);
}

// ========================================
// SETTINGS PAGE - CATEGORY MANAGEMENT
// ========================================

function showSettingsPage() {
  console.log('=== SHOWING SETTINGS PAGE ===');
  
  currentSettingsTab = 'expense'; // Default tab
  
  var html = '<div class="card">';
  html += '<div class="card-header">';
  html += '<h2 class="card-title">Qu·∫£n l√Ω Danh m·ª•c</h2>';
  html += '</div>';
  
  // Tab navigation
  html += '<div style="display: flex; gap: 10px; padding: 20px; border-bottom: 1px solid #e5e7eb;">';
  html += '<button class="btn-primary" id="tabExpense" onclick="switchSettingsTab(\'expense\')">Chi ti√™u</button>';
  html += '<button class="btn-secondary" id="tabIncome" onclick="switchSettingsTab(\'income\')">Thu nh·∫≠p</button>';
  html += '<button class="btn-secondary" id="tabBudget" onclick="switchSettingsTab(\'budget\')">Ng√¢n s√°ch</button>';
  html += '</div>';
  
  // Category list container
  html += '<div id="categoryListContainer" style="padding: 20px;">';
  html += '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #3782f4;"></i></div>';
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
  
  // Load categories for default tab
  loadCategoriesForTab('expense');
}

function loadCategoriesForTab(type) {
  console.log('=== LOADING CATEGORIES FOR TAB: ' + type + ' ===');
  
  showLoading();
  
  // Load ALL categories (main + sub) for this type
  google.script.run
    .withSuccessHandler(function(response) {
      console.log('Categories response:', response);
      
      if (response && response.success) {
        var allCats = response.data || [];
        
        // Ph√¢n lo·∫°i main v√† sub
        var mainCategories = [];
        var subCategoriesMap = {}; // { parentId: [subcategories] }
        
        for (var i = 0; i < allCats.length; i++) {
          var cat = allCats[i];
          
          if (!cat.parentId || cat.parentId === 'null' || cat.parentId === '') {
            // Main category
            mainCategories.push(cat);
            subCategoriesMap[cat.id] = []; // Initialize empty array
          } else {
            // Subcategory
            if (!subCategoriesMap[cat.parentId]) {
              subCategoriesMap[cat.parentId] = [];
            }
            subCategoriesMap[cat.parentId].push(cat);
          }
        }
        
        console.log('Main categories:', mainCategories.length);
        console.log('Subcategories map:', subCategoriesMap);
        
        // Render
        renderCategoryTree(mainCategories, subCategoriesMap);
        
        hideLoading();
      } else {
        console.error('Failed to load categories:', response?.message);
        hideLoading();
        showToast('L·ªói t·∫£i danh m·ª•c', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error loading categories:', error);
      hideLoading();
      showToast('L·ªói k·∫øt n·ªëi', 'error');
    })
    .handleRequest('getAllCategoriesByType', { 
      type: type,
      userId: getCurrentUserId()
    });
}

function loadAllCategories() {
  showLoading('ƒêang t·∫£i danh m·ª•c...');
  
  // Refresh categories from server
  Promise.all([
    DataManager.refreshCategories('expense'),
    DataManager.refreshCategories('income'),
    DataManager.refreshCategories('budget')
  ])
  .then(results => {
    allCategories = [...results[0], ...results[1], ...results[2]];
    
    console.log('‚úÖ Categories loaded:', allCategories.length);
    
    hideLoading();
    renderSettingsPage();
  })
  .catch(error => {
    console.error('‚ùå Load categories error:', error);
    hideLoading();
    showToast('L·ªói t·∫£i danh m·ª•c', 'error');
  });
}

function renderSettingsPage() {
  console.log('=== RENDERING SETTINGS PAGE ===');
  console.log('Current tab:', currentSettingsTab);
  console.log('Categories:', allCategories.length);
  
  var html = '<div class="card">' +
    '<div class="card-header">' +
    '<h2 class="card-title">C√†i ƒë·∫∑t - Qu·∫£n l√Ω Danh m·ª•c</h2>' +
    '</div>' +
    
    // TABS
    '<div style="background: #f7fafc; padding: 15px; border-bottom: 2px solid #e2e8f0;">' +
    '<div style="display: flex; gap: 10px; flex-wrap: wrap;">' +
    
    '<button class="' + (currentSettingsTab === 'expense' ? 'btn-primary' : 'btn-secondary') + '" ' +
    'onclick="switchSettingsTab(\'expense\')" style="padding: 8px 20px;">' +
    '<i class="fas fa-shopping-cart"></i> Chi ti√™u' +
    '</button>' +
    
    '<button class="' + (currentSettingsTab === 'income' ? 'btn-primary' : 'btn-secondary') + '" ' +
    'onclick="switchSettingsTab(\'income\')" style="padding: 8px 20px;">' +
    '<i class="fas fa-money-bill-wave"></i> Thu nh·∫≠p' +
    '</button>' +
    
    '<button class="' + (currentSettingsTab === 'budget' ? 'btn-primary' : 'btn-secondary') + '" ' +
    'onclick="switchSettingsTab(\'budget\')" style="padding: 8px 20px;">' +
    '<i class="fas fa-chart-pie"></i> Ng√¢n s√°ch' +
    '</button>' +
    
    '</div>' +
    '</div>' +
    
    // CATEGORY TREE
    '<div style="padding: 20px;">' +
    
    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
    '<h3 style="margin: 0; color: #1f2937;">Danh s√°ch danh m·ª•c</h3>' +
    '<button class="btn-primary" onclick="openAddCategoryModal(null)">' +
    '<i class="fas fa-plus"></i> Th√™m danh m·ª•c ch√≠nh' +
    '</button>' +
    '</div>' +
    
    '<div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">' +
    renderCategoryTree() +
    '</div>' +
    
    '</div>' +
    
    '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
}

function renderCategoryTree(mainCategories, subCategoriesMap) {
  console.log('=== RENDERING CATEGORY TREE ===');
  
  var html = '';
  
  // Add new category button
  html += '<div style="margin-bottom: 20px;">';
  html += '<button class="btn-primary" onclick="openAddCategoryModal()">';
  html += '<i class="fas fa-plus"></i> Th√™m danh m·ª•c ch√≠nh';
  html += '</button>';
  html += '</div>';
  
  if (!mainCategories || mainCategories.length === 0) {
    html += '<div style="text-align: center; padding: 40px; color: #718096;">';
    html += '<i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 10px;"></i>';
    html += '<p>Ch∆∞a c√≥ danh m·ª•c n√†o</p>';
    html += '</div>';
    
    document.getElementById('categoryListContainer').innerHTML = html;
    return;
  }
  
  // Render category tree
  html += '<div class="category-tree">';
  
  for (var i = 0; i < mainCategories.length; i++) {
    var mainCat = mainCategories[i];
    var subcategories = subCategoriesMap[mainCat.id] || [];
    
    html += '<div class="category-item main-category" data-category-id="' + mainCat.id + '">';
    
    // Main category row
    html += '<div class="category-row">';
    html += '<div class="category-info">';
    html += '<div class="category-icon" style="background: ' + (mainCat.color || '#6b7280') + ';">';
    html += mainCat.icon || 'üìÅ';
    html += '</div>';
    html += '<span class="category-name">' + mainCat.name + '</span>';
    
    if (subcategories.length > 0) {
      html += '<span class="badge-count">' + subcategories.length + '</span>';
    }
    
    html += '</div>';
    
    // Action buttons
    html += '<div class="category-actions">';
    html += '<button class="btn-icon-small" onclick="openAddSubcategoryModal(\'' + mainCat.id + '\', \'' + mainCat.name + '\')" title="Th√™m danh m·ª•c con">';
    html += '<i class="fas fa-plus"></i>';
    html += '</button>';
    html += '<button class="btn-icon-small" onclick="editCategory(\'' + mainCat.id + '\')" title="S·ª≠a">';
    html += '<i class="fas fa-edit"></i>';
    html += '</button>';
    html += '<button class="btn-icon-small btn-danger-outline" onclick="deleteCategory(\'' + mainCat.id + '\')" title="X√≥a">';
    html += '<i class="fas fa-trash"></i>';
    html += '</button>';
    html += '</div>';
    
    html += '</div>'; // End category-row
    
    // Render subcategories
    if (subcategories.length > 0) {
      html += '<div class="subcategories">';
      
      for (var j = 0; j < subcategories.length; j++) {
        var subCat = subcategories[j];
        
        html += '<div class="category-item sub-category">';
        html += '<div class="category-row">';
        html += '<div class="category-info">';
        html += '<span class="category-name">‚îú‚îÄ ' + subCat.name + '</span>';
        html += '</div>';
        
        html += '<div class="category-actions">';
        html += '<button class="btn-icon-small" onclick="editCategory(\'' + subCat.id + '\')" title="S·ª≠a">';
        html += '<i class="fas fa-edit"></i>';
        html += '</button>';
        html += '<button class="btn-icon-small btn-danger-outline" onclick="deleteCategory(\'' + subCat.id + '\')" title="X√≥a">';
        html += '<i class="fas fa-trash"></i>';
        html += '</button>';
        html += '</div>';
        
        html += '</div>'; // End category-row
        html += '</div>'; // End sub-category
      }
      
      html += '</div>'; // End subcategories
    }
    
    html += '</div>'; // End main-category
  }
  
  html += '</div>'; // End category-tree
  
  document.getElementById('categoryListContainer').innerHTML = html;
  
  console.log('‚úÖ Category tree rendered');
}

function renderSubcategories(parentId) {
  console.log('=== RENDERING SUBCATEGORIES for parent:', parentId);
  
  // Filter danh m·ª•c con d·ª±a tr√™n parentId
  var subcategories = allCategories.filter(function(cat) {
    return cat.parentId === parentId;
  });
  
  console.log('Found', subcategories.length, 'subcategories');
  
  if (subcategories.length === 0) {
    return '<div style="padding: 10px; color: #9ca3af; font-size: 13px;">Ch∆∞a c√≥ danh m·ª•c con</div>';
  }
  
  var html = '';
  
  for (var i = 0; i < subcategories.length; i++) {
    var cat = subcategories[i];
    
    console.log('- Subcategory:', cat.name);
    
    html += '<div class="category-item sub-category">' +
      '<div class="category-row">' +
      
      '<div class="category-info">' +
      '<span class="category-name">‚îú‚îÄ ' + cat.name + '</span>' +
      '</div>' +
      
      '<div class="category-actions">' +
      '<button class="btn-icon-small" onclick="openEditCategoryModal(\'' + cat.id + '\')" title="S·ª≠a">' +
      '<i class="fas fa-edit"></i>' +
      '</button>' +
      '<button class="btn-icon-small btn-danger-outline" onclick="confirmDeleteCategory(\'' + cat.id + '\')" title="X√≥a">' +
      '<i class="fas fa-trash"></i>' +
      '</button>' +
      '</div>' +
      
      '</div>' +
      '</div>';
  }
  
  return html;
}

function getSubcategoriesCount(parentId) {
  return allCategories.filter(function(cat) {
    return cat.parentId === parentId;
  }).length;
}

function toggleSubcategories(categoryId) {
  var subDiv = document.getElementById('sub-' + categoryId);
  var icon = document.getElementById('toggle-' + categoryId);
  
  if (subDiv.style.display === 'none') {
    subDiv.style.display = 'block';
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-up');
  } else {
    subDiv.style.display = 'none';
    icon.classList.remove('fa-chevron-up');
    icon.classList.add('fa-chevron-down');
  }
}

function switchSettingsTab(tab) {
  console.log('Switching to tab:', tab);
  
  currentSettingsTab = tab;
  
  // Update button styles
  document.getElementById('tabExpense').className = tab === 'expense' ? 'btn-primary' : 'btn-secondary';
  document.getElementById('tabIncome').className = tab === 'income' ? 'btn-primary' : 'btn-secondary';
  document.getElementById('tabBudget').className = tab === 'budget' ? 'btn-primary' : 'btn-secondary';
  
  // Load categories for selected tab
  loadCategoriesForTab(tab);
}

function getCurrentUserId() {
  return currentUser ? currentUser.id : 'USR001';
}


function saveSubcategory() {
  var parentId = document.getElementById('subcategoryParentId').value;
  var name = document.getElementById('subcategoryName').value.trim();
  var sortOrder = parseInt(document.getElementById('subcategorySortOrder').value) || 999;
  
  if (!name) {
    showToast('Vui l√≤ng nh·∫≠p t√™n danh m·ª•c con', 'error');
    return;
  }
  
  if (!parentId) {
    showToast('L·ªói: Kh√¥ng t√¨m th·∫•y danh m·ª•c cha', 'error');
    return;
  }
  
  showLoading();
  closeModal();
  
  var data = {
    type: currentSettingsTab,
    parentId: parentId,
    name: name,
    icon: '',
    color: '',
    userId: getCurrentUserId(),
    sortOrder: sortOrder
  };
  
  console.log('Saving subcategory:', data);
  
  google.script.run
    .withSuccessHandler(function(response) {
      hideLoading();
      
      if (response.success) {
        console.log('‚úÖ Subcategory saved successfully');
        showToast('Th√™m danh m·ª•c con th√†nh c√¥ng', 'success');
        
        // Clear cache
        CategoryManager.clearCache(parentId);
        
        // Reload categories for current tab
        loadCategoriesForTab(currentSettingsTab);
        
        // Refresh main categories cache
        DataManager.refreshCategories(currentSettingsTab).then(function() {
          console.log('Categories cache refreshed');
        });
        
      } else {
        showToast(response.message || 'L·ªói khi th√™m danh m·ª•c con', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      console.error('Error:', error);
      showToast('L·ªói k·∫øt n·ªëi', 'error');
    })
    .handleRequest('saveCategory', data);
}

function openAddSubcategoryModal(parentId, parentName) {
  var body = '<div class="form-group">' +
    '<label>Danh m·ª•c cha</label>' +
    '<input type="text" class="form-control" value="' + parentName + '" disabled>' +
    '<input type="hidden" id="subcategoryParentId" value="' + parentId + '">' +
    '</div>' +
    '<div class="form-group">' +
    '<label>T√™n danh m·ª•c con <span style="color: red;">*</span></label>' +
    '<input type="text" id="subcategoryName" class="form-control" placeholder="Nh·∫≠p t√™n danh m·ª•c con">' +
    '</div>' +
    '<div class="form-group">' +
    '<label>Th·ª© t·ª± hi·ªÉn th·ªã</label>' +
    '<input type="number" id="subcategorySortOrder" class="form-control" value="999" min="1">' +
    '</div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-primary" onclick="saveSubcategory()">L∆∞u</button>';
  
  openModal('Th√™m danh m·ª•c con', body, footer);
  
  // Focus to name input
  setTimeout(function() {
    document.getElementById('subcategoryName').focus();
  }, 100);
}
// ========================================
// CATEGORY MODALS - ADD / EDIT / DELETE
// ========================================

/**
 * Open modal to add new category
 * @param {string} parentId - Parent category ID (null for main category)
 */
function openAddCategoryModal(parentId) {
  editingCategoryId = null;
  
  var title = parentId ? 'Th√™m danh m·ª•c con' : 'Th√™m danh m·ª•c ch√≠nh';
  var parentName = '';
  
  if (parentId) {
    var parent = allCategories.find(function(cat) {
      return cat.id === parentId;
    });
    parentName = parent ? parent.name : '';
  }
  
  var modalBody = '<form id="categoryForm" onsubmit="handleSaveCategory(event)">' +
    
    (parentId ? 
      '<div class="form-group">' +
      '<label>Danh m·ª•c cha</label>' +
      '<input type="text" class="form-control" value="' + parentName + '" disabled>' +
      '<input type="hidden" id="categoryParentId" value="' + parentId + '">' +
      '</div>' : 
      '<input type="hidden" id="categoryParentId" value="">') +
    
    '<div class="form-group">' +
    '<label>T√™n danh m·ª•c <span style="color: red;">*</span></label>' +
    '<input type="text" id="categoryName" class="form-control" placeholder="Nh·∫≠p t√™n danh m·ª•c" required autofocus>' +
    '</div>' +
    
    // ===== S·ª¨A PH·∫¶N N√ÄY - TH√äM EMOJI PICKER =====
    (parentId ? '' : 
      '<div class="form-group">' +
      '<label>Icon (Emoji)</label>' +
      '<div style="display: flex; gap: 10px; margin-bottom: 10px;">' +
      '<input type="text" id="categoryIcon" class="form-control" placeholder="üçî" maxlength="2" style="flex: 1;">' +
      '<button type="button" class="btn-secondary" onclick="toggleEmojiPicker()" style="padding: 8px 16px;">üìù Ch·ªçn</button>' +
      '</div>' +
      '<div id="emojiPicker" style="display: none; padding: 15px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 200px; overflow-y: auto;">' +
      renderEmojiPicker() +
      '</div>' +
      '</div>' +
      
      '<div class="form-group">' +
      '<label>M√†u s·∫Øc</label>' +
      '<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">' +
      renderColorPicker() +
      '</div>' +
      '<input type="hidden" id="categoryColor" value="#e94849">' +
      '</div>') +
    // ===== K·∫æT TH√öC PH·∫¶N S·ª¨A =====
    
    '<div class="form-group">' +
    '<label>Th·ª© t·ª± hi·ªÉn th·ªã</label>' +
    '<input type="number" id="categorySortOrder" class="form-control" value="999" min="1">' +
    '</div>' +
    
    '</form>';
  
  var modalFooter = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-primary" onclick="document.getElementById(\'categoryForm\').requestSubmit()">L∆∞u</button>';
  
  openModal(title, modalBody, modalFooter);
}

/**
 * Open modal to edit existing category
 * @param {string} categoryId - Category ID to edit
 */
function openEditCategoryModal(categoryId) {
  editingCategoryId = categoryId;
  
  var category = allCategories.find(function(cat) {
    return cat.id === categoryId;
  });
  
  if (!category) {
    showToast('Kh√¥ng t√¨m th·∫•y danh m·ª•c', 'error');
    return;
  }
  
  var title = 'S·ª≠a danh m·ª•c: ' + category.name;
  var isMainCategory = !category.parentId;
  
  var modalBody = '<form id="categoryForm" onsubmit="handleSaveCategory(event)">' +
    
    '<div class="form-group">' +
    '<label>T√™n danh m·ª•c <span style="color: red;">*</span></label>' +
    '<input type="text" id="categoryName" class="form-control" value="' + category.name + '" required autofocus>' +
    '</div>' +
    
    // ===== S·ª¨A PH·∫¶N N√ÄY - TH√äM EMOJI PICKER =====
    (isMainCategory ? 
      '<div class="form-group">' +
      '<label>Icon (Emoji)</label>' +
      '<div style="display: flex; gap: 10px; margin-bottom: 10px;">' +
      '<input type="text" id="categoryIcon" class="form-control" value="' + (category.icon || '') + '" maxlength="2" style="flex: 1;">' +
      '<button type="button" class="btn-secondary" onclick="toggleEmojiPicker()" style="padding: 8px 16px;">üìù Ch·ªçn</button>' +
      '</div>' +
      '<div id="emojiPicker" style="display: none; padding: 15px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 200px; overflow-y: auto;">' +
      renderEmojiPicker() +
      '</div>' +
      '</div>' +
      
      '<div class="form-group">' +
      '<label>M√†u s·∫Øc</label>' +
      '<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">' +
      renderColorPicker(category.color) +
      '</div>' +
      '<input type="hidden" id="categoryColor" value="' + (category.color || '#e94849') + '">' +
      '</div>' : '') +
    // ===== K·∫æT TH√öC PH·∫¶N S·ª¨A =====
    
    '<div class="form-group">' +
    '<label>Th·ª© t·ª± hi·ªÉn th·ªã</label>' +
    '<input type="number" id="categorySortOrder" class="form-control" value="' + (category.sortOrder || 999) + '" min="1">' +
    '</div>' +
    
    '</form>';
  
  var modalFooter = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-primary" onclick="document.getElementById(\'categoryForm\').requestSubmit()">C·∫≠p nh·∫≠t</button>';
  
  openModal(title, modalBody, modalFooter);
}

/**
 * Render color picker
 */
function renderColorPicker(selectedColor) {
  var colors = [
    '#e94849', // Red
    '#f59e0b', // Orange
    '#f59e0b', // Yellow
    '#24c560', // Green
    '#10b981', // Teal
    '#3782f4', // Blue
    '#8b5cf6', // Purple
    '#ec4899', // Pink
    '#6b7280'  // Gray
  ];
  
  var html = '';
  
  for (var i = 0; i < colors.length; i++) {
    var color = colors[i];
    var isSelected = selectedColor === color || (!selectedColor && i === 0);
    
    html += '<div class="color-option' + (isSelected ? ' selected' : '') + '" ' +
      'style="background: ' + color + ';" ' +
      'onclick="selectColor(\'' + color + '\')" ' +
      'data-color="' + color + '">' +
      (isSelected ? '<i class="fas fa-check"></i>' : '') +
      '</div>';
  }
  
  return html;
}

/**
 * Render emoji picker
 */
function renderEmojiPicker() {
  var emojiGroups = {
    'Ph·ªï bi·∫øn': ['üçî', 'üöó', 'üõí', 'üìö', '‚öïÔ∏è', 'üéÆ', 'üí∞', 'üìà', 'üéÅ', 'üì¶', 'üè†', '‚ö°', 'üí°', 'üîß'],
    'ƒÇn u·ªëng': ['üçï', 'üçú', '‚òï', 'üç∫', 'ü•ó', 'üç£', 'ü•ò', 'üç∞', 'üçé', 'ü•ê', 'üç±', 'ü•§'],
    'Di chuy·ªÉn': ['üöô', 'üöï', 'üöå', '‚úàÔ∏è', 'üöÇ', 'üö¥', 'üõµ', '‚õΩ', 'üö¶'],
    'Mua s·∫Øm': ['üëï', 'üëó', 'üëî', 'üë†', 'üíÑ', 'üì±', 'üíª', 'üì∑', 'üéß', '‚åö'],
    'H·ªçc t·∫≠p': ['üìñ', '‚úèÔ∏è', 'üìù', 'üéì', 'üè´', 'üíº', 'üìä', 'üñäÔ∏è'],
    'Y t·∫ø': ['üíä', 'üè•', 'ü©∫', 'üíâ', 'üßò', 'üèÉ', '‚öïÔ∏è'],
    'Gi·∫£i tr√≠': ['üé¨', 'üéµ', 'üé∏', 'üéÆ', 'üéØ', 'üé™', 'üé®', 'üì∫', 'üé≠'],
    'T√†i ch√≠nh': ['üíµ', 'üí≥', 'üíé', 'üè¶', 'üìà', 'üìâ', 'üí∏', 'ü™ô'],
    'Kh√°c': ['‚≠ê', '‚ù§Ô∏è', 'üéâ', 'üîî', 'üìå', 'üèÜ', 'üéØ', '‚úÖ', '‚ùå', '‚ö†Ô∏è']
  };
  
  var html = '';
  
  for (var group in emojiGroups) {
    html += '<div style="margin-bottom: 15px;">' +
      '<div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 8px; text-transform: uppercase;">' + group + '</div>' +
      '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 5px;">';
    
    var emojis = emojiGroups[group];
    for (var i = 0; i < emojis.length; i++) {
      html += '<button type="button" class="emoji-btn" onclick="selectEmoji(\'' + emojis[i] + '\')">' + 
        emojis[i] + 
        '</button>';
    }
    
    html += '</div></div>';
  }
  
  return html;
}

/**
 * Toggle emoji picker visibility
 */
function toggleEmojiPicker() {
  var picker = document.getElementById('emojiPicker');
  if (picker) {
    picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
  }
}

/**
 * Select emoji from picker
 */
function selectEmoji(emoji) {
  var input = document.getElementById('categoryIcon');
  if (input) {
    input.value = emoji;
    toggleEmojiPicker(); // Close picker
  }
}

/**
 * Select color
 */
function selectColor(color) {
  // Remove selected class from all
  var options = document.querySelectorAll('.color-option');
  options.forEach(function(opt) {
    opt.classList.remove('selected');
    opt.innerHTML = '';
  });
  
  // Add selected class to clicked
  var selected = document.querySelector('.color-option[data-color="' + color + '"]');
  if (selected) {
    selected.classList.add('selected');
    selected.innerHTML = '<i class="fas fa-check"></i>';
  }
  
  // Update hidden input
  document.getElementById('categoryColor').value = color;
}

/**
 * Handle save category (add or edit)
 */
function handleSaveCategory(event) {
  event.preventDefault();
  
  var name = document.getElementById('categoryName').value.trim();
  var icon = document.getElementById('categoryIcon') ? document.getElementById('categoryIcon').value.trim() : '';
  var color = document.getElementById('categoryColor') ? document.getElementById('categoryColor').value : '';
  var sortOrder = parseInt(document.getElementById('categorySortOrder').value) || 999;
  var parentId = document.getElementById('categoryParentId') ? document.getElementById('categoryParentId').value : '';
  
  if (!name) {
    showToast('Vui l√≤ng nh·∫≠p t√™n danh m·ª•c', 'error');
    return;
  }
  
  var data = {
    type: currentSettingsTab,
    name: name,
    icon: icon,
    color: color,
    sortOrder: sortOrder,
    parentId: parentId || null,
    userId: getCurrentUserId()
  };
  
  closeModal();
  
  if (editingCategoryId) {
    // Update existing
    updateCategoryBackend(editingCategoryId, data);
  } else {
    // Add new
    saveCategoryBackend(data);
  }
}

/**
 * Save new category to backend
 */
function saveCategoryBackend(data) {
  showLoading('ƒêang l∆∞u danh m·ª•c...');
  
  var parentIdToExpand = data.parentId; // L∆∞u parentId ƒë·ªÉ expand sau
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        showToast('Th√™m danh m·ª•c th√†nh c√¥ng', 'success');
        
        // Reload v√† t·ª± ƒë·ªông m·ªü danh m·ª•c cha n·∫øu th√™m danh m·ª•c con
        loadAllCategoriesAndExpand(parentIdToExpand);
      } else {
        showToast(result.message || 'L·ªói th√™m danh m·ª•c', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .saveCategory(data);
}

/**
 * Update existing category
 */
function updateCategoryBackend(categoryId, data) {
  showLoading('ƒêang c·∫≠p nh·∫≠t...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        showToast('C·∫≠p nh·∫≠t danh m·ª•c th√†nh c√¥ng', 'success');
        loadAllCategories(); // Reload
      } else {
        showToast(result.message || 'L·ªói c·∫≠p nh·∫≠t', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .updateCategory(categoryId, data);
}

/**
 * Confirm delete category
 */
function confirmDeleteCategory(categoryId) {
  var category = allCategories.find(function(cat) {
    return cat.id === categoryId;
  });
  
  if (!category) {
    showToast('Kh√¥ng t√¨m th·∫•y danh m·ª•c', 'error');
    return;
  }
  
  var message = 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c "<strong>' + category.name + '</strong>"?';
  
  if (category.hasChildren) {
    message += '<br><br><span style="color: #e94849;">‚ö†Ô∏è Danh m·ª•c n√†y c√≥ ' + getSubcategoriesCount(category.id) + ' danh m·ª•c con. T·∫•t c·∫£ danh m·ª•c con c≈©ng s·∫Ω b·ªã x√≥a.</span>';
  }
  
  var modalBody = '<div style="padding: 20px; text-align: center;">' +
    '<i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f59e0b; margin-bottom: 15px;"></i>' +
    '<p style="font-size: 16px; color: #1f2937;">' + message + '</p>' +
    '</div>';
  
  var modalFooter = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-danger" onclick="deleteCategoryBackend(\'' + categoryId + '\')">X√≥a</button>';
  
  openModal('X√°c nh·∫≠n x√≥a', modalBody, modalFooter);
}

/**
 * Delete category from backend
 */
function deleteCategoryBackend(categoryId) {
  closeModal();
  showLoading('ƒêang x√≥a...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        showToast('X√≥a danh m·ª•c th√†nh c√¥ng', 'success');
        loadAllCategories(); // Reload
      } else {
        showToast(result.message || 'L·ªói x√≥a danh m·ª•c', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .deleteCategory(categoryId);
}

// ========== FILTERS ==========
function applyBudgetFilters() {
  var monthFromEl = document.getElementById('budgetFilterMonthFrom');
  var monthToEl = document.getElementById('budgetFilterMonthTo');
  var categoryEl = document.getElementById('budgetFilterCategory');
  
  if (monthFromEl) budgetFilters.monthFrom = monthFromEl.value;
  if (monthToEl) budgetFilters.monthTo = monthToEl.value;
  if (categoryEl) budgetFilters.category = categoryEl.value;
  
  console.log('=== APPLYING BUDGET FILTERS ===');
  console.log('Filters:', budgetFilters);
  console.log('All budget data:', allBudgetData.length);
  
  budgetFilteredData = [];
  
  for (var i = 0; i < allBudgetData.length; i++) {
    var item = allBudgetData[i];
    var itemMonth = item['Th√°ng'];
    
    // Normalize month format
    if (itemMonth) {
      if (typeof itemMonth === 'string' && itemMonth.length > 7) {
        itemMonth = itemMonth.substring(0, 7);
      }
    }
    
    // Filter by month range
    if (budgetFilters.monthFrom && itemMonth < budgetFilters.monthFrom) {
      continue;
    }
    
    if (budgetFilters.monthTo && itemMonth > budgetFilters.monthTo) {
      continue;
    }
    
    // Filter by category
    if (budgetFilters.category) {
      try {
        var cat = typeof item['Danh m·ª•c ID'] === 'string' ? 
          JSON.parse(item['Danh m·ª•c ID']) : item['Danh m·ª•c ID'];
        
        if (!cat || !cat[0] || cat[0].id !== budgetFilters.category) {
          continue;
        }
      } catch(e) {
        continue;
      }
    }
    
    budgetFilteredData.push(item);
  }
  
  console.log('Filtered data count:', budgetFilteredData.length);
}

// ========== CALCULATE SUMMARY ==========
function renderBudgetSummary() {
  var totalPlanned = 0;
  var totalSpent = 0;
  
  for (var i = 0; i < budgetFilteredData.length; i++) {
    totalPlanned += parseCurrency(budgetFilteredData[i]['K·∫ø ho·∫°ch']);
    totalSpent += parseCurrency(budgetFilteredData[i]['Chi ti√™u']);
  }
  
  var totalRemaining = totalPlanned - totalSpent;
  var totalPercentage = totalPlanned > 0 ? Math.round((totalSpent / totalPlanned) * 100) : 0;
  
  var html = 
    '<div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);">' +
    '<div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px; font-weight: 500;">T·ªïng k·∫ø ho·∫°ch</div>' +
    '<div style="font-size: 24px; font-weight: 700; color: #fff;">' + formatCurrency(totalPlanned) + ' ƒë</div>' +
    '</div>' +
    
    '<div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);">' +
    '<div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px; font-weight: 500;">T·ªïng chi ti√™u</div>' +
    '<div style="font-size: 24px; font-weight: 700; color: #fff;">' + formatCurrency(totalSpent) + ' ƒë</div>' +
    '</div>' +
    
    '<div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);">' +
    '<div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px; font-weight: 500;">C√≤n l·∫°i</div>' +
    '<div style="font-size: 24px; font-weight: 700; color: ' + (totalRemaining >= 0 ? '#4ade80' : '#fca5a5') + ';">' + 
    formatCurrency(totalRemaining) + ' ƒë</div>' +
    '</div>' +
    
    '<div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);">' +
    '<div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px; font-weight: 500;">T·ª∑ l·ªá th·ª±c hi·ªán</div>' +
    '<div style="font-size: 24px; font-weight: 700; color: ' + 
    (totalPercentage >= 100 ? '#fca5a5' : totalPercentage >= 90 ? '#fde047' : '#4ade80') + ';">' + 
    totalPercentage + '%</div>' +
    '</div>';
  
  return html;
}


// ========== CALCULATE SUMMARY ==========
function renderBudgetSummary() {
  var totalPlanned = 0;
  var totalSpent = 0;
  
  for (var i = 0; i < budgetFilteredData.length; i++) {
    totalPlanned += parseCurrency(budgetFilteredData[i]['K·∫ø ho·∫°ch']);
    totalSpent += parseCurrency(budgetFilteredData[i]['Chi ti√™u']);
  }
  
  var totalRemaining = totalPlanned - totalSpent;
  var totalPercentage = totalPlanned > 0 ? Math.round((totalSpent / totalPlanned) * 100) : 0;
  
  var html = 
    '<div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);">' +
    '<div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px; font-weight: 500;">T·ªïng k·∫ø ho·∫°ch</div>' +
    '<div style="font-size: 24px; font-weight: 700; color: #fff;">' + formatCurrency(totalPlanned) + ' ƒë</div>' +
    '</div>' +
    
    '<div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);">' +
    '<div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px; font-weight: 500;">T·ªïng chi ti√™u</div>' +
    '<div style="font-size: 24px; font-weight: 700; color: #fff;">' + formatCurrency(totalSpent) + ' ƒë</div>' +
    '</div>' +
    
    '<div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);">' +
    '<div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px; font-weight: 500;">C√≤n l·∫°i</div>' +
    '<div style="font-size: 24px; font-weight: 700; color: ' + (totalRemaining >= 0 ? '#4ade80' : '#fca5a5') + ';">' + 
    formatCurrency(totalRemaining) + ' ƒë</div>' +
    '</div>' +
    
    '<div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);">' +
    '<div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px; font-weight: 500;">T·ª∑ l·ªá th·ª±c hi·ªán</div>' +
    '<div style="font-size: 24px; font-weight: 700; color: ' + 
    (totalPercentage >= 100 ? '#fca5a5' : totalPercentage >= 90 ? '#fde047' : '#4ade80') + ';">' + 
    totalPercentage + '%</div>' +
    '</div>';
  
  return html;
}

function clearBudgetFilters() {
  budgetFilters = { 
    monthFrom: '', 
    monthTo: '', 
    category: '' 
  };
  budgetCurrentPage = 1;
  budgetFilteredData = allBudgetData.slice();
  renderBudgetPage();
  
  setTimeout(function() {
    var monthFromEl = document.getElementById('budgetFilterMonthFrom');
    var monthToEl = document.getElementById('budgetFilterMonthTo');
    var categoryEl = document.getElementById('budgetFilterCategory');
    
    if (monthFromEl) monthFromEl.value = '';
    if (monthToEl) monthToEl.value = '';
    if (categoryEl) categoryEl.value = '';
  }, 100);
}

function changeBudgetItemsPerPage(value) {
  budgetItemsPerPage = parseInt(value);
  budgetCurrentPage = 1;
  renderBudgetPage();
}

function updateBudgetsForMonth(month) {
  console.log('=== UPDATE BUDGETS FOR MONTH:', month, '===');
  
  // Call backend to update all budgets for this month
  google.script.run
    .withSuccessHandler(function(response) {
      console.log('Budget update response:', response);
      
      if (response.success) {
        console.log('‚úÖ Budgets updated:', response.updated, 'records');
        
        // Reload budget data if on budget page
        if (currentPage === 'budget') {
          setTimeout(function() {
            loadSheetData('Ng√¢n s√°ch').then(function(data) {
              allBudgetData = data;
              budgetFilteredData = data.slice();
              renderBudgetPage();
              console.log('‚úÖ Budget page refreshed');
            });
          }, 1000);
        }
        
        // Update local cache
        setTimeout(function() {
          DataManager.refresh('budget').then(function() {
            console.log('‚úÖ Budget cache refreshed');
          });
        }, 1500);
        
      } else {
        console.error('Budget update failed:', response.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error('Budget update error:', error);
    })
    .handleRequest('updateAllBudgets', { month: month });
}

function updateBudgetManually() {
  console.log('=== MANUAL BUDGET UPDATE ===');
  
  showLoading('ƒêang c·∫≠p nh·∫≠t ng√¢n s√°ch...');
  
  // Get current month filter or use current month
  var currentMonth = new Date().toISOString().substring(0, 7);
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        showToast('ƒê√£ c·∫≠p nh·∫≠t ' + response.updated + ' ng√¢n s√°ch', 'success');
        
        // Reload budget data
        loadSheetData('Ng√¢n s√°ch').then(function(data) {
          allBudgetData = data;
          budgetFilteredData = data.slice();
          renderBudgetPage();
          hideLoading();
        });
      } else {
        hideLoading();
        showToast('L·ªói c·∫≠p nh·∫≠t: ' + response.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('updateAllBudgets', { month: currentMonth });
}

// ========== TABLE RENDER ==========
function renderBudgetTableWithPagination() {
  console.log('Rendering budget table, filtered data:', budgetFilteredData.length);
  
  if (!budgetFilteredData || budgetFilteredData.length === 0) {
    return '<tr><td colspan="8" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
  }
  
  var startIndex = (budgetCurrentPage - 1) * budgetItemsPerPage;
  var endIndex = Math.min(startIndex + budgetItemsPerPage, budgetFilteredData.length);
  
  console.log('Rendering from', startIndex, 'to', endIndex);
  
  var html = '';
  
  for (var i = startIndex; i < endIndex; i++) {
    var item = budgetFilteredData[i];
    var id = item.ID || 'N/A';
    
    console.log('Rendering budget item:', item);
    
    var categoryName = 'N/A';
    var categoryIcon = '';
    var categoryColor = '';

    try {
      var cat = typeof item['Danh m·ª•c ID'] === 'string' ? 
        JSON.parse(item['Danh m·ª•c ID']) : item['Danh m·ª•c ID'];
      
      if (cat && cat[0]) {
        var categoryId = cat[0].id;
        
        // Get icon & color from cache
        var categoryInfo = categoryCache[categoryId];
        if (categoryInfo) {
          categoryIcon = categoryInfo.icon || '';
          categoryColor = categoryInfo.color || '#6b7280';
        }
        
        categoryName = cat[0].name || 'N/A';
        if (cat[0].subcategory) {
          categoryName += ' - ' + cat[0].subcategory;
        }
      }
    } catch(e) {
      console.error('Parse category error:', e);
    }

    
    var planned = parseCurrency(item['K·∫ø ho·∫°ch']);
    var spent = parseCurrency(item['Chi ti√™u']);
    var remaining = planned - spent;
    var percentage = planned > 0 ? Math.round((spent / planned) * 100) : 0;
    
    var status = 'on-track';
    var statusBadge = 'badge-success';
    var statusText = 'B√¨nh th∆∞·ªùng';
    
    if (percentage >= 100) {
      status = 'exceeded';
      statusBadge = 'badge-danger';
      statusText = 'V∆∞·ª£t ng√¢n s√°ch';
    } else if (percentage >= 90) {
      status = 'warning';
      statusBadge = 'badge-warning';
      statusText = 'C·∫£nh b√°o';
    }
    
    var progressColor = percentage >= 100 ? '#e94849' : percentage >= 90 ? '#f59e0b' : '#24c560';
    
    html += '<tr>' +
      '<td>' + (item['Th√°ng'] || 'N/A') + '</td>' +
      '<td>' + 
        (categoryIcon ? 
          '<span style="display: inline-flex; align-items: center; gap: 8px;">' +
          '<span style="background: ' + categoryColor + '; color: white; padding: 4px 8px; border-radius: 6px; font-size: 16px;">' + 
          categoryIcon + 
          '</span>' +
          '<span>' + categoryName + '</span>' +
          '</span>' 
          : categoryName) +
      '</td>' +
      '<td style="color: #3782f4; font-weight: 600;">' + formatCurrency(planned) + ' ƒë</td>' +
      '<td style="color: #e94849; font-weight: 600;">' + formatCurrency(spent) + ' ƒë</td>' +
      '<td style="color: ' + (remaining >= 0 ? '#24c560' : '#e94849') + '; font-weight: 600;">' + formatCurrency(remaining) + ' ƒë</td>' +
      '<td>' +
      '<div style="width: 80px;">' +
      '<div style="background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden;">' +
      '<div style="background: ' + progressColor + '; width: ' + Math.min(percentage, 100) + '%; height: 100%;"></div>' +
      '</div>' +
      '<span style="font-size: 11px; color: #4a5568;">' + percentage + '%</span>' +
      '</div>' +
      '</td>' +
      '<td><span class="badge ' + statusBadge + '">' + statusText + '</span></td>' +
      '<td class="action-buttons">' +
      '<button class="btn-primary btn-sm" onclick="editBudget(\'' + id + '\')"><i class="fas fa-edit"></i></button>' +
      '<button class="btn-danger btn-sm" onclick="confirmDeleteBudget(\'' + id + '\')"><i class="fas fa-trash"></i></button>' +
      '</td></tr>';
  }
  
  return html;
}

// ========== PAGINATION ==========
function renderBudgetPagination(totalPages) {
  if (totalPages <= 1) return '';
  
  var html = '<div style="display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px;">';
  
  html += '<button class="btn-secondary btn-sm" onclick="budgetGoToPage(' + (budgetCurrentPage - 1) + ')" ' + 
    (budgetCurrentPage === 1 ? 'disabled' : '') + '><i class="fas fa-chevron-left"></i></button>';
  
  var startPage = Math.max(1, budgetCurrentPage - 2);
  var endPage = Math.min(totalPages, budgetCurrentPage + 2);
  
  if (startPage > 1) {
    html += '<button class="btn-secondary btn-sm" onclick="budgetGoToPage(1)">1</button>';
    if (startPage > 2) html += '<span>...</span>';
  }
  
  for (var i = startPage; i <= endPage; i++) {
    if (i === budgetCurrentPage) {
      html += '<button class="btn-primary btn-sm" disabled>' + i + '</button>';
    } else {
      html += '<button class="btn-secondary btn-sm" onclick="budgetGoToPage(' + i + ')">' + i + '</button>';
    }
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span>...</span>';
    html += '<button class="btn-secondary btn-sm" onclick="budgetGoToPage(' + totalPages + ')">' + totalPages + '</button>';
  }
  
  html += '<button class="btn-secondary btn-sm" onclick="budgetGoToPage(' + (budgetCurrentPage + 1) + ')" ' + 
    (budgetCurrentPage === totalPages ? 'disabled' : '') + '><i class="fas fa-chevron-right"></i></button>';
  
  html += '</div>';
  
  return html;
}

function budgetGoToPage(page) {
  budgetCurrentPage = page;
  renderBudgetPage();
  window.scrollTo(0, 0);
}

// ========================================
// BUDGET MODAL - OPTIMIZED VERSION
// ========================================

function openBudgetModal(id) {
  console.log('=== OPENING BUDGET MODAL ===', id ? 'EDIT' : 'CREATE');
  
  var isEdit = !!id;
  var item = {};
  
  if (isEdit) {
    const budgetList = DataManager.getBudget();
    item = budgetList.find(i => i.ID === id) || {};
    
    if (!item.ID) {
      showToast('Kh√¥ng t√¨m th·∫•y b·∫£n ghi', 'error');
      return;
    }
  }
  
  // Parse existing data
  var categoryId = '';
  var subcategoryId = '';
  
  if (isEdit && item['Danh m·ª•c ID']) {
    try {
      var cat = typeof item['Danh m·ª•c ID'] === 'string' ? 
        JSON.parse(item['Danh m·ª•c ID']) : item['Danh m·ª•c ID'];
      if (cat && cat[0]) {
        categoryId = cat[0].id || '';
        subcategoryId = cat[0].subcategoryId || '';
      }
    } catch(e) {
      console.error('Parse category error:', e);
    }
  }
  
  var currentMonth = new Date().toISOString().substring(0, 7);
  var currentSpent = isEdit ? parseCurrency(item['Chi ti√™u']) : 0;
  
  // Build modal HTML
  var body = 
    '<form id="budgetForm" onsubmit="handleSaveBudget(event, \'' + (id || '') + '\')">' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-calendar-alt"></i> Th√°ng <span style="color: red;">*</span></label>' +
    '<input type="month" id="budgetMonth" name="Th√°ng" class="form-control" value="' + 
    (item['Th√°ng'] || currentMonth) + '" required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-tag"></i> Danh m·ª•c ch√≠nh <span style="color: red;">*</span></label>' +
    '<select id="budgetCategory" name="Danh m·ª•c" class="form-control" onchange="loadBudgetSubcategories()" required>' +
    '<option value="">-- Loading categories... --</option>' +
    '</select>' +
    '</div>' +
    
    '<div class="form-group" id="budgetSubcategoryWrapper" style="display: none;">' +
    '<label><i class="fas fa-sitemap"></i> Danh m·ª•c con (T√πy ch·ªçn)</label>' +
    '<select id="budgetSubcategory" class="form-control">' +
    '<option value="">-- Kh√¥ng ch·ªçn --</option>' +
    '</select>' +
    '<small style="color: #718096; display: block; margin-top: 5px;">N·∫øu kh√¥ng ch·ªçn, s·∫Ω t√≠nh t·ªïng t·∫•t c·∫£ danh m·ª•c con</small>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-wallet"></i> K·∫ø ho·∫°ch (VNƒê) <span style="color: red;">*</span></label>' +
    '<input type="text" id="budgetPlanned" name="K·∫ø ho·∫°ch" class="form-control currency-input" value="' + 
    (isEdit ? formatCurrency(item['K·∫ø ho·∫°ch']) : '0') + '" required>' +
    '</div>' +
    
    (isEdit ? 
      '<div class="form-group">' +
      '<label><i class="fas fa-chart-line"></i> Chi ti√™u hi·ªán t·∫°i <i class="fas fa-info-circle" title="ƒê∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông t·ª´ b·∫£ng Chi ti√™u"></i></label>' +
      '<input type="text" class="form-control" value="' + formatCurrency(currentSpent) + ' ƒë" disabled style="background: #f7fafc; font-weight: 600; color: #e94849;">' +
      '<small style="color: #718096; display: block; margin-top: 5px;">üí° Gi√° tr·ªã n√†y ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông t·ª´ b·∫£ng Chi ti√™u</small>' +
      '</div>' 
      : '') +
    
    '<div style="background: #fffbeb; border-left: 3px solid #f59e0b; padding: 12px; border-radius: 4px; margin-top: 15px;">' +
    '<strong style="color: #92400e;">üí° L∆∞u √Ω:</strong><br>' +
    '<ul style="margin: 5px 0 0 0; padding-left: 20px; font-size: 13px; color: #78350f;">' +
    '<li>Ch·ªâ c·∫ßn nh·∫≠p <strong>K·∫ø ho·∫°ch</strong></li>' +
    '<li>C·ªôt <strong>Chi ti√™u</strong> s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t t·ª´ b·∫£ng Chi ti√™u</li>' +
    '<li>S·ª≠ d·ª•ng n√∫t <strong>"C·∫≠p nh·∫≠t chi ti√™u"</strong> ƒë·ªÉ l√†m m·ªõi d·ªØ li·ªáu</li>' +
    '</ul>' +
    '</div>' +
    
    '</form>';
  
  var footer = 
    '<button type="button" class="btn-secondary" onclick="closeModal()">' +
    '<i class="fas fa-times"></i> H·ªßy' +
    '</button>' +
    '<button type="button" class="btn-primary" onclick="document.getElementById(\'budgetForm\').requestSubmit()">' +
    '<i class="fas fa-save"></i> L∆∞u' +
    '</button>';
  
  openModal(
    isEdit ? '‚úèÔ∏è S·ª≠a ng√¢n s√°ch' : '‚ûï Th√™m ng√¢n s√°ch', 
    body, 
    footer
  );
  
  // Initialize after modal opens
  setTimeout(function() {
    console.log('üîß Initializing budget modal...');
    
    // 1. Load categories from cache (use expense categories)
    const categories = DataManager.getCategories('expense');
    console.log('‚úÖ Loaded', categories.length, 'expense categories from cache');
    
    var categorySelect = document.getElementById('budgetCategory');
    if (categorySelect) {
      categorySelect.innerHTML = renderCategoryOptions(categories, categoryId);
      
      if (categoryId) {
        loadBudgetSubcategories().then(function() {
          if (subcategoryId) {
            var subcatSelect = document.getElementById('budgetSubcategory');
            if (subcatSelect) {
              subcatSelect.value = subcategoryId;
            }
          }
        });
      }
    }
    
    // 2. Setup currency input
    setupCurrencyInput(document.getElementById('budgetPlanned'));
    
    // 3. Enable real-time validation
    const form = document.getElementById('budgetForm');
    if (form) {
      Validator.enableRealTimeValidation(form, 'budget');
    }
    
    // 4. Focus first input
    document.getElementById('budgetMonth').focus();
    
    console.log('‚úÖ Budget modal initialized');
  }, 100);
}

// ========================================
// LOAD BUDGET SUBCATEGORIES
// ========================================

function loadBudgetSubcategories() {
  return new Promise(function(resolve, reject) {
    var categorySelect = document.getElementById('budgetCategory');
    var subcategoryWrapper = document.getElementById('budgetSubcategoryWrapper');
    var subcategorySelect = document.getElementById('budgetSubcategory');
    
    if (!categorySelect || !subcategoryWrapper || !subcategorySelect) {
      reject('Elements not found');
      return;
    }
    
    var categoryId = categorySelect.value;
    
    if (!categoryId) {
      subcategoryWrapper.style.display = 'none';
      subcategorySelect.innerHTML = '<option value="">-- Kh√¥ng ch·ªçn --</option>';
      resolve();
      return;
    }
    
    console.log('üì• Loading subcategories for:', categoryId);
    
    subcategorySelect.innerHTML = '<option value="">-- ƒêang t·∫£i... --</option>';
    subcategoryWrapper.style.display = 'block';
    
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success && response.data.length > 0) {
          console.log('‚úÖ Loaded', response.data.length, 'subcategories');
          subcategorySelect.innerHTML = renderSubcategoryOptions(response.data, '');
          subcategoryWrapper.style.display = 'block';
        } else {
          subcategorySelect.innerHTML = '<option value="">-- Kh√¥ng c√≥ danh m·ª•c con --</option>';
          subcategoryWrapper.style.display = 'block';
        }
        resolve();
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Load subcategories error:', error);
        subcategorySelect.innerHTML = '<option value="">-- L·ªói t·∫£i d·ªØ li·ªáu --</option>';
        reject(error);
      })
      .handleRequest('getSubcategories', { 
        parentId: categoryId,
        userId: currentUser.userId 
      });
  });
}

function updateBudgetSubcategories() {
  var categoryEl = document.getElementById('budgetCategory');
  var subcategoryEl = document.getElementById('budgetSubcategory');
  var wrapperEl = document.getElementById('subcategoryWrapper');
  
  console.log('updateBudgetSubcategories called');
  console.log('Category:', categoryEl ? categoryEl.value : 'null');
  console.log('budgetSubcategories:', budgetSubcategories);
  
  if (!categoryEl || !subcategoryEl || !wrapperEl) {
    console.error('Elements not found');
    return;
  }
  
  var category = categoryEl.value;
  
  if (!category) {
    wrapperEl.style.display = 'none';
    return;
  }
  
  // Clear existing options
  subcategoryEl.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c con --</option>';
  
  // Add subcategories
  var subcats = budgetSubcategories[category] || [];
  console.log('Subcategories for', category, ':', subcats);
  
  for (var i = 0; i < subcats.length; i++) {
    var option = document.createElement('option');
    option.value = subcats[i];
    option.textContent = subcats[i];
    subcategoryEl.appendChild(option);
  }
  
  wrapperEl.style.display = 'block';
}

// ========================================
// SAVE BUDGET - WITH VALIDATION & ERROR RECOVERY
// ========================================

async function handleSaveBudget(event, id) {
  event.preventDefault();
  
  console.log('=== SAVING BUDGET ===', id ? 'UPDATE' : 'CREATE');
  
  Validator.clearErrors();
  
  // Collect form data
  var formData = {
    'Th√°ng': document.getElementById('budgetMonth').value,
    'Danh m·ª•c': document.getElementById('budgetCategory').value,
    'K·∫ø ho·∫°ch': parseCurrency(document.getElementById('budgetPlanned').value)
  };
  
  var subcategoryId = document.getElementById('budgetSubcategory') ? 
    document.getElementById('budgetSubcategory').value : '';
  
  // Validate
  const validation = Validator.validate(formData, 'budget');
  
  if (!validation.valid) {
    console.log('‚ùå Validation failed:', validation.errors);
    Validator.showErrors(validation.errors);
    return;
  }
  
  // Get category details
  var categoryInfo = DataManager.getCategoryById(formData['Danh m·ª•c']);
  var categoryName = categoryInfo ? categoryInfo.name : formData['Danh m·ª•c'];
  
  // Build category data
  var categoryData = {
    id: formData['Danh m·ª•c'],
    name: categoryName
  };
  
  var displayName = categoryName;
  
  if (subcategoryId) {
    var subcategorySelect = document.getElementById('budgetSubcategory');
    var subcategoryName = '';
    
    if (subcategorySelect) {
      var selectedOption = subcategorySelect.options[subcategorySelect.selectedIndex];
      if (selectedOption) {
        subcategoryName = selectedOption.text.replace('‚îú‚îÄ ', '').trim();
      }
    }
    
    categoryData.subcategory = subcategoryName;
    categoryData.subcategoryId = subcategoryId;
    displayName += ' - ' + subcategoryName;
  }
  
  // Build record data
  var recordData = {
    'ID': id || generateId('NS'),
    'UserID': currentUser.userId,
    'Th√°ng': formData['Th√°ng'],
    'Danh m·ª•c ID': JSON.stringify([categoryData]),
    'K·∫ø ho·∫°ch': formData['K·∫ø ho·∫°ch'],
    'Chi ti√™u': 0,
    'Ch√™nh l·ªách': 0,
    'Metadata': JSON.stringify({
      categoryName: displayName,
      remaining: formData['K·∫ø ho·∫°ch'],
      percentage: 0,
      status: 'on-track',
      alerts: [],
      history: []
    })
  };
  
  console.log('üíæ Record data:', recordData);
  
  closeModal();
  showLoading('ƒêang l∆∞u...');
  
  try {
    // Optimistic update
    if (id) {
      DataManager.updateRecord('Ng√¢n s√°ch', id, recordData);
    } else {
      DataManager.addRecord('Ng√¢n s√°ch', recordData);
    }
    
    // Update UI immediately
    allBudgetData = DataManager.getBudget();
    budgetFilteredData = allBudgetData.slice();
    renderBudgetPage();
    
    // Save to server with retry
    var action = id ? 'updateRecord' : 'createRecord';
    var params = id ? 
      {sheetName: 'Ng√¢n s√°ch', id: id, data: recordData} : 
      {sheetName: 'Ng√¢n s√°ch', data: recordData};
    
    const response = await ErrorHandler.callWithRetry(action, params);
    
    if (response.success) {
      console.log('‚úÖ Server save successful');
      
      // Auto-calculate spent amount
      try {
        const calcResponse = await ErrorHandler.callWithRetry('calculateBudgetSpent', {
          budgetId: recordData.ID,
          month: formData['Th√°ng']
        });
        
        if (calcResponse.success) {
          console.log('‚úÖ Budget spent calculated:', calcResponse.spent);
          
          // Refresh budget data
          await DataManager.refresh('Ng√¢n s√°ch');
          allBudgetData = DataManager.getBudget();
          budgetFilteredData = allBudgetData.slice();
          renderBudgetPage();
          
          hideLoading();
          showToast('‚úÖ ƒê√£ l∆∞u ng√¢n s√°ch v√† c·∫≠p nh·∫≠t chi ti√™u: ' + 
            formatCurrency(calcResponse.spent) + ' ƒë', 'success');
        }
      } catch (calcError) {
        console.error('‚ö†Ô∏è Calculate spent failed:', calcError);
        hideLoading();
        showToast('‚úÖ ƒê√£ l∆∞u ng√¢n s√°ch!', 'success');
      }
      
    } else {
      throw new Error(response.message || 'Save failed');
    }
    
  } catch (error) {
    console.error('‚ùå Save error:', error);
    
    // Rollback
    await DataManager.refresh('Ng√¢n s√°ch');
    allBudgetData = DataManager.getBudget();
    budgetFilteredData = allBudgetData.slice();
    renderBudgetPage();
    
    hideLoading();
  }
}

function editBudget(id) {
  openBudgetModal(id);
}

function confirmDeleteBudget(id) {
  var body = '<p style="text-align: center; font-size: 16px; margin: 20px 0;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng√¢n s√°ch n√†y?</p>' +
    '<p style="text-align: center; color: #e94849; font-weight: 500;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-danger" onclick="executeDeleteBudget(\'' + id + '\')">X√≥a</button>';
  
  openModal('X√°c nh·∫≠n x√≥a', body, footer);
}

function executeDeleteBudget(id) {
  closeModal();
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        reloadBudgetData();
      } else {
        hideLoading();
        showToast(response.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('deleteRecord', {sheetName: 'Ng√¢n s√°ch', id: id});
}

function reloadBudgetData() {
  showLoading();
  
  loadSheetData('Ng√¢n s√°ch').then(function(data) {
    allBudgetData = data;
    hideLoading();
    renderBudgetPage();
    showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
  }).catch(function(error) {
    hideLoading();
    console.error('Reload error:', error);
    showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
  });
}

// ========== UPDATE BUDGETS ==========
function updateCurrentMonthBudgets() {
  var currentMonth = new Date().toISOString().substring(0, 7);
  
  console.log('Updating budgets for month:', currentMonth);
  
  showLoading('ƒêang c·∫≠p nh·∫≠t ng√¢n s√°ch...');
  
  google.script.run
    .withSuccessHandler(function(response) {
      console.log('Update budgets response:', response);
      
      hideLoading();
      
      if (response.success) {
        showToast('‚úÖ ' + response.message + ' (' + response.updated + ' ng√¢n s√°ch)', 'success');
        
        // Reload data
        loadSheetData('Ng√¢n s√°ch').then(function(data) {
          console.log('Reloaded budget data:', data);
          allBudgetData = data || [];
          budgetFilteredData = allBudgetData.slice();
          renderBudgetPage();
        });
      } else {
        showToast(response.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Update budgets error:', error);
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('updateAllBudgets', {month: currentMonth});
}

// ========== EXCEL TEMPLATE ==========
function downloadBudgetTemplate() {
  var wb = XLSX.utils.book_new();
  
  var wsData = [
    ['Th√°ng', 'Danh m·ª•c', 'Danh m·ª•c con', 'K·∫ø ho·∫°ch', 'Chi ti√™u'],
    ['2025-10', 'food', 'ƒÇn s√°ng', 5000000, 3000000],
    ['2025-10', 'transport', 'XƒÉng xe', 2000000, 1500000],
    ['2025-10', 'shopping', 'Qu·∫ßn √°o', 3000000, 0]
  ];
  
  var ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [
    { wch: 12 },  // Th√°ng
    { wch: 15 },  // Danh m·ª•c
    { wch: 15 },  // Danh m·ª•c con
    { wch: 15 },  // K·∫ø ho·∫°ch
    { wch: 15 }   // Chi ti√™u
  ];
  
  XLSX.utils.book_append_sheet(wb, ws, 'Budget_Template');
  
  var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  var blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  
  var link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'Budget_Template.xlsx';
  link.click();
  
  showToast('ƒê√£ t·∫£i xu·ªëng file m·∫´u Excel', 'success');
}

// ========== IMPORT EXCEL ==========
function openBudgetImportModal() {
  var body = '<div class="form-group">' +
    '<label>Ch·ªçn file Excel/CSV</label>' +
    '<input type="file" id="budgetImportFile" accept=".xlsx,.xls,.csv" class="form-control">' +
    '<small style="color: #718096; margin-top: 5px; display: block;">ƒê·ªãnh d·∫°ng: XLSX, XLS, CSV</small>' +
    '<small style="color: #718096; margin-top: 5px; display: block;">C·∫•u tr√∫c: Th√°ng | Danh m·ª•c | K·∫ø ho·∫°ch</small>' +
    '<div style="margin-top: 10px; padding: 10px; background: #fffbeb; border-left: 3px solid #f59e0b; border-radius: 4px;">' +
    '<strong>L∆∞u √Ω:</strong><br>' +
    '<ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">' +
    '<li>Th√°ng: ƒê·ªãnh d·∫°ng YYYY-MM (VD: 2025-10)</li>' +
    '<li>Danh m·ª•c: food, transport, shopping, education, health, entertainment, other</li>' +
    '<li>K·∫ø ho·∫°ch: S·ªë nguy√™n (VD: 5000000)</li>' +
    '</ul>' +
    '</div>' +
    '</div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-primary" onclick="processBudgetImport()">Import</button>';
  
  openModal('Import d·ªØ li·ªáu Ng√¢n s√°ch', body, footer);
}

function processBudgetImport() {
  var fileInput = document.getElementById('budgetImportFile');
  
  if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
    showToast('Vui l√≤ng ch·ªçn file', 'error');
    return;
  }
  
  var file = fileInput.files[0];
  var reader = new FileReader();
  
  closeModal();
  showLoading();
  
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, { type: 'array' });
      var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      var jsonData = XLSX.utils.sheet_to_json(firstSheet);
      
      if (jsonData.length === 0) {
        hideLoading();
        showToast('File kh√¥ng c√≥ d·ªØ li·ªáu', 'error');
        return;
      }
      
      var successCount = 0;
      var errorCount = 0;
      
      function processRow(index) {
        if (index >= jsonData.length) {
          hideLoading();
          
          if (successCount > 0) {
          showToast('Import th√†nh c√¥ng ' + successCount + ' / ' + jsonData.length + ' b·∫£n ghi', 'success');
          
          console.log('Reloading budget data after import...');
          
          // Force full reload
          setTimeout(function() {
            showLoading();
            
            loadSheetData('Ng√¢n s√°ch').then(function(data) {
              console.log('‚úÖ Budget data after import:', data);
              console.log('Records count:', data ? data.length : 0);
              
              if (!data || data.length === 0) {
                console.warn('‚ö†Ô∏è No data returned after import');
              }
              
              allBudgetData = data || [];
              budgetFilteredData = allBudgetData.slice();
              budgetCurrentPage = 1;
              
              hideLoading();
              renderBudgetPage();
              
              console.log('‚úÖ Budget page rendered after import');
              console.log('budgetFilteredData:', budgetFilteredData.length);
            }).catch(function(error) {
              console.error('‚ùå Reload error after import:', error);
              hideLoading();
              showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
            });
          }, 2000); // TƒÉng l√™n 2s
          } else {
            showToast('Kh√¥ng c√≥ b·∫£n ghi n√†o ƒë∆∞·ª£c import', 'error');
          }
          
          if (errorCount > 0) {
            showToast('C√≥ ' + errorCount + ' l·ªói', 'error');
          }
          
          return;
        }
        
        var row = jsonData[index];

        console.log('Processing row', index, ':', row);

        // Validate required fields
        if (!row['Th√°ng'] || !row['Danh m·ª•c']) {
          console.error('Row', index, 'missing Th√°ng or Danh m·ª•c');
          errorCount++;
          processRow(index + 1);
          return;
        }

        // Set default values
        var planned = parseFloat(row['K·∫ø ho·∫°ch']) || 0;
        var spent = parseFloat(row['Chi ti√™u']) || 0;
        var subcategory = row['Danh m·ª•c con'] || '';

        if (planned <= 0) {
          console.error('Row', index, 'invalid K·∫ø ho·∫°ch:', planned);
          errorCount++;
          processRow(index + 1);
          return;
        }

        var remaining = planned - spent;
        var percentage = planned > 0 ? Math.round((spent / planned) * 100) : 0;
        var ratio = planned > 0 ? spent / planned : 0;

        var status = 'on-track';
        var alerts = [];

        if (percentage >= 100) {
          status = 'exceeded';
          alerts.push('ƒê√£ v∆∞·ª£t ng√¢n s√°ch');
        } else if (percentage >= 90) {
          status = 'warning';
          alerts.push('S·∫Øp v∆∞·ª£t ng√¢n s√°ch');
        }

        var categoryName = getCategoryLabel(row['Danh m·ª•c']);
        if (subcategory) {
          categoryName += ' - ' + subcategory;
        }

        var recordData = {
          'ID': generateId('NS'),
          'UserID': currentUser.userId,
          'Th√°ng': row['Th√°ng'],
          'Danh m·ª•c ID': JSON.stringify([{
            id: row['Danh m·ª•c'], 
            name: getCategoryLabel(row['Danh m·ª•c']),
            subcategory: subcategory
          }]),
          'K·∫ø ho·∫°ch': planned,
          'Chi ti√™u': spent,
          'Ch√™nh l·ªách': ratio,
          'Metadata': JSON.stringify({
            categoryName: categoryName,
            remaining: remaining,
            percentage: percentage,
            status: status,
            alerts: alerts,
            history: []
          })
        };

        console.log('Record data:', recordData);
        
        var recordData = {
          'ID': generateId('NS'),
          'UserID': currentUser.userId,
          'Th√°ng': row['Th√°ng'],
          'Danh m·ª•c ID': JSON.stringify([{
            id: row['Danh m·ª•c'], 
            name: getCategoryLabel(row['Danh m·ª•c'])
          }]),
          'K·∫ø ho·∫°ch': parseFloat(row['K·∫ø ho·∫°ch']),
          'Chi ti√™u': 0,
          'Ch√™nh l·ªách': 0,
          'Metadata': JSON.stringify({
            categoryName: getCategoryLabel(row['Danh m·ª•c']),
            remaining: parseFloat(row['K·∫ø ho·∫°ch']),
            percentage: 0,
            status: 'on-track',
            alerts: [],
            history: []
          })
        };
        
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              successCount++;
            } else {
              errorCount++;
            }
            processRow(index + 1);
          })
          .withFailureHandler(function(error) {
            errorCount++;
            processRow(index + 1);
          })
          .handleRequest('createRecord', {
            sheetName: 'Ng√¢n s√°ch',
            data: recordData
          });
      }
      
      processRow(0);
      
    } catch (error) {
      hideLoading();
      showToast('L·ªói ƒë·ªçc file: ' + error.message, 'error');
    }
  };
  
  reader.onerror = function() {
    hideLoading();
    showToast('L·ªói ƒë·ªçc file', 'error');
  };
  
  reader.readAsArrayBuffer(file);
}

// ========== INITIALIZATION ==========
window.onload = function() {
  console.log('App initialized');
  
  var loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      handleLogin();
    });
  }
  
  initNavigation();
};

// ========== TRANSFER MONEY BETWEEN ACCOUNTS ==========
function openTransferModal() {
  if (!allAccountsData || allAccountsData.length < 2) {
    showToast('C·∫ßn √≠t nh·∫•t 2 t√†i kho·∫£n ƒë·ªÉ chuy·ªÉn ti·ªÅn', 'error');
    return;
  }
  
  var accountOptions = '<option value="">-- Ch·ªçn t√†i kho·∫£n --</option>';
  
  for (var i = 0; i < allAccountsData.length; i++) {
    var acc = allAccountsData[i];
    accountOptions += '<option value="' + acc.AccountID + '">' + 
      acc['T√™n t√†i kho·∫£n'] + ' (' + formatCurrency(acc['S·ªë d∆∞ hi·ªán t·∫°i']) + ' ƒë)</option>';
  }
  
  var body = '<div class="form-group">' +
    '<label><i class="fas fa-arrow-up"></i> T·ª´ t√†i kho·∫£n</label>' +
    '<select id="transferFromAccount" class="form-control">' + accountOptions + '</select>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-arrow-down"></i> ƒê·∫øn t√†i kho·∫£n</label>' +
    '<select id="transferToAccount" class="form-control">' + accountOptions + '</select>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-money-bill-wave"></i> S·ªë ti·ªÅn (VNƒê)</label>' +
    '<input type="text" id="transferAmount" class="form-control currency-input" value="0">' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-comment"></i> M√¥ t·∫£ (t√πy ch·ªçn)</label>' +
    '<textarea id="transferDescription" class="form-control" rows="2" placeholder="Ghi ch√∫ v·ªÅ giao d·ªãch..."></textarea>' +
    '</div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-warning" onclick="processTransfer()"><i class="fas fa-exchange-alt"></i> Chuy·ªÉn ti·ªÅn</button>';
  
  openModal('Chuy·ªÉn ti·ªÅn gi·ªØa t√†i kho·∫£n', body, footer);
  
  setTimeout(function() { 
    setupCurrencyInput(document.getElementById('transferAmount')); 
  }, 100);
}

function processTransfer() {
  var fromAccountId = document.getElementById('transferFromAccount').value;
  var toAccountId = document.getElementById('transferToAccount').value;
  var amount = parseCurrency(document.getElementById('transferAmount').value);
  var description = document.getElementById('transferDescription').value || 'Chuy·ªÉn ti·ªÅn';
  
  if (!fromAccountId || !toAccountId) {
    showToast('Vui l√≤ng ch·ªçn t√†i kho·∫£n ngu·ªìn v√† ƒë√≠ch', 'error');
    return;
  }
  
  if (fromAccountId === toAccountId) {
    showToast('Kh√¥ng th·ªÉ chuy·ªÉn ƒë·∫øn c√πng t√†i kho·∫£n', 'error');
    return;
  }
  
  if (amount <= 0) {
    showToast('S·ªë ti·ªÅn ph·∫£i l·ªõn h∆°n 0', 'error');
    return;
  }
  
  // Ki·ªÉm tra s·ªë d∆∞
  var fromAccount = null;
  for (var i = 0; i < allAccountsData.length; i++) {
    if (allAccountsData[i].AccountID === fromAccountId) {
      fromAccount = allAccountsData[i];
      break;
    }
  }
  
  if (!fromAccount) {
    showToast('Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n ngu·ªìn', 'error');
    return;
  }
  
  if (amount > parseCurrency(fromAccount['S·ªë d∆∞ hi·ªán t·∫°i'])) {
    showToast('S·ªë d∆∞ t√†i kho·∫£n ngu·ªìn kh√¥ng ƒë·ªß', 'error');
    return;
  }
  
  closeModal();
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        // Reload accounts data
        loadSheetData('T√†i kho·∫£n').then(function(data) {
          allAccountsData = data;
          hideLoading();
          showAccountsPage();
          showToast('Chuy·ªÉn ti·ªÅn th√†nh c√¥ng!', 'success');
        }).catch(function(error) {
          hideLoading();
          showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
        });
      } else {
        hideLoading();
        showToast(response.message || 'Chuy·ªÉn ti·ªÅn th·∫•t b·∫°i', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('transferMoney', {
      fromAccountId: fromAccountId,
      toAccountId: toAccountId,
      amount: amount,
      description: description
    });
}

// ========== TEST CHART ==========
function testSimpleChart() {
  console.log('=== TESTING SIMPLE CHART ===');
  
  if (typeof Chart === 'undefined') {
    console.error('Chart.js not loaded!');
    return;
  }
  
  var canvas = document.getElementById('trendChart');
  if (!canvas) {
    console.error('Canvas not found!');
    return;
  }
  
  try {
    new Chart(canvas, {
      type: 'bar',
      data: {
        labels: ['A', 'B', 'C'],
        datasets: [{
          label: 'Test',
          data: [10, 20, 30],
          backgroundColor: '#3782f4'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
    
    console.log('‚úÖ Test chart rendered successfully!');
  } catch (error) {
    console.error('‚ùå Test chart failed:', error);
  }
}

// ========================================
// UTILITY FUNCTIONS v2.0
// ========================================

// Get current user ID
function getCurrentUserId() {
  return currentUser ? currentUser.userId : 'USR001';
}

// Render account options with balance
function renderAccountOptions(selectedId) {
  var html = '<option value="">-- Ch·ªçn t√†i kho·∫£n --</option>';
  
  const accounts = DataManager.getAccounts();
  
  if (!accounts || accounts.length === 0) {
    return html;
  }
  
  for (var i = 0; i < accounts.length; i++) {
    var acc = accounts[i];
    var selected = acc.AccountID === selectedId ? ' selected' : '';
    var balance = formatCurrency(acc['S·ªë d∆∞ hi·ªán t·∫°i']);
    
    html += '<option value="' + acc.AccountID + '"' + selected + '>' + 
            acc['T√™n t√†i kho·∫£n'] + ' (' + balance + ' ƒë)' +
            '</option>';
  }
  
  return html;
}

// Get account name by ID
function getAccountName(accountId) {
  if (!accountId) return 'N/A';
  
  const accounts = DataManager.getAccounts();
  const account = accounts.find(a => a.AccountID === accountId);
  
  return account ? account['T√™n t√†i kho·∫£n'] : 'N/A';
}

// Format currency with thousand separators
function formatCurrency(amount) {
  if (!amount && amount !== 0) return '0';
  return parseFloat(amount).toLocaleString('vi-VN');
}

// Parse currency string to number
function parseCurrency(value) {
  if (typeof value === 'number') return value;
  return parseFloat(value.toString().replace(/[,.]/g, '')) || 0;
}

// Setup currency input with auto-formatting
function setupCurrencyInput(inputElement) {
  if (!inputElement) return;
  
  inputElement.addEventListener('input', function(e) {
    var value = e.target.value.replace(/[^\d]/g, '');
    if (value) {
      e.target.value = formatCurrency(value);
    }
  });
  
  inputElement.addEventListener('focus', function(e) {
    var value = parseCurrency(e.target.value);
    if (value > 0) {
      e.target.value = value;
    }
  });
  
  inputElement.addEventListener('blur', function(e) {
    var value = parseCurrency(e.target.value);
    e.target.value = formatCurrency(value);
  });
}

// Generate unique ID
function generateId(prefix) {
  var timestamp = new Date().getTime();
  var random = Math.floor(Math.random() * 10000);
  return prefix + String(timestamp).slice(-8) + String(random).padStart(4, '0');
}

// Format date to DD/MM/YYYY
function formatDate(dateStr) {
  if (!dateStr) return '';
  var date = new Date(dateStr);
  var day = ('0' + date.getDate()).slice(-2);
  var month = ('0' + (date.getMonth() + 1)).slice(-2);
  var year = date.getFullYear();
  return day + '/' + month + '/' + year;
}

// Debounce function for search/filter
function debounce(func, wait) {
  var timeout;
  return function executedFunction() {
    var context = this;
    var args = arguments;
    var later = function() {
      timeout = null;
      func.apply(context, args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ========================================
// LOAN TABLE RENDERING - FULL IMPLEMENTATION
// ========================================
// Loan state variables
var allLoanData = [];
var loanFilteredData = [];
var loanCurrentPage = 1;
var loanItemsPerPage = 10;
var loanFilters = {
  fromDate: '',
  toDate: '',
  loanName: '',
  status: ''
};

/**
 * Show loan page - MAIN ENTRY POINT
 */
function showLoanPage() {
  console.log('=== SHOW LOAN PAGE ===');
  
  showLoading('ƒêang t·∫£i d·ªØ li·ªáu kho·∫£n vay...');
  
  // Load loan data
  if (DataManager && DataManager.isInitialized && DataManager.isInitialized()) {
    allLoanData = DataManager.getLoan();
    loanFilteredData = allLoanData.slice();
    hideLoading();
    renderLoanPage();
  } else {
    // Fallback: Load directly
    google.script.run
      .withSuccessHandler(function(response) {
        console.log('Loan data loaded:', response);
        
        if (response.success) {
          allLoanData = response.data || [];
          loanFilteredData = allLoanData.slice();
        } else {
          allLoanData = [];
          loanFilteredData = [];
          showToast('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu kho·∫£n vay', 'error');
        }
        
        hideLoading();
        renderLoanPage();
      })
      .withFailureHandler(function(error) {
        console.error('Load loan error:', error);
        hideLoading();
        showToast('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
        
        // Render empty page
        allLoanData = [];
        loanFilteredData = [];
        renderLoanPage();
      })
      .getRecords('Kho·∫£n vay');
  }
}

/**
 * Render loan page - FIXED VERSION
 */
function renderLoanPage() {
  console.log('=== RENDERING LOAN PAGE ===');
  
  document.getElementById('pageTitle').textContent = 'Kho·∫£n vay';
  
  // Apply filters DIRECTLY without calling applyLoanFilters()
  if (document.getElementById('loanFromDate')) {
    loanFilters.fromDate = document.getElementById('loanFromDate').value;
  }
  if (document.getElementById('loanToDate')) {
    loanFilters.toDate = document.getElementById('loanToDate').value;
  }
  if (document.getElementById('loanNameFilter')) {
    loanFilters.loanName = document.getElementById('loanNameFilter').value.toLowerCase();
  }
  if (document.getElementById('loanStatusFilter')) {
    loanFilters.status = document.getElementById('loanStatusFilter').value;
  }
  
  // Filter data
  loanFilteredData = allLoanData.filter(function(item) {
    var loanDate = item['Ng√†y vay'] || '';
    var loanName = (item['Danh m·ª•c vay'] || '').toLowerCase();
    var status = item['T√¨nh tr·∫°ng'] || 'active';
    
    if (loanFilters.fromDate && loanDate < loanFilters.fromDate) return false;
    if (loanFilters.toDate && loanDate > loanFilters.toDate) return false;
    if (loanFilters.loanName && loanName.indexOf(loanFilters.loanName) === -1) return false;
    if (loanFilters.status && status !== loanFilters.status) return false;
    
    return true;
  });
  
  var totalPages = Math.ceil(loanFilteredData.length / loanItemsPerPage);
  var startIndex = (loanCurrentPage - 1) * loanItemsPerPage;
  var endIndex = Math.min(startIndex + loanItemsPerPage, loanFilteredData.length);
  
  console.log('Total filtered:', loanFilteredData.length);
  console.log('Current page:', loanCurrentPage);
  console.log('Items per page:', loanItemsPerPage);
  console.log('Total pages:', totalPages);
  
  var html = 
    // Filter Section
    '<div class="card">' +
    '<div class="card-header">' +
    '<h3 class="card-title">Qu·∫£n l√Ω Kho·∫£n vay</h3>' +
    '<div style="display: flex; gap: 10px;">' +
    '<button class="btn-primary" onclick="downloadLoanTemplate()">' +
    '<i class="fas fa-download"></i> T·∫£i m·∫´u' +
    '</button>' +
    '<button class="btn-warning" onclick="openLoanImportModal()">' +
    '<i class="fas fa-file-import"></i> Import Excel' +
    '</button>' +
    '<button class="btn-success" onclick="exportLoanToExcel()">' +
    '<i class="fas fa-file-excel"></i> Xu·∫•t Excel' +
    '</button>' +
    '<button class="btn-primary" onclick="openLoanModal(null)">' +
    '<i class="fas fa-plus"></i> Th√™m kho·∫£n vay' +
    '</button>' +
    '</div>' +
    '</div>' +
    
    // Notifications container
    '<div id="loanNotifications"></div>' +
    
    // Filters
    '<div style="padding: 20px; background: #f9fafb; border-radius: 8px; margin-bottom: 20px;">' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">' +
    '<div>' +
    '<label style="display: block; font-size: 13px; font-weight: 500; color: #4a5568; margin-bottom: 5px;">T·ª´ ng√†y vay</label>' +
    '<input type="date" id="loanFromDate" class="form-control" value="' + loanFilters.fromDate + '" onchange="renderLoanPage()">' +
    '</div>' +
    '<div>' +
    '<label style="display: block; font-size: 13px; font-weight: 500; color: #4a5568; margin-bottom: 5px;">ƒê·∫øn ng√†y vay</label>' +
    '<input type="date" id="loanToDate" class="form-control" value="' + loanFilters.toDate + '" onchange="renderLoanPage()">' +
    '</div>' +
    '<div>' +
    '<label style="display: block; font-size: 13px; font-weight: 500; color: #4a5568; margin-bottom: 5px;">T√™n kho·∫£n vay</label>' +
    '<input type="text" id="loanNameFilter" class="form-control" placeholder="T√¨m theo t√™n..." value="' + loanFilters.loanName + '" oninput="renderLoanPage()">' +
    '</div>' +
    '<div>' +
    '<label style="display: block; font-size: 13px; font-weight: 500; color: #4a5568; margin-bottom: 5px;">T√¨nh tr·∫°ng</label>' +
    '<select id="loanStatusFilter" class="form-control" onchange="renderLoanPage()">' +
    '<option value="">T·∫•t c·∫£</option>' +
    '<option value="active"' + (loanFilters.status === 'active' ? ' selected' : '') + '>ƒêang vay</option>' +
    '<option value="completed"' + (loanFilters.status === 'completed' ? ' selected' : '') + '>ƒê√£ tr·∫£ h·∫øt</option>' +
    '<option value="overdue"' + (loanFilters.status === 'overdue' ? ' selected' : '') + '>Qu√° h·∫°n</option>' +
    '</select>' +
    '</div>' +
    '</div>' +
    '<div style="text-align: right;">' +
    '<button class="btn-secondary btn-sm" onclick="clearLoanFilters()">' +
    '<i class="fas fa-times"></i> X√≥a b·ªô l·ªçc' +
    '</button>' +
    '</div>' +
    '</div>' +
    
    // Summary cards
    renderLoanSummary() +
    
    // Table
    '<div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">' +
    '<div style="color: #6b7280; font-size: 14px;">Hi·ªÉn th·ªã ' + 
    (loanFilteredData.length === 0 ? 0 : (startIndex + 1)) + '-' + endIndex + ' trong t·ªïng s·ªë ' + loanFilteredData.length + ' b·∫£n ghi</div>' +
    '<div style="display: flex; align-items: center; gap: 10px;">' +
    '<label style="font-size: 14px; color: #4a5568;">Hi·ªÉn th·ªã:</label>' +
    '<select class="form-control" style="width: 80px; padding: 6px 10px;" onchange="changeLoanItemsPerPage(this.value)">' +
    '<option value="10"' + (loanItemsPerPage === 10 ? ' selected' : '') + '>10</option>' +
    '<option value="20"' + (loanItemsPerPage === 20 ? ' selected' : '') + '>20</option>' +
    '<option value="50"' + (loanItemsPerPage === 50 ? ' selected' : '') + '>50</option>' +
    '<option value="100"' + (loanItemsPerPage === 100 ? ' selected' : '') + '>100</option>' +
    '</select>' +
    '</div>' +
    '</div>' +
    
    '<div style="overflow-x: auto; max-height: calc(100vh - 400px); overflow-y: auto;">' +
    '<table>' +
    '<thead>' +
    '<tr>' +
    '<th class="sticky-column" style="min-width: 180px;">DANH M·ª§C VAY</th>' +
    '<th style="min-width: 120px;">NG√ÄY VAY</th>' +
    '<th style="min-width: 120px;">H·∫†N TR·∫¢</th>' +
    '<th style="min-width: 140px;">GI√Å TR·ªä VAY</th>' +
    '<th style="min-width: 100px;">L√ÉI SU·∫§T</th>' +
    '<th style="min-width: 140px;">G·ªêC/TH√ÅNG</th>' +
    '<th style="min-width: 140px;">L√ÉI/TH√ÅNG</th>' +
    '<th style="min-width: 160px;">G·ªêC ƒê√É TR·∫¢</th>' +
    '<th style="min-width: 140px;">C√íN L·∫†I</th>' +
    '<th style="min-width: 120px;">T√åNH TR·∫†NG</th>' +
    '<th style="min-width: 180px;">H√ÄNH ƒê·ªòNG</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody>' +
    renderLoanTableWithPagination() +
    '</tbody>' +
    '</table>' +
    '</div>' +
    
    // Pagination
    renderLoanPagination(totalPages) +
    
    '</div>';
  
  document.getElementById('contentWrapper').innerHTML = html;
  
  console.log('‚úÖ Loan page rendered');
  
  // Check and display notifications
  checkLoanNotifications();
}
/**
 * Render loan summary cards
 */
function renderLoanSummary() {
  var totalPrincipal = 0;
  var totalMonthlyPayment = 0;
  var totalInterest = 0;
  var totalPaid = 0;
  var totalRemaining = 0;
  
  for (var i = 0; i < loanFilteredData.length; i++) {
    var principal = parseCurrency(loanFilteredData[i]['Gi√° tr·ªã vay']);
    var monthlyPrincipal = parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng']);
    var monthlyInterest = parseCurrency(loanFilteredData[i]['Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng']);
    var paid = parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']);
    var remaining = parseCurrency(loanFilteredData[i]['Ti·ªÅn vay c√≤n l·∫°i']);
    
    totalPrincipal += principal;
    totalMonthlyPayment += (monthlyPrincipal + monthlyInterest);
    totalInterest += monthlyInterest;
    totalPaid += paid;
    totalRemaining += remaining;
  }
  
  var paymentPercent = totalPrincipal > 0 ? Math.round((totalPaid / totalPrincipal) * 100) : 0;
  
  return '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">' +
    '<div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px; color: white;">' +
    '<i class="fas fa-calculator" style="font-size: 24px; margin-right: 10px;"></i>' +
    '<h3 style="margin: 0; font-size: 18px;">T·ªîNG H·ª¢P KHO·∫¢N VAY</h3>' +
    '</div>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">T·ªïng gi√° tr·ªã vay</div>' +
    '<div style="color: white; font-size: 20px; font-weight: 700;">' + formatCurrency(totalPrincipal) + ' ƒë</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">Tr·∫£/th√°ng</div>' +
    '<div style="color: white; font-size: 20px; font-weight: 700;">' + formatCurrency(totalMonthlyPayment) + ' ƒë</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">L√£i/th√°ng</div>' +
    '<div style="color: white; font-size: 20px; font-weight: 700;">' + formatCurrency(totalInterest) + ' ƒë</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">G·ªëc ƒë√£ tr·∫£</div>' +
    '<div style="color: #4ade80; font-size: 20px; font-weight: 700;">' + formatCurrency(totalPaid) + ' ƒë</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">C√≤n l·∫°i</div>' +
    '<div style="color: #fbbf24; font-size: 20px; font-weight: 700;">' + formatCurrency(totalRemaining) + ' ƒë</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 5px;">T·ª∑ l·ªá ho√†n th√†nh</div>' +
    '<div style="color: white; font-size: 20px; font-weight: 700;">' + paymentPercent + '%</div>' +
    '</div>' +
    '</div>' +
    '</div>';
}

/**
 * Apply loan filters
 */
function applyLoanFilters() {
  loanFilters.fromDate = document.getElementById('loanFromDate') ? document.getElementById('loanFromDate').value : '';
  loanFilters.toDate = document.getElementById('loanToDate') ? document.getElementById('loanToDate').value : '';
  loanFilters.loanName = document.getElementById('loanNameFilter') ? document.getElementById('loanNameFilter').value.toLowerCase() : '';
  loanFilters.status = document.getElementById('loanStatusFilter') ? document.getElementById('loanStatusFilter').value : '';
  
  loanFilteredData = allLoanData.filter(function(item) {
    var loanDate = item['Ng√†y vay'] || '';
    var loanName = (item['Danh m·ª•c vay'] || '').toLowerCase();
    var status = item['T√¨nh tr·∫°ng'] || 'active';
    
    if (loanFilters.fromDate && loanDate < loanFilters.fromDate) return false;
    if (loanFilters.toDate && loanDate > loanFilters.toDate) return false;
    if (loanFilters.loanName && loanName.indexOf(loanFilters.loanName) === -1) return false;
    if (loanFilters.status && status !== loanFilters.status) return false;
    
    return true;
  });
  
  loanCurrentPage = 1;
}

/**
 * Clear loan filters
 */
function clearLoanFilters() {
  loanFilters = {
    fromDate: '',
    toDate: '',
    loanName: '',
    status: ''
  };
  
  // Reset input fields if exist
  if (document.getElementById('loanFromDate')) document.getElementById('loanFromDate').value = '';
  if (document.getElementById('loanToDate')) document.getElementById('loanToDate').value = '';
  if (document.getElementById('loanNameFilter')) document.getElementById('loanNameFilter').value = '';
  if (document.getElementById('loanStatusFilter')) document.getElementById('loanStatusFilter').value = '';
  
  loanFilteredData = allLoanData.slice();
  loanCurrentPage = 1;
  
  renderLoanPage();
}

/**
 * Change items per page
 */
function changeLoanItemsPerPage(value) {
  loanItemsPerPage = parseInt(value);
  loanCurrentPage = 1;
  renderLoanPage();
}

/**
 * Go to specific page
 * @param {number} page - Page number
 */
function loanGoToPage(page) {
  loanCurrentPage = page;
  renderLoanPage();
  window.scrollTo(0, 0);
}


/**
 * Render loan table with pagination + TOTALS ROW
 * @return {string} HTML table rows
 */
function renderLoanTableWithPagination() {
  console.log('Rendering loan table, filtered data:', loanFilteredData.length);
  
  if (!loanFilteredData || loanFilteredData.length === 0) {
    return '<tr><td colspan="11" class="text-center" style="padding: 40px; color: #9ca3af;">' +
      '<i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>' +
      '<div>Ch∆∞a c√≥ kho·∫£n vay n√†o</div>' +
      '</td></tr>';
  }
  
  var startIndex = (loanCurrentPage - 1) * loanItemsPerPage;
  var endIndex = Math.min(startIndex + loanItemsPerPage, loanFilteredData.length);
  
  console.log('Rendering from', startIndex, 'to', endIndex);
  
  // Calculate totals for ALL filtered data (not just current page)
  var totalPrincipal = 0;
  var totalMonthlyPrincipal = 0;
  var totalMonthlyInterest = 0;
  var totalPaidPrincipal = 0;
  var totalRemaining = 0;
  
  for (var i = 0; i < loanFilteredData.length; i++) {
    totalPrincipal += parseCurrency(loanFilteredData[i]['Gi√° tr·ªã vay']);
    totalMonthlyPrincipal += parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng']);
    totalMonthlyInterest += parseCurrency(loanFilteredData[i]['Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng']);
    totalPaidPrincipal += parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']);
    totalRemaining += parseCurrency(loanFilteredData[i]['Ti·ªÅn vay c√≤n l·∫°i']);
  }
  
  var html = '';
  
  // Render data rows
  for (var i = startIndex; i < endIndex; i++) {
    var item = loanFilteredData[i];
    var id = item.ID || 'N/A';
    
    console.log('Rendering loan item:', item);
    
    // Parse values
    var loanName = item['Danh m·ª•c vay'] || 'N/A';
    var loanDate = item['Ng√†y vay'] || '';
    var dueDate = item['H·∫°n tr·∫£ vay'] || '';
    var principal = parseCurrency(item['Gi√° tr·ªã vay']);
    var annualRate = parseFloat(item['L√£i su·∫•t vay/nƒÉm']) || 0;
    var monthlyPrincipal = parseCurrency(item['Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng']);
    var monthlyInterest = parseCurrency(item['Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng']);
    var paidPrincipal = parseCurrency(item['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']);
    var remaining = parseCurrency(item['Ti·ªÅn vay c√≤n l·∫°i']);
    var status = item['T√¨nh tr·∫°ng'] || 'active';
    
    // Status badge
    var statusBadge = 'badge-info';
    var statusText = 'ƒêang vay';
    var statusIcon = 'fa-clock';
    
    if (status === 'completed') {
      statusBadge = 'badge-success';
      statusText = 'ƒê√£ tr·∫£ h·∫øt';
      statusIcon = 'fa-check-circle';
    } else if (status === 'overdue') {
      statusBadge = 'badge-danger';
      statusText = 'Qu√° h·∫°n';
      statusIcon = 'fa-exclamation-triangle';
    }
    
    // Progress calculation
    var progress = principal > 0 ? Math.round((paidPrincipal / principal) * 100) : 0;
    var progressColor = progress >= 100 ? '#24c560' : progress >= 75 ? '#3782f4' : progress >= 50 ? '#f59e0b' : '#e94849';
    
    html += '<tr>' +
      // Danh m·ª•c vay (sticky column)
      '<td class="sticky-column" style="font-weight: 600;">' + loanName + '</td>' +
      
      // Ng√†y vay
      '<td>' + formatDate(loanDate) + '</td>' +
      
      // H·∫°n tr·∫£
      '<td>' + formatDate(dueDate) + '</td>' +
      
      // Gi√° tr·ªã vay
      '<td style="color: #e94849; font-weight: 600;">' + formatCurrency(principal) + ' ƒë</td>' +
      
      // L√£i su·∫•t
      '<td>' + annualRate.toFixed(2) + '%/nƒÉm</td>' +
      
      // G·ªëc/th√°ng
      '<td style="color: #3782f4; font-weight: 600;">' + formatCurrency(monthlyPrincipal) + ' ƒë</td>' +
      
      // L√£i/th√°ng
      '<td style="color: #f59e0b; font-weight: 600;">' + formatCurrency(monthlyInterest) + ' ƒë</td>' +
      
      // G·ªëc ƒë√£ tr·∫£ + Progress bar
      '<td>' +
      '<div style="margin-bottom: 5px; font-weight: 600; color: #24c560;">' + formatCurrency(paidPrincipal) + ' ƒë</div>' +
      '<div style="width: 100%; background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden;">' +
      '<div style="background: ' + progressColor + '; width: ' + Math.min(progress, 100) + '%; height: 100%;"></div>' +
      '</div>' +
      '<div style="font-size: 11px; color: #718096; margin-top: 2px;">' + progress + '%</div>' +
      '</td>' +
      
      // C√≤n l·∫°i
      '<td style="color: ' + (remaining > 0 ? '#e94849' : '#24c560') + '; font-weight: 600;">' + 
      formatCurrency(remaining) + ' ƒë</td>' +
      
      // T√¨nh tr·∫°ng
      '<td>' +
      '<span class="badge ' + statusBadge + '">' +
      '<i class="fas ' + statusIcon + '"></i> ' + statusText +
      '</span>' +
      '</td>' +
      
      // H√†nh ƒë·ªông
      '<td class="action-buttons" style="white-space: nowrap;">' +
      '<button class="btn-primary btn-sm" onclick="viewLoanDetails(\'' + id + '\')" title="Xem chi ti·∫øt">' +
      '<i class="fas fa-eye"></i>' +
      '</button>' +
      '<button class="btn-success btn-sm" onclick="markPayment(\'' + id + '\')" title="Thanh to√°n">' +
      '<i class="fas fa-money-bill"></i>' +
      '</button>' +
      '<button class="btn-warning btn-sm" onclick="editLoan(\'' + id + '\')" title="S·ª≠a">' +
      '<i class="fas fa-edit"></i>' +
      '</button>' +
      '<button class="btn-danger btn-sm" onclick="confirmDeleteLoan(\'' + id + '\')" title="X√≥a">' +
      '<i class="fas fa-trash"></i>' +
      '</button>' +
      '</td>' +
      '</tr>';
  }
  
  // TOTALS ROW
  html += '<tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; border-top: 3px solid #667eea;">' +
    '<td class="sticky-column" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700;">' +
    '<i class="fas fa-calculator"></i> T·ªîNG C·ªòNG' +
    '</td>' +
    '<td colspan="2" style="text-align: center;">' + loanFilteredData.length + ' kho·∫£n</td>' +
    '<td style="font-size: 15px;">' + formatCurrency(totalPrincipal) + ' ƒë</td>' +
    '<td></td>' +
    '<td style="font-size: 15px;">' + formatCurrency(totalMonthlyPrincipal) + ' ƒë</td>' +
    '<td style="font-size: 15px;">' + formatCurrency(totalMonthlyInterest) + ' ƒë</td>' +
    '<td style="font-size: 15px;">' + formatCurrency(totalPaidPrincipal) + ' ƒë</td>' +
    '<td style="font-size: 15px;">' + formatCurrency(totalRemaining) + ' ƒë</td>' +
    '<td colspan="2"></td>' +
    '</tr>';
  
  return html;
}

/**
 * Render loan pagination controls
 * @param {number} totalPages - Total number of pages
 * @return {string} HTML pagination
 */
function renderLoanPagination(totalPages) {
  if (totalPages <= 1) return '';
  
  var html = '<div style="display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px;">';
  
  // Previous button
  html += '<button class="btn-secondary btn-sm" onclick="loanGoToPage(' + (loanCurrentPage - 1) + ')" ' + 
    (loanCurrentPage === 1 ? 'disabled' : '') + '>' +
    '<i class="fas fa-chevron-left"></i>' +
    '</button>';
  
  // Page numbers
  var startPage = Math.max(1, loanCurrentPage - 2);
  var endPage = Math.min(totalPages, loanCurrentPage + 2);
  
  if (startPage > 1) {
    html += '<button class="btn-secondary btn-sm" onclick="loanGoToPage(1)">1</button>';
    if (startPage > 2) html += '<span style="padding: 0 10px; color: #718096;">...</span>';
  }
  
  for (var i = startPage; i <= endPage; i++) {
    if (i === loanCurrentPage) {
      html += '<button class="btn-primary btn-sm" disabled>' + i + '</button>';
    } else {
      html += '<button class="btn-secondary btn-sm" onclick="loanGoToPage(' + i + ')">' + i + '</button>';
    }
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span style="padding: 0 10px; color: #718096;">...</span>';
    html += '<button class="btn-secondary btn-sm" onclick="loanGoToPage(' + totalPages + ')">' + totalPages + '</button>';
  }
  
  // Next button
  html += '<button class="btn-secondary btn-sm" onclick="loanGoToPage(' + (loanCurrentPage + 1) + ')" ' + 
    (loanCurrentPage === totalPages ? 'disabled' : '') + '>' +
    '<i class="fas fa-chevron-right"></i>' +
    '</button>';
  
  html += '</div>';
  
  return html;
}

// ========================================
// LOAN MODAL - ADD/EDIT WITH CALCULATOR
// ========================================

/**
 * Open loan modal for add/edit
 * @param {string} id - Loan ID (null for add new)
 */
function openLoanModal(id) {
  console.log('=== OPENING LOAN MODAL ===', id ? 'EDIT' : 'CREATE');
  
  var isEdit = !!id;
  var item = {};
  
  if (isEdit) {
    const loanList = DataManager.isInitialized && DataManager.isInitialized() ? 
      DataManager.getLoan() : allLoanData;
    item = loanList.find(function(i) { return i.ID === id; }) || {};
    
    if (!item.ID) {
      showToast('Kh√¥ng t√¨m th·∫•y kho·∫£n vay', 'error');
      return;
    }
  }
  
  // Parse existing data
  var loanName = item['Danh m·ª•c vay'] || '';
  var loanDate = item['Ng√†y vay'] || new Date().toISOString().split('T')[0];
  var principal = isEdit ? parseCurrency(item['Gi√° tr·ªã vay']) : 0;
  var annualRate = isEdit ? parseFloat(item['L√£i su·∫•t vay/nƒÉm']) : 0;
  var months = 12; // Default
  var interestType = 'declining'; // Default
  
  // Parse details to get months and interest type
  if (isEdit && item['Chi ti·∫øt kho·∫£n vay']) {
    try {
      var details = typeof item['Chi ti·∫øt kho·∫£n vay'] === 'string' ? 
        JSON.parse(item['Chi ti·∫øt kho·∫£n vay']) : item['Chi ti·∫øt kho·∫£n vay'];
      
      if (details) {
        months = details.months || 12;
        interestType = details.interestType || 'declining';
      }
    } catch(e) {
      console.error('Parse details error:', e);
    }
  }
  
  // Build modal HTML
  var body = 
    '<form id="loanForm" onsubmit="handleSaveLoan(event, \'' + (id || '') + '\')">' +
    
    // Basic Info
    '<div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #3782f4;">' +
    '<h4 style="margin: 0 0 10px 0; color: #1e40af;"><i class="fas fa-info-circle"></i> Th√¥ng tin c∆° b·∫£n</h4>' +
    
    '<div class="form-row">' +
    '<div class="form-group">' +
    '<label><i class="fas fa-tag"></i> T√™n kho·∫£n vay <span style="color: red;">*</span></label>' +
    '<input type="text" id="loanName" name="Danh m·ª•c vay" class="form-control" value="' + loanName + '" ' +
    'placeholder="VD: Vay mua nh√†, Vay ti√™u d√πng..." required>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-calendar"></i> Ng√†y vay <span style="color: red;">*</span></label>' +
    '<input type="date" id="loanDate" name="Ng√†y vay" class="form-control" value="' + loanDate + '" required>' +
    '</div>' +
    '</div>' +
    
    '</div>' +
    
    // Loan Calculation
    '<div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #f59e0b;">' +
    '<h4 style="margin: 0 0 10px 0; color: #92400e;"><i class="fas fa-calculator"></i> T√≠nh to√°n kho·∫£n vay</h4>' +
    
    '<div class="form-row">' +
    '<div class="form-group">' +
    '<label><i class="fas fa-money-bill-wave"></i> S·ªë ti·ªÅn vay (VNƒê) <span style="color: red;">*</span></label>' +
    '<input type="text" id="loanPrincipal" class="form-control currency-input" value="' + 
    (isEdit ? formatCurrency(principal) : '0') + '" required oninput="calculateLoanPreview()">' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-percentage"></i> L√£i su·∫•t (%/nƒÉm) <span style="color: red;">*</span></label>' +
    '<input type="number" id="loanRate" class="form-control" value="' + annualRate + '" ' +
    'step="0.01" min="0" max="100" required oninput="calculateLoanPreview()">' +
    '</div>' +
    '</div>' +
    
    '<div class="form-row">' +
    '<div class="form-group">' +
    '<label><i class="fas fa-clock"></i> K·ª≥ h·∫°n (th√°ng) <span style="color: red;">*</span></label>' +
    '<input type="number" id="loanMonths" class="form-control" value="' + months + '" ' +
    'min="1" max="360" required oninput="calculateLoanPreview()">' +
    '<small style="color: #78350f;">T·ªëi ƒëa 360 th√°ng (30 nƒÉm)</small>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-chart-line"></i> H√¨nh th·ª©c l√£i su·∫•t <span style="color: red;">*</span></label>' +
    '<select id="loanInterestType" class="form-control" onchange="calculateLoanPreview()">' +
    '<option value="declining"' + (interestType === 'declining' ? ' selected' : '') + '>L√£i gi·∫£m d·∫ßn (Ph·ªï bi·∫øn nh·∫•t)</option>' +
    '<option value="simple"' + (interestType === 'simple' ? ' selected' : '') + '>L√£i ƒë∆°n</option>' +
    '<option value="compound"' + (interestType === 'compound' ? ' selected' : '') + '>L√£i k√©p</option>' +
    '</select>' +
    '<small id="interestTypeDescription" style="color: #78350f; display: block; margin-top: 5px;"></small>' +
    '</div>' +
    '</div>' +
    
    '</div>' +
    
    // Preview Results
    '<div id="loanPreview" style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #24c560; display: none;">' +
    '<h4 style="margin: 0 0 15px 0; color: #166534;"><i class="fas fa-chart-bar"></i> D·ª± t√≠nh tr·∫£ n·ª£</h4>' +
    
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">' +
    '<div style="background: white; padding: 12px; border-radius: 8px;">' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">G·ªëc h√†ng th√°ng</div>' +
    '<div id="previewMonthlyPrincipal" style="font-size: 18px; font-weight: 700; color: #3782f4;">0 ƒë</div>' +
    '</div>' +
    
    '<div style="background: white; padding: 12px; border-radius: 8px;">' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">L√£i h√†ng th√°ng</div>' +
    '<div id="previewMonthlyInterest" style="font-size: 18px; font-weight: 700; color: #f59e0b;">0 ƒë</div>' +
    '</div>' +
    
    '<div style="background: white; padding: 12px; border-radius: 8px;">' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">T·ªïng tr·∫£ h√†ng th√°ng</div>' +
    '<div id="previewMonthlyTotal" style="font-size: 18px; font-weight: 700; color: #24c560;">0 ƒë</div>' +
    '</div>' +
    
    '<div style="background: white; padding: 12px; border-radius: 8px;">' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">T·ªïng l√£i ph·∫£i tr·∫£</div>' +
    '<div id="previewTotalInterest" style="font-size: 18px; font-weight: 700; color: #e94849;">0 ƒë</div>' +
    '</div>' +
    '</div>' +
    
    '</div>' +
    
    // Important Notes
    '<div style="background: #fffbeb; padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b;">' +
    '<strong style="color: #92400e;"><i class="fas fa-lightbulb"></i> L∆∞u √Ω:</strong>' +
    '<ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: #78350f;">' +
    '<li><strong>L√£i gi·∫£m d·∫ßn:</strong> L√£i t√≠nh tr√™n s·ªë d∆∞ n·ª£ c√≤n l·∫°i ‚Üí Ph·ªï bi·∫øn nh·∫•t (ng√¢n h√†ng, mua nh√†)</li>' +
    '<li><strong>L√£i ƒë∆°n:</strong> L√£i t√≠nh c·ªë ƒë·ªãnh tr√™n g·ªëc ban ƒë·∫ßu ‚Üí D·ªÖ t√≠nh, ·ªïn ƒë·ªãnh</li>' +
    '<li><strong>L√£i k√©p:</strong> L√£i t√≠nh tr√™n c·∫£ g·ªëc + l√£i t√≠ch l≈©y ‚Üí Chi ph√≠ cao nh·∫•t</li>' +
    '<li>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o l·ªãch tr·∫£ n·ª£ chi ti·∫øt sau khi l∆∞u</li>' +
    '</ul>' +
    '</div>' +
    
    '</form>';
  
  var footer = 
    '<button type="button" class="btn-secondary" onclick="closeModal()">' +
    '<i class="fas fa-times"></i> H·ªßy' +
    '</button>' +
    '<button type="button" class="btn-primary" onclick="document.getElementById(\'loanForm\').requestSubmit()">' +
    '<i class="fas fa-save"></i> ' + (isEdit ? 'C·∫≠p nh·∫≠t' : 'T·∫°o kho·∫£n vay') +
    '</button>';
  
  openModal(
    isEdit ? '‚úèÔ∏è S·ª≠a kho·∫£n vay' : '‚ûï Th√™m kho·∫£n vay m·ªõi', 
    body, 
    footer
  );
  
  // Initialize after modal opens
  setTimeout(function() {
    console.log('üîß Initializing loan modal...');
    
    // Setup currency input
    setupCurrencyInput(document.getElementById('loanPrincipal'));
    
    // Calculate preview if editing
    if (isEdit) {
      calculateLoanPreview();
    }
    
    // Update interest type description
    updateInterestTypeDescription();
    
    // Focus first input
    document.getElementById('loanName').focus();
    
    console.log('‚úÖ Loan modal initialized');
  }, 100);
}

/**
 * Calculate loan preview in real-time
 */
function calculateLoanPreview() {
  var principal = parseCurrency(document.getElementById('loanPrincipal').value);
  var annualRate = parseFloat(document.getElementById('loanRate').value) || 0;
  var months = parseInt(document.getElementById('loanMonths').value) || 0;
  var interestType = document.getElementById('loanInterestType').value;
  
  if (principal <= 0 || months <= 0) {
    document.getElementById('loanPreview').style.display = 'none';
    return;
  }
  
  // Calculate based on interest type
  var monthlyPrincipal = 0;
  var monthlyInterest = 0;
  var totalInterest = 0;
  
  if (interestType === 'declining') {
    // L√£i gi·∫£m d·∫ßn: PMT formula
    if (annualRate === 0) {
      monthlyPrincipal = Math.round(principal / months);
      monthlyInterest = 0;
      totalInterest = 0;
    } else {
      var monthlyRate = annualRate / 12 / 100;
      var monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                          (Math.pow(1 + monthlyRate, months) - 1);
      
      monthlyPayment = Math.round(monthlyPayment);
      
      // Estimate average interest (first month)
      monthlyInterest = Math.round(principal * monthlyRate);
      monthlyPrincipal = monthlyPayment - monthlyInterest;
      
      // Total interest = total payment - principal
      totalInterest = Math.round(monthlyPayment * months - principal);
    }
    
  } else if (interestType === 'simple') {
    // L√£i ƒë∆°n
    totalInterest = Math.round(principal * (annualRate / 100) * (months / 12));
    var totalPayment = principal + totalInterest;
    var monthlyPayment = Math.round(totalPayment / months);
    monthlyPrincipal = Math.round(principal / months);
    monthlyInterest = Math.round(totalInterest / months);
    
  } else if (interestType === 'compound') {
    // L√£i k√©p
    var monthlyRate = annualRate / 12 / 100;
    var futureValue = principal * Math.pow(1 + monthlyRate, months);
    totalInterest = Math.round(futureValue - principal);
    var monthlyPayment = Math.round(futureValue / months);
    monthlyPrincipal = Math.round(principal / months);
    monthlyInterest = Math.round(totalInterest / months);
  }
  
  // Update UI
  document.getElementById('loanPreview').style.display = 'block';
  document.getElementById('previewMonthlyPrincipal').textContent = formatCurrency(monthlyPrincipal) + ' ƒë';
  document.getElementById('previewMonthlyInterest').textContent = formatCurrency(monthlyInterest) + ' ƒë';
  document.getElementById('previewMonthlyTotal').textContent = formatCurrency(monthlyPrincipal + monthlyInterest) + ' ƒë';
  document.getElementById('previewTotalInterest').textContent = formatCurrency(totalInterest) + ' ƒë';
  
  console.log('Preview calculated:', {
    principal: principal,
    rate: annualRate,
    months: months,
    type: interestType,
    monthlyPrincipal: monthlyPrincipal,
    monthlyInterest: monthlyInterest,
    totalInterest: totalInterest
  });
}

/**
 * Update interest type description
 */
function updateInterestTypeDescription() {
  var interestType = document.getElementById('loanInterestType').value;
  var desc = '';
  
  if (interestType === 'declining') {
    desc = '‚úÖ ƒê∆∞·ª£c khuy√™n d√πng - L√£i gi·∫£m d·∫ßn theo s·ªë n·ª£ c√≤n l·∫°i';
  } else if (interestType === 'simple') {
    desc = 'L√£i t√≠nh c·ªë ƒë·ªãnh tr√™n s·ªë g·ªëc ban ƒë·∫ßu';
  } else if (interestType === 'compound') {
    desc = '‚ö†Ô∏è Chi ph√≠ cao - L√£i t√≠nh tr√™n c·∫£ g·ªëc v√† l√£i t√≠ch l≈©y';
  }
  
  var descEl = document.getElementById('interestTypeDescription');
  if (descEl) {
    descEl.textContent = desc;
  }
  
  // Trigger preview recalculation
  calculateLoanPreview();
}

// ========================================
// SAVE LOAN - CREATE/UPDATE WITH SCHEDULE
// ========================================

/**
 * Handle save loan (create or update)
 * @param {Event} event - Form submit event
 * @param {string} id - Loan ID (empty for create)
 */
async function handleSaveLoan(event, id) {
  event.preventDefault();
  
  console.log('=== SAVING LOAN ===', id ? 'UPDATE' : 'CREATE');
  
  // Collect form data
  var loanName = document.getElementById('loanName').value.trim();
  var loanDate = document.getElementById('loanDate').value;
  var principal = parseCurrency(document.getElementById('loanPrincipal').value);
  var annualRate = parseFloat(document.getElementById('loanRate').value);
  var months = parseInt(document.getElementById('loanMonths').value);
  var interestType = document.getElementById('loanInterestType').value;
  
  // Validate
  if (!loanName || !loanDate || principal <= 0 || annualRate < 0 || months <= 0) {
    showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
    return;
  }
  
  console.log('Loan data:', {
    name: loanName,
    date: loanDate,
    principal: principal,
    rate: annualRate,
    months: months,
    type: interestType
  });
  
  closeModal();
  showLoading('ƒêang t√≠nh to√°n l·ªãch tr·∫£ n·ª£...');
  
  try {
    // Step 1: Calculate loan schedule from backend
    console.log('Step 1: Calling backend to calculate schedule...');
    
    const scheduleResponse = await new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .handleRequest('calculateLoanSchedule', {
          loanData: {
            principal: principal,
            annualRate: annualRate,
            months: months,
            interestType: interestType,
            startDate: loanDate
          }
        });
    });
    
    console.log('Schedule response:', scheduleResponse);
    
    if (!scheduleResponse.success) {
      throw new Error(scheduleResponse.message || 'Kh√¥ng th·ªÉ t√≠nh l·ªãch tr·∫£ n·ª£');
    }
    
    const schedule = scheduleResponse.data;
    console.log('Schedule calculated:', schedule.length, 'periods');
    
    // Calculate monthly amounts from schedule
    var firstPeriod = schedule[0];
    var monthlyPrincipal = firstPeriod.principalPayment || 0;
    var monthlyInterest = firstPeriod.interestPayment || 0;
    
    // Calculate due date (last period)
    var lastPeriod = schedule[schedule.length - 1];
    var dueDate = lastPeriod.dueDate;
    
    console.log('Calculated:', {
      monthlyPrincipal: monthlyPrincipal,
      monthlyInterest: monthlyInterest,
      dueDate: dueDate
    });
    
    // Step 2: Build record data
    var recordData = {
      'ID': id || generateId('KV'),
      'UserID': currentUser.userId,
      'Ng√†y vay': loanDate,
      'H·∫°n tr·∫£ vay': dueDate,
      'Danh m·ª•c vay': loanName,
      'Gi√° tr·ªã vay': principal,
      'L√£i su·∫•t vay/nƒÉm': annualRate,
      'Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng': monthlyPrincipal,
      'Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng': monthlyInterest,
      'Ti·ªÅn g·ªëc ƒë√£ tr·∫£': 0,
      'Ti·ªÅn vay c√≤n l·∫°i': principal,
      'T√¨nh tr·∫°ng': 'active',
      'Chi ti·∫øt kho·∫£n vay': JSON.stringify({
        months: months,
        interestType: interestType,
        schedule: schedule,
        createdAt: new Date().toISOString()
      })
    };
    
    console.log('Record data:', recordData);
    
    // Step 3: Save to backend
    console.log('Step 2: Saving to backend...');
    
    var action = id ? 'updateRecord' : 'createRecord';
    var params = id ? 
      {sheetName: 'Kho·∫£n vay', id: id, data: recordData} : 
      {sheetName: 'Kho·∫£n vay', data: recordData};
    
    const saveResponse = await new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .handleRequest(action, params);
    });
    
    console.log('Save response:', saveResponse);
    
    if (!saveResponse.success) {
      throw new Error(saveResponse.message || 'Kh√¥ng th·ªÉ l∆∞u kho·∫£n vay');
    }
    
    // Step 4: Reload data
    console.log('Step 3: Reloading loan data...');
    await reloadLoanData();
    
    hideLoading();
    showToast('‚úÖ ƒê√£ ' + (id ? 'c·∫≠p nh·∫≠t' : 't·∫°o') + ' kho·∫£n vay th√†nh c√¥ng!', 'success');
    
    console.log('‚úÖ Save loan completed');
    
  } catch (error) {
    console.error('‚ùå Save loan error:', error);
    hideLoading();
    showToast('L·ªói: ' + error.message, 'error');
  }
}

/**
 * Reload loan data from backend
 */
async function reloadLoanData() {
  try {
    console.log('Reloading loan data...');
    
    // Use DataManager if available
    if (DataManager && DataManager.isInitialized && DataManager.isInitialized()) {
      await DataManager.refresh('Kho·∫£n vay');
      allLoanData = DataManager.getLoan();
    } else {
      // Fallback to direct load
      const result = await new Promise(function(resolve, reject) {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getRecords('Kho·∫£n vay');
      });
      
      if (result.success) {
        allLoanData = result.data;
      }
    }
    
    loanFilteredData = allLoanData.slice();
    loanCurrentPage = 1;
    
    console.log('‚úÖ Loan data reloaded:', allLoanData.length, 'records');
    
    renderLoanPage();
    
  } catch (error) {
    console.error('Reload loan data error:', error);
    throw error;
  }
}

/**
 * Open edit loan modal
 * @param {string} id - Loan ID
 */
function editLoan(id) {
  openLoanModal(id);
}

/**
 * Confirm delete loan
 * @param {string} id - Loan ID
 */
function confirmDeleteLoan(id) {
  var loan = null;
  var loanList = DataManager.isInitialized && DataManager.isInitialized() ? 
    DataManager.getLoan() : allLoanData;
  
  for (var i = 0; i < loanList.length; i++) {
    if (loanList[i].ID === id) {
      loan = loanList[i];
      break;
    }
  }
  
  if (!loan) {
    showToast('Kh√¥ng t√¨m th·∫•y kho·∫£n vay', 'error');
    return;
  }
  
  var body = '<div style="padding: 20px; text-align: center;">' +
    '<i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f59e0b; margin-bottom: 15px;"></i>' +
    '<p style="font-size: 16px; color: #1f2937; margin-bottom: 10px;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kho·∫£n vay:</p>' +
    '<p style="font-size: 18px; font-weight: 600; color: #e94849; margin-bottom: 20px;">"' + loan['Danh m·ª•c vay'] + '"?</p>' +
    '<p style="color: #e94849;">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>' +
    '</div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-danger" onclick="executeDeleteLoan(\'' + id + '\')">X√≥a</button>';
  
  openModal('‚ö†Ô∏è X√°c nh·∫≠n x√≥a', body, footer);
}

/**
 * Execute delete loan
 * @param {string} id - Loan ID
 */
function executeDeleteLoan(id) {
  closeModal();
  showLoading('ƒêang x√≥a...');
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        reloadLoanData().then(function() {
          hideLoading();
          showToast('‚úÖ ƒê√£ x√≥a kho·∫£n vay', 'success');
        }).catch(function(error) {
          hideLoading();
          showToast('L·ªói t·∫£i l·∫°i d·ªØ li·ªáu', 'error');
        });
      } else {
        hideLoading();
        showToast(response.message || 'X√≥a th·∫•t b·∫°i', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('deleteRecord', {sheetName: 'Kho·∫£n vay', id: id});
}



// ========================================
// VIEW LOAN DETAILS - PAYMENT SCHEDULE
// ========================================

/**
 * View loan details with payment schedule
 * @param {string} id - Loan ID
 */
function viewLoanDetails(id) {
  console.log('=== VIEW LOAN DETAILS ===', id);
  
  var loanList = DataManager.isInitialized && DataManager.isInitialized() ? 
    DataManager.getLoan() : allLoanData;
  
  var loan = null;
  for (var i = 0; i < loanList.length; i++) {
    if (loanList[i].ID === id) {
      loan = loanList[i];
      break;
    }
  }
  
  if (!loan) {
    showToast('Kh√¥ng t√¨m th·∫•y kho·∫£n vay', 'error');
    return;
  }
  
  // Parse details
  var details = null;
  try {
    details = typeof loan['Chi ti·∫øt kho·∫£n vay'] === 'string' ? 
      JSON.parse(loan['Chi ti·∫øt kho·∫£n vay']) : loan['Chi ti·∫øt kho·∫£n vay'];
  } catch(e) {
    showToast('Kh√¥ng th·ªÉ ƒë·ªçc chi ti·∫øt kho·∫£n vay', 'error');
    return;
  }
  
  if (!details || !details.schedule) {
    showToast('Kh√¥ng c√≥ l·ªãch tr·∫£ n·ª£', 'error');
    return;
  }
  
  var schedule = details.schedule;
  var interestType = details.interestType || 'declining';
  
  // Interest type label
  var interestTypeLabel = interestType === 'declining' ? 'L√£i gi·∫£m d·∫ßn' : 
    interestType === 'simple' ? 'L√£i ƒë∆°n' : 'L√£i k√©p';
  
  // Calculate totals
  var totalPrincipal = 0;
  var totalInterest = 0;
  var totalPayment = 0;
  var paidCount = 0;
  
  for (var i = 0; i < schedule.length; i++) {
    totalPrincipal += schedule[i].principalPayment;
    totalInterest += schedule[i].interestPayment;
    totalPayment += schedule[i].totalPayment;
    if (schedule[i].status === 'paid') paidCount++;
  }
  
  // Build modal HTML
  var body = 
    // Loan Info
    '<div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3782f4;">' +
    '<h4 style="margin: 0 0 15px 0; color: #1e40af; font-size: 18px;">' +
    '<i class="fas fa-info-circle"></i> Th√¥ng tin kho·∫£n vay' +
    '</h4>' +
    
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">' +
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">T√™n kho·∫£n vay</div>' +
    '<div style="font-weight: 600; color: #1f2937; font-size: 15px;">' + loan['Danh m·ª•c vay'] + '</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">Gi√° tr·ªã vay</div>' +
    '<div style="font-weight: 700; color: #e94849; font-size: 16px;">' + formatCurrency(loan['Gi√° tr·ªã vay']) + ' ƒë</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">L√£i su·∫•t</div>' +
    '<div style="font-weight: 600; color: #f59e0b; font-size: 15px;">' + loan['L√£i su·∫•t vay/nƒÉm'] + '%/nƒÉm</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">H√¨nh th·ª©c l√£i</div>' +
    '<div style="font-weight: 600; color: #3782f4; font-size: 15px;">' + interestTypeLabel + '</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">Ng√†y vay</div>' +
    '<div style="font-weight: 600; font-size: 15px;">' + formatDate(loan['Ng√†y vay']) + '</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">H·∫°n tr·∫£</div>' +
    '<div style="font-weight: 600; font-size: 15px;">' + formatDate(loan['H·∫°n tr·∫£ vay']) + '</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">G·ªëc ƒë√£ tr·∫£</div>' +
    '<div style="font-weight: 700; color: #24c560; font-size: 16px;">' + formatCurrency(loan['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']) + ' ƒë</div>' +
    '</div>' +
    
    '<div>' +
    '<div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">C√≤n l·∫°i</div>' +
    '<div style="font-weight: 700; color: #e94849; font-size: 16px;">' + formatCurrency(loan['Ti·ªÅn vay c√≤n l·∫°i']) + ' ƒë</div>' +
    '</div>' +
    '</div>' +
    '</div>' +
    
    // Payment Schedule Table
    '<div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">' +
    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">' +
    '<h4 style="margin: 0; color: #92400e; font-size: 18px;">' +
    '<i class="fas fa-calendar-alt"></i> L·ªãch tr·∫£ n·ª£ (' + schedule.length + ' k·ª≥)' +
    '</h4>' +
    '<div style="font-size: 14px; color: #92400e;">' +
    '<strong>ƒê√£ thanh to√°n: ' + paidCount + '/' + schedule.length + '</strong>' +
    '</div>' +
    '</div>' +
    
    '<div class="loan-schedule-table">' +
    '<table>' +
    '<thead>' +
    '<tr>' +
    '<th class="sticky-period-col" style="text-align: center; width: 50px;">K·ª≥</th>' +
    '<th class="sticky-date-col" style="text-align: left; width: 120px;">H·∫°n tr·∫£</th>' +
    '<th style="text-align: right; min-width: 100px;">G·ªëc</th>' +
    '<th style="text-align: right; min-width: 100px;">L√£i</th>' +
    '<th style="text-align: right; min-width: 120px;">T·ªïng tr·∫£</th>' +
    '<th style="text-align: right; min-width: 100px;">D∆∞ n·ª£</th>' +
    '<th style="text-align: center; min-width: 100px;">Tr·∫°ng th√°i</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody>';
  
  for (var i = 0; i < schedule.length; i++) {
    var period = schedule[i];
    var isPaid = period.status === 'paid';
    var rowClass = isPaid ? 'paid-row' : '';
    
    body += '<tr class="' + rowClass + '">' +
      '<td class="sticky-period-col" style="text-align: center;">' + period.period + '</td>' +
      '<td class="sticky-date-col">' + formatDate(period.dueDate) + '</td>' +
      '<td style="text-align: right; color: #3782f4; font-weight: 600;">' + formatCurrency(period.principalPayment) + '</td>' +
      '<td style="text-align: right; color: #f59e0b; font-weight: 600;">' + formatCurrency(period.interestPayment) + '</td>' +
      '<td style="text-align: right; font-weight: 700;">' + formatCurrency(period.totalPayment) + '</td>' +
      '<td style="text-align: right; color: #e94849; font-weight: 600;">' + formatCurrency(period.remainingPrincipal) + '</td>' +
      '<td style="text-align: center;">' +
      (isPaid ? 
        '<span class="badge badge-success"><i class="fas fa-check"></i> ƒê√£ tr·∫£</span>' :
        '<button class="btn-success btn-sm" onclick="markPaymentInModal(\'' + id + '\', ' + period.period + ')" style="padding: 5px 10px; font-size: 12px;">' +
        '<i class="fas fa-money-bill-wave"></i> Thanh to√°n' +
        '</button>') +
      '</td>' +
      '</tr>';
  }
  
  // Totals row
  body += '<tr style="background: #fff3cd; font-weight: 700; border-top: 3px solid #fbbf24;">' +
    '<td class="sticky-period-col" style="text-align: center;">T·ªïng</td>' +
    '<td class="sticky-date-col"></td>' +
    '<td style="text-align: right; color: #3782f4;">' + formatCurrency(totalPrincipal) + '</td>' +
    '<td style="text-align: right; color: #f59e0b;">' + formatCurrency(totalInterest) + '</td>' +
    '<td style="text-align: right; color: #1f2937;">' + formatCurrency(totalPayment) + '</td>' +
    '<td colspan="2"></td>' +
    '</tr>';
  
  body += '</tbody></table></div></div>';
  
  var footer = '<button class="btn-secondary" onclick="closeModal()"><i class="fas fa-times"></i> ƒê√≥ng</button>';
  
  // Open modal with LARGE class
  openModal('üìã Chi ti·∫øt kho·∫£n vay', body, footer);
  
  // Add large class to modal after opening
  setTimeout(function() {
    var modalContent = document.querySelector('.modal-content');
    if (modalContent) {
      modalContent.classList.add('modal-large');
    }
  }, 50);
}

/**
 * Mark payment as paid from detail modal
 * @param {string} loanId - Loan ID
 * @param {number} period - Payment period
 */
function markPaymentInModal(loanId, period) {
  console.log('Mark payment in modal:', loanId, period);
  
  // Get loan data
  var loanList = DataManager.isInitialized && DataManager.isInitialized() ? 
    DataManager.getLoan() : allLoanData;
  
  var loan = null;
  for (var i = 0; i < loanList.length; i++) {
    if (loanList[i].ID === loanId) {
      loan = loanList[i];
      break;
    }
  }
  
  if (!loan) {
    showToast('Kh√¥ng t√¨m th·∫•y kho·∫£n vay', 'error');
    return;
  }
  
  // Parse details
  var details = null;
  try {
    details = typeof loan['Chi ti·∫øt kho·∫£n vay'] === 'string' ? 
      JSON.parse(loan['Chi ti·∫øt kho·∫£n vay']) : loan['Chi ti·∫øt kho·∫£n vay'];
  } catch(e) {
    showToast('Kh√¥ng th·ªÉ ƒë·ªçc chi ti·∫øt', 'error');
    return;
  }
  
  // Find payment
  var payment = null;
  for (var i = 0; i < details.schedule.length; i++) {
    if (details.schedule[i].period === period) {
      payment = details.schedule[i];
      break;
    }
  }
  
  if (!payment) {
    showToast('Kh√¥ng t√¨m th·∫•y k·ª≥ thanh to√°n', 'error');
    return;
  }
  
  // Close detail modal first
  closeModal();
  
  // Wait a bit then open payment confirm modal
  setTimeout(function() {
    // Build payment confirm modal
    var body = '<div style="padding: 20px;">' +
      '<div style="text-align: center; margin-bottom: 20px;">' +
      '<i class="fas fa-money-bill-wave" style="font-size: 48px; color: #24c560; margin-bottom: 10px;"></i>' +
      '<h3 style="margin: 10px 0; color: #1f2937;">X√°c nh·∫≠n thanh to√°n k·ª≥ ' + payment.period + '</h3>' +
      '<p style="color: #6b7280;">Kho·∫£n vay: <strong>' + loan['Danh m·ª•c vay'] + '</strong></p>' +
      '</div>' +
      
      '<div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
      '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">' +
      '<div>' +
      '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">H·∫°n tr·∫£</div>' +
      '<div style="font-weight: 600; color: #1f2937;">' + formatDate(payment.dueDate) + '</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Ti·ªÅn g·ªëc</div>' +
      '<div style="font-weight: 600; color: #3782f4;">' + formatCurrency(payment.principalPayment) + ' ƒë</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Ti·ªÅn l√£i</div>' +
      '<div style="font-weight: 600; color: #f59e0b;">' + formatCurrency(payment.interestPayment) + ' ƒë</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">T·ªïng thanh to√°n</div>' +
      '<div style="font-weight: 700; color: #24c560; font-size: 18px;">' + formatCurrency(payment.totalPayment) + ' ƒë</div>' +
      '</div>' +
      '</div>' +
      '</div>' +
      
      '<div style="background: #fffbeb; padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b;">' +
      '<p style="margin: 0; color: #92400e; font-size: 14px;">' +
      '<i class="fas fa-info-circle"></i> Sau khi thanh to√°n, s·ªë d∆∞ n·ª£ c√≤n l·∫°i s·∫Ω l√†: <strong>' + 
      formatCurrency(payment.remainingPrincipal) + ' ƒë</strong>' +
      '</p>' +
      '</div>' +
      '</div>';
    
    var footer = 
      '<button class="btn-secondary" onclick="closeModal(); setTimeout(function() { viewLoanDetails(\'' + loanId + '\'); }, 300);">H·ªßy</button>' +
      '<button class="btn-success" onclick="executeMarkPaymentFromDetail(\'' + loanId + '\', ' + payment.period + ')">' +
      '<i class="fas fa-check"></i> X√°c nh·∫≠n thanh to√°n' +
      '</button>';
    
    openModal('üí∞ Thanh to√°n k·ª≥ ' + payment.period, body, footer);
  }, 300);
}

/**
 * Execute mark payment from detail modal
 * @param {string} loanId - Loan ID
 * @param {number} period - Payment period
 */
function executeMarkPaymentFromDetail(loanId, period) {
  closeModal();
  showLoading('ƒêang c·∫≠p nh·∫≠t thanh to√°n...');
  
  console.log('Execute mark payment from detail:', loanId, period);
  
  google.script.run
    .withSuccessHandler(function(response) {
      console.log('Payment response:', response);
      
      if (!response) {
        hideLoading();
        showToast('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server', 'error');
        return;
      }
      
      if (response.success) {
        reloadLoanData().then(function() {
          hideLoading();
          showToast('‚úÖ ƒê√£ thanh to√°n k·ª≥ ' + period + ' th√†nh c√¥ng!', 'success');
          
          // Re-open detail modal
          setTimeout(function() {
            viewLoanDetails(loanId);
          }, 500);
        }).catch(function(error) {
          console.error('Reload error:', error);
          hideLoading();
          showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng nh∆∞ng kh√¥ng t·∫£i l·∫°i ƒë∆∞·ª£c d·ªØ li·ªáu', 'warning');
          setTimeout(function() { location.reload(); }, 2000);
        });
      } else {
        hideLoading();
        showToast(response.message || 'Thanh to√°n th·∫•t b·∫°i', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Payment error:', error);
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('markLoanPaymentAsPaid', {loanId: loanId, period: period});
}

/**
 * Mark payment from main table (quick payment)
 * @param {string} loanId - Loan ID
 */
function markPayment(loanId) {
  console.log('Quick mark payment for loan:', loanId);
  
  var loanList = DataManager.isInitialized && DataManager.isInitialized() ? 
    DataManager.getLoan() : allLoanData;
  
  var loan = null;
  for (var i = 0; i < loanList.length; i++) {
    if (loanList[i].ID === loanId) {
      loan = loanList[i];
      break;
    }
  }
  
  if (!loan) {
    showToast('Kh√¥ng t√¨m th·∫•y kho·∫£n vay', 'error');
    return;
  }
  
  // Parse details
  var details = null;
  try {
    details = typeof loan['Chi ti·∫øt kho·∫£n vay'] === 'string' ? 
      JSON.parse(loan['Chi ti·∫øt kho·∫£n vay']) : loan['Chi ti·∫øt kho·∫£n vay'];
  } catch(e) {
    showToast('Kh√¥ng th·ªÉ ƒë·ªçc chi ti·∫øt kho·∫£n vay', 'error');
    return;
  }
  
  if (!details || !details.schedule) {
    showToast('Kh√¥ng c√≥ l·ªãch tr·∫£ n·ª£', 'error');
    return;
  }
  
  // Find next unpaid period
  var nextPeriod = null;
  for (var i = 0; i < details.schedule.length; i++) {
    if (details.schedule[i].status !== 'paid') {
      nextPeriod = details.schedule[i];
      break;
    }
  }
  
  if (!nextPeriod) {
    showToast('Kho·∫£n vay ƒë√£ tr·∫£ h·∫øt', 'info');
    return;
  }
  
  // Build payment modal
  var body = '<div style="padding: 20px;">' +
    '<div style="text-align: center; margin-bottom: 20px;">' +
    '<i class="fas fa-money-bill-wave" style="font-size: 48px; color: #24c560; margin-bottom: 10px;"></i>' +
    '<h3 style="margin: 10px 0; color: #1f2937;">Thanh to√°n k·ª≥ ' + nextPeriod.period + '</h3>' +
    '<p style="color: #6b7280;">Kho·∫£n vay: <strong>' + loan['Danh m·ª•c vay'] + '</strong></p>' +
    '</div>' +
    
    '<div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">' +
    '<div>' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">H·∫°n tr·∫£</div>' +
    '<div style="font-weight: 600; color: #1f2937;">' + formatDate(nextPeriod.dueDate) + '</div>' +
    '</div>' +
    '<div>' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Ti·ªÅn g·ªëc</div>' +
    '<div style="font-weight: 600; color: #3782f4;">' + formatCurrency(nextPeriod.principalPayment) + ' ƒë</div>' +
    '</div>' +
    '<div>' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Ti·ªÅn l√£i</div>' +
    '<div style="font-weight: 600; color: #f59e0b;">' + formatCurrency(nextPeriod.interestPayment) + ' ƒë</div>' +
    '</div>' +
    '<div>' +
    '<div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">T·ªïng thanh to√°n</div>' +
    '<div style="font-weight: 700; color: #24c560; font-size: 18px;">' + formatCurrency(nextPeriod.totalPayment) + ' ƒë</div>' +
    '</div>' +
    '</div>' +
    '</div>' +
    
    '<div style="background: #fffbeb; padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b;">' +
    '<p style="margin: 0; color: #92400e; font-size: 14px;">' +
    '<i class="fas fa-info-circle"></i> Sau khi thanh to√°n, s·ªë d∆∞ n·ª£ c√≤n l·∫°i s·∫Ω l√†: <strong>' + 
    formatCurrency(nextPeriod.remainingPrincipal) + ' ƒë</strong>' +
    '</p>' +
    '</div>' +
    '</div>';
  
  var footer = 
    '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-success" onclick="executeMarkPayment(\'' + loanId + '\', ' + nextPeriod.period + ')">' +
    '<i class="fas fa-check"></i> X√°c nh·∫≠n thanh to√°n' +
    '</button>';
  
  openModal('üí∞ Thanh to√°n k·ª≥ ' + nextPeriod.period, body, footer);
}

/**
 * Execute mark payment
 * @param {string} loanId - Loan ID
 * @param {number} period - Payment period
 */
function executeMarkPayment(loanId, period) {
  closeModal();
  showLoading('ƒêang c·∫≠p nh·∫≠t thanh to√°n...');
  
  console.log('=== EXECUTE MARK PAYMENT ===');
  console.log('LoanID:', loanId, 'Period:', period);
  
  google.script.run
    .withSuccessHandler(function(response) {
      console.log('Mark payment response:', response);
      
      // Check response validity
      if (!response) {
        hideLoading();
        showToast('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server', 'error');
        return;
      }
      
      if (response.success) {
        console.log('Payment marked successfully');
        
        reloadLoanData().then(function() {
          hideLoading();
          showToast('‚úÖ ƒê√£ thanh to√°n k·ª≥ ' + period + ' th√†nh c√¥ng!', 'success');
        }).catch(function(error) {
          console.error('Reload error:', error);
          hideLoading();
          showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng nh∆∞ng kh√¥ng t·∫£i l·∫°i ƒë∆∞·ª£c d·ªØ li·ªáu', 'warning');
          
          // Force reload page if data manager fails
          setTimeout(function() {
            location.reload();
          }, 2000);
        });
      } else {
        hideLoading();
        showToast(response.message || 'Thanh to√°n th·∫•t b·∫°i', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Mark payment failure:', error);
      hideLoading();
      showToast('L·ªói: ' + error.message, 'error');
    })
    .handleRequest('markLoanPaymentAsPaid', {loanId: loanId, period: period});
}

// ========================================
// LOAN NOTIFICATIONS - DUE DATE ALERTS
// ========================================

/**
 * Check and display loan notifications
 * Called when loan page loads
 */
async function checkLoanNotifications() {
  try {
    console.log('Checking loan notifications...');
    
    // Get alert days from settings (default 7 days)
    var alertDays = parseInt(localStorage.getItem('loanAlertDays') || '7');
    
    const response = await new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .handleRequest('getLoanNotifications', {daysBeforeDue: alertDays});
    });
    
    if (!response.success) {
      console.log('No notifications or error:', response.message);
      return;
    }
    
    var notifications = response.data || [];
    
    console.log('Loan notifications:', notifications.length);
    
    if (notifications.length === 0) {
      // No notifications
      var notifContainer = document.getElementById('loanNotifications');
      if (notifContainer) {
        notifContainer.innerHTML = '';
      }
      return;
    }
    
    // Display notifications
    displayLoanNotifications(notifications);
    
  } catch (error) {
    console.error('Check notifications error:', error);
  }
}

/**
 * Display loan notifications in UI
 * @param {Array} notifications - Array of notifications
 */
function displayLoanNotifications(notifications) {
  var notifContainer = document.getElementById('loanNotifications');
  if (!notifContainer) return;
  
  var html = '<div style="background: #fff7ed; border: 2px solid #fb923c; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(251, 146, 60, 0.15);">' +
    '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">' +
    '<h3 style="margin: 0; color: #c2410c; font-size: 18px;">' +
    '<i class="fas fa-bell" style="margin-right: 8px; animation: ring 2s infinite;"></i>' +
    'Th√¥ng b√°o kho·∫£n vay s·∫Øp ƒë·∫øn h·∫°n (' + notifications.length + ')' +
    '</h3>' +
    '<button class="btn-secondary btn-sm" onclick="openLoanNotificationSettings()" title="C√†i ƒë·∫∑t c·∫£nh b√°o">' +
    '<i class="fas fa-cog"></i>' +
    '</button>' +
    '</div>';
  
  // Sort by urgency (urgent first)
  notifications.sort(function(a, b) {
    if (a.type === 'urgent' && b.type !== 'urgent') return -1;
    if (a.type !== 'urgent' && b.type === 'urgent') return 1;
    return a.daysUntilDue - b.daysUntilDue;
  });
  
  html += '<div style="display: grid; gap: 12px;">';
  
  for (var i = 0; i < notifications.length; i++) {
    var notif = notifications[i];
    var isUrgent = notif.type === 'urgent';
    var bgColor = isUrgent ? '#fef2f2' : '#fffbeb';
    var borderColor = isUrgent ? '#f87171' : '#fbbf24';
    var iconColor = isUrgent ? '#dc2626' : '#f59e0b';
    var icon = isUrgent ? 'fa-exclamation-triangle' : 'fa-clock';
    
    html += '<div style="background: ' + bgColor + '; border-left: 4px solid ' + borderColor + '; padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">' +
      '<div style="flex: 1;">' +
      '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">' +
      '<i class="fas ' + icon + '" style="color: ' + iconColor + '; font-size: 20px;"></i>' +
      '<strong style="color: #1f2937; font-size: 15px;">' + notif.loanName + '</strong>' +
      '</div>' +
      '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 13px; color: #4b5563;">' +
      '<div>K·ª≥: <strong>' + notif.period + '</strong></div>' +
      '<div>H·∫°n tr·∫£: <strong>' + formatDate(notif.dueDate) + '</strong></div>' +
      '<div>S·ªë ti·ªÅn: <strong style="color: ' + iconColor + ';">' + formatCurrency(notif.amount) + ' ƒë</strong></div>' +
      '<div>C√≤n: <strong style="color: ' + (notif.daysUntilDue <= 3 ? '#dc2626' : '#f59e0b') + ';">' + notif.daysUntilDue + ' ng√†y</strong></div>' +
      '</div>' +
      '</div>' +
      '<div style="display: flex; gap: 8px;">' +
      '<button class="btn-primary btn-sm" onclick="viewLoanDetails(\'' + notif.loanId + '\')" title="Xem chi ti·∫øt">' +
      '<i class="fas fa-eye"></i>' +
      '</button>' +
      '<button class="btn-success btn-sm" onclick="markPayment(\'' + notif.loanId + '\')" title="Thanh to√°n">' +
      '<i class="fas fa-money-bill-wave"></i>' +
      '</button>' +
      '</div>' +
      '</div>';
  }
  
  html += '</div></div>';
  
  // Add animation keyframes
  html += '<style>' +
    '@keyframes ring {' +
    '0%, 100% { transform: rotate(0deg); }' +
    '10%, 30% { transform: rotate(-10deg); }' +
    '20%, 40% { transform: rotate(10deg); }' +
    '}' +
    '</style>';
  
  notifContainer.innerHTML = html;
}

/**
 * Open notification settings modal
 */
function openLoanNotificationSettings() {
  var currentDays = parseInt(localStorage.getItem('loanAlertDays') || '7');
  
  var body = '<div style="padding: 20px;">' +
    '<div style="text-align: center; margin-bottom: 20px;">' +
    '<i class="fas fa-bell" style="font-size: 48px; color: #3782f4; margin-bottom: 10px;"></i>' +
    '<p style="color: #6b7280;">C√†i ƒë·∫∑t th·ªùi gian c·∫£nh b√°o tr∆∞·ªõc khi ƒë·∫øn h·∫°n thanh to√°n</p>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-calendar-alt"></i> C·∫£nh b√°o tr∆∞·ªõc (ng√†y)</label>' +
    '<input type="number" id="loanAlertDays" class="form-control" value="' + currentDays + '" min="1" max="30">' +
    '<small style="color: #6b7280;">H·ªá th·ªëng s·∫Ω c·∫£nh b√°o c√°c kho·∫£n vay ƒë·∫øn h·∫°n trong X ng√†y t·ªõi</small>' +
    '</div>' +
    
    '<div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-top: 15px;">' +
    '<p style="margin: 0; color: #1e40af; font-size: 13px;">' +
    '<i class="fas fa-info-circle"></i> G·ª£i √Ω:' +
    '</p>' +
    '<ul style="margin: 8px 0 0 20px; padding: 0; font-size: 13px; color: #1e40af;">' +
    '<li>3-5 ng√†y: C·∫£nh b√°o kh·∫©n c·∫•p</li>' +
    '<li>7 ng√†y: Khuy√™n d√πng (m·∫∑c ƒë·ªãnh)</li>' +
    '<li>14-30 ng√†y: C·∫£nh b√°o s·ªõm</li>' +
    '</ul>' +
    '</div>' +
    '</div>';
  
  var footer = 
    '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-primary" onclick="saveLoanNotificationSettings()">' +
    '<i class="fas fa-save"></i> L∆∞u c√†i ƒë·∫∑t' +
    '</button>';
  
  openModal('‚öôÔ∏è C√†i ƒë·∫∑t c·∫£nh b√°o', body, footer);
}

/**
 * Save notification settings
 */
function saveLoanNotificationSettings() {
  var days = parseInt(document.getElementById('loanAlertDays').value);
  
  if (!days || days < 1 || days > 30) {
    showToast('Vui l√≤ng nh·∫≠p s·ªë ng√†y t·ª´ 1-30', 'error');
    return;
  }
  
  localStorage.setItem('loanAlertDays', days);
  closeModal();
  showToast('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t c·∫£nh b√°o: ' + days + ' ng√†y', 'success');
  
  // Reload notifications with new settings
  checkLoanNotifications();
}

// ========================================
// LOAN IMPORT/EXPORT
// ========================================

// ========================================
// EXPORT LOAN TO EXCEL
// ========================================

/**
 * Export loan data to Excel
 */
function exportLoanToExcel() {
  console.log('Exporting loan to Excel...');
  
  if (!loanFilteredData || loanFilteredData.length === 0) {
    showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'warning');
    return;
  }
  
  showLoading('ƒêang t·∫°o file Excel...');
  
  try {
    // Prepare data
    var headers = [
      'Danh m·ª•c vay',
      'Ng√†y vay',
      'H·∫°n tr·∫£ vay',
      'Gi√° tr·ªã vay',
      'L√£i su·∫•t (%/nƒÉm)',
      'G·ªëc/th√°ng',
      'L√£i/th√°ng',
      'G·ªëc ƒë√£ tr·∫£',
      'C√≤n l·∫°i',
      'T√¨nh tr·∫°ng'
    ];
    
    var data = [];
    
    for (var i = 0; i < loanFilteredData.length; i++) {
      var item = loanFilteredData[i];
      
      var statusText = item['T√¨nh tr·∫°ng'] === 'completed' ? 'ƒê√£ tr·∫£ h·∫øt' : 
                      item['T√¨nh tr·∫°ng'] === 'overdue' ? 'Qu√° h·∫°n' : 'ƒêang vay';
      
      data.push([
        item['Danh m·ª•c vay'] || '',
        formatDate(item['Ng√†y vay']),
        formatDate(item['H·∫°n tr·∫£ vay']),
        parseCurrency(item['Gi√° tr·ªã vay']),
        parseFloat(item['L√£i su·∫•t vay/nƒÉm']) || 0,
        parseCurrency(item['Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng']),
        parseCurrency(item['Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng']),
        parseCurrency(item['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']),
        parseCurrency(item['Ti·ªÅn vay c√≤n l·∫°i']),
        statusText
      ]);
    }
    
    // Calculate totals
    var totalPrincipal = 0;
    var totalMonthlyPrincipal = 0;
    var totalMonthlyInterest = 0;
    var totalPaidPrincipal = 0;
    var totalRemaining = 0;
    
    for (var i = 0; i < loanFilteredData.length; i++) {
      totalPrincipal += parseCurrency(loanFilteredData[i]['Gi√° tr·ªã vay']);
      totalMonthlyPrincipal += parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng']);
      totalMonthlyInterest += parseCurrency(loanFilteredData[i]['Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng']);
      totalPaidPrincipal += parseCurrency(loanFilteredData[i]['Ti·ªÅn g·ªëc ƒë√£ tr·∫£']);
      totalRemaining += parseCurrency(loanFilteredData[i]['Ti·ªÅn vay c√≤n l·∫°i']);
    }
    
    // Add totals row
    data.push([
      'T·ªîNG C·ªòNG',
      '',
      '',
      totalPrincipal,
      '',
      totalMonthlyPrincipal,
      totalMonthlyInterest,
      totalPaidPrincipal,
      totalRemaining,
      loanFilteredData.length + ' kho·∫£n'
    ]);
    
    // Create workbook
    var ws_data = [headers].concat(data);
    var ws = XLSX.utils.aoa_to_sheet(ws_data);
    
    // Set column widths
    ws['!cols'] = [
      {wch: 25}, // Danh m·ª•c vay
      {wch: 12}, // Ng√†y vay
      {wch: 12}, // H·∫°n tr·∫£
      {wch: 15}, // Gi√° tr·ªã vay
      {wch: 12}, // L√£i su·∫•t
      {wch: 15}, // G·ªëc/th√°ng
      {wch: 15}, // L√£i/th√°ng
      {wch: 15}, // G·ªëc ƒë√£ tr·∫£
      {wch: 15}, // C√≤n l·∫°i
      {wch: 12}  // T√¨nh tr·∫°ng
    ];
    
    // Style header row
    var range = XLSX.utils.decode_range(ws['!ref']);
    for (var C = range.s.c; C <= range.e.c; ++C) {
      var address = XLSX.utils.encode_col(C) + "1";
      if (!ws[address]) continue;
      ws[address].s = {
        font: {bold: true, color: {rgb: "FFFFFF"}},
        fill: {fgColor: {rgb: "667eea"}},
        alignment: {horizontal: "center", vertical: "center"}
      };
    }
    
    // Style totals row
    var lastRow = range.e.r + 1;
    for (var C = range.s.c; C <= range.e.c; ++C) {
      var address = XLSX.utils.encode_col(C) + lastRow;
      if (!ws[address]) continue;
      ws[address].s = {
        font: {bold: true, color: {rgb: "FFFFFF"}},
        fill: {fgColor: {rgb: "764ba2"}},
        alignment: {horizontal: "center"}
      };
    }
    
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Kho·∫£n vay");
    
    // Generate filename
    var filename = 'Khoan_vay_' + formatDate(new Date()).replace(/\//g, '-') + '.xlsx';
    
    // Download
    XLSX.writeFile(wb, filename);
    
    hideLoading();
    showToast('‚úÖ ƒê√£ xu·∫•t ' + loanFilteredData.length + ' kho·∫£n vay ra Excel', 'success');
    
  } catch (error) {
    console.error('Export error:', error);
    hideLoading();
    showToast('L·ªói xu·∫•t Excel: ' + error.message, 'error');
  }
}

/**
 * Download loan template Excel
 */
function downloadLoanTemplate() {
  console.log('Downloading loan template...');
  
  // Create template data
  var headers = [
    'Danh m·ª•c vay',
    'Ng√†y vay',
    'Gi√° tr·ªã vay',
    'L√£i su·∫•t vay/nƒÉm (%)',
    'K·ª≥ h·∫°n (th√°ng)',
    'H√¨nh th·ª©c l√£i'
  ];
  
  var sampleData = [
    ['Vay mua nh√†', '2025-01-01', '500000000', '8.5', '240', 'declining'],
    ['Vay ti√™u d√πng', '2025-01-15', '50000000', '12', '36', 'simple'],
    ['Vay mua xe', '2025-02-01', '200000000', '9', '60', 'declining']
  ];
  
  var instructions = [
    [''],
    ['H∆Ø·ªöNG D·∫™N NH·∫¨P LI·ªÜU:'],
    ['1. Danh m·ª•c vay: T√™n kho·∫£n vay (VD: Vay mua nh√†, Vay ti√™u d√πng)'],
    ['2. Ng√†y vay: ƒê·ªãnh d·∫°ng YYYY-MM-DD (VD: 2025-01-01)'],
    ['3. Gi√° tr·ªã vay: S·ªë ti·ªÅn vay (VD: 100000000 = 100 tri·ªáu)'],
    ['4. L√£i su·∫•t: L√£i su·∫•t nƒÉm (VD: 8.5 nghƒ©a l√† 8.5%/nƒÉm)'],
    ['5. K·ª≥ h·∫°n: S·ªë th√°ng (VD: 12, 24, 36, 60, 240)'],
    ['6. H√¨nh th·ª©c l√£i: declining (l√£i gi·∫£m d·∫ßn), simple (l√£i ƒë∆°n), compound (l√£i k√©p)'],
    [''],
    ['L∆ØU √ù:'],
    ['- Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng c√°c c·ªôt b·∫Øt bu·ªôc'],
    ['- Gi√° tr·ªã vay ph·∫£i > 0'],
    ['- L√£i su·∫•t ph·∫£i t·ª´ 0-100'],
    ['- K·ª≥ h·∫°n ph·∫£i t·ª´ 1-360 th√°ng'],
    ['- H√¨nh th·ª©c l√£i khuy√™n d√πng: declining (ph·ªï bi·∫øn nh·∫•t)']
  ];
  
  // Build workbook
  var ws_data = [headers].concat(sampleData).concat(instructions);
  var ws = XLSX.utils.aoa_to_sheet(ws_data);
  
  // Set column widths
  ws['!cols'] = [
    {wch: 25}, // Danh m·ª•c vay
    {wch: 15}, // Ng√†y vay
    {wch: 15}, // Gi√° tr·ªã vay
    {wch: 20}, // L√£i su·∫•t
    {wch: 15}, // K·ª≥ h·∫°n
    {wch: 20}  // H√¨nh th·ª©c l√£i
  ];
  
  // Style header row
  var range = XLSX.utils.decode_range(ws['!ref']);
  for (var C = range.s.c; C <= range.e.c; ++C) {
    var address = XLSX.utils.encode_col(C) + "1";
    if (!ws[address]) continue;
    ws[address].s = {
      font: {bold: true},
      fill: {fgColor: {rgb: "3782f4"}},
      alignment: {horizontal: "center"}
    };
  }
  
  var wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Kho·∫£n vay");
  
  // Download
  XLSX.writeFile(wb, 'Mau_Khoan_vay_' + formatDate(new Date()) + '.xlsx');
  
  showToast('‚úÖ ƒê√£ t·∫£i xu·ªëng file m·∫´u', 'success');
}

/**
 * Open import loan modal
 */
function openLoanImportModal() {
  var body = '<div style="padding: 20px;">' +
    '<div style="text-align: center; margin-bottom: 20px;">' +
    '<i class="fas fa-file-import" style="font-size: 48px; color: #3782f4; margin-bottom: 10px;"></i>' +
    '<h3 style="margin: 10px 0; color: #1f2937;">Import kho·∫£n vay t·ª´ Excel</h3>' +
    '</div>' +
    
    '<div class="form-group">' +
    '<label><i class="fas fa-file-excel"></i> Ch·ªçn file Excel</label>' +
    '<input type="file" id="loanImportFile" class="form-control" accept=".xlsx,.xls" ' +
    'onchange="handleLoanFileSelect(event)">' +
    '<small style="color: #6b7280;">Ch·∫•p nh·∫≠n file .xlsx, .xls</small>' +
    '</div>' +
    
    '<div style="background: #fffbeb; padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b; margin-top: 15px;">' +
    '<p style="margin: 0 0 8px 0; color: #92400e; font-weight: 600;"><i class="fas fa-lightbulb"></i> L∆∞u √Ω:</p>' +
    '<ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f;">' +
    '<li>File ph·∫£i c√≥ ƒë√∫ng c·∫•u tr√∫c template</li>' +
    '<li>D·ªØ li·ªáu b·∫Øt ƒë·∫ßu t·ª´ d√≤ng 2 (d√≤ng 1 l√† header)</li>' +
    '<li>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√≠nh l·ªãch tr·∫£ n·ª£</li>' +
    '<li>C√°c kho·∫£n vay b·ªã l·ªói s·∫Ω b·ªã b·ªè qua</li>' +
    '</ul>' +
    '</div>' +
    
    '<div id="importPreview" style="margin-top: 15px;"></div>' +
    '</div>';
  
  var footer = 
    '<button class="btn-secondary" onclick="closeModal()">H·ªßy</button>' +
    '<button class="btn-warning" onclick="downloadLoanTemplate()" style="margin-right: auto;">' +
    '<i class="fas fa-download"></i> T·∫£i file m·∫´u' +
    '</button>' +
    '<button id="btnImportLoan" class="btn-primary" onclick="processLoanImport()" disabled>' +
    '<i class="fas fa-upload"></i> Import' +
    '</button>';
  
  openModal('üì• Import kho·∫£n vay', body, footer);
}

/**
 * Handle file select for import
 * @param {Event} event - File input change event
 */
function handleLoanFileSelect(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  console.log('File selected:', file.name);
  
  var reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, {type: 'array'});
      
      // Get first sheet
      var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      var jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
      
      console.log('Excel data:', jsonData);
      
      // Validate and preview
      var validRecords = validateLoanImportData(jsonData);
      
      if (validRecords.length === 0) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ import', 'error');
        return;
      }
      
      // Store for import
      window.loanImportData = validRecords;
      
      // Show preview
      displayLoanImportPreview(validRecords);
      
      // Enable import button
      document.getElementById('btnImportLoan').disabled = false;
      
    } catch (error) {
      console.error('Read file error:', error);
      showToast('L·ªói ƒë·ªçc file: ' + error.message, 'error');
    }
  };
  
  reader.readAsArrayBuffer(file);
}

/**
 * Validate loan import data
 * @param {Array} data - Raw Excel data
 * @return {Array} Valid records
 */
function validateLoanImportData(data) {
  if (!data || data.length < 2) return [];
  
  var headers = data[0];
  var validRecords = [];
  
  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    
    // Skip empty rows
    if (!row || row.length === 0 || !row[0]) continue;
    
    try {
      var record = {
        'Danh m·ª•c vay': row[0] ? String(row[0]).trim() : '',
        'Ng√†y vay': row[1] ? String(row[1]).trim() : '',
        'Gi√° tr·ªã vay': parseFloat(row[2]) || 0,
        'L√£i su·∫•t vay/nƒÉm': parseFloat(row[3]) || 0,
        'K·ª≥ h·∫°n': parseInt(row[4]) || 0,
        'H√¨nh th·ª©c l√£i': row[5] ? String(row[5]).trim().toLowerCase() : 'declining'
      };
      
      // Validate
      if (!record['Danh m·ª•c vay']) continue;
      if (!record['Ng√†y vay'] || !isValidDate(record['Ng√†y vay'])) continue;
      if (record['Gi√° tr·ªã vay'] <= 0) continue;
      if (record['L√£i su·∫•t vay/nƒÉm'] < 0 || record['L√£i su·∫•t vay/nƒÉm'] > 100) continue;
      if (record['K·ª≥ h·∫°n'] < 1 || record['K·ª≥ h·∫°n'] > 360) continue;
      
      // Validate interest type
      var validTypes = ['declining', 'simple', 'compound'];
      if (validTypes.indexOf(record['H√¨nh th·ª©c l√£i']) === -1) {
        record['H√¨nh th·ª©c l√£i'] = 'declining';
      }
      
      validRecords.push(record);
      
    } catch (e) {
      console.error('Parse row error:', e);
      continue;
    }
  }
  
  return validRecords;
}

/**
 * Display import preview
 * @param {Array} records - Valid records
 */
function displayLoanImportPreview(records) {
  var html = '<div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 3px solid #24c560;">' +
    '<p style="margin: 0; color: #166534; font-weight: 600;">' +
    '<i class="fas fa-check-circle"></i> T√¨m th·∫•y ' + records.length + ' kho·∫£n vay h·ª£p l·ªá' +
    '</p>' +
    '<ul style="margin: 10px 0 0 20px; padding: 0; font-size: 13px; color: #166534;">';
  
  for (var i = 0; i < Math.min(records.length, 5); i++) {
    html += '<li>' + records[i]['Danh m·ª•c vay'] + ' - ' + 
      formatCurrency(records[i]['Gi√° tr·ªã vay']) + ' ƒë - ' +
      records[i]['L√£i su·∫•t vay/nƒÉm'] + '%/nƒÉm - ' +
      records[i]['K·ª≥ h·∫°n'] + ' th√°ng' +
      '</li>';
  }
  
  if (records.length > 5) {
    html += '<li>... v√† ' + (records.length - 5) + ' kho·∫£n vay kh√°c</li>';
  }
  
  html += '</ul></div>';
  
  document.getElementById('importPreview').innerHTML = html;
}

/**
 * Process loan import
 */
async function processLoanImport() {
  if (!window.loanImportData || window.loanImportData.length === 0) {
    showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ import', 'error');
    return;
  }
  
  closeModal();
  showLoading('ƒêang import ' + window.loanImportData.length + ' kho·∫£n vay...');
  
  var successCount = 0;
  var errorCount = 0;
  
  try {
    for (var i = 0; i < window.loanImportData.length; i++) {
      var record = window.loanImportData[i];
      
      try {
        // Calculate schedule
        const scheduleResponse = await new Promise(function(resolve, reject) {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .handleRequest('calculateLoanSchedule', {
              loanData: {
                principal: record['Gi√° tr·ªã vay'],
                annualRate: record['L√£i su·∫•t vay/nƒÉm'],
                months: record['K·ª≥ h·∫°n'],
                interestType: record['H√¨nh th·ª©c l√£i'],
                startDate: record['Ng√†y vay']
              }
            });
        });
        
        if (!scheduleResponse.success) {
          errorCount++;
          continue;
        }
        
        var schedule = scheduleResponse.data;
        var firstPeriod = schedule[0];
        var lastPeriod = schedule[schedule.length - 1];
        
        // Build record
        var loanData = {
          'ID': generateId('KV'),
          'UserID': currentUser.userId,
          'Ng√†y vay': record['Ng√†y vay'],
          'H·∫°n tr·∫£ vay': lastPeriod.dueDate,
          'Danh m·ª•c vay': record['Danh m·ª•c vay'],
          'Gi√° tr·ªã vay': record['Gi√° tr·ªã vay'],
          'L√£i su·∫•t vay/nƒÉm': record['L√£i su·∫•t vay/nƒÉm'],
          'Ti·ªÅn g·ªëc tr·∫£ h√†ng th√°ng': firstPeriod.principalPayment,
          'Ti·ªÅn l√£i tr·∫£ h√†ng th√°ng': firstPeriod.interestPayment,
          'Ti·ªÅn g·ªëc ƒë√£ tr·∫£': 0,
          'Ti·ªÅn vay c√≤n l·∫°i': record['Gi√° tr·ªã vay'],
          'T√¨nh tr·∫°ng': 'active',
          'Chi ti·∫øt kho·∫£n vay': JSON.stringify({
            months: record['K·ª≥ h·∫°n'],
            interestType: record['H√¨nh th·ª©c l√£i'],
            schedule: schedule,
            createdAt: new Date().toISOString()
          })
        };
        
        // Save
        const saveResponse = await new Promise(function(resolve, reject) {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .handleRequest('createRecord', {sheetName: 'Kho·∫£n vay', data: loanData});
        });
        
        if (saveResponse.success) {
          successCount++;
        } else {
          errorCount++;
        }
        
      } catch (e) {
        console.error('Import record error:', e);
        errorCount++;
      }
    }
    
    // Reload data
    await reloadLoanData();
    
    hideLoading();
    
    var message = 'Import ho√†n t·∫•t: ' + successCount + ' th√†nh c√¥ng';
    if (errorCount > 0) {
      message += ', ' + errorCount + ' th·∫•t b·∫°i';
    }
    
    showToast('‚úÖ ' + message, successCount > 0 ? 'success' : 'warning');
    
    // Clear import data
    window.loanImportData = null;
    
  } catch (error) {
    console.error('Import error:', error);
    hideLoading();
    showToast('L·ªói import: ' + error.message, 'error');
  }
}

/**
 * Validate date format YYYY-MM-DD
 * @param {string} dateStr - Date string
 * @return {boolean} Valid or not
 */
function isValidDate(dateStr) {
  if (!dateStr) return false;
  var regex = /^\d{4}-\d{2}-\d{2}$/;
  if (!regex.test(dateStr)) return false;
  var date = new Date(dateStr);
  return date instanceof Date && !isNaN(date);
}
</script>